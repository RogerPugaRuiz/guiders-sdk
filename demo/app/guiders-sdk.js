!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.GuidersPixel=e():t.GuidersPixel=e()}(this,(()=>(()=>{var t={343:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(t){var e,n=(e="string"==typeof t?(0,s.default)(t):t,Uint8Array.of((15&e[6])<<4|e[7]>>4&15,(15&e[7])<<4|(240&e[4])>>4,(15&e[4])<<4|(240&e[5])>>4,(15&e[5])<<4|(240&e[0])>>4,(15&e[0])<<4|(240&e[1])>>4,(15&e[1])<<4|(240&e[2])>>4,96|15&e[2],e[3],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]));return"string"==typeof t?(0,a.unsafeStringify)(n):n};var i,s=(i=n(6792))&&i.__esModule?i:{default:i},a=n(9910)},401:function(t,e){"use strict";var n=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function r(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.BotDetector=void 0,e.BotDetector=class{constructor(){this.score=0,this.checks=[]}detect(){return n(this,void 0,void 0,(function*(){this.checkUserAgent(),this.checkBrowserFeatures(),this.checkTiming(),yield this.checkBehavior();const t=this.score/this.checks.length;return{isBot:t>.6,probability:t,details:this.checks}}))}checkUserAgent(){const t=/bot|crawler|spider|scraper/i.test(navigator.userAgent);this.addCheck("userAgent",t,t?1:0)}checkBrowserFeatures(){const t=navigator.webdriver||!navigator.plugins.length||!window.MouseEvent;this.addCheck("browserFeatures",t,t?1:0)}checkTiming(){const t=performance.timing.loadEventEnd-performance.timing.navigationStart<100;this.addCheck("timing",t,t?.8:0)}checkBehavior(){return new Promise((t=>{let e=!1;["click","mousemove","keypress"].forEach((t=>{document.addEventListener(t,(()=>{e=!0}),{once:!0})})),setTimeout((()=>{this.addCheck("behavior",!e,e?0:1),t()}),1e3)}))}addCheck(t,e,n){this.checks.push({name:t,result:e}),this.score+=n}}},421:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TokenInjectionStage=void 0;const i=n(1921);e.TokenInjectionStage=class{process(t){return i.TokenManager.attachTokenToEvent(t)}}},528:function(t,e,n){"use strict";var i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.Polling=void 0;const s=n(4689),a=n(5374),o=n(6376),r=(0,i(n(7833)).default)("engine.io-client:polling");class c extends s.Transport{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(t){this.readyState="pausing";const e=()=>{r("paused"),this.readyState="paused",t()};if(this._polling||!this.writable){let t=0;this._polling&&(r("we are currently polling - waiting to pause"),t++,this.once("pollComplete",(function(){r("pre-pause polling complete"),--t||e()}))),this.writable||(r("we are currently writing - waiting to pause"),t++,this.once("drain",(function(){r("pre-pause writing complete"),--t||e()})))}else e()}_poll(){r("polling"),this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(t){r("polling got data %s",t),(0,o.decodePayload)(t,this.socket.binaryType).forEach((t=>{if("opening"===this.readyState&&"open"===t.type&&this.onOpen(),"close"===t.type)return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(t)})),"closed"!==this.readyState&&(this._polling=!1,this.emitReserved("pollComplete"),"open"===this.readyState?this._poll():r('ignoring poll - transport state "%s"',this.readyState))}doClose(){const t=()=>{r("writing close packet"),this.write([{type:"close"}])};"open"===this.readyState?(r("transport open - closing"),t()):(r("transport not open - deferring close"),this.once("open",t))}write(t){this.writable=!1,(0,o.encodePayload)(t,(t=>{this.doWrite(t,(()=>{this.writable=!0,this.emitReserved("drain")}))}))}uri(){const t=this.opts.secure?"https":"http",e=this.query||{};return!1!==this.opts.timestampRequests&&(e[this.opts.timestampParam]=(0,a.randomString)()),this.supportsBinary||e.sid||(e.b64=1),this.createUri(t,e)}}e.Polling=c},736:(t,e,n)=>{t.exports=function(t){function e(t){let n,s,a,o=null;function r(...t){if(!r.enabled)return;const i=r,s=Number(new Date),a=s-(n||s);i.diff=a,i.prev=n,i.curr=s,n=s,t[0]=e.coerce(t[0]),"string"!=typeof t[0]&&t.unshift("%O");let o=0;t[0]=t[0].replace(/%([a-zA-Z%])/g,((n,s)=>{if("%%"===n)return"%";o++;const a=e.formatters[s];if("function"==typeof a){const e=t[o];n=a.call(i,e),t.splice(o,1),o--}return n})),e.formatArgs.call(i,t),(i.log||e.log).apply(i,t)}return r.namespace=t,r.useColors=e.useColors(),r.color=e.selectColor(t),r.extend=i,r.destroy=e.destroy,Object.defineProperty(r,"enabled",{enumerable:!0,configurable:!1,get:()=>null!==o?o:(s!==e.namespaces&&(s=e.namespaces,a=e.enabled(t)),a),set:t=>{o=t}}),"function"==typeof e.init&&e.init(r),r}function i(t,n){const i=e(this.namespace+(void 0===n?":":n)+t);return i.log=this.log,i}function s(t){return t.toString().substring(2,t.toString().length-2).replace(/\.\*\?$/,"*")}return e.debug=e,e.default=e,e.coerce=function(t){return t instanceof Error?t.stack||t.message:t},e.disable=function(){const t=[...e.names.map(s),...e.skips.map(s).map((t=>"-"+t))].join(",");return e.enable(""),t},e.enable=function(t){let n;e.save(t),e.namespaces=t,e.names=[],e.skips=[];const i=("string"==typeof t?t:"").split(/[\s,]+/),s=i.length;for(n=0;n<s;n++)i[n]&&("-"===(t=i[n].replace(/\*/g,".*?"))[0]?e.skips.push(new RegExp("^"+t.slice(1)+"$")):e.names.push(new RegExp("^"+t+"$")))},e.enabled=function(t){if("*"===t[t.length-1])return!0;let n,i;for(n=0,i=e.skips.length;n<i;n++)if(e.skips[n].test(t))return!1;for(n=0,i=e.names.length;n<i;n++)if(e.names[n].test(t))return!0;return!1},e.humanize=n(6585),e.destroy=function(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")},Object.keys(t).forEach((n=>{e[n]=t[n]})),e.names=[],e.skips=[],e.formatters={},e.selectColor=function(t){let n=0;for(let e=0;e<t.length;e++)n=(n<<5)-n+t.charCodeAt(e),n|=0;return e.colors[Math.abs(n)%e.colors.length]},e.enable(e.load()),e}},744:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i,s=(i=n(2858))&&i.__esModule?i:{default:i},a=n(9910),o=null,r=null,c=0;e.default=function(t,e,n){t=t||{};var i=e&&n||0,d=e||new Uint8Array(16),l=t.random||(t.rng||s.default)(),h=void 0!==t.msecs?t.msecs:Date.now(),u=void 0!==t.seq?t.seq:null,g=r,p=o;return h>c&&void 0===t.msecs&&(c=h,null!==u&&(g=null,p=null)),null!==u&&(u>2147483647&&(u=2147483647),g=u>>>19&4095,p=524287&u),null!==g&&null!==p||(g=(g=127&l[6])<<8|l[7],p=(p=(p=63&l[8])<<8|l[9])<<5|l[10]>>>3),h+1e4>c&&null===u?++p>524287&&(p=0,++g>4095&&(g=0,c++)):c=h,r=g,o=p,d[i++]=c/1099511627776&255,d[i++]=c/4294967296&255,d[i++]=c/16777216&255,d[i++]=c/65536&255,d[i++]=c/256&255,d[i++]=255&c,d[i++]=g>>>4&15|112,d[i++]=255&g,d[i++]=p>>>13&63|128,d[i++]=p>>>5&255,d[i++]=p<<3&255|7&l[10],d[i++]=l[11],d[i++]=l[12],d[i++]=l[13],d[i++]=l[14],d[i++]=l[15],e||(0,a.unsafeStringify)(d)}},969:function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function r(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.UnreadMessagesService=void 0;const s=n(2597),a=n(3104),o=n(3235),r=n(3974);class c{constructor(){this.visitorId="",this.currentChatId=null,this.unreadCount=0,this.unreadMessages=[],this.onCountChangeCallback=null,this.onMessageReceivedCallback=null,this.autoOpenChatOnMessage=!1,this.debug=!1,this.isChatOpen=!1,this.wsService=a.WebSocketService.getInstance(),(0,r.debugLog)("ðŸ“¬ [UnreadMessagesService] Instancia creada")}static getInstance(){return c.instance||(c.instance=new c),c.instance}initialize(t){this.visitorId=t.visitorId,this.onCountChangeCallback=t.onCountChange||null,this.onMessageReceivedCallback=t.onMessageReceived||null,this.autoOpenChatOnMessage=t.autoOpenChatOnMessage||!1,this.debug=t.debug||!1,this.log("ðŸš€ Inicializando servicio con:",{visitorId:this.visitorId,hasCallback:!!this.onCountChangeCallback,autoOpenChatOnMessage:this.autoOpenChatOnMessage}),this.wsService.updateCallbacks({onMessage:t=>this.handleNewMessage(t)}),this.log("âœ… Servicio inicializado correctamente")}setCurrentChat(t){this.currentChatId!==t?(this.log("ðŸ“Œ Cambiando chat activo:",{anterior:this.currentChatId,nuevo:t}),this.currentChatId=t,this.refreshUnreadMessages()):this.log("Chat ya activo:",t)}setChatOpenState(t){this.isChatOpen=t,this.log("ðŸ’¬ Estado del chat cambiado:",t?"abierto":"cerrado"),!t&&this.unreadCount>0&&(this.log("ðŸ“¢ Chat cerrado con mensajes no leÃ­dos, notificando badge"),this.notifyCountChange())}getAuthHeaders(){return(0,o.getCommonHeaders)()}getFetchOptions(t="GET",e){const n=(0,o.getCommonFetchOptions)(t);return e&&(n.body=e),n}getApiUrl(){const t=s.EndpointManager.getInstance(),e=localStorage.getItem("pixelEndpoint")||t.getEndpoint();return e.endsWith("/api")?e:`${e}/api`}refreshUnreadMessages(){return i(this,void 0,void 0,(function*(){if(this.currentChatId){this.log("ðŸ”„ Obteniendo mensajes no leÃ­dos del chat:",this.currentChatId);try{const t=`${this.getApiUrl()}/v2/messages/chat/${this.currentChatId}/unread`,e=yield fetch(t,this.getFetchOptions("GET"));if(!e.ok){const t=yield e.text();throw new Error(`Error al obtener mensajes no leÃ­dos (${e.status}): ${t}`)}const n=yield e.json();if(this.unreadMessages=n.filter((t=>t.senderId!==this.visitorId)),this.unreadCount=this.unreadMessages.length,this.log("âœ… Mensajes no leÃ­dos obtenidos:",{total:n.length,filtrados:this.unreadCount,mensajes:this.unreadMessages.map((t=>({id:t.id,senderId:t.senderId})))}),this.unreadCount>0&&this.autoOpenChatOnMessage&&!this.isChatOpen&&this.onMessageReceivedCallback){this.log("ðŸ”“ Auto-apertura: mensajes no leÃ­dos previos detectados - abriendo chat con chatId:",this.currentChatId),this.onMessageReceivedCallback(this.currentChatId),this.isChatOpen=!0;const t=this.unreadMessages.map((t=>t.id));return this.markAsRead(t).catch((t=>{})),this.unreadMessages=[],void(this.unreadCount=0)}this.notifyCountChange()}catch(t){}}else this.log("âš ï¸ No hay chat activo, omitiendo refresh")}))}markAsRead(t){return i(this,void 0,void 0,(function*(){if(0===t.length)return this.log("âš ï¸ No hay mensajes para marcar como leÃ­dos"),!1;this.log("ðŸ“ Marcando mensajes como leÃ­dos:",t);try{const e=`${this.getApiUrl()}/v2/messages/mark-as-read`,n=yield fetch(e,this.getFetchOptions("PUT",JSON.stringify({messageIds:t})));if(!n.ok)return yield n.text(),!1;const i=yield n.json();return this.log("âœ… Mensajes marcados como leÃ­dos:",i.markedCount),this.unreadMessages=this.unreadMessages.filter((e=>!t.includes(e.id))),this.unreadCount=this.unreadMessages.length,this.notifyCountChange(),!0}catch(t){return!1}}))}markAllAsRead(){return i(this,void 0,void 0,(function*(){const t=this.unreadMessages.map((t=>t.id));return this.markAsRead(t)}))}handleNewMessage(t){if(!this.currentChatId&&t.chatId&&(this.log("ðŸ†• Nuevo chat iniciado por comercial, asignando chatId:",t.chatId),this.currentChatId=t.chatId),t.chatId!==this.currentChatId)return void this.log("âš ï¸ Mensaje de otro chat, ignorando:",{mensajeChatId:t.chatId,currentChatId:this.currentChatId});if(t.senderId===this.visitorId)return void this.log("ðŸš« Mensaje propio ignorado");if(t.isInternal)return void this.log("ðŸ”’ Mensaje interno ignorado");if(this.log("ðŸ“¨ Nuevo mensaje recibido:",{messageId:t.messageId,senderId:t.senderId,chatAbierto:this.isChatOpen,autoOpenHabilitado:this.autoOpenChatOnMessage}),this.isChatOpen)return this.log("âœ… Chat abierto - marcando mensaje como leÃ­do automÃ¡ticamente"),void this.markAsRead([t.messageId]).catch((t=>{}));if(this.autoOpenChatOnMessage&&this.onMessageReceivedCallback)return this.log("ðŸ”“ Auto-apertura habilitada - abriendo chat con chatId:",t.chatId),this.onMessageReceivedCallback(t.chatId),this.isChatOpen=!0,this.log("ðŸ’¬ Chat abierto por auto-apertura - marcando mensaje como leÃ­do"),void this.markAsRead([t.messageId]).catch((t=>{}));const e={id:t.messageId,chatId:t.chatId,senderId:t.senderId,senderType:"commercial",content:t.content,type:t.type||"text",isRead:!1,readAt:null,readBy:null,createdAt:t.sentAt,updatedAt:t.sentAt,isInternal:t.isInternal||!1};this.unreadMessages.push(e),this.unreadCount=this.unreadMessages.length,this.log("âœ… Contador actualizado:",this.unreadCount),this.notifyCountChange()}notifyCountChange(){this.isChatOpen?this.log("â¸ï¸ Chat abierto - pausando notificaciones de badge (contador:",this.unreadCount+")"):this.onCountChangeCallback&&(this.log("ðŸ“¢ Notificando cambio de contador:",this.unreadCount),this.onCountChangeCallback(this.unreadCount))}getUnreadCount(){return this.unreadCount}getUnreadMessages(){return[...this.unreadMessages]}reset(){this.unreadMessages=[],this.unreadCount=0,this.currentChatId=null,this.notifyCountChange(),this.log("ðŸ”„ Servicio reseteado")}log(...t){this.debug&&(0,r.debugLog)("ðŸ“¬ [UnreadMessagesService]",...t)}}e.UnreadMessagesService=c,c.instance=null},1015:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.parse=function(t){if(t.length>8e3)throw"URI too long";const e=t,s=t.indexOf("["),a=t.indexOf("]");-1!=s&&-1!=a&&(t=t.substring(0,s)+t.substring(s,a).replace(/:/g,";")+t.substring(a,t.length));let o=n.exec(t||""),r={},c=14;for(;c--;)r[i[c]]=o[c]||"";return-1!=s&&-1!=a&&(r.source=e,r.host=r.host.substring(1,r.host.length-1).replace(/;/g,":"),r.authority=r.authority.replace("[","").replace("]","").replace(/;/g,":"),r.ipv6uri=!0),r.pathNames=function(t,e){const n=e.replace(/\/{2,9}/g,"/").split("/");return"/"!=e.slice(0,1)&&0!==e.length||n.splice(0,1),"/"==e.slice(-1)&&n.splice(n.length-1,1),n}(0,r.path),r.queryKey=function(t,e){const n={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,(function(t,e,i){e&&(n[e]=i)})),n}(0,r.query),r};const n=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,i=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"]},1034:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.HeuristicElementDetector=void 0;const i=n(6932);e.HeuristicElementDetector=class{constructor(t={}){this.heuristicRules={add_to_cart:[{selector:'button, input[type="submit"], a',confidence:i.ConfidenceLevel.HIGH,textPatterns:["aÃ±adir","agregar","add to cart","add cart","comprar","buy"],attributePatterns:{class:"cart",id:"cart"},contextSelectors:['[class*="product"]','[class*="item"]','[class*="cart"]']},{selector:'input[type="submit"]',confidence:i.ConfidenceLevel.MEDIUM,attributePatterns:{value:"carrito"}},{selector:'a[href*="cart"]',confidence:i.ConfidenceLevel.MEDIUM,textPatterns:["add","aÃ±adir"]}],contact_dealer:[{selector:'button, a, input[type="submit"]',confidence:i.ConfidenceLevel.HIGH,textPatterns:["contactar","contact","concesionario","dealer"],contextSelectors:['[class*="dealer"]','[class*="contact"]','form[class*="contact"]']},{selector:'form input[type="submit"]',confidence:i.ConfidenceLevel.MEDIUM,contextSelectors:['form[class*="contact"]','form[id*="contact"]']}],search_submit:[{selector:'button[type="submit"], input[type="submit"]',confidence:i.ConfidenceLevel.HIGH,contextSelectors:['form[class*="search"]','[class*="filter"]','[class*="search"]']},{selector:'button, input[type="submit"]',confidence:i.ConfidenceLevel.MEDIUM,textPatterns:["buscar","search","filtrar","filter"]}],schedule_test_drive:[{selector:'button, a, input[type="submit"]',confidence:i.ConfidenceLevel.HIGH,textPatterns:["test drive","prueba","conducir","probar","cita"],contextSelectors:['[class*="vehicle"]','[class*="car"]','[class*="auto"]']}],request_quote:[{selector:'button, a, input[type="submit"]',confidence:i.ConfidenceLevel.HIGH,textPatterns:["cotizar","quote","presupuesto","precio","solicitar"],contextSelectors:['[class*="vehicle"]','[class*="product"]','[class*="price"]']}],view_product:[{selector:"a, div, article",confidence:i.ConfidenceLevel.MEDIUM,contextSelectors:['[class*="product"]','[class*="item"]','[class*="card"]'],attributePatterns:{href:"product"}}],purchase:[{selector:'button, input[type="submit"]',confidence:i.ConfidenceLevel.HIGH,textPatterns:["comprar","buy","purchase","pagar","pay","checkout"],contextSelectors:['[class*="checkout"]','[class*="payment"]','[class*="buy"]']}],view_cart:[{selector:"a, button, div",confidence:i.ConfidenceLevel.MEDIUM,textPatterns:["carrito","cart","basket"],attributePatterns:{href:"cart",class:"cart"}}],download_brochure:[{selector:"a, button",confidence:i.ConfidenceLevel.HIGH,textPatterns:["descargar","download","brochure","folleto","catÃ¡logo","pdf"],attributePatterns:{href:".pdf"}}]},this.config=Object.assign({enabled:!0,confidenceThreshold:i.ConfidenceLevel.MEDIUM,fallbackToManual:!0},t),t.customRules&&(this.heuristicRules=Object.assign(Object.assign({},this.heuristicRules),t.customRules))}detectElements(t){if(!this.config.enabled)return[];const e=this.heuristicRules[t];if(!e||0===e.length)return[];const n=[];for(const i of e){const e=this.findElementsByRule(i);for(const s of e){const e=this.calculateConfidence(s,i);e>=this.config.confidenceThreshold&&n.push({element:s,eventType:t,confidence:e,matchedRule:i})}}return this.deduplicateResults(n).sort(((t,e)=>e.confidence-t.confidence))}findElementsByRule(t){return Array.from(document.querySelectorAll(t.selector)).filter((e=>this.elementMatchesRule(e,t)))}elementMatchesRule(t,e){var n,i;if(e.textPatterns){const i=(null===(n=t.textContent)||void 0===n?void 0:n.toLowerCase())||"";if(!e.textPatterns.some((t=>i.includes(t.toLowerCase()))))return!1}if(e.attributePatterns)for(const[n,s]of Object.entries(e.attributePatterns))if(!((null===(i=t.getAttribute(n))||void 0===i?void 0:i.toLowerCase())||"").includes(s.toLowerCase()))return!1;return!(e.contextSelectors&&!e.contextSelectors.some((e=>null!==t.closest(e)||null!==t.querySelector(e))))}calculateConfidence(t,e){var n;let i=e.confidence;if(e.textPatterns){const s=(null===(n=t.textContent)||void 0===n?void 0:n.toLowerCase())||"";i+=.1*e.textPatterns.filter((t=>s===t.toLowerCase())).length}if(e.attributePatterns){const n=Object.entries(e.attributePatterns).filter((([e,n])=>{var i;return((null===(i=t.getAttribute(e))||void 0===i?void 0:i.toLowerCase())||"").includes(n.toLowerCase())})).length;i+=.05*n}return Math.min(i,1)}deduplicateResults(t){const e=new Set;return t.filter((t=>!e.has(t.element)&&(e.add(t.element),!0)))}getConfig(){return Object.assign({},this.config)}updateConfig(t){this.config=Object.assign(Object.assign({},this.config),t)}addCustomRules(t,e){this.heuristicRules[t]||(this.heuristicRules[t]=[]),this.heuristicRules[t].push(...e)}}},1506:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0})},1556:function(t,e){"use strict";var n=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function r(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.AsyncSignal=e.Signal=void 0;class i{constructor(t=null){this.subscribers=[],this.state={loading:!1,data:t,error:null}}subscribe(t){return this.subscribers.push(t),()=>{const e=this.subscribers.indexOf(t);e>=0&&this.subscribers.splice(e,1)}}unsubscribe(t){const e=this.subscribers.indexOf(t);e>=0&&this.subscribers.splice(e,1)}getState(){return Object.assign({},this.state)}getValue(){return this.state.data}isLoading(){return this.state.loading}hasError(){return null!==this.state.error}setState(t){const e=Object.assign({},this.state);this.state=Object.assign(Object.assign({},this.state),t),this.hasStateChanged(e,this.state)&&this.notifySubscribers()}notifySubscribers(){this.subscribers.forEach((t=>{try{t(this.getState())}catch(t){}}))}hasStateChanged(t,e){return t.loading!==e.loading||t.data!==e.data||t.error!==e.error}setLoading(){this.setState({loading:!0,error:null})}setSuccess(t){this.setState({loading:!1,data:t,error:null})}setError(t){this.setState({loading:!1,error:t})}reset(){this.setState({loading:!1,data:null,error:null})}dispose(){this.subscribers.length=0}}e.Signal=i,e.AsyncSignal=class extends i{constructor(){super(...arguments),this.currentPromise=null,this.promiseId=0}execute(t){return n(this,void 0,void 0,(function*(){const e=++this.promiseId;this.setLoading();try{const n=t();this.currentPromise=n;const i=yield n;return this.promiseId===e?(this.setSuccess(i),this.currentPromise=null,i):i}catch(t){throw this.promiseId===e&&(this.setError(t instanceof Error?t:new Error(String(t))),this.currentPromise=null),t}}))}cancel(){this.currentPromise&&(this.promiseId++,this.currentPromise=null,this.setState({loading:!1}))}isPending(){return null!==this.currentPromise}}},1688:(t,e)=>{"use strict";function n(t){return t.replace(/\s+/g,"").replace(/\/+$/,"")}Object.defineProperty(e,"__esModule",{value:!0}),e.resolveDefaultEndpoints=function(){const t="undefined"!=typeof window&&window.GUIDERS_CONFIG?window.GUIDERS_CONFIG:{};let e=null;try{if("undefined"!=typeof window&&(e=new URL(window.location.href).searchParams.get("dev"),!e&&"undefined"!=typeof document)){let t=document.currentScript||null;if(t||(t=Array.from(document.getElementsByTagName("script")).find((t=>/index\.js/.test(t.src)))||null),t&&t.src)try{e=new URL(t.src,window.location.origin).searchParams.get("dev")}catch(t){}}}catch(t){}const i=!!e&&!/^0|false$/i.test(e);let s;s="production"===t.environment||"development"!==t.environment&&!i;const a="undefined"!=typeof process?"https://guiders.es/api":void 0,o="undefined"!=typeof process?"wss://guiders.es":void 0;let r=t.endpoint||a||(s?"https://guiders.es/api":"http://localhost:3000/api"),c=t.webSocketEndpoint||o||(s?"wss://guiders.es":"ws://localhost:3000");return r=n(r),c=n(c),{endpoint:r,webSocketEndpoint:c,isProd:s}}},1750:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0})},1921:function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function r(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.TokenManager=void 0;const s=n(3974);class a{static subscribeToTokenChanges(t){this.tokenChangeSubscribers.push(t)}static unsubscribeFromTokenChanges(t){const e=this.tokenChangeSubscribers.indexOf(t);e>=0&&this.tokenChangeSubscribers.splice(e,1)}static notifyTokenChange(t){this.tokenChangeSubscribers.forEach((e=>e(t)))}static setTokens(t){this.accessToken=t.access_token,this.refreshToken=t.refresh_token,localStorage.setItem("accessToken",t.access_token),localStorage.setItem("refreshToken",t.refresh_token),this.setExpirationTime(t.access_token)}static setAccessToken(t){this.accessToken=t,localStorage.setItem("accessToken",t),this.setExpirationTime(t)}static isTokenExpiring(t=60){if(!this.expirationTime)return!0;const e=Math.floor(Date.now()/1e3);return this.expirationTime-e<t}static getValidAccessToken(){return i(this,void 0,void 0,(function*(){return this.isTokenExpiring()?((0,s.debugLog)("Access token expirando, solicitando nuevos tokens..."),(0,s.debugLog)("âŒ No hay servicio de tokens disponible."),null):this.accessToken}))}static loadTokensFromStorage(){try{const t=localStorage.getItem("accessToken"),e=localStorage.getItem("refreshToken"),n=localStorage.getItem("tokenExpiration");if(!t||!e||!n)return!1;const i=parseInt(n,10);return!(isNaN(i)||i<=0||(this.accessToken=t,this.refreshToken=e,this.expirationTime=i,0))}catch(t){return!1}}static hasValidTokens(){return!!this.accessToken&&!!this.refreshToken}static attachTokenToEvent(t){return this.accessToken?((0,s.debugLog)("ðŸ”’ Adjuntando token al evento."),Object.assign(Object.assign({},t),{token:this.accessToken})):t}static startTokenMonitor(){this.tokenMonitorInterval||(this.tokenMonitorInterval=setInterval((()=>i(this,void 0,void 0,(function*(){if((0,s.debugLog)("â³ Verificando el estado del token..."),this.isTokenExpiring()){(0,s.debugLog)("âš ï¸ Token a punto de expirar, intentando refrescar...");const t=yield this.getValidAccessToken();t&&(this.notifyTokenChange(t),(0,s.debugLog)("âœ… Token refrescado automÃ¡ticamente."))}}))),1e4),(0,s.debugLog)("ðŸŸ¢ Token monitor iniciado."))}static stopTokenMonitor(){this.tokenMonitorInterval&&(clearInterval(this.tokenMonitorInterval),this.tokenMonitorInterval=null,(0,s.debugLog)("ðŸ›‘ Token monitor detenido."))}static setExpirationTime(t){try{const e=t.split(".")[1],n=atob(e),i=JSON.parse(n);this.expirationTime=i.exp,localStorage.setItem("tokenExpiration",i.exp.toString())}catch(t){this.expirationTime=null}}}e.TokenManager=a,a.accessToken=null,a.refreshToken=null,a.expirationTime=null,a.tokenMonitorInterval=null,a.tokenChangeSubscribers=[]},1999:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ValidationStage=void 0,e.ValidationStage=class{constructor(t="session"){this.uuidRegex=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i,this.authMode=t}isValidUUID(t){return this.uuidRegex.test(t)}process(t){if(!t.type)throw new Error("El evento debe tener un tipo");if(!t.data)throw new Error("El evento debe tener datos");if(!t.timestamp)throw new Error("El evento debe tener una marca de tiempo");if("jwt"===this.authMode&&!t.token)throw new Error("El evento debe tener un token en modo JWT");const e=t.data;if(!e.visitorId)throw new Error("El evento debe tener visitorId. AsegÃºrate de que identify() se haya completado antes de enviar eventos.");if(!this.isValidUUID(e.visitorId))throw new Error(`El visitorId debe ser un UUID vÃ¡lido, recibido: ${e.visitorId}`);if(!e.sessionId)throw new Error("El evento debe tener sessionId vÃ¡lido");if(!this.isValidUUID(e.sessionId))throw new Error(`El sessionId debe ser un UUID vÃ¡lido, recibido: ${e.sessionId}`);if(!e.eventType)throw new Error("El evento debe tener eventType");if(!e.metadata||"object"!=typeof e.metadata)throw new Error("El evento debe tener metadata como objeto");if(!e.occurredAt)throw new Error("El evento debe tener occurredAt en formato ISO 8601");return t}}},2046:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ERROR_PACKET=e.PACKET_TYPES_REVERSE=e.PACKET_TYPES=void 0;const n=Object.create(null);e.PACKET_TYPES=n,n.open="0",n.close="1",n.ping="2",n.pong="3",n.message="4",n.upgrade="5",n.noop="6";const i=Object.create(null);e.PACKET_TYPES_REVERSE=i,Object.keys(n).forEach((t=>{i[n[t]]=t})),e.ERROR_PACKET={type:"error",data:"parser error"}},2071:function(t,e,n){"use strict";var i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.XHR=e.Request=e.BaseXHR=void 0;const s=n(528),a=n(4454),o=n(5374),r=n(4624),c=n(4110),d=(0,i(n(7833)).default)("engine.io-client:polling");function l(){}class h extends s.Polling{constructor(t){if(super(t),"undefined"!=typeof location){const e="https:"===location.protocol;let n=location.port;n||(n=e?"443":"80"),this.xd="undefined"!=typeof location&&t.hostname!==location.hostname||n!==t.port}}doWrite(t,e){const n=this.request({method:"POST",data:t});n.on("success",e),n.on("error",((t,e)=>{this.onError("xhr post error",t,e)}))}doPoll(){d("xhr poll");const t=this.request();t.on("data",this.onData.bind(this)),t.on("error",((t,e)=>{this.onError("xhr poll error",t,e)})),this.pollXhr=t}}e.BaseXHR=h;class u extends a.Emitter{constructor(t,e,n){super(),this.createRequest=t,(0,o.installTimerFunctions)(this,n),this._opts=n,this._method=n.method||"GET",this._uri=e,this._data=void 0!==n.data?n.data:null,this._create()}_create(){var t;const e=(0,o.pick)(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");e.xdomain=!!this._opts.xd;const n=this._xhr=this.createRequest(e);try{d("xhr open %s: %s",this._method,this._uri),n.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){n.setDisableHeaderCheck&&n.setDisableHeaderCheck(!0);for(let t in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(t)&&n.setRequestHeader(t,this._opts.extraHeaders[t])}}catch(t){}if("POST"===this._method)try{n.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(t){}try{n.setRequestHeader("Accept","*/*")}catch(t){}null===(t=this._opts.cookieJar)||void 0===t||t.addCookies(n),"withCredentials"in n&&(n.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(n.timeout=this._opts.requestTimeout),n.onreadystatechange=()=>{var t;3===n.readyState&&(null===(t=this._opts.cookieJar)||void 0===t||t.parseCookies(n.getResponseHeader("set-cookie"))),4===n.readyState&&(200===n.status||1223===n.status?this._onLoad():this.setTimeoutFn((()=>{this._onError("number"==typeof n.status?n.status:0)}),0))},d("xhr data %s",this._data),n.send(this._data)}catch(t){return void this.setTimeoutFn((()=>{this._onError(t)}),0)}"undefined"!=typeof document&&(this._index=u.requestsCount++,u.requests[this._index]=this)}_onError(t){this.emitReserved("error",t,this._xhr),this._cleanup(!0)}_cleanup(t){if(void 0!==this._xhr&&null!==this._xhr){if(this._xhr.onreadystatechange=l,t)try{this._xhr.abort()}catch(t){}"undefined"!=typeof document&&delete u.requests[this._index],this._xhr=null}}_onLoad(){const t=this._xhr.responseText;null!==t&&(this.emitReserved("data",t),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}if(e.Request=u,u.requestsCount=0,u.requests={},"undefined"!=typeof document)if("function"==typeof attachEvent)attachEvent("onunload",g);else if("function"==typeof addEventListener){const t="onpagehide"in r.globalThisShim?"pagehide":"unload";addEventListener(t,g,!1)}function g(){for(let t in u.requests)u.requests.hasOwnProperty(t)&&u.requests[t].abort()}const p=function(){const t=f({xdomain:!1});return t&&null!==t.responseType}();function f(t){const e=t.xdomain;try{if("undefined"!=typeof XMLHttpRequest&&(!e||c.hasCORS))return new XMLHttpRequest}catch(t){}if(!e)try{return new(r.globalThisShim[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(t){}}e.XHR=class extends h{constructor(t){super(t);const e=t&&t.forceBase64;this.supportsBinary=p&&!e}request(t={}){return Object.assign(t,{xd:this.xd},this.opts),new u(f,this.uri(),t)}}},2090:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ConsentManager=void 0;const i=n(3974);class s{constructor(t={}){var e;this.listeners=new Set,this.STORAGE_KEY="guiders_consent_state",this.config={defaultStatus:t.defaultStatus||"pending",storageKey:t.storageKey||this.STORAGE_KEY,version:t.version||"1.0.0",waitForConsent:null===(e=t.waitForConsent)||void 0===e||e,onConsentChange:t.onConsentChange||(()=>{})};const n=this.loadState();n?this.state=n:(this.state=this.createInitialState(),"granted"===this.config.defaultStatus&&(this.state.preferences={analytics:!0,functional:!0,personalization:!0},this.saveState(),(0,i.debugLog)("[ConsentManager] âœ… Estado inicial con consentimiento otorgado guardado"))),(0,i.debugLog)("[ConsentManager] ðŸ” Inicializado con estado:",this.state)}static getInstance(t){return s.instance||(s.instance=new s(t)),s.instance}static resetInstance(){s.instance=null}createInitialState(){return{status:this.config.defaultStatus,timestamp:Date.now(),version:this.config.version,preferences:{analytics:!1,functional:!1,personalization:!1}}}loadState(){try{if("undefined"==typeof localStorage)return null;const t=localStorage.getItem(this.config.storageKey);if(!t)return null;const e=JSON.parse(t);return(0,i.debugLog)("[ConsentManager] ðŸ’¾ Estado cargado desde localStorage:",e),e}catch(t){return(0,i.debugError)("[ConsentManager] âŒ Error cargando estado:",t),null}}saveState(){try{if("undefined"==typeof localStorage)return void(0,i.debugWarn)("[ConsentManager] âš ï¸ localStorage no disponible");localStorage.setItem(this.config.storageKey,JSON.stringify(this.state)),(0,i.debugLog)("[ConsentManager] ðŸ’¾ Estado guardado:",this.state)}catch(t){(0,i.debugError)("[ConsentManager] âŒ Error guardando estado:",t)}}notifyListeners(){if(this.listeners.forEach((t=>{try{t(this.state)}catch(t){(0,i.debugError)("[ConsentManager] âŒ Error en listener:",t)}})),this.config.onConsentChange)try{this.config.onConsentChange(this.state)}catch(t){(0,i.debugError)("[ConsentManager] âŒ Error en onConsentChange callback:",t)}}getState(){return Object.assign({},this.state)}getStatus(){return this.state.status}isGranted(){return"granted"===this.state.status}isDenied(){return"denied"===this.state.status}isPending(){return"pending"===this.state.status}shouldWaitForConsent(){return this.config.waitForConsent&&this.isPending()}isTrackingAllowed(){return!this.config.waitForConsent||this.isGranted()}isCategoryAllowed(t){var e,n;return!!this.isGranted()&&null!==(n=null===(e=this.state.preferences)||void 0===e?void 0:e[t])&&void 0!==n&&n}grantConsent(){(0,i.debugLog)("[ConsentManager] âœ… Consentimiento otorgado"),this.state={status:"granted",timestamp:Date.now(),version:this.config.version,preferences:{analytics:!0,functional:!0,personalization:!0}},this.saveState(),this.notifyListeners()}grantConsentWithPreferences(t){var e,n,s;(0,i.debugLog)("[ConsentManager] âœ… Consentimiento otorgado con preferencias:",t),this.state={status:"granted",timestamp:Date.now(),version:this.config.version,preferences:{analytics:null===(e=t.analytics)||void 0===e||e,functional:null===(n=t.functional)||void 0===n||n,personalization:null===(s=t.personalization)||void 0===s||s}},this.saveState(),this.notifyListeners()}denyConsent(){(0,i.debugLog)("[ConsentManager] âŒ Consentimiento denegado"),this.state={status:"denied",timestamp:Date.now(),version:this.config.version,preferences:{analytics:!1,functional:!1,personalization:!1}},this.saveState(),this.notifyListeners()}revokeConsent(){(0,i.debugLog)("[ConsentManager] ðŸ”„ Consentimiento revocado"),this.denyConsent()}resetConsent(){(0,i.debugLog)("[ConsentManager] ðŸ”„ Consentimiento reseteado a pending"),this.state=this.createInitialState(),this.saveState(),this.notifyListeners()}subscribe(t){return this.listeners.add(t),t(this.state),()=>{this.listeners.delete(t)}}clearConsentData(){try{"undefined"!=typeof localStorage&&(localStorage.removeItem(this.config.storageKey),(0,i.debugLog)("[ConsentManager] ðŸ—‘ï¸ Datos de consentimiento eliminados"))}catch(t){(0,i.debugError)("[ConsentManager] âŒ Error eliminando datos de consentimiento:",t)}}updateVersion(t){this.state.version=t,this.saveState(),(0,i.debugLog)("[ConsentManager] ðŸ“¦ VersiÃ³n actualizada a:",t)}needsRenewal(t){return this.state.version!==t&&this.isGranted()}exportState(){return JSON.stringify(Object.assign(Object.assign({},this.state),{exportedAt:(new Date).toISOString()}),null,2)}}e.ConsentManager=s},2311:(t,e)=>{"use strict";function n(t){return 14+(t+64>>>9<<4)+1}function i(t,e){var n=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(n>>16)<<16|65535&n}function s(t,e,n,s,a,o){return i((r=i(i(e,t),i(s,o)))<<(c=a)|r>>>32-c,n);var r,c}function a(t,e,n,i,a,o,r){return s(e&n|~e&i,t,e,a,o,r)}function o(t,e,n,i,a,o,r){return s(e&i|n&~i,t,e,a,o,r)}function r(t,e,n,i,a,o,r){return s(e^n^i,t,e,a,o,r)}function c(t,e,n,i,a,o,r){return s(n^(e|~i),t,e,a,o,r)}Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0,e.default=function(t){if("string"==typeof t){var e=unescape(encodeURIComponent(t));t=new Uint8Array(e.length);for(var s=0;s<e.length;++s)t[s]=e.charCodeAt(s)}return function(t){for(var e=[],n=32*t.length,i="0123456789abcdef",s=0;s<n;s+=8){var a=t[s>>5]>>>s%32&255,o=parseInt(i.charAt(a>>>4&15)+i.charAt(15&a),16);e.push(o)}return e}(function(t,e){t[e>>5]|=128<<e%32,t[n(e)-1]=e;for(var s=1732584193,d=-271733879,l=-1732584194,h=271733878,u=0;u<t.length;u+=16){var g=s,p=d,f=l,m=h;s=a(s,d,l,h,t[u],7,-680876936),h=a(h,s,d,l,t[u+1],12,-389564586),l=a(l,h,s,d,t[u+2],17,606105819),d=a(d,l,h,s,t[u+3],22,-1044525330),s=a(s,d,l,h,t[u+4],7,-176418897),h=a(h,s,d,l,t[u+5],12,1200080426),l=a(l,h,s,d,t[u+6],17,-1473231341),d=a(d,l,h,s,t[u+7],22,-45705983),s=a(s,d,l,h,t[u+8],7,1770035416),h=a(h,s,d,l,t[u+9],12,-1958414417),l=a(l,h,s,d,t[u+10],17,-42063),d=a(d,l,h,s,t[u+11],22,-1990404162),s=a(s,d,l,h,t[u+12],7,1804603682),h=a(h,s,d,l,t[u+13],12,-40341101),l=a(l,h,s,d,t[u+14],17,-1502002290),s=o(s,d=a(d,l,h,s,t[u+15],22,1236535329),l,h,t[u+1],5,-165796510),h=o(h,s,d,l,t[u+6],9,-1069501632),l=o(l,h,s,d,t[u+11],14,643717713),d=o(d,l,h,s,t[u],20,-373897302),s=o(s,d,l,h,t[u+5],5,-701558691),h=o(h,s,d,l,t[u+10],9,38016083),l=o(l,h,s,d,t[u+15],14,-660478335),d=o(d,l,h,s,t[u+4],20,-405537848),s=o(s,d,l,h,t[u+9],5,568446438),h=o(h,s,d,l,t[u+14],9,-1019803690),l=o(l,h,s,d,t[u+3],14,-187363961),d=o(d,l,h,s,t[u+8],20,1163531501),s=o(s,d,l,h,t[u+13],5,-1444681467),h=o(h,s,d,l,t[u+2],9,-51403784),l=o(l,h,s,d,t[u+7],14,1735328473),s=r(s,d=o(d,l,h,s,t[u+12],20,-1926607734),l,h,t[u+5],4,-378558),h=r(h,s,d,l,t[u+8],11,-2022574463),l=r(l,h,s,d,t[u+11],16,1839030562),d=r(d,l,h,s,t[u+14],23,-35309556),s=r(s,d,l,h,t[u+1],4,-1530992060),h=r(h,s,d,l,t[u+4],11,1272893353),l=r(l,h,s,d,t[u+7],16,-155497632),d=r(d,l,h,s,t[u+10],23,-1094730640),s=r(s,d,l,h,t[u+13],4,681279174),h=r(h,s,d,l,t[u],11,-358537222),l=r(l,h,s,d,t[u+3],16,-722521979),d=r(d,l,h,s,t[u+6],23,76029189),s=r(s,d,l,h,t[u+9],4,-640364487),h=r(h,s,d,l,t[u+12],11,-421815835),l=r(l,h,s,d,t[u+15],16,530742520),s=c(s,d=r(d,l,h,s,t[u+2],23,-995338651),l,h,t[u],6,-198630844),h=c(h,s,d,l,t[u+7],10,1126891415),l=c(l,h,s,d,t[u+14],15,-1416354905),d=c(d,l,h,s,t[u+5],21,-57434055),s=c(s,d,l,h,t[u+12],6,1700485571),h=c(h,s,d,l,t[u+3],10,-1894986606),l=c(l,h,s,d,t[u+10],15,-1051523),d=c(d,l,h,s,t[u+1],21,-2054922799),s=c(s,d,l,h,t[u+8],6,1873313359),h=c(h,s,d,l,t[u+15],10,-30611744),l=c(l,h,s,d,t[u+6],15,-1560198380),d=c(d,l,h,s,t[u+13],21,1309151649),s=c(s,d,l,h,t[u+4],6,-145523070),h=c(h,s,d,l,t[u+11],10,-1120210379),l=c(l,h,s,d,t[u+2],15,718787259),d=c(d,l,h,s,t[u+9],21,-343485551),s=i(s,g),d=i(d,p),l=i(l,f),h=i(h,m)}return[s,d,l,h]}(function(t){if(0===t.length)return[];for(var e=8*t.length,i=new Uint32Array(n(e)),s=0;s<e;s+=8)i[s>>5]|=(255&t[s/8])<<s%32;return i}(t),8*t.length))}},2326:function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function r(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.DevRandomMessages=void 0;const s=n(7686),a=n(1688),o=n(3974);class r{constructor(){this.config={enabled:!1,minInterval:1e3,maxInterval:3e3,messageCount:5},this.isActive=!1,this.chatId=null,this.randomMessages=["Â¿Tienen descuentos disponibles?","Â¿CuÃ¡l es el tiempo de entrega?","Â¿Aceptan devoluciones?","Â¿Tienen garantÃ­a los productos?","Â¿CuÃ¡les son los mÃ©todos de pago?","Â¿Hacen envÃ­os internacionales?","Â¿Hay stock del producto?","Â¿CuÃ¡ndo llega la nueva colecciÃ³n?","Â¿Tienen tallas mÃ¡s grandes?","Â¿Puedo cambiar el producto?","Me gusta mucho este producto","Estoy interesado en mÃ¡s informaciÃ³n","Â¿Hay mÃ¡s colores disponibles?","El precio estÃ¡ bien ðŸ‘","Necesito ayuda para elegir","Muy buena calidad","Perfecto para lo que busco","Excelente atenciÃ³n al cliente","Recomendado por un amigo","Primera vez que compro aquÃ­","Testing scroll infinito ðŸ§ª","Verificando respuestas automÃ¡ticas","Probando notificaciones","Test de rendimiento del chat","Debug de mensajes largos: Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.","Validando funcionalidad de chat","Prueba de carga de mensajes","Testing de latencia","Verificando persistencia","Test de reconexiÃ³n","ðŸ˜€ Â¡Excelente servicio!","ðŸ›’ Quiero comprar esto","â“ Tengo una pregunta","â­ 5 estrellas para esta tienda","ðŸš€ Muy rÃ¡pido el envÃ­o","ðŸ’ Perfecto como regalo","ðŸ”¥ Oferta increÃ­ble","ðŸ‘Œ Todo perfecto","ðŸ’¯ Recomendado al 100%","ðŸŽ‰ Â¡Genial!","Hola","Gracias","Perfecto","OK","Entendido","Genial","Bien","Claro","Por supuesto","Muchas gracias","Mensaje con\nnueva lÃ­nea","Texto con 'comillas' y \"comillas dobles\"","Caracteres especiales: Ã±Ã‘Ã¡Ã©Ã­Ã³ÃºÃÃ‰ÃÃ“Ãš","NÃºmeros: 123 - 456.78 - $99.99","Enlaces: https://ejemplo.com","Mensaje muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy muy largo para testing","Emojis mÃºltiples: ðŸŽ¯ðŸš€ðŸ’¬ðŸ”¥â­ðŸ‘ðŸ›’ðŸ’ðŸŽ‰","TEXTO EN MAYÃšSCULAS","texto en minÃºsculas","CaMeLcAsE tExTo","Â¿CuÃ¡nto cuesta el envÃ­o?","Â¿Puedo pagar a plazos?","Â¿Hay descuento por volumen?","Â¿CuÃ¡l es la polÃ­tica de privacidad?","Â¿Tienen programa de fidelidad?","Â¿Hacen facturaciÃ³n empresarial?","Â¿Puedo recoger en tienda?","Â¿Tienen chat 24/7?","Â¿CuÃ¡l es el horario de atenciÃ³n?","Â¿Puedo hablar con un humano?","Estoy muy contento con la compra","El producto llegÃ³ defectuoso","SuperÃ³ mis expectativas","No es lo que esperaba","Calidad-precio excelente","TardÃ³ mÃ¡s de lo prometido","El empaque fue perfecto","Falta una pieza","Todo como en la descripciÃ³n","La foto no coincide","Â¿Es mejor que la marca X?","Â¿CuÃ¡l es la diferencia con el modelo anterior?","Â¿Vale la pena el upgrade?","Â¿QuÃ© ventajas tiene?","Â¿Es compatible con mi dispositivo?","Â¿Incluye accesorios?","Â¿Viene con garantÃ­a extendida?","Â¿Hay versiÃ³n premium?","Â¿CuÃ¡l me recomiendan?","Â¿Es el mÃ¡s vendido?","SÃ­mbolos: @#$%^&*()_+-=[]{}|;:,.<>?","Acentos: Ã Ã¡Ã¢Ã£Ã¤Ã¥Ã¦Ã§Ã¨Ã©ÃªÃ«Ã¬Ã­Ã®Ã¯Ã°Ã±Ã²Ã³Ã´ÃµÃ¶Ã¸Ã¹ÃºÃ»Ã¼Ã½Ã¾Ã¿","MatemÃ¡ticas: âˆ‘âˆâˆ†âˆ‡âˆ‚âˆ«âˆžÂ±â‰ â‰¤â‰¥â‰ˆâ‰¡âˆšâˆâˆˆâˆ‰âˆªâˆ©âŠ‚âŠƒ","Monetario: $â‚¬Â£Â¥â‚¹â‚½â‚©â‚¦â‚¨â‚¡â‚ªâ‚«â‚±â‚¡","Fracciones: Â½â…“â…”Â¼Â¾â…›â…œâ…â…ž","Quiero 2 unidades","Necesito 10 para mi empresa","Â¿Hay descuento desde 50 unidades?","Solo 1 por favor","Â¿Puedo comprar 100?","MÃ¡ximo 5 unidades","Â¿CuÃ¡ntos quedan en stock?","MÃ­nimo pedido 25 piezas","Lote de 12 unidades","Precio por mayoreo 500+"],this.init()}static getInstance(){return r.instance||(r.instance=new r),r.instance}init(){(0,a.resolveDefaultEndpoints)().isProd?(0,o.debugLog)("ðŸŽ² [DevRandomMessages] âŒ Deshabilitado en modo producciÃ³n"):(this.config.enabled=!0,(0,o.debugLog)("ðŸŽ² [DevRandomMessages] âœ… Inicializado en modo desarrollo"),this.interceptChatInput())}interceptChatInput(){"undefined"!=typeof window&&(window.addEventListener("guidersDevCommand",(t=>{this.handleDevCommand(t.detail)})),(0,o.debugLog)("ðŸŽ² [DevRandomMessages] ðŸŽ¯ Interceptor de comandos configurado"))}handleDevCommand(t){if(!this.config.enabled||this.isActive)return;const{command:e,text:n,count:i,chatId:s}=t;if("random"===e)if((0,o.debugLog)(`ðŸŽ² [DevRandomMessages] ðŸŽ¯ Comando detectado: ${n}`),null!==i){const t=200,e=Math.min(i,t);(0,o.debugLog)(`ðŸŽ² [DevRandomMessages] ðŸŽ¯ Comando #random:${i} detectado, generando ${e} mensajes`);const n=this.config.messageCount;this.config.messageCount=e,this.chatId=s,this.startRandomMessages().finally((()=>{this.config.messageCount=n}))}else(0,o.debugLog)("ðŸŽ² [DevRandomMessages] ðŸŽ¯ Comando #random detectado (cantidad por defecto)"),this.chatId=s,this.startRandomMessages()}startRandomMessages(){return i(this,void 0,void 0,(function*(){if(!this.isActive&&this.chatId){this.isActive=!0,(0,o.debugLog)(`ðŸŽ² [DevRandomMessages] ðŸš€ Iniciando generaciÃ³n de ${this.config.messageCount} mensajes aleatorios`);try{let t=this.config.minInterval,e=this.config.maxInterval;this.config.messageCount>50&&(t=Math.max(300,this.config.minInterval/2),e=Math.max(800,this.config.maxInterval/2),(0,o.debugLog)(`ðŸŽ² [DevRandomMessages] âš¡ Usando intervalos optimizados para ${this.config.messageCount} mensajes: ${t}-${e}ms`));for(let n=0;n<this.config.messageCount;n++){const i=this.randomBetween(t,e);yield this.sleep(i);const s=this.getRandomMessage();yield this.sendRandomMessage(s),(0,o.debugLog)(`ðŸŽ² [DevRandomMessages] ðŸ“¤ Mensaje ${n+1}/${this.config.messageCount}: "${s}"`)}}catch(t){}finally{this.isActive=!1,(0,o.debugLog)("ðŸŽ² [DevRandomMessages] âœ… GeneraciÃ³n de mensajes completada")}}}))}sendRandomMessage(t){return i(this,void 0,void 0,(function*(){if(!this.chatId)throw new Error("No hay chat ID disponible");try{yield s.ChatV2Service.getInstance().sendMessage(this.chatId,t,"text")}catch(t){throw t}}))}getRandomMessage(){const t=Math.floor(Math.random()*this.randomMessages.length);return this.randomMessages[t]}randomBetween(t,e){return Math.floor(Math.random()*(e-t+1))+t}sleep(t){return new Promise((e=>setTimeout(e,t)))}setConfig(t){this.config=Object.assign(Object.assign({},this.config),t),(0,o.debugLog)("ðŸŽ² [DevRandomMessages] âš™ï¸ ConfiguraciÃ³n actualizada:",this.config)}getConfig(){return Object.assign({},this.config)}isEnabled(){return this.config.enabled}isGenerating(){return this.isActive}triggerRandomMessages(t,e){return i(this,void 0,void 0,(function*(){if(this.config.enabled)if(void 0!==e){const n=200,i=Math.min(e,n),s=this.config.messageCount;this.config.messageCount=i,this.chatId=t,yield this.startRandomMessages().finally((()=>{this.config.messageCount=s}))}else this.chatId=t,yield this.startRandomMessages()}))}addCustomMessages(t){this.randomMessages.push(...t),(0,o.debugLog)(`ðŸŽ² [DevRandomMessages] âž• Agregados ${t.length} mensajes personalizados`)}}e.DevRandomMessages=r,r.instance=null,"undefined"!=typeof window&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{r.getInstance()})):r.getInstance()),e.default=r},2588:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PipelineProcessorBuilder=e.PipelineProcessor=void 0;const i=n(3974);class s{constructor(t=[]){this.stages=t}process(t){let e;for(const n of this.stages)try{e=n.process(t),t=e,(0,i.debugLog)(`Procesando evento con ${n.constructor.name}`)}catch(t){break}if(!e)throw new Error("No se pudo procesar el evento");return(0,i.debugLog)("Evento procesado:",e),e}}e.PipelineProcessor=s,e.PipelineProcessorBuilder=class{constructor(){this.stages=[]}addStage(t){return this.stages.push(t),this}build(){return new s(this.stages)}}},2597:function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function r(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))},s=this&&this.__rest||function(t,e){var n={};for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&e.indexOf(i)<0&&(n[i]=t[i]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(i=Object.getOwnPropertySymbols(t);s<i.length;s++)e.indexOf(i[s])<0&&Object.prototype.propertyIsEnumerable.call(t,i[s])&&(n[i[s]]=t[i[s]])}return n};Object.defineProperty(e,"__esModule",{value:!0}),e.TrackingPixelSDK=e.EndpointManager=void 0;const a=n(9126),o=n(2588),r=n(1921),c=n(4815),d=n(421),l=n(1999),h=n(5861),u=n(9329),g=n(4476),p=n(3741),f=n(3038),m=n(3731),b=n(9453),v=n(3722),y=n(2919),C=n(7183),S=n(7785),w=n(7686),k=n(1688),I=n(5558),x=n(2969),T=n(9167),E=n(2831),M=n(6808),L=n(2895),_=n(6420),A=n(4412),P=n(5303),O=n(6571),D=n(3104),j=n(7696),U=n(2090),R=n(4968),B=n(4729),N=n(3974),V=n(5269),F=n(6398);class z{constructor(t,e){this.endpoint=t,this.webSocketEndpoint=e}static getInstance(t,e){if(z.instance)(t||e)&&(t&&(z.instance.endpoint=t),e&&(z.instance.webSocketEndpoint=e));else{const n=(0,k.resolveDefaultEndpoints)();z.instance=new z(t||n.endpoint,e||n.webSocketEndpoint)}return z.instance}static setInstance(t,e){z.instance?(z.instance.endpoint=t,z.instance.webSocketEndpoint=e):z.instance=new z(t,e)}getEndpoint(){return this.endpoint}getWebSocketEndpoint(){return this.webSocketEndpoint}setEndpoint(t){this.endpoint=t}setWebSocketEndpoint(t){this.webSocketEndpoint=t}}e.EndpointManager=z,e.TrackingPixelSDK=class{constructor(t){var e,n,i,s,a,r,y,C,S,w,I,x,T,E,A,B,V,F,H,K,$,W,q,G,Q,Y,J,X,Z,tt,et,nt,it,st,at,ot,rt,ct,dt,lt,ht,ut,gt,pt,ft,mt,bt,vt,yt,Ct,St,wt,kt,It,xt,Tt,Et,Mt,Lt,_t,At,Pt,Ot,Dt,jt,Ut,Rt;this.pipelineBuilder=new o.PipelineProcessorBuilder,this.eventQueue=[],this.eventQueueManager=null,this.trackingV2Service=null,this.trackingV2Enabled=!0,this.eventThrottler=null,this.eventAggregator=null,this.bypassConsentForTracking=!1,this.fingerprint=null,this.chatUI=null,this.chatMessagesUI=null,this.chatInputUI=null,this.chatToggleButton=null,this.autoFlush=!1,this.flushInterval=1e4,this.flushTimer=null,this.maxRetries=3,this.listeners=new Map,this.sessionTrackingManager=null,this.identifyExecuted=!1,this.presenceService=null,this.consentBanner=null,this.commercialAvailabilityService=null,this.autoOpenChatOnMessage=!0;const Bt=(0,k.resolveDefaultEndpoints)(),Nt=t.endpoint||Bt.endpoint,Vt=t.webSocketEndpoint||Bt.webSocketEndpoint;if(z.setInstance(Nt,Vt),this.endpoint=Nt,this.webSocketEndpoint=Vt,this.apiKey=t.apiKey,this.authMode=t.authMode||"session",this.autoFlush=null!==(e=t.autoFlush)&&void 0!==e&&e,this.flushInterval=null!==(n=t.flushInterval)&&void 0!==n?n:1e4,this.maxRetries=null!==(i=t.maxRetries)&&void 0!==i?i:3,this.chatConsentMessageConfig=t.chatConsentMessage,this.chatPositionConfig=t.chatPosition,this.mobileDetectionConfig=t.mobileDetection,this.presenceConfig={enabled:null===(a=null===(s=t.presence)||void 0===s?void 0:s.enabled)||void 0===a||a,showTypingIndicator:null===(y=null===(r=t.presence)||void 0===r?void 0:r.showTypingIndicator)||void 0===y||y,typingDebounce:null!==(S=null===(C=t.presence)||void 0===C?void 0:C.typingDebounce)&&void 0!==S?S:300,typingTimeout:null!==(I=null===(w=t.presence)||void 0===w?void 0:w.typingTimeout)&&void 0!==I?I:2e3,pollingInterval:null!==(T=null===(x=t.presence)||void 0===x?void 0:x.pollingInterval)&&void 0!==T?T:3e4,showOfflineBanner:null===(A=null===(E=t.presence)||void 0===E?void 0:E.showOfflineBanner)||void 0===A||A,heartbeatInterval:null!==(V=null===(B=t.presence)||void 0===B?void 0:B.heartbeatInterval)&&void 0!==V?V:6e4,userInteractionThrottle:null!==(H=null===(F=t.presence)||void 0===F?void 0:F.userInteractionThrottle)&&void 0!==H?H:5e3},(0,N.debugLog)("[TrackingPixelSDK] ðŸŸ¢ ConfiguraciÃ³n de presencia:",this.presenceConfig),this.autoOpenChatOnMessage=null===(K=t.autoOpenChatOnMessage)||void 0===K||K,(0,N.debugLog)("[TrackingPixelSDK] ðŸ“¬ Auto-apertura del chat:",this.autoOpenChatOnMessage?"habilitada":"deshabilitada"),this.quickActionsConfig=t.quickActions,this.aiConfig=t.ai,this.aiConfig&&(0,N.debugLog)("[TrackingPixelSDK] ðŸ¤– ConfiguraciÃ³n de IA:",this.aiConfig),t.activeHours&&t.activeHours.enabled){const e={enabled:!0,ranges:t.activeHours.ranges||[],timezone:t.activeHours.timezone,fallbackMessage:t.activeHours.fallbackMessage};O.ActiveHoursValidator.validateConfig(e).length>0||(this.activeHoursValidator=new O.ActiveHoursValidator(e),(0,N.debugLog)("[TrackingPixelSDK] ðŸ• Validador de horarios activos configurado:",e))}this.trackingV2Enabled=null===(W=null===($=t.trackingV2)||void 0===$?void 0:$.enabled)||void 0===W||W,this.bypassConsentForTracking=null!==(G=null===(q=t.trackingV2)||void 0===q?void 0:q.bypassConsent)&&void 0!==G&&G,this.bypassConsentForTracking,this.trackingV2Enabled?(this.eventQueueManager=new f.EventQueueManager({maxSize:null!==(Y=null===(Q=t.trackingV2)||void 0===Q?void 0:Q.maxQueueSize)&&void 0!==Y?Y:1e4,persistEnabled:null===(X=null===(J=t.trackingV2)||void 0===J?void 0:J.persistQueue)||void 0===X||X}),this.trackingV2Service=m.TrackingV2Service.getInstance(),this.eventThrottler=new b.EventThrottler({enabled:null===(et=null===(tt=null===(Z=t.trackingV2)||void 0===Z?void 0:Z.throttling)||void 0===tt?void 0:tt.enabled)||void 0===et||et,rules:null!==(st=null===(it=null===(nt=t.trackingV2)||void 0===nt?void 0:nt.throttling)||void 0===it?void 0:it.rules)&&void 0!==st?st:{},debug:null!==(rt=null===(ot=null===(at=t.trackingV2)||void 0===at?void 0:at.throttling)||void 0===ot?void 0:ot.debug)&&void 0!==rt&&rt}),this.eventAggregator=new v.EventAggregator({enabled:null===(lt=null===(dt=null===(ct=t.trackingV2)||void 0===ct?void 0:ct.aggregation)||void 0===dt?void 0:dt.enabled)||void 0===lt||lt,windowMs:null!==(gt=null===(ut=null===(ht=t.trackingV2)||void 0===ht?void 0:ht.aggregation)||void 0===ut?void 0:ut.windowMs)&&void 0!==gt?gt:1e3,maxBufferSize:null!==(mt=null===(ft=null===(pt=t.trackingV2)||void 0===pt?void 0:pt.aggregation)||void 0===ft?void 0:ft.maxBufferSize)&&void 0!==mt?mt:1e3,debug:null!==(yt=null===(vt=null===(bt=t.trackingV2)||void 0===bt?void 0:bt.aggregation)||void 0===vt?void 0:vt.debug)&&void 0!==yt&&yt,onFlush:t=>{t.forEach((t=>{this.eventQueueManager&&this.eventQueueManager.enqueue(t)})),(0,N.debugLog)(`[TrackingPixelSDK] ðŸ”— Auto-flush agregador: ${t.length} eventos encolados`)}}),(0,N.debugLog)("[TrackingPixelSDK] ðŸ“Š Tracking V2 habilitado",{batchSize:null!==(St=null===(Ct=t.trackingV2)||void 0===Ct?void 0:Ct.batchSize)&&void 0!==St?St:500,flushInterval:null!==(kt=null===(wt=t.trackingV2)||void 0===wt?void 0:wt.flushInterval)&&void 0!==kt?kt:5e3,throttling:this.eventThrottler.isEnabled(),aggregation:this.eventAggregator.isEnabled(),bypassConsent:this.bypassConsentForTracking})):(0,N.debugLog)("[TrackingPixelSDK] âš ï¸ Tracking V2 deshabilitado"),this.identitySignal=P.IdentitySignal.getInstance(),this.wsService=D.WebSocketService.getInstance(),this.realtimeMessageManager=j.RealtimeMessageManager.getInstance();const Ft=null!==(It=t.requireConsent)&&void 0!==It&&It,zt=null!==(Tt=null===(xt=t.consent)||void 0===xt?void 0:xt.waitForConsent)&&void 0!==Tt?Tt:Ft,Ht=Ft?(null===(Et=t.consent)||void 0===Et?void 0:Et.defaultStatus)||"pending":"granted";if(this.consentManager=U.ConsentManager.getInstance({version:"1.6.0",waitForConsent:zt,defaultStatus:Ht,onConsentChange:e=>{var n;(0,N.debugLog)("[TrackingPixelSDK] ðŸ” Estado de consentimiento cambiado:",e),"granted"===e.status&&((0,N.debugLog)("[TrackingPixelSDK] âœ… Consentimiento otorgado - habilitando tracking"),(0,N.debugLog)("[TrackingPixelSDK] ðŸ“ El backend registrarÃ¡ automÃ¡ticamente el consentimiento en identify()"),this.init().catch((t=>{}))),"denied"===e.status&&((0,N.debugLog)("[TrackingPixelSDK] âŒ Consentimiento denegado - deshabilitando tracking"),this.stopTrackingActivities()),(null===(n=t.consent)||void 0===n?void 0:n.onConsentChange)&&t.consent.onConsentChange(e)}}),this.consentBackendService=R.ConsentBackendService.getInstance(),(0,N.debugLog)("[TrackingPixelSDK] ðŸ” ConsentBackendService inicializado"),this.commercialAvailabilityConfig=t.commercialAvailability,Ft&&t.consentBanner&&!1!==t.consentBanner.enabled&&this.initConsentBanner(t.consentBanner),this.sessionInjectionStage=new g.SessionInjectionStage,this.pipelineBuilder.addStage(new c.TimeStampStage),"jwt"===this.authMode?this.pipelineBuilder.addStage(new d.TokenInjectionStage):(0,N.debugLog)("[TrackingPixelSDK] ðŸ” authMode=session: omitiendo TokenInjectionStage"),this.eventPipeline=this.pipelineBuilder.addStage(new u.URLInjectionStage).addStage(this.sessionInjectionStage).addStage(new h.MetadataInjectionStage).addStage(new p.TrackingV2TransformStage).addStage(new l.ValidationStage(this.authMode)).build(),this.heuristicEnabled=null===(Lt=null===(Mt=t.heuristicDetection)||void 0===Mt?void 0:Mt.enabled)||void 0===Lt||Lt,this.heuristicEnabled?((0,N.debugLog)("[TrackingPixelSDK] ðŸš€ Initializing with heuristic detection enabled"),this.domTrackingManager=new L.EnhancedDomTrackingManager((t=>this.track(t)),new M.DefaultTrackDataExtractor,(null===(_t=t.heuristicDetection)||void 0===_t?void 0:_t.config)||{})):((0,N.debugLog)("[TrackingPixelSDK] Initializing with legacy DOM tracking"),this.domTrackingManager=new M.DomTrackingManager((t=>this.track(t)))),null===(Pt=null===(At=t.sessionTracking)||void 0===At?void 0:At.enabled)||void 0===Pt||Pt){(0,N.debugLog)("[TrackingPixelSDK] ðŸ“Š Initializing advanced session tracking with Intercom-like features");const e=(null===(Ot=t.sessionTracking)||void 0===Ot?void 0:Ot.config)||{},n=(null===(Dt=t.sessionTracking)||void 0===Dt?void 0:Dt.activityDetection)||{},i=(null===(jt=t.sessionTracking)||void 0===jt||jt.multiTabSupport,Object.assign(Object.assign({},e),{maxInactivityTime:null!==(Ut=n.inactivityThreshold)&&void 0!==Ut?Ut:6e4,heartbeatInterval:null!==(Rt=e.heartbeatInterval)&&void 0!==Rt?Rt:1e4}));this.sessionTrackingManager=new _.SessionTrackingManager((t=>{setTimeout((()=>{this.track(t),"user_resume"!==t.event&&"session_reactivate"!==t.event||this.wsService.isConnected()&&this.wsService.emitUserActivity(!0)}),500)}),i),this.sessionInjectionStage.setSessionManager(this.sessionTrackingManager),(0,N.debugLog)("[TrackingPixelSDK] Session tracking configured with enhanced features:",{heartbeatInterval:i.heartbeatInterval,inactivityThreshold:i.maxInactivityTime})}const Kt=this.consentManager.getState();"pending"===Kt.status?((0,N.debugLog)("[TrackingPixelSDK] ðŸ” Estado inicial: pending - SDK pausado"),(0,N.debugLog)("[TrackingPixelSDK] â¸ï¸ SDK pausado hasta que se otorgue consentimiento")):"granted"===Kt.status?((0,N.debugLog)("[TrackingPixelSDK] ðŸ” Estado inicial: granted - Inicializando SDK"),this.init().catch((t=>{}))):(0,N.debugLog)("[TrackingPixelSDK] ðŸ” Estado inicial: denied - SDK no se inicializarÃ¡")}init(){return i(this,void 0,void 0,(function*(){const t=this.consentManager.getState();if("granted"!==t.status)return void(0,N.debugLog)("[TrackingPixelSDK] ðŸ”’ init() bloqueado: consentimiento no otorgado (status: "+t.status+")");(0,N.debugLog)("[TrackingPixelSDK] ðŸš€ Inicializando SDK con consentimiento otorgado..."),(0,N.debugLog)("[TrackingPixelSDK] ðŸ” Consentimiento verificado - guardando configuraciÃ³n en localStorage"),localStorage.setItem("pixelEndpoint",this.endpoint),localStorage.setItem("guidersApiKey",this.apiKey);const e=new a.ClientJS;if(this.fingerprint=localStorage.getItem("fingerprint")||e.getFingerprint().toString(),localStorage.setItem("fingerprint",this.fingerprint),"jwt"===this.authMode&&r.TokenManager.loadTokensFromStorage(),this.trackingV2Enabled&&this.trackingV2Service)try{yield this.trackingV2Service.initialize(this.apiKey),(0,N.debugLog)("[TrackingPixelSDK] âœ… TrackingV2Service inicializado")}catch(t){}w.ChatV2Service.getInstance(),(0,N.debugLog)("[TrackingPixelSDK] âœ… ChatV2Service inicializado (session keepalive activo)"),(0,N.debugLog)("âœ… SDK inicializado sin servicios de WebSocket."),this.autoFlush&&this.startAutoFlush(),(0,N.debugLog)("SDK listo para tracking..."),this.setupTabOpenListener(),this.chatUI=new y.ChatUI({widget:!0,chatConsentMessage:this.chatConsentMessageConfig,position:this.chatPositionConfig,mobileDetection:this.mobileDetectionConfig,quickActions:this.quickActionsConfig,ai:this.aiConfig}),this.setupQuickActionsCallbacks();const n=this.chatUI;this.chatInputUI=new I.ChatInputUI(n);const s=this.chatInputUI;this.chatToggleButton=new x.ChatToggleButtonUI(n);const o=this.chatToggleButton,c=()=>{var t,e;if((0,N.debugLog)("Inicializando componentes del chat rÃ¡pidamente..."),this.activeHoursValidator&&!this.activeHoursValidator.isChatActive()){(0,N.debugLog)("ðŸ• Chat no estÃ¡ disponible segÃºn horarios configurados"),n.init(),n.hide(),s.init(),o.init(),o.hide();const t=this.activeHoursValidator.getFallbackMessage(),e=this.activeHoursValidator.getNextAvailableTime();let i=t;e&&(i+=` PrÃ³ximo horario disponible: ${e}`),(0,N.debugLog)("ðŸ• "+i),n&&n.addSystemMessage(i);const a=setInterval((()=>{this.activeHoursValidator&&this.activeHoursValidator.isChatActive()&&((0,N.debugLog)("ðŸ• âœ… Chat ahora estÃ¡ disponible segÃºn horarios"),o.show(),clearInterval(a))}),3e5);return}n.init(),n.hide(),s.init(),o.init();const a=n.getMessagesContainer();if(a&&(this.chatMessagesUI=new C.ChatMessagesUI(a)),document.querySelectorAll(".chat-widget, .chat-widget-fixed").forEach((t=>{t.addEventListener("system-message",(t=>{const e=t;n.addSystemMessage(e.detail.message)}))})),(0,N.debugLog)("Componentes del chat inicializados. Chat oculto por defecto."),this.initializeCommercialAvailability(n,o),null===(t=this.commercialAvailabilityConfig)||void 0===t?void 0:t.enabled)(0,N.debugLog)("ðŸ”˜ BotÃ³n de chat oculto inicialmente (esperando verificaciÃ³n de disponibilidad)");else{const t=this.consentManager.getState();"granted"===t.status&&(null===(e=t.preferences)||void 0===e?void 0:e.functional)?(o.show(),(0,N.debugLog)("ðŸ”˜ BotÃ³n de chat mostrado (consentimiento otorgado)")):(0,N.debugLog)("ðŸ”’ Chat oculto: consentimiento no otorgado o funcional deshabilitado")}this.setupParticipantEventsListener(n,o),n.onOpen((()=>i(this,void 0,void 0,(function*(){this.captureEvent("visitor:open-chat",{timestamp:(new Date).getTime(),chatId:n.getChatId()});const t=n.getChatId();if(t)try{yield w.ChatV2Service.getInstance().openChat(t),(0,N.debugLog)("ðŸ”“ [TrackingPixelSDK] Chat abierto en backend:",t)}catch(t){}o.updateState(!0),o.notifyChatOpenState(!0),(0,N.debugLog)("ðŸ’¬ [TrackingPixelSDK] Notificado: chat abierto - badge pausado"),this.initializeWebSocketConnection(n),this.loadChatMessagesOnOpen(n),this.chatToggleButton&&setTimeout((()=>i(this,void 0,void 0,(function*(){yield this.chatToggleButton.markAllMessagesAsRead(),(0,N.debugLog)("ðŸ“¬ [TrackingPixelSDK] Mensajes marcados como leÃ­dos al abrir chat")}))),500)})))),n.onClose((()=>i(this,void 0,void 0,(function*(){this.captureEvent("visitor:close-chat",{timestamp:(new Date).getTime(),chatId:n.getChatId()});const t=n.getChatId();if(t)try{yield w.ChatV2Service.getInstance().closeChat(t),(0,N.debugLog)("ðŸ”’ [TrackingPixelSDK] Chat cerrado en backend:",t)}catch(t){}o.updateState(!1),o.notifyChatOpenState(!1),(0,N.debugLog)("ðŸ’¬ [TrackingPixelSDK] Notificado: chat cerrado - badge reactivado");const e=n.getChatId();e&&(o.setActiveChatForUnread(e),(0,N.debugLog)("ðŸ“¬ [TrackingPixelSDK] Refrescando mensajes no leÃ­dos al cerrar chat"))})))),n.onActiveInterval((()=>{(0,N.debugLog)("Intervalo activo"),this.captureEvent("visitor:chat-active",{timestamp:(new Date).getTime(),chatId:n.getChatId()})}),1e4),o.onToggle((t=>{(0,N.debugLog)("Toggle event: chat debe estar "+(t?"visible":"oculto")),t?n.show():n.hide()})),s.onSubmit((t=>i(this,void 0,void 0,(function*(){if(!t)return;(0,N.debugLog)("ðŸ’¬ [TrackingPixelSDK] ðŸ“ Mensaje enviado desde UI:",t),this.captureEvent("visitor:send-message",{id:(0,E.v4)(),message:t,timestamp:(new Date).getTime(),chatId:n.getChatId()}),this.flush();const e=this.getVisitorId(),i=this.isVisitorIdentified();if((0,N.debugLog)("ðŸ’¬ [TrackingPixelSDK] ðŸ” Estado del visitante:",{visitorId:e,isIdentified:i,identityState:this.identitySignal.getState()}),!e)try{yield this.executeIdentify();const t=this.getVisitorId();if(!t)return;(0,N.debugLog)("ðŸ’¬ [TrackingPixelSDK] âœ… Visitante identificado:",t)}catch(t){return}try{const e=this.getVisitorId(),i=n.getChatId();let s;if((0,N.debugLog)("ðŸ’¬ [TrackingPixelSDK] ðŸ“¤ Enviando mensaje para visitante:",e),(0,N.debugLog)("ðŸ’¬ [TrackingPixelSDK] ðŸ” Chat ID actual:",i),i)(0,N.debugLog)("ðŸ’¬ [TrackingPixelSDK] ðŸ“‹ Enviando mensaje a chat existente (WebSocket):",i),this.wsService.isConnected()||this.initializeWebSocketConnection(n),this.realtimeMessageManager.getCurrentChatId()!==i&&this.realtimeMessageManager.setCurrentChat(i),yield this.realtimeMessageManager.sendMessage(t,"text"),s={chat:{id:i},message:{id:"pending"},isNewChat:!1};else if(n.isCreatingChat()){(0,N.debugLog)("ðŸ’¬ [TrackingPixelSDK] â³ Ya se estÃ¡ creando un chat, esperando..."),yield n.waitForChatCreation();const e=n.getChatId();if(!e)throw new Error("No se pudo obtener el chatId despuÃ©s de la creaciÃ³n");(0,N.debugLog)("ðŸ’¬ [TrackingPixelSDK] ðŸ“‹ Enviando mensaje a chat reciÃ©n creado:",e),s={chat:{id:e},message:yield w.ChatV2Service.getInstance().sendMessage(e,t,"text"),isNewChat:!1}}else{n.setCreatingChat(!0),(0,N.debugLog)("ðŸ’¬ [TrackingPixelSDK] ðŸ†• Creando nuevo chat con mensaje");try{const e=yield w.ChatV2Service.getInstance().createChatWithMessage({},{content:t,type:"text"}),i=e.chatId;i&&(n.setChatId(i),(0,N.debugLog)("ðŸ’¬ [TrackingPixelSDK] ðŸ†• Chat ID asignado:",i),this.initializeWebSocketConnection(n),this.realtimeMessageManager.setCurrentChat(i)),s={chat:{id:i},message:{id:e.messageId},isNewChat:!0}}finally{n.setCreatingChat(!1)}}if(s&&((0,N.debugLog)("ðŸ’¬ [TrackingPixelSDK] âœ… Mensaje enviado exitosamente:",{chatId:s.chat.id,isNewChat:s.isNewChat}),"undefined"!=typeof window)){const e=new CustomEvent("guidersMessageSent",{detail:{message:t,chatId:s.chat.id,isNewChat:s.isNewChat}});window.dispatchEvent(e)}}catch(t){n.setCreatingChat(!1)}})))),this.on("receive-message",(t=>{(0,N.debugLog)("Mensaje recibido via WebSocket:",t),t.data.senderId,n.renderChatMessage({text:t.data.message,sender:"other",senderId:t.data.senderId,timestamp:t.data.timestamp})}))};"loading"===document.readyState?((0,N.debugLog)("El DOM aÃºn no estÃ¡ completamente cargado. Esperando..."),document.addEventListener("DOMContentLoaded",c),(0,N.debugLog)("Esperando a que el DOM estÃ© completamente cargado...")):((0,N.debugLog)("El DOM ya estÃ¡ completamente cargado."),c()),this.sessionTrackingManager&&(0,N.debugLog)("ðŸŽ¯ Starting session tracking..."),this.enableAutomaticTracking(),this.setupPageUnloadHandlers()}))}setupQuickActionsCallbacks(){this.chatUI&&(this.chatUI.onQuickActionSendMessage=(t,e)=>i(this,void 0,void 0,(function*(){(0,N.debugLog)("[TrackingPixelSDK] Quick Action: enviando mensaje",t),yield this.realtimeMessageManager.sendMessage(t,"text")})),this.chatUI.onQuickActionRequestAgent=()=>i(this,void 0,void 0,(function*(){(0,N.debugLog)("[TrackingPixelSDK] Quick Action: solicitando agente humano"),yield this.handleRequestAgent()})),this.chatUI.onTrackQuickAction=t=>{(0,N.debugLog)("[TrackingPixelSDK] Quick Action tracked:",t),this.captureEvent(t.eventType||"quick_action_clicked",{buttonId:t.buttonId,actionType:t.actionType,timestamp:t.timestamp})},(0,N.debugLog)("[TrackingPixelSDK] Quick Actions callbacks configurados"))}handleRequestAgent(){return i(this,void 0,void 0,(function*(){(0,N.debugLog)("[TrackingPixelSDK] Procesando solicitud de agente humano");try{this.captureEvent("agent_requested",{source:"quick_action",timestamp:Date.now()});const t="Me gustarÃ­a hablar con una persona real";yield this.realtimeMessageManager.sendMessage(t,"text"),yield this.notifyAgentRequest()}catch(t){(0,N.debugLog)("[TrackingPixelSDK] Error en solicitud de agente:",t)}}))}notifyAgentRequest(){return i(this,void 0,void 0,(function*(){var t,e;const n=this.getVisitorId(),i=null===(e=null===(t=this.chatUI)||void 0===t?void 0:t.getChatId)||void 0===e?void 0:e.call(t);if(!n)return void(0,N.debugLog)("[TrackingPixelSDK] No hay visitorId para notificar request-agent");if(!i)return void(0,N.debugLog)("[TrackingPixelSDK] No hay chatId para notificar request-agent");const s=`${z.getInstance().getEndpoint()}/chats/${i}/request-agent`;try{const t=yield fetch(s,{method:"POST",headers:{"Content-Type":"application/json","X-Guiders-SID":n},credentials:"include",body:JSON.stringify({visitorId:n,timestamp:(new Date).toISOString(),source:"quick_action"})});t.ok?(0,N.debugLog)("[TrackingPixelSDK] NotificaciÃ³n request-agent enviada correctamente"):(0,N.debugLog)("[TrackingPixelSDK] Error en request-agent:",t.status)}catch(t){(0,N.debugLog)("[TrackingPixelSDK] Error en notifyAgentRequest:",t)}}))}setupTabOpenListener(){if("undefined"!=typeof window)if((0,N.debugLog)("[TrackingPixelSDK] ðŸ” Configurando listener para apertura de pestaÃ±a (una sola vez)"),"visible"===document.visibilityState)(0,N.debugLog)("[TrackingPixelSDK] ðŸš€ PestaÃ±a cargada - ejecutando identify una sola vez"),this.executeIdentify();else{(0,N.debugLog)("[TrackingPixelSDK] â³ PestaÃ±a en segundo plano - esperando visibilidad");const t=()=>{"visible"!==document.visibilityState||this.identifyExecuted||((0,N.debugLog)("[TrackingPixelSDK] ðŸš€ PestaÃ±a ahora visible - ejecutando identify"),this.executeIdentify(),document.removeEventListener("visibilitychange",t))};document.addEventListener("visibilitychange",t),window.addEventListener("beforeunload",(()=>{document.removeEventListener("visibilitychange",t)}),{once:!0})}}executeIdentify(){return i(this,void 0,void 0,(function*(){var t,e,n;if((0,N.debugLog)("[TrackingPixelSDK] ðŸ” executeIdentify() LLAMADO"),this.identifyExecuted)(0,N.debugLog)("[TrackingPixelSDK] âš ï¸ identify() ya ejecutado - ignorando llamada duplicada");else{this.identifyExecuted=!0;try{(0,N.debugLog)("[TrackingPixelSDK] ðŸ” Ejecutando identify...");const i=this.consentManager.getState().version,s=yield this.identitySignal.identify(this.fingerprint,this.apiKey,i);if(null===(t=null==s?void 0:s.identity)||void 0===t?void 0:t.visitorId){(0,N.debugLog)("[TrackingPixelSDK] âœ… Visitante identificado con identitySignal:",s.identity.visitorId);const t=sessionStorage.getItem("guiders_backend_session_id");if(t&&(this.consentBackendService.setSessionId(t),(0,N.debugLog)("[TrackingPixelSDK] ðŸ” SessionId configurado en ConsentBackendService")),this.chatToggleButton&&this.chatUI&&(this.chatUI.setVisitorId(s.identity.visitorId),(0,N.debugLog)("ðŸ“¬ [TrackingPixelSDK] VisitorId establecido en ChatUI:",s.identity.visitorId),this.chatToggleButton.connectUnreadService(s.identity.visitorId,(t=>{(0,N.debugLog)("ðŸ“¬ [TrackingPixelSDK] ðŸ”“ Auto-abriendo chat por mensaje recibido con chatId:",t),this.chatUI.getChatId()&&this.chatUI.getChatId()===t||((0,N.debugLog)("ðŸ“¬ [TrackingPixelSDK] ðŸ†• Actualizando chatId en ChatUI:",t),this.chatUI.setChatId(t)),this.chatUI.show(),(0,N.debugLog)("ðŸ“¬ [TrackingPixelSDK] ðŸ”„ Obteniendo detalles del chat desde lista del visitante"),this.chatUI.refreshChatDetailsFromVisitorList(s.identity.visitorId).catch((t=>{(0,N.debugLog)("ðŸ“¬ [TrackingPixelSDK] ðŸ”„ Fallback: intentando mÃ©todo tradicional"),this.chatUI.refreshChatDetailsForced().catch((t=>{}))}))}),this.autoOpenChatOnMessage),(0,N.debugLog)("ðŸ“¬ [TrackingPixelSDK] âœ… Servicio de mensajes no leÃ­dos conectado tempranamente")),this.setupPresenceService(),(0,N.debugLog)("ðŸŸ¢ [TrackingPixelSDK] âœ… Servicio de presencia configurado"),(0,N.debugLog)("[TrackingPixelSDK] âœ… Consentimientos registrados automÃ¡ticamente por el backend en identify()"),this.consentManager.isGranted())try{const t=this.consentManager.getState(),e=Date.now()-t.timestamp;if(e>5e3){(0,N.debugLog)("[TrackingPixelSDK] ðŸ”„ Sincronizando con backend (visitante recurrente, consentimiento antiguo)...");const e=yield this.consentBackendService.syncWithBackend(s.identity.visitorId);(0,N.debugLog)("[TrackingPixelSDK] ðŸ”„ Estado de consentimiento sincronizado con backend:",e),t.preferences&&(t.preferences.analytics!==e.analytics||t.preferences.functional!==e.functional||t.preferences.personalization!==e.personalization)&&((0,N.debugLog)("[TrackingPixelSDK] ðŸ”„ Actualizando preferencias locales con estado del backend"),this.consentManager.grantConsentWithPreferences(e))}else(0,N.debugLog)("[TrackingPixelSDK] â­ï¸ Saltando sincronizaciÃ³n: consentimiento reciÃ©n otorgado (edad: "+Math.round(e/1e3)+"s)"),(0,N.debugLog)("[TrackingPixelSDK] ðŸ“ El backend ya tiene los consentimientos del identify() actual")}catch(t){}const i=(null===(e=s.chats)||void 0===e?void 0:e.chats)&&s.chats.chats.length>0;i&&s.chats?(localStorage.setItem("guiders_recent_chats",JSON.stringify(s.chats.chats)),A.ChatMemoryStore.getInstance().setChatId(s.chats.chats[0].id),(0,N.debugLog)("[TrackingPixelSDK] â™»ï¸ Chat reutilizable (mÃ¡s reciente) guardado en memoria:",s.chats.chats[0].id),this.chatToggleButton&&s.chats.chats[0].id&&(this.chatToggleButton.setActiveChatForUnread(s.chats.chats[0].id),(0,N.debugLog)("ðŸ“¬ [TrackingPixelSDK] Cargando mensajes no leÃ­dos al inicializar con chat existente"))):((0,N.debugLog)("[TrackingPixelSDK] ðŸ’¬ No hay chats previos, mostrando mensaje de bienvenida automÃ¡ticamente"),this.chatUI&&this.chatUI.checkAndAddInitialMessages&&setTimeout((()=>{this.chatUI&&this.chatUI.checkAndAddInitialMessages&&(this.chatUI.checkAndAddInitialMessages(),(0,N.debugLog)("[TrackingPixelSDK] âœ… Mensaje de bienvenida mostrado automÃ¡ticamente"))}),500)),(0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] ðŸ” DEBUG: Verificando condiciones WebSocket:",{hasChatUI:!!this.chatUI,isConnected:this.wsService.isConnected(),visitorId:(null===(n=this.getVisitorId())||void 0===n?void 0:n.substring(0,8))+"..."}),this.chatUI&&!this.wsService.isConnected()&&((0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] ðŸš€ Inicializando WebSocket para notificaciones en tiempo real"),this.initializeWebSocketConnection(this.chatUI),i&&s.chats&&s.chats.chats[0].id?(this.realtimeMessageManager.setCurrentChat(s.chats.chats[0].id),(0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] âœ… WebSocket configurado para chat existente:",s.chats.chats[0].id)):(0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] âœ… WebSocket configurado para recibir notificaciones de chats nuevos"))}}catch(t){(t instanceof Error?t.message:String(t)).includes("Operation was superseded")?(0,N.debugLog)("[TrackingPixelSDK] â„¹ï¸ identify cancelado por operaciÃ³n mÃ¡s reciente"):this.identifyExecuted=!1}}}))}setupPageUnloadHandlers(){if("undefined"==typeof window)return;let t=!1,e=!1;try{const t=performance.getEntriesByType("navigation");t.length>0&&(e="reload"===t[0].type)}catch(t){}const n=sessionStorage.getItem("guiders_last_unload_time");if(n){const t=Date.now()-parseInt(n,10);t<3e3||e?((0,N.debugLog)(`[TrackingPixelSDK] ðŸ”„ Refresh rÃ¡pido detectado (${t}ms, isReload=${e}) - reanudando sesiÃ³n`),sessionStorage.setItem("guiders_is_refresh","true")):sessionStorage.removeItem("guiders_is_refresh"),sessionStorage.removeItem("guiders_last_unload_time")}else e&&((0,N.debugLog)("[TrackingPixelSDK] ðŸ”„ PÃ¡gina cargada como refresh - configurando flag"),sessionStorage.setItem("guiders_is_refresh","true"));const i=e=>{if(!t){t=!0;try{if(sessionStorage.setItem("guiders_last_unload_time",Date.now().toString()),(0,N.debugLog)(`[TrackingPixelSDK] ðŸšª Finalizando sesiÃ³n por: ${e}`),this.eventQueue.length>0){const t=[...this.eventQueue];if(this.eventQueue=[],"undefined"!=typeof navigator&&"sendBeacon"in navigator)try{const e=z.getInstance().getEndpoint(),n=`${e.endsWith("/api")?e:`${e}/api`}/tracking/events/batch`,i=new Blob([JSON.stringify(t)],{type:"application/json"});navigator.sendBeacon(n,i),(0,N.debugLog)(`[TrackingPixelSDK] ðŸ“¤ ${t.length} eventos enviados via beacon`)}catch(t){}}S.VisitorsV2Service.getInstance().endSession({useBeacon:!0})}catch(t){}}};(0,N.debugLog)("[TrackingPixelSDK] ðŸšª Configurando listeners simplificados para cierre de ventana"),window.addEventListener("beforeunload",(()=>{if((0,N.debugLog)("[TrackingPixelSDK] ðŸšª beforeunload detectado"),this.trackingV2Enabled&&this.eventQueueManager&&this.trackingV2Service){this.eventQueueManager.saveToStorage(),(0,N.debugLog)("[TrackingPixelSDK] ðŸ’¾ Cola de eventos guardada en localStorage");const t=this.eventQueueManager.getBatch(500);t.length>0&&this.trackingV2Service.sendBatchWithBeacon(t)&&(0,N.debugLog)(`[TrackingPixelSDK] ðŸ“¤ ${t.length} eventos enviados con sendBeacon`)}i("window_close")})),window.addEventListener("pagehide",(()=>{(0,N.debugLog)("[TrackingPixelSDK] ðŸšª pagehide detectado"),this.trackingV2Enabled&&this.eventQueueManager&&this.eventQueueManager.saveToStorage(),i("window_close")}))}configureTypingIndicators(t){(0,N.debugLog)("ðŸ’¬ Indicadores de escritura desactivados (sin WebSocket)")}on(t,e){var n;this.listeners.has(t)||this.listeners.set(t,new Set),null===(n=this.listeners.get(t))||void 0===n||n.add(e)}off(t,e){var n;null===(n=this.listeners.get(t))||void 0===n||n.delete(e)}once(t,e){const n=i=>{e(i),this.off(t,n)};this.on(t,n)}addPipelineStage(t){this.eventPipeline=this.pipelineBuilder.addStage(t).build()}enableDOMTracking(){this.domTrackingManager instanceof L.EnhancedDomTrackingManager?((0,N.debugLog)("[TrackingPixelSDK] ðŸŽ¯ Enabling automatic heuristic tracking"),this.domTrackingManager.enableAutomaticTracking()):((0,N.debugLog)("[TrackingPixelSDK] Enabling legacy DOM tracking"),this.domTrackingManager.enableDOMTracking())}enableAutomaticTracking(){this.domTrackingManager instanceof L.EnhancedDomTrackingManager?this.domTrackingManager.enableAutomaticTracking():this.domTrackingManager.enableDOMTracking()}getHeuristicConfig(){return this.domTrackingManager instanceof L.EnhancedDomTrackingManager?this.domTrackingManager.getHeuristicConfig():null}updateHeuristicConfig(t){this.domTrackingManager instanceof L.EnhancedDomTrackingManager&&this.domTrackingManager.updateHeuristicConfig(t)}setHeuristicEnabled(t){this.domTrackingManager instanceof L.EnhancedDomTrackingManager&&this.domTrackingManager.setHeuristicEnabled(t)}updateActiveHoursConfig(t){var e;try{this.activeHoursValidator=new O.ActiveHoursValidator(t),(0,N.debugLog)("[TrackingPixelSDK] ðŸ• ConfiguraciÃ³n de horarios activos actualizada:",{enabled:t.enabled,timezone:t.timezone,ranges:(null===(e=t.ranges)||void 0===e?void 0:e.length)||0,fallbackMessage:t.fallbackMessage?"Configurado":"No configurado"}),!this.activeHoursValidator.isChatActive()&&t.fallbackMessage&&(0,N.debugLog)("[TrackingPixelSDK] ðŸ• Chat fuera de horario activo, aplicando mensaje de fallback")}catch(t){}}getActiveHoursConfig(){var t;return(null===(t=this.activeHoursValidator)||void 0===t?void 0:t.getConfig())||null}enableSessionTracking(){this.sessionTrackingManager&&(0,N.debugLog)("[TrackingPixelSDK] ðŸŽ¯ Session tracking already enabled and initialized")}setMetadata(t,e){const n=this.eventQueue.findIndex((e=>e.type===t));-1!==n&&(this.eventQueue[n].metadata=e)}flush(){return i(this,void 0,void 0,(function*(){if(this.trackingV2Enabled&&this.eventQueueManager&&this.trackingV2Service){if(this.eventAggregator&&this.eventAggregator.isEnabled()){const t=this.eventAggregator.flush();t.forEach((t=>{this.eventQueueManager.enqueue(t)})),t.length>0&&(0,N.debugLog)(`[TrackingPixelSDK] ðŸ”— ${t.length} eventos agregados aÃ±adidos a la cola`)}if(this.eventQueueManager.isEmpty())return void(0,N.debugLog)("[TrackingPixelSDK] ðŸ“­ No hay eventos para enviar (V2)");const t=this.eventQueueManager.getBatch(500);if(0===t.length)return;(0,N.debugLog)(`[TrackingPixelSDK] ðŸ“¤ Enviando batch de ${t.length} eventos (V2)...`);try{const e=yield this.trackingV2Service.sendBatch(t);e&&e.success&&(this.eventQueueManager.dequeue(t.length),(0,N.debugLog)(`[TrackingPixelSDK] âœ… ${e.processed} eventos procesados, ${e.discarded} descartados`))}catch(t){}}else{if(0===this.eventQueue.length)return;const t=[...this.eventQueue];this.eventQueue=[],yield Promise.all(t.map((t=>this.trySendEventWithRetry(t,this.maxRetries))))}}))}stopAutoFlush(){this.flushTimer&&(clearInterval(this.flushTimer),this.flushTimer=null)}track(t){return i(this,void 0,void 0,(function*(){return new Promise(((e,n)=>{if(!this.consentManager.isTrackingAllowed())return(0,N.debugLog)("[TrackingPixelSDK] ðŸ” Tracking bloqueado - sin consentimiento"),void e();const{event:i}=t,a=s(t,["event"]);if("string"==typeof i)try{this.captureEvent("tracking:tracking-event",{trackingEventId:(0,E.v4)(),metadata:Object.assign({},a),eventType:i}),e()}catch(t){n(t)}else n(new Error("El evento debe tener un tipo."))}))}))}trackEvent(t,e){return i(this,void 0,void 0,(function*(){return this.track(Object.assign({event:t},e))}))}captureEvent(t,e){if(!this.bypassConsentForTracking){if(!this.consentManager.isTrackingAllowed())return void(0,N.debugLog)("[TrackingPixelSDK] ðŸ” Evento bloqueado - sin consentimiento:",t);if(!this.consentManager.isCategoryAllowed("analytics"))return void(0,N.debugLog)("[TrackingPixelSDK] ðŸ” Evento bloqueado - analytics no permitido:",t)}const n={type:t,data:e,timestamp:Date.now()},i=this.eventPipeline.process(n);if(this.trackingV2Enabled&&this.eventQueueManager){const t=i.data;if(this.eventThrottler&&!this.eventThrottler.shouldAllow(t.eventType))return;this.eventAggregator&&this.eventAggregator.isEnabled()?this.eventAggregator.add(t):this.eventQueueManager.enqueue(t)}else this.eventQueue.push(i)}trySendEventWithRetry(t,e){return i(this,void 0,void 0,(function*(){try{(0,N.debugLog)("ðŸ“¡ Enviando evento via HTTP (sin WebSocket):",t.type)}catch(n){e>0&&setTimeout((()=>{this.trySendEventWithRetry(t,e-1)}),1e3)}}))}startAutoFlush(){this.flushTimer&&clearInterval(this.flushTimer),this.flushTimer=setInterval((()=>{this.flush()}),this.flushInterval)}dispatchMessage(t){const e=this.listeners.get(t.type);if("receive-message"===t.type&&((0,N.debugLog)("ðŸ’¬ Mensaje recibido (sin servicio de mensajes no leÃ­dos)"),"undefined"!=typeof window&&"Notification"in window)){const e=t.data&&"string"==typeof t.data.message&&t.data.message?t.data.message:"Tienes un nuevo mensaje en el chat";"granted"===Notification.permission?new Notification("Nuevo mensaje",{body:e,icon:"/favicon.ico"}):"denied"!==Notification.permission&&Notification.requestPermission().then((t=>{"granted"===t&&new Notification("Nuevo mensaje",{body:e,icon:"/favicon.ico"})}))}e&&0!==e.size&&e.forEach((e=>{try{e(t)}catch(t){}}))}cleanup(){S.VisitorsV2Service.getInstance().endSession().catch((()=>{})),this.stopAutoFlush(),this.eventQueue=[],this.listeners.clear(),this.commercialAvailabilityService&&(this.commercialAvailabilityService.cleanup(),this.commercialAvailabilityService=null,(0,N.debugLog)("[TrackingPixelSDK] ðŸ“¡ CommercialAvailabilityService limpiado")),this.presenceService&&(this.presenceService.cleanup(),this.presenceService=null,(0,N.debugLog)("[TrackingPixelSDK] ðŸ’“ PresenceService limpiado (heartbeat detenido)")),(0,N.debugLog)("[TrackingPixelSDK] Cleanup completed")}setupParticipantEventsListener(t,e){(0,N.debugLog)("ðŸ’¬ Eventos de participantes desactivados (sin WebSocket)")}checkAndUpdateChatVisibility(t,e,n){return i(this,void 0,void 0,(function*(){try{(0,N.debugLog)(`ðŸ” checkAndUpdateChatVisibility - Verificando chat ${t}`);const e=yield this.fetchChatDetail(t);(0,N.debugLog)("ðŸ“‹ Detalles del chat obtenidos:",{totalParticipants:e.participants.length,participants:e.participants.map((t=>({name:t.name,isCommercial:t.isCommercial,isOnline:t.isOnline,id:t.id})))});const i=e.participants.filter((t=>t.isCommercial));(0,N.debugLog)(`ðŸª Comerciales encontrados: ${i.length}`,i.map((t=>({name:t.name,isOnline:t.isOnline,id:t.id}))));const s=i.some((t=>t.isOnline)),a=i.filter((t=>t.isOnline));(0,N.debugLog)("ðŸ“Š Resumen de comerciales:"),(0,N.debugLog)(`  - Total comerciales: ${i.length}`),(0,N.debugLog)(`  - Comerciales online: ${a.length}`),(0,N.debugLog)(`  - Â¿Hay al menos un comercial online? ${s}`),(0,N.debugLog)(`  - Estado actual del botÃ³n: ${n.isButtonVisible()}`),n.show()}catch(t){Error}}))}initializeCommercialAvailability(t,e){var n;if(!(null===(n=this.commercialAvailabilityConfig)||void 0===n?void 0:n.enabled))return;const i=window.location.hostname;this.commercialAvailabilityService=new V.CommercialAvailabilityService({domain:i,apiKey:this.apiKey,apiBaseUrl:this.endpoint,pollingInterval:this.commercialAvailabilityConfig.pollingInterval||30,debug:this.commercialAvailabilityConfig.debug||!1}),this.commercialAvailabilityService.onAvailabilityChanged(((n,i)=>{var s;(0,N.debugLog)(`ðŸ“¡ [CommercialAvailability] Estado cambiÃ³: ${n} (${i} online)`),n?(e.show(),(null===(s=this.commercialAvailabilityConfig)||void 0===s?void 0:s.showBadge)&&i>0?e.updateUnreadCount(i):e.hideUnreadBadge()):((0,N.debugLog)("ðŸ“¡ [CommercialAvailability] No hay comerciales disponibles - ocultando chat"),t.isVisible()&&t.hide(),e.hide())})),this.commercialAvailabilityService.startPolling(),(0,N.debugLog)("ðŸ“¡ [CommercialAvailability] Polling iniciado")}checkCommercialAvailability(t,e){return i(this,void 0,void 0,(function*(){try{let n=t.getChatId(),i=0;const s=10;for(;!n&&i<s;)yield new Promise((t=>setTimeout(t,500))),n=t.getChatId(),i++,(0,N.debugLog)(`Esperando chat ID... intento ${i}/${s}`);if(!n)return(0,N.debugLog)("ðŸ”˜ Mostrando botÃ³n de chat sin verificaciÃ³n de comerciales"),void e.show();(0,N.debugLog)(`Verificando disponibilidad de comerciales para el chat ${n}...`);const a=yield this.fetchChatDetail(n),o=a.participants.filter((t=>t.isCommercial)),r=o.some((t=>t.isOnline));(0,N.debugLog)("Participantes del chat:",a.participants),(0,N.debugLog)("Comerciales en el chat:",o.length),(0,N.debugLog)("Comerciales online:",o.filter((t=>t.isOnline)).length),(0,N.debugLog)("Â¿Hay comerciales online?",r),e.show()}catch(t){(0,N.debugLog)("ðŸ”˜ Mostrando botÃ³n de chat a pesar del error en verificaciÃ³n"),e.show()}}))}fetchChatDetail(t){return i(this,void 0,void 0,(function*(){if(!t)throw new Error("chatId requerido");(0,N.debugLog)(`ðŸŒ fetchChatDetail - Obteniendo detalles para chat ${t} (usando API V2)`);try{const e=yield(0,T.fetchChatDetailV2)(t);(0,N.debugLog)("ðŸŒ fetchChatDetail - Detalles V2 obtenidos:",{id:e.id,status:e.status,visitorId:e.visitorId,assignedCommercialId:e.assignedCommercialId,availableCommercialIds:e.availableCommercialIds,isActive:e.isActive});const n=this.convertV2ToLegacyDetail(e);return(0,N.debugLog)("ðŸŒ fetchChatDetail - Convertido a formato legacy:",{id:n.id,participantsCount:n.participants.length,participants:n.participants.map((t=>({id:t.id,name:t.name,isCommercial:t.isCommercial,isOnline:t.isOnline})))}),n}catch(e){return yield(0,T.fetchChatDetail)(t)}}))}convertV2ToLegacyDetail(t){var e,n,i,s,a;const o=[];if(o.push({id:t.visitorInfo.id,name:t.visitorInfo.name,isCommercial:!1,isVisitor:!0,isOnline:!0,assignedAt:t.createdAt.toISOString(),lastSeenAt:(null===(e=t.lastMessageDate)||void 0===e?void 0:e.toISOString())||null,isViewing:t.isActive,isTyping:!1,isAnonymous:!1}),t.assignedCommercialId){const e=(null===(n=t.assignedCommercial)||void 0===n?void 0:n.name)||`Comercial ${t.assignedCommercialId}`;o.push({id:t.assignedCommercialId,name:e,isCommercial:!0,isVisitor:!1,isOnline:t.isActive,assignedAt:(null===(i=t.assignedAt)||void 0===i?void 0:i.toISOString())||t.createdAt.toISOString(),lastSeenAt:(null===(s=t.lastMessageDate)||void 0===s?void 0:s.toISOString())||null,isViewing:t.isActive,isTyping:!1,isAnonymous:!1})}return t.availableCommercialIds&&t.availableCommercialIds.length>0&&t.availableCommercialIds.forEach((e=>{e!==t.assignedCommercialId&&o.push({id:e,name:`Comercial ${e}`,isCommercial:!0,isVisitor:!1,isOnline:!0,assignedAt:t.createdAt.toISOString(),lastSeenAt:null,isViewing:!1,isTyping:!1,isAnonymous:!1})})),{id:t.id,participants:o,status:t.status,lastMessage:null,lastMessageAt:(null===(a=t.lastMessageDate)||void 0===a?void 0:a.toISOString())||null,createdAt:t.createdAt.toISOString()}}get visitorsService(){return S.VisitorsV2Service.getInstance()}getIdentitySignal(){return this.identitySignal}identifyVisitor(t,e){return i(this,void 0,void 0,(function*(){const n=t||this.fingerprint||this.generateFingerprint(),i=e||this.apiKey;(0,N.debugLog)("[TrackingPixelSDK] ðŸ” Identificando visitante con fingerprint:",n);try{const t=this.consentManager.getState().version,e=yield this.identitySignal.identify(n,i,t);return(0,N.debugLog)("[TrackingPixelSDK] âœ… Visitante identificado exitosamente:",e.identity.visitorId),e}catch(t){throw t}}))}generateFingerprint(){const t=(new a.ClientJS).getFingerprint().toString();return localStorage.setItem("fingerprint",t),this.fingerprint=t,t}reloadVisitorChats(){return i(this,void 0,void 0,(function*(){return(0,N.debugLog)("[TrackingPixelSDK] ðŸ”„ Recargando chats del visitante..."),this.identitySignal.reloadChats()}))}getIdentityState(){return this.identitySignal.getState()}getVisitorId(){return this.identitySignal.getVisitorId()}isVisitorIdentified(){return this.identitySignal.isIdentified()}subscribeToIdentityChanges(t){return this.identitySignal.subscribe(t)}subscribeToChatChanges(t){return this.identitySignal.getChatsSignal().subscribe(t)}showChat(){(0,N.debugLog)("[TrackingPixelSDK] ðŸ’¬ Mostrando chat..."),this.chatUI&&this.chatUI.show()}hideChat(){(0,N.debugLog)("[TrackingPixelSDK] ðŸ’¬ Ocultando chat..."),this.chatUI&&this.chatUI.hide()}isChatVisible(){var t;return(null===(t=this.chatUI)||void 0===t?void 0:t.isVisible())||!1}resetChat(){(0,N.debugLog)("[TrackingPixelSDK] ðŸ”„ Reiniciando chat..."),this.chatUI&&(this.chatUI.hide(),setTimeout((()=>{this.chatUI&&this.chatUI.show()}),500))}loadChatMessagesOnOpen(t){return i(this,void 0,void 0,(function*(){var e;t.setLoadingInitialMessages(!0);try{const n=t.getChatId();if(!n)return(0,N.debugLog)("[TrackingPixelSDK] ðŸ’¬ No hay chatId, omitiendo carga de mensajes"),void(null===(e=t.checkAndAddInitialMessages)||void 0===e||e.call(t));if((0,N.debugLog)("[TrackingPixelSDK] ðŸ’¬ ðŸ”’ Iniciando carga de mensajes con protecciÃ³n de race condition para chat:",n),this.chatMessagesUI)return(0,N.debugLog)("[TrackingPixelSDK] âœ… Usando ChatMessagesUI para carga unificada"),yield this.chatMessagesUI.initializeChat(n),(0,N.debugLog)("[TrackingPixelSDK] ðŸ’¬ Carga completa, verificando necesidad de mensaje de bienvenida"),void(t.checkAndAddInitialMessages&&t.checkAndAddInitialMessages());(0,N.debugLog)("[TrackingPixelSDK] âš ï¸ ChatMessagesUI no disponible, usando sistema legacy"),t.showLoadingMessages();const i=yield w.ChatV2Service.getInstance().getChatMessages(n,50,void 0);if(t.clearMessages(),i.messages&&i.messages.length>0){const e=i.messages.reverse();for(const n of e){let e="";e="string"==typeof n.content?n.content:n.content&&"object"==typeof n.content?n.content.text||n.content.message||n.content.body||JSON.stringify(n.content):String(n.content||""),t.renderChatMessage({text:e,sender:n.senderId===this.getVisitorId()?"user":"other",timestamp:new Date(n.createdAt).getTime(),senderId:n.senderId})}(0,N.debugLog)(`[TrackingPixelSDK] âœ… Cargados ${e.length} mensajes del chat (sistema legacy)`)}else(0,N.debugLog)("[TrackingPixelSDK] ðŸ“­ No hay mensajes en el chat (sistema legacy)");t.hideLoadingMessages(),setTimeout((()=>{t.scrollToBottomV2?t.scrollToBottomV2():t.scrollToBottom(!0)}),100),(0,N.debugLog)("[TrackingPixelSDK] ðŸ’¬ Carga legacy completa, verificando necesidad de mensaje de bienvenida"),t.checkAndAddInitialMessages&&t.checkAndAddInitialMessages()}catch(e){t.hideLoadingMessages(),(0,N.debugLog)("[TrackingPixelSDK] âš ï¸ Error en carga, verificando mensaje de bienvenida como fallback"),t.checkAndAddInitialMessages&&t.checkAndAddInitialMessages()}finally{t.setLoadingInitialMessages(!1),(0,N.debugLog)("[TrackingPixelSDK] ðŸ’¬ ðŸ”’ Bandera de carga limpiada, race condition protection finalizada")}}))}loadInitialMessagesFromFirstChat(t){return i(this,void 0,void 0,(function*(){try{if(!(null==t?void 0:t.id))return void(0,N.debugLog)("[TrackingPixelSDK] ðŸ“­ No hay ID en el primer chat, omitiendo carga inicial");if((0,N.debugLog)("[TrackingPixelSDK] ðŸ”„ Cargando mensajes iniciales del chat:",t.id),this.chatMessagesUI)return this.chatMessagesUI.isChatInitialized(t.id)?void(0,N.debugLog)("[TrackingPixelSDK] âœ… Chat ya inicializado con ChatMessagesUI, omitiendo carga duplicada"):this.chatMessagesUI.isLoadingMessages()?void(0,N.debugLog)("[TrackingPixelSDK] â³ ChatMessagesUI ya estÃ¡ cargando mensajes, omitiendo carga duplicada"):(yield this.chatMessagesUI.initializeChat(t.id),void(0,N.debugLog)("[TrackingPixelSDK] âœ… Mensajes iniciales cargados con ChatMessagesUI"));const e=yield w.ChatV2Service.getInstance().getChatMessages(t.id,50,void 0);if(e.messages&&e.messages.length>0){const n=e.messages.reverse();localStorage.setItem("guiders_initial_messages",JSON.stringify({chatId:t.id,messages:n,loadedAt:Date.now()})),(0,N.debugLog)(`[TrackingPixelSDK] ðŸ’¾ ${n.length} mensajes iniciales almacenados en memoria`)}else(0,N.debugLog)("[TrackingPixelSDK] ðŸ“­ No hay mensajes iniciales para cargar")}catch(t){}}))}isChatActive(){return!this.activeHoursValidator||this.activeHoursValidator.isChatActive()}getChatFallbackMessage(){return this.activeHoursValidator?this.activeHoursValidator.getFallbackMessage():null}getNextAvailableTime(){return this.activeHoursValidator?this.activeHoursValidator.getNextAvailableTime():null}updateActiveHours(t){var e;try{const n={enabled:null===(e=t.enabled)||void 0===e||e,ranges:t.ranges||[],timezone:t.timezone,fallbackMessage:t.fallbackMessage};return!(O.ActiveHoursValidator.validateConfig(n).length>0||(this.activeHoursValidator=new O.ActiveHoursValidator(n),(0,N.debugLog)("[TrackingPixelSDK] ðŸ• âœ… ConfiguraciÃ³n de horarios activos actualizada"),this.checkAndUpdateChatAvailability(),0))}catch(t){return!1}}disableActiveHours(){this.activeHoursValidator=void 0,(0,N.debugLog)("[TrackingPixelSDK] ðŸ• ValidaciÃ³n de horarios activos desactivada"),this.checkAndUpdateChatAvailability()}checkAndUpdateChatAvailability(){if(!this.chatUI)return;const t=this.isChatActive(),e=document.querySelector(".chat-toggle-button");if(t)e&&(e.style.display="block"),(0,N.debugLog)("[TrackingPixelSDK] ðŸ• âœ… Chat ahora disponible segÃºn horarios");else{e&&(e.style.display="none"),this.chatUI.isVisible&&this.chatUI.isVisible()&&this.chatUI.hide();const t=this.getChatFallbackMessage(),n=this.getNextAvailableTime();let i=t||"Chat no disponible en este momento";n&&(i+=` PrÃ³ximo horario: ${n}`),(0,N.debugLog)("[TrackingPixelSDK] ðŸ• "+i)}}initializeWebSocketConnection(t){(0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] ðŸ” DEBUG: initializeWebSocketConnection() LLAMADO");const e=this.getVisitorId();if((0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] ðŸ” DEBUG: visitorId =",(null==e?void 0:e.substring(0,8))+"..."),e){if((0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] ðŸ” DEBUG: Verificando si ya conectado:",this.wsService.isConnected()),this.wsService.isConnected()){(0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] âœ… WebSocket ya conectado (skip init)");const e=t.getChatId();return e&&this.realtimeMessageManager.getCurrentChatId()!==e&&this.realtimeMessageManager.setCurrentChat(e),void(this.chatToggleButton&&e&&(this.chatToggleButton.setActiveChatForUnread(e),(0,N.debugLog)("ðŸ“¬ [TrackingPixelSDK] âœ… UnreadMessagesService actualizado con chat:",e)))}(0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] ðŸš€ Inicializando conexiÃ³n WebSocket...");try{const n=sessionStorage.getItem("guiders_backend_session_id");if((0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] ðŸ” DEBUG: sessionId encontrado:",n?n.substring(0,8)+"...":"NO"),(0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] ðŸ” DEBUG: Llamando wsService.connect()..."),this.wsService.connect({sessionId:n||void 0},{onConnect:()=>{(0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] âœ… WebSocket conectado exitosamente"),e&&(this.wsService.joinVisitorRoom(e),(0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] ðŸš€ Unido a sala de visitante para notificaciones proactivas"));const n=t.getChatId();n&&(this.realtimeMessageManager.setCurrentChat(n),(0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] âœ… Unido a sala de chat:",n))},onDisconnect:t=>{(0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] âš ï¸ WebSocket desconectado:",t)},onError:t=>{},onChatCreated:t=>{(0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] ðŸŽ‰ Chat creado proactivamente por un comercial:",t),this.wsService.joinChatRoom(t.chatId),this.realtimeMessageManager.setCurrentChat(t.chatId),A.ChatMemoryStore.getInstance().setChatId(t.chatId),this.chatToggleButton&&this.chatToggleButton.setActiveChatForUnread(t.chatId),this.showChatCreatedNotification(t),(0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] âœ… Configurado automÃ¡ticamente para el nuevo chat:",t.chatId)}}),this.realtimeMessageManager.initialize({chatUI:t,visitorId:e,enableTypingIndicators:!0,aiConfig:this.aiConfig}),this.chatToggleButton){this.chatToggleButton.connectUnreadService(e,(()=>{(0,N.debugLog)("ðŸ“¬ [TrackingPixelSDK] ðŸ”“ Auto-abriendo chat por mensaje recibido"),this.chatUI.show()}),this.autoOpenChatOnMessage);const n=t.getChatId();n&&this.chatToggleButton.setActiveChatForUnread(n),(0,N.debugLog)("ðŸ“¬ [TrackingPixelSDK] âœ… Servicio de mensajes no leÃ­dos inicializado")}(0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] âœ… Sistema de mensajerÃ­a en tiempo real inicializado")}catch(t){}}}setupPresenceService(){var t,e,n;(0,N.debugLog)("ðŸŸ¢ [TrackingPixelSDK] setupPresenceService() LLAMADO");const i=this.getVisitorId();if(i)if(this.presenceConfig.enabled)if(this.presenceService)(0,N.debugLog)("ðŸŸ¢ [TrackingPixelSDK] âœ… PresenceService ya configurado");else{(0,N.debugLog)("ðŸŸ¢ [TrackingPixelSDK] ðŸš€ Configurando PresenceService...",this.presenceConfig);try{if(this.presenceService=new F.PresenceService(this.wsService,i,{enabled:this.presenceConfig.enabled,pollingInterval:this.presenceConfig.pollingInterval,showTypingIndicator:this.presenceConfig.showTypingIndicator,typingTimeout:this.presenceConfig.typingTimeout,typingDebounce:this.presenceConfig.typingDebounce,heartbeatInterval:this.presenceConfig.heartbeatInterval}),(0,N.debugLog)("ðŸŸ¢ [TrackingPixelSDK] âœ… PresenceService inicializado"),this.chatUI&&(this.chatUI.setPresenceService(this.presenceService),null===(e=(t=this.chatUI).setShowOfflineBanner)||void 0===e||e.call(t,this.presenceConfig.showOfflineBanner),(0,N.debugLog)("ðŸŸ¢ [TrackingPixelSDK] âœ… PresenceService configurado en ChatUI")),this.chatInputUI){const t=null===(n=this.chatUI)||void 0===n?void 0:n.getChatId();t?(this.chatInputUI.setPresenceService(this.presenceService,t),(0,N.debugLog)("ðŸŸ¢ [TrackingPixelSDK] âœ… PresenceService configurado en ChatInputUI")):(0,N.debugLog)("ðŸŸ¢ [TrackingPixelSDK] âš ï¸ No hay chatId disponible aÃºn para ChatInputUI")}if(this.chatMessagesUI&&(0,N.debugLog)("ðŸŸ¢ [TrackingPixelSDK] âœ… ChatMessagesUI usa typing indicators via ChatUI"),!this.wsService.isConnected()){(0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] ðŸš€ Conectando WebSocket automÃ¡ticamente para presencia...");const t=sessionStorage.getItem("guiders_backend_session_id");this.wsService.connect({sessionId:t||void 0},{onConnect:()=>{(0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] âœ… WebSocket conectado automÃ¡ticamente (presencia)"),this.wsService.joinVisitorRoom(i)},onDisconnect:t=>{(0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] âš ï¸ WebSocket desconectado (presencia):",t)},onError:t=>{}})}(0,N.debugLog)("ðŸŸ¢ [TrackingPixelSDK] âœ… Sistema de presencia configurado exitosamente")}catch(t){}}else(0,N.debugLog)("ðŸŸ¢ [TrackingPixelSDK] âš ï¸ Sistema de presencia deshabilitado en configuraciÃ³n")}sendRealtimeMessage(t){return i(this,arguments,void 0,(function*(t,e="text"){try{yield this.realtimeMessageManager.sendMessage(t,e)}catch(t){throw t}}))}showChatCreatedNotification(t){try{if("Notification"in window&&"default"===Notification.permission?Notification.requestPermission().then((e=>{"granted"===e&&this.displayChatNotification(t)})):"Notification"in window&&"granted"===Notification.permission&&this.displayChatNotification(t),this.chatToggleButton){const t=this.chatToggleButton.getButtonElement();t&&(t.classList.add("pulse-animation"),setTimeout((()=>{t.classList.remove("pulse-animation")}),3e3))}(0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] ðŸ”” NotificaciÃ³n de nuevo chat mostrada")}catch(t){}}displayChatNotification(t){try{const e=new Notification("Â¡Un comercial ha iniciado un chat!",{body:t.message||"Tienes un nuevo mensaje esperÃ¡ndote",icon:"/chat-icon.png",tag:t.chatId,requireInteraction:!0});e.onclick=()=>{this.chatUI&&this.chatUI.show(),e.close()}}catch(t){}}getWebSocketState(){return this.wsService.getState()}isWebSocketConnected(){return this.wsService.isConnected()}disconnectWebSocket(){this.wsService.disconnect(),this.realtimeMessageManager.cleanup(),(0,N.debugLog)("ðŸ“¡ [TrackingPixelSDK] ðŸ”Œ WebSocket desconectado")}initChatUIOnly(){return i(this,void 0,void 0,(function*(){(0,N.debugLog)("[TrackingPixelSDK] ðŸ” Inicializando solo chat UI (sin tracking)"),this.chatUI=new y.ChatUI({widget:!0,chatConsentMessage:this.chatConsentMessageConfig,position:this.chatPositionConfig,mobileDetection:this.mobileDetectionConfig,quickActions:this.quickActionsConfig,ai:this.aiConfig}),this.setupQuickActionsCallbacks();const t=()=>{if(!this.chatUI)return;if(this.activeHoursValidator&&!this.activeHoursValidator.isChatActive())return void(0,N.debugLog)("[TrackingPixelSDK] ðŸ• Chat no disponible segÃºn horarios");const t=this.chatUI;this.chatInputUI=new I.ChatInputUI(t);const e=this.chatInputUI;this.chatToggleButton=new x.ChatToggleButtonUI(t);const n=this.chatToggleButton;t.init(),t.hide(),e.init(),n.init(),this.initializeCommercialAvailability(t,n),(0,N.debugLog)("[TrackingPixelSDK] âœ… Chat UI inicializado (sin tracking)"),t.onOpen((()=>{(0,N.debugLog)("[TrackingPixelSDK] ðŸ’¬ Chat abierto (sin tracking de eventos)")})),t.onClose((()=>{(0,N.debugLog)("[TrackingPixelSDK] ðŸ’¬ Chat cerrado (sin tracking de eventos)")})),n.onToggle((e=>{e?t.show():t.hide()})),e.onSubmit((e=>i(this,void 0,void 0,(function*(){if(e)if(this.consentManager.isCategoryAllowed("functional"))try{this.getVisitorId()||(yield this.executeIdentify());const n=t.getChatId();if(n)yield w.ChatV2Service.getInstance().sendMessage(n,e,"text");else{const n=yield w.ChatV2Service.getInstance().createChatWithMessage({},{content:e,type:"text"});t.setChatId(n.chatId)}}catch(t){}else t.addSystemMessage("Se requiere aceptar cookies funcionales para enviar mensajes.")}))))};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t()}))}stopTrackingActivities(){(0,N.debugLog)("[TrackingPixelSDK] ðŸ›‘ Deteniendo todas las actividades de tracking..."),this.domTrackingManager&&(0,N.debugLog)("[TrackingPixelSDK] ðŸ›‘ DOM tracking detenido"),this.sessionTrackingManager&&(0,N.debugLog)("[TrackingPixelSDK] ðŸ›‘ Session tracking detenido"),this.stopAutoFlush(),this.eventQueue=[],(0,N.debugLog)("[TrackingPixelSDK] âœ… Todas las actividades de tracking detenidas")}initConsentBanner(t){(0,N.debugLog)("[TrackingPixelSDK] ðŸŽ¨ Inicializando banner de consentimiento..."),this.consentBanner=new B.ConsentBannerUI(t),this.consentBanner.onAccept=()=>{var t;(0,N.debugLog)("[TrackingPixelSDK] âœ… Usuario aceptÃ³ desde banner"),this.grantConsent(),null===(t=this.consentBanner)||void 0===t||t.hide()},this.consentBanner.onDeny=()=>{var t;(0,N.debugLog)("[TrackingPixelSDK] âŒ Usuario rechazÃ³ desde banner"),this.denyConsent(),null===(t=this.consentBanner)||void 0===t||t.hide()},this.consentBanner.onPreferences=()=>{(0,N.debugLog)("[TrackingPixelSDK] âš™ï¸ Usuario abriÃ³ preferencias desde banner"),alert("Modal de preferencias: PrÃ³ximamente.\n\nPor ahora, puedes:\n- Aceptar Todo = Otorgar consentimiento completo\n- Rechazar = Solo cookies esenciales")},this.consentBanner.render(),t.autoShow&&this.consentManager.isPending()&&(this.consentBanner.show(),(0,N.debugLog)("[TrackingPixelSDK] ðŸ‘ï¸ Banner mostrado automÃ¡ticamente (consent pending)"))}grantConsent(){(0,N.debugLog)("[TrackingPixelSDK] âœ… Otorgando consentimiento completo..."),this.consentManager.grantConsent(),(0,N.debugLog)("[TrackingPixelSDK] ðŸ“ El backend registrarÃ¡ el consentimiento automÃ¡ticamente durante identify()"),(0,N.debugLog)("[TrackingPixelSDK] ðŸ”„ Reiniciando SDK con tracking habilitado..."),this.init().catch((t=>{}))}grantConsentWithPreferences(t){(0,N.debugLog)("[TrackingPixelSDK] âœ… Otorgando consentimiento con preferencias:",t),this.consentManager.grantConsentWithPreferences(t),(0,N.debugLog)("[TrackingPixelSDK] ðŸ“ El backend registrarÃ¡ el consentimiento automÃ¡ticamente durante identify()"),(0,N.debugLog)("[TrackingPixelSDK] ðŸ”„ Reiniciando SDK..."),this.init().catch((t=>{}))}denyConsent(){(0,N.debugLog)("[TrackingPixelSDK] âŒ Denegando consentimiento..."),this.consentManager.denyConsent(),this.stopTrackingActivities(),(0,N.debugLog)("[TrackingPixelSDK] ðŸ“ Registrando rechazo de consentimiento en el backend...");const t=new a.ClientJS,e=this.fingerprint||t.getFingerprint().toString(),n=this.consentManager.getState().version;this.identitySignal.identify(e,this.apiKey,n).catch((t=>{}))}revokeConsent(){(0,N.debugLog)("[TrackingPixelSDK] ðŸ”„ Revocando consentimiento..."),this.consentManager.revokeConsent(),this.stopTrackingActivities();const t=this.getVisitorId();t&&this.consentBackendService.revokeAllConsents(t,"Usuario revocÃ³ consentimiento desde el SDK").then((()=>{(0,N.debugLog)("[TrackingPixelSDK] ðŸ”„ RevocaciÃ³n sincronizada con backend")})).catch((t=>{}))}getConsentStatus(){return this.consentManager.getStatus()}getConsentState(){return this.consentManager.getState()}isConsentGranted(){return this.consentManager.isGranted()}isCategoryAllowed(t){return this.consentManager.isCategoryAllowed(t)}subscribeToConsentChanges(t){return this.consentManager.subscribe(t)}deleteVisitorData(){return i(this,void 0,void 0,(function*(){(0,N.debugLog)("[TrackingPixelSDK] ðŸ—‘ï¸ Eliminando datos del visitante (GDPR Right to Erasure)...");try{const t=this.getVisitorId();if(this.stopTrackingActivities(),this.clearLocalStorageData(),this.consentManager.clearConsentData(),t)try{yield this.consentBackendService.deleteConsentData(t),(0,N.debugLog)("[TrackingPixelSDK] âœ… Datos de consentimiento eliminados del backend"),(0,N.debugLog)("[TrackingPixelSDK] ðŸ“¡ Solicitud de eliminaciÃ³n enviada al servidor para visitor:",t)}catch(t){throw new Error("No se pudieron eliminar los datos del servidor")}this.identitySignal.reset(),this.fingerprint=null,(0,N.debugLog)("[TrackingPixelSDK] âœ… Datos del visitante eliminados exitosamente")}catch(t){throw t}}))}clearLocalStorageData(){"undefined"!=typeof localStorage&&(["fingerprint","guiders_backend_session_id","guiders_recent_chats","guiders_initial_messages","pixelEndpoint","guidersApiKey","guiders_consent_state"].forEach((t=>{try{localStorage.removeItem(t),(0,N.debugLog)("[TrackingPixelSDK] ðŸ—‘ï¸ Eliminado:",t)}catch(t){}})),(0,N.debugLog)("[TrackingPixelSDK] ðŸ—‘ï¸ Datos locales eliminados"))}exportVisitorData(){return i(this,void 0,void 0,(function*(){(0,N.debugLog)("[TrackingPixelSDK] ðŸ“¦ Exportando datos del visitante...");const t=this.getVisitorId(),e={visitorId:t,fingerprint:this.fingerprint,sessionId:this.identitySignal.getSessionId(),identityState:this.identitySignal.getState(),consentState:this.consentManager.getState(),localStorage:this.getLocalStorageData(),exportedAt:(new Date).toISOString()};if(t)try{const n=yield this.consentBackendService.exportConsentData(t);e.backendConsents=JSON.parse(n),(0,N.debugLog)("[TrackingPixelSDK] âœ… Datos de consentimiento del backend incluidos en exportaciÃ³n")}catch(t){e.backendConsents={error:"No se pudieron obtener datos del backend"}}return JSON.stringify(e,null,2)}))}getLocalStorageData(){if("undefined"==typeof localStorage)return{};const t={};return["fingerprint","guiders_backend_session_id","guiders_recent_chats","pixelEndpoint","guiders_consent_state"].forEach((e=>{try{const n=localStorage.getItem(e);n&&(t[e]=n)}catch(t){}})),t}}},2662:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.decodePacket=void 0;const i=n(2046),s=n(2745),a="function"==typeof ArrayBuffer;e.decodePacket=(t,e)=>{if("string"!=typeof t)return{type:"message",data:r(t,e)};const n=t.charAt(0);return"b"===n?{type:"message",data:o(t.substring(1),e)}:i.PACKET_TYPES_REVERSE[n]?t.length>1?{type:i.PACKET_TYPES_REVERSE[n],data:t.substring(1)}:{type:i.PACKET_TYPES_REVERSE[n]}:i.ERROR_PACKET};const o=(t,e)=>{if(a){const n=(0,s.decode)(t);return r(n,e)}return{base64:!0,data:t}},r=(t,e)=>"blob"===e?t instanceof Blob?t:new Blob([t]):t instanceof ArrayBuffer?t:t.buffer},2686:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.encodePacket=void 0,e.encodePacketToBinary=function(t,e){return s&&t.data instanceof Blob?t.data.arrayBuffer().then(d).then(e):a&&(t.data instanceof ArrayBuffer||o(t.data))?e(d(t.data)):void r(t,!1,(t=>{l||(l=new TextEncoder),e(l.encode(t))}))};const i=n(2046),s="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Object.prototype.toString.call(Blob),a="function"==typeof ArrayBuffer,o=t=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(t):t&&t.buffer instanceof ArrayBuffer,r=({type:t,data:e},n,r)=>s&&e instanceof Blob?n?r(e):c(e,r):a&&(e instanceof ArrayBuffer||o(e))?n?r(e):c(new Blob([e]),r):r(i.PACKET_TYPES[t]+(e||""));e.encodePacket=r;const c=(t,e)=>{const n=new FileReader;return n.onload=function(){const t=n.result.split(",")[1];e("b"+(t||""))},n.readAsDataURL(t)};function d(t){return t instanceof Uint8Array?t:t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}let l},2745:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.decode=e.encode=void 0;const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i="undefined"==typeof Uint8Array?[]:new Uint8Array(256);for(let t=0;t<64;t++)i[n.charCodeAt(t)]=t;e.encode=t=>{let e,i=new Uint8Array(t),s=i.length,a="";for(e=0;e<s;e+=3)a+=n[i[e]>>2],a+=n[(3&i[e])<<4|i[e+1]>>4],a+=n[(15&i[e+1])<<2|i[e+2]>>6],a+=n[63&i[e+2]];return s%3==2?a=a.substring(0,a.length-1)+"=":s%3==1&&(a=a.substring(0,a.length-2)+"=="),a},e.decode=t=>{let e,n,s,a,o,r=.75*t.length,c=t.length,d=0;"="===t[t.length-1]&&(r--,"="===t[t.length-2]&&r--);const l=new ArrayBuffer(r),h=new Uint8Array(l);for(e=0;e<c;e+=4)n=i[t.charCodeAt(e)],s=i[t.charCodeAt(e+1)],a=i[t.charCodeAt(e+2)],o=i[t.charCodeAt(e+3)],h[d++]=n<<2|s>>4,h[d++]=(15&s)<<4|a>>2,h[d++]=(3&a)<<6|63&o;return l}},2782:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.MessageRenderer=void 0;let n={enabled:!0,showAIIndicator:!0,aiAvatarEmoji:"ðŸ¤–",aiSenderName:"Asistente IA",showTypingIndicator:!0};e.MessageRenderer=class{static setAIConfig(t){n=Object.assign(Object.assign({},n),t)}static getAIConfig(){return Object.assign({},n)}static createMessageElement(t){var e;const i=document.createElement("div"),s="user"===t.sender,a=!0===t.isAI||"ai"===t.sender;let o=s?"chat-message-wrapper chat-message-user-wrapper":"chat-message-wrapper chat-message-other-wrapper";if(a&&(o+=" chat-message-ai-wrapper"),i.className=o,t.id&&i.setAttribute("data-message-id",t.id),a&&(i.setAttribute("data-ai-message","true"),(null===(e=t.aiMetadata)||void 0===e?void 0:e.model)&&i.setAttribute("data-ai-model",t.aiMetadata.model)),t.timestamp){const e="string"==typeof t.timestamp?t.timestamp:new Date(t.timestamp).toISOString();i.setAttribute("data-created-at",e)}const r=document.createElement("div");r.className="message-content-wrapper";const c=document.createElement("div");let d=s?"chat-message chat-message-user":"chat-message chat-message-other";if(a&&(d+=" chat-message-ai"),c.className=d,a&&!1!==n.showAIIndicator){const t=this.createAIHeader();c.appendChild(t)}const l=document.createElement("div");l.className="message-text";const h=t.content.replace(/\r\n/g," ").replace(/\n/g," ").replace(/\r/g," ").replace(/\s+/g," ").trim();l.textContent=h;const u=document.createElement("div");return u.className="chat-message-time",u.textContent=s?`${this.formatTime(t.timestamp)} âœ“`:this.formatTime(t.timestamp),c.appendChild(l),c.appendChild(u),r.appendChild(c),i.appendChild(r),this.applyModernMessageStyles(i,s,a),i}static createAIHeader(){const t=document.createElement("div");t.className="ai-message-header",t.style.cssText="\n            display: flex;\n            align-items: center;\n            gap: 6px;\n            margin-bottom: 6px;\n            padding-bottom: 4px;\n            border-bottom: 1px solid rgba(66, 133, 244, 0.15);\n        ";const e=document.createElement("span");e.className="ai-avatar",e.textContent=n.aiAvatarEmoji||"ðŸ¤–",e.style.cssText="\n            font-size: 14px;\n        ";const i=document.createElement("span");i.className="ai-sender-name",i.textContent=n.aiSenderName||"Asistente IA",i.style.cssText="\n            font-size: 12px;\n            font-weight: 500;\n            color: #4285f4;\n        ";const s=document.createElement("span");return s.className="ai-badge",s.textContent="IA",s.style.cssText="\n            background: linear-gradient(135deg, #4285f4, #34a853);\n            color: white;\n            font-size: 9px;\n            font-weight: 600;\n            padding: 2px 5px;\n            border-radius: 3px;\n            text-transform: uppercase;\n            letter-spacing: 0.5px;\n        ",t.appendChild(e),t.appendChild(i),t.appendChild(s),t}static fromMessageV2(t){return{id:t.id,content:t.content,sender:this.determineSender(t),timestamp:t.createdAt,senderId:t.senderId}}static determineSender(t){try{const e=localStorage.getItem("visitorId");if(e&&t.senderId===e)return"user"}catch(t){}return"user"===t.type?"user":"system"===t.type?"system":"agent"}static getParticipantInitials(t){if(!t)return"BOT";if(t.length<=3)return t.toUpperCase();const e=t.split(/[\s_-]+/);return e.length>=2?(e[0][0]+e[1][0]).toUpperCase():t.substring(0,2).toUpperCase()}static escapeHtml(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}static formatTime(t){let e;return e=t?new Date(t):new Date,e.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",hour12:!1})}static applyModernMessageStyles(t,e,n=!1){const i=t.querySelector(".chat-avatar"),s=t.querySelector(".chat-message"),a=t.querySelector(".message-text"),o=t.querySelector(".chat-message-time"),r=t.querySelector(".message-content-wrapper");if(t.style.cssText=`\n            display: flex;\n            align-items: flex-end;\n            margin-bottom: 3px;\n            ${e?"flex-direction: row-reverse; margin-left: 30%;":"flex-direction: row; margin-right: 30%;"}\n            opacity: 1;\n            transform: translateY(0);\n        `,i){i.style.cssText="\n                margin-right: 12px;\n                margin-bottom: 4px;\n                filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));\n            ";const t=i.querySelector(".avatar-circle");t&&(t.style.cssText="\n                    width: 32px;\n                    height: 32px;\n                    border-radius: 50%;\n                    background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    color: white;\n                    font-size: 11px;\n                    font-weight: 600;\n                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n                    border: none;\n                    box-sizing: border-box;\n                    min-width: 32px;\n                    min-height: 32px;\n                    max-width: 32px;\n                    max-height: 32px;\n                ")}if(r&&(r.style.cssText=`\n                display: flex;\n                flex-direction: column;\n                ${e?"align-items: flex-end;":"align-items: flex-start;"}\n                max-width: 100%;\n            `),s){let t,i="";e?(t="background: #D1E7FF;",i="border-bottom-right-radius: 2px;"):n?(t="background: linear-gradient(135deg, #f0f7ff 0%, #e8f4fe 100%);",i="border-bottom-left-radius: 2px; border-left: 3px solid #4285f4;"):(t="background: #FFFFFF;",i="border-bottom-left-radius: 2px;"),s.style.cssText=`\n                padding: 8px 12px;\n                border-radius: 10px;\n                position: relative;\n                overflow-wrap: break-word;\n                word-wrap: break-word;\n                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n                display: inline-flex;\n                flex-direction: ${n?"column":"row"};\n                flex-wrap: nowrap;\n                align-items: ${n?"stretch":"flex-end"};\n                gap: 6px;\n                max-width: 100%;\n                ${t}\n                color: #2c3e50;\n                ${i}\n                transition: all 0.2s ease;\n            `}a&&(a.style.cssText="\n                font-size: 14px;\n                line-height: 1.4;\n                margin: 0;\n                overflow-wrap: break-word;\n                word-wrap: break-word;\n                white-space: normal;\n                -webkit-font-smoothing: antialiased;\n                -moz-osx-font-smoothing: grayscale;\n                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n                color: #2c3e50;\n            "),o&&(o.style.cssText="\n                font-size: 10px;\n                color: rgba(44, 62, 80, 0.5);\n                font-weight: 400;\n                letter-spacing: 0.01em;\n                font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;\n                white-space: nowrap;\n                flex-shrink: 0;\n                opacity: 0.9;\n            "),this.ensureAnimationStyles()}static ensureAnimationStyles(){if(document.getElementById("guiders-message-animations"))return;const t=document.createElement("style");t.id="guiders-message-animations",t.innerHTML="\n            @keyframes messageSlideIn {\n                0% {\n                    opacity: 0;\n                    transform: translateY(20px) scale(0.95);\n                    filter: blur(4px);\n                }\n                50% {\n                    opacity: 0.7;\n                    transform: translateY(8px) scale(0.98);\n                    filter: blur(2px);\n                }\n                100% {\n                    opacity: 1;\n                    transform: translateY(0) scale(1);\n                    filter: blur(0);\n                }\n            }\n            \n            .modern-message {\n                will-change: transform, opacity;\n            }\n            \n            .modern-message .message-content {\n                transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);\n            }\n            \n            .modern-message .message-avatar {\n                transition: transform 0.2s ease;\n            }\n            \n            /* Efecto hover del avatar deshabilitado por solicitud del usuario */\n        ",document.head.appendChild(t)}}},2831:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),Object.defineProperty(e,"MAX",{enumerable:!0,get:function(){return i.default}}),Object.defineProperty(e,"NIL",{enumerable:!0,get:function(){return s.default}}),Object.defineProperty(e,"parse",{enumerable:!0,get:function(){return a.default}}),Object.defineProperty(e,"stringify",{enumerable:!0,get:function(){return o.default}}),Object.defineProperty(e,"v1",{enumerable:!0,get:function(){return r.default}}),Object.defineProperty(e,"v1ToV6",{enumerable:!0,get:function(){return c.default}}),Object.defineProperty(e,"v3",{enumerable:!0,get:function(){return d.default}}),Object.defineProperty(e,"v4",{enumerable:!0,get:function(){return l.default}}),Object.defineProperty(e,"v5",{enumerable:!0,get:function(){return h.default}}),Object.defineProperty(e,"v6",{enumerable:!0,get:function(){return u.default}}),Object.defineProperty(e,"v6ToV1",{enumerable:!0,get:function(){return g.default}}),Object.defineProperty(e,"v7",{enumerable:!0,get:function(){return p.default}}),Object.defineProperty(e,"validate",{enumerable:!0,get:function(){return f.default}}),Object.defineProperty(e,"version",{enumerable:!0,get:function(){return m.default}});var i=b(n(4213)),s=b(n(4808)),a=b(n(6792)),o=b(n(9910)),r=b(n(3518)),c=b(n(343)),d=b(n(4948)),l=b(n(5073)),h=b(n(7186)),u=b(n(4671)),g=b(n(3507)),p=b(n(744)),f=b(n(7037)),m=b(n(7775));function b(t){return t&&t.__esModule?t:{default:t}}},2858:(t,e)=>{"use strict";var n;Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(){if(!n&&!(n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return n(i)};var i=new Uint8Array(16)},2895:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EnhancedDomTrackingManager=void 0;const i=n(6808),s=n(1034),a=n(7690),o=n(3974);class r extends i.DomTrackingManager{constructor(t,e=new i.DefaultTrackDataExtractor,n={}){super(t,e),this.heuristicEnabled=!0,this.registeredListeners=new Map,this.lastTrackedUrl="",this.navigationListenersSetup=!1,this.heuristicDetector=new s.HeuristicElementDetector(n),this.urlDetector=new a.URLPageDetector}enableAutomaticTracking(){this.heuristicEnabled?((0,o.debugLog)("[EnhancedDomTrackingManager] ðŸš€ Enabling automatic heuristic tracking"),this.handlePageViewTracking(),this.setupHeuristicEventListeners(),this.observeDOMChanges()):(0,o.debugLog)("[EnhancedDomTrackingManager] Heuristic detection is disabled")}handlePageViewTracking(){const t=()=>{this.trackPageView(),this.navigationListenersSetup||(this.setupNavigationListeners(),this.navigationListenersSetup=!0)};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t()}trackPageView(){const t=window.location.href;if(this.lastTrackedUrl===t)return void(0,o.debugLog)("[EnhancedDomTrackingManager] â­ï¸ Skipping duplicate page_view for:",t);this.lastTrackedUrl=t;const e=this.urlDetector.detectCurrentPage();(0,o.debugLog)("[EnhancedDomTrackingManager] ðŸ“„ Page detected:",e.pageType,"confidence:",e.confidence),this.trackCallback({event:"page_view"})}setupNavigationListeners(){(0,o.debugLog)("[EnhancedDomTrackingManager] ðŸ§­ Setting up navigation listeners for SPA"),window.addEventListener("popstate",(()=>{(0,o.debugLog)("[EnhancedDomTrackingManager] â¬…ï¸ popstate detected"),this.trackPageView()})),window.addEventListener("hashchange",(()=>{(0,o.debugLog)("[EnhancedDomTrackingManager] #ï¸âƒ£ hashchange detected"),this.trackPageView()}));const t=history.pushState;history.pushState=(...e)=>{t.apply(history,e),(0,o.debugLog)("[EnhancedDomTrackingManager] âž¡ï¸ pushState detected"),this.trackPageView()};const e=history.replaceState;history.replaceState=(...t)=>{e.apply(history,t),(0,o.debugLog)("[EnhancedDomTrackingManager] ðŸ”„ replaceState detected"),this.trackPageView()}}setupHeuristicEventListeners(){Object.keys(this.getDomEventMap()).forEach((t=>{"page_view"!==t&&this.setupEventTypeListeners(t)}))}setupEventTypeListeners(t){const e=this.getDomEventMap()[t];if(!e)return;const n=this.heuristicDetector.detectElements(t);(0,o.debugLog)(`[EnhancedDomTrackingManager] ðŸŽ¯ Found ${n.length} elements for "${t}"`),n.forEach((n=>{this.attachEventListener(n.element,t,e,n)}))}attachEventListener(t,e,n,i){this.registeredListeners.has(t)||this.registeredListeners.set(t,new Map);const s=this.registeredListeners.get(t),a=`${e}_${n}`;if(s.has(a))return;const r=()=>{(0,o.debugLog)(`[EnhancedDomTrackingManager] ðŸ“Š Tracking "${e}" (confidence: ${i.confidence.toFixed(2)})`);const n=this.createHeuristicEventData(t,e,i);this.trackCallback(n)};t.addEventListener(n,r),s.set(a,r)}createHeuristicEventData(t,e,n){var i;return Object.assign({event:e,detection_method:"heuristic",confidence:n.confidence,matched_selector:n.matchedRule.selector,element_text:(null===(i=t.textContent)||void 0===i?void 0:i.trim())||"",element_tag:t.tagName.toLowerCase(),element_class:t.className||"",element_id:t.id||"",timestamp:Date.now()},this.urlDetector.extractPageMetadata())}addVisualIndicator(t,e,n){const i=document.createElement("div");i.innerHTML=`ðŸŽ¯ ${e} (${Math.round(100*n)}%)`,i.style.cssText="\n            position: absolute;\n            background: rgba(30, 58, 138, 0.9);\n            color: white;\n            padding: 2px 6px;\n            font-size: 10px;\n            border-radius: 3px;\n            z-index: 10000;\n            pointer-events: none;\n            font-family: monospace;\n        ";const s=t.getBoundingClientRect();i.style.top=s.top+window.scrollY-20+"px",i.style.left=s.left+window.scrollX+"px",document.body.appendChild(i),setTimeout((()=>{i.parentNode&&i.parentNode.removeChild(i)}),3e3)}observeDOMChanges(){new MutationObserver((t=>{let e=!1;t.forEach((t=>{"childList"===t.type&&t.addedNodes.length>0&&t.addedNodes.forEach((t=>{t.nodeType===Node.ELEMENT_NODE&&(e=!0)}))})),e&&setTimeout((()=>this.rescanForNewElements()),500)})).observe(document.body,{childList:!0,subtree:!0})}rescanForNewElements(){(0,o.debugLog)("[EnhancedDomTrackingManager] ðŸ”„ Rescanning for new elements"),Object.keys(this.getDomEventMap()).forEach((t=>{"page_view"!==t&&this.setupEventTypeListeners(t)}))}setHeuristicEnabled(t){this.heuristicEnabled=t,(0,o.debugLog)("[EnhancedDomTrackingManager] Heuristic detection "+(t?"enabled":"disabled"))}getHeuristicConfig(){return this.heuristicDetector.getConfig()}updateHeuristicConfig(t){this.heuristicDetector.updateConfig(t)}getURLDetector(){return this.urlDetector}getHeuristicDetector(){return this.heuristicDetector}getDomEventMap(){return this.domEventMap}enableDOMTracking(){this.enableAutomaticTracking()}}e.EnhancedDomTrackingManager=r},2919:function(t,e,n){"use strict";var i=this&&this.__createBinding||(Object.create?function(t,e,n,i){void 0===i&&(i=n);var s=Object.getOwnPropertyDescriptor(e,n);s&&!("get"in s?!e.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return e[n]}}),Object.defineProperty(t,i,s)}:function(t,e,n,i){void 0===i&&(i=n),t[i]=e[n]}),s=this&&this.__exportStar||function(t,e){for(var n in t)"default"===n||Object.prototype.hasOwnProperty.call(e,n)||i(e,t,n)};Object.defineProperty(e,"__esModule",{value:!0}),e.ChatInputUI=e.ChatUI=e.createDateSeparator=e.generateInitials=e.isBot=e.formatDate=e.formatTime=void 0;var a=n(5649);Object.defineProperty(e,"formatTime",{enumerable:!0,get:function(){return a.formatTime}}),Object.defineProperty(e,"formatDate",{enumerable:!0,get:function(){return a.formatDate}}),Object.defineProperty(e,"isBot",{enumerable:!0,get:function(){return a.isBot}}),Object.defineProperty(e,"generateInitials",{enumerable:!0,get:function(){return a.generateInitials}}),Object.defineProperty(e,"createDateSeparator",{enumerable:!0,get:function(){return a.createDateSeparator}});var o=n(3129);Object.defineProperty(e,"ChatUI",{enumerable:!0,get:function(){return o.ChatUI}});var r=n(3626);Object.defineProperty(e,"ChatInputUI",{enumerable:!0,get:function(){return r.ChatInputUI}}),s(n(3129),e),s(n(3626),e),s(n(4505),e),s(n(5649),e)},2969:function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function r(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.ChatToggleButtonUI=void 0;const s=n(969),a=n(3974);e.ChatToggleButtonUI=class{constructor(t,e={}){this.badgeElement=null,this.isVisible=!1,this.toggleCallback=[],this.chatUI=t,this.resolvedPosition=this.chatUI.getResolvedPosition(),(0,a.debugLog)("ðŸ”˜ [ChatToggleButton] PosiciÃ³n resuelta del botÃ³n:",this.resolvedPosition.button);const n=this.chatUI.getOptions().widgetWidth||"300px";parseInt(n.replace("px","")),this.options=Object.assign({label:"Chat",buttonSize:"50px",backgroundColor:"#007bff",textColor:"#ffffff",positionRight:"20px",positionBottom:"20px",borderRadius:"50%"},e),this.button=document.createElement("button"),this.button.className="chat-toggle-btn";const i=document.createElement("div");i.className="btn-background",this.button.appendChild(i),this.unreadService=s.UnreadMessagesService.getInstance(),this.isVisible=!1}getButtonPositionCSS(){const t=this.resolvedPosition.button,e=[];return t.top&&e.push(`top: ${t.top};`),t.bottom&&e.push(`bottom: ${t.bottom};`),t.left&&e.push(`left: ${t.left};`),t.right&&e.push(`right: ${t.right};`),e.join(" ")}getBadgePositionCSS(){const t=this.resolvedPosition.button,e=[];return t.bottom?(parseInt(t.bottom),e.push(`bottom: calc(${t.bottom} + 43px);`)):t.top&&(parseInt(t.top),e.push(`top: calc(${t.top} + 13px);`)),t.right?e.push(`right: calc(${t.right} + 13px);`):t.left&&e.push(`left: calc(${t.left} + 43px);`),e.join(" ")}init(){this.button||(this.button=document.createElement("button"),this.button.className="chat-toggle-btn"),this.isVisible=!1,this.button.classList.remove("open"),this.addButtonToDOM(),this.applyStyles(),this.addEventListeners(),this.initializeStyles(),(0,a.debugLog)("ðŸ’¬ Inicializando sistema de notificaciones")}registerCSSProperty(){try{CSS&&"registerProperty"in CSS&&CSS.registerProperty({name:"--deg",syntax:"<angle>",initialValue:"0deg",inherits:!1})}catch(t){}}addButtonToDOM(){this.registerCSSProperty();const t=document.querySelector(".chat-widget-host");if(t&&t.shadowRoot){if(t.shadowRoot.querySelectorAll(".chat-toggle-btn").forEach((t=>t.remove())),t.shadowRoot.querySelectorAll(".chat-unread-badge").forEach((t=>t.remove())),t.shadowRoot.insertBefore(this.button,t.shadowRoot.firstChild),this.badgeElement=document.createElement("div"),this.badgeElement.className="chat-unread-badge",this.badgeElement.setAttribute("id","chat-unread-badge"),this.button.appendChild(this.badgeElement),this.hideBadge(),(0,a.debugLog)("ðŸ’¬ Badge inicializado y oculto (0 mensajes no leÃ­dos)"),!t.shadowRoot.querySelector("style[data-chat-toggle-btn]")){const e=this.getButtonPositionCSS(),n=(this.getBadgePositionCSS(),document.createElement("style"));n.setAttribute("data-chat-toggle-btn","true"),n.textContent=`\n\t\t\t\t\t.chat-toggle-btn {\n\t\t\t\t\t\tposition: fixed;\n\t\t\t\t\t\t${e}\n\t\t\t\t\t\twidth: 56px;\n\t\t\t\t\t\theight: 56px;\n\t\t\t\t\t\tborder-radius: 16px;\n\t\t\t\t\t\tbackground: transparent;\n\t\t\t\t\t\tcolor: #111827 !important;\n\t\t\t\t\t\tborder: none;\n\t\t\t\t\t\tcursor: pointer;\n\t\t\t\t\t\tdisplay: flex;\n\t\t\t\t\t\talign-items: center;\n\t\t\t\t\t\tjustify-content: center;\n\t\t\t\t\t\tfont-weight: bold;\n\t\t\t\t\t\tbox-shadow: none;\n\t\t\t\t\t\ttransition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);\n\t\t\t\t\t\tz-index: 2147483647;\n\t\t\t\t\t}\n\n\t\t\t\t\t/* AnimaciÃ³n de rotaciÃ³n del gradiente */\n\t\t\t\t\t@keyframes rotate-gradient {\n\t\t\t\t\t\tfrom {\n\t\t\t\t\t\t\t--deg: 0deg;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tto {\n\t\t\t\t\t\t\t--deg: 360deg;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t/* Capa de glow multicolor con blur */\n\t\t\t\t\t.chat-toggle-btn::after {\n\t\t\t\t\t\tcontent: '';\n\t\t\t\t\t\tposition: absolute;\n\t\t\t\t\t\tinset: 0;\n\t\t\t\t\t\tbackground: conic-gradient(from var(--deg, 0deg), #ff0000, #ff8000, #ffff00, #80ff00, #00ff00, #00ff80, #00ffff, #0080ff, #0000ff, #8000ff, #ff00ff, #ff0080, #ff0000);\n\t\t\t\t\t\tfilter: blur(8px);\n\t\t\t\t\t\tborder-radius: 16px;\n\t\t\t\t\t\topacity: 0.7;\n\t\t\t\t\t\tz-index: 1;\n\t\t\t\t\t\tanimation: rotate-gradient 4s linear infinite;\n\t\t\t\t\t\ttransition: filter 0.3s ease, opacity 0.3s ease;\n\t\t\t\t\t}\n\n\t\t\t\t\t/* Fondo blanco encima del glow */\n\t\t\t\t\t.chat-toggle-btn .btn-background {\n\t\t\t\t\t\tposition: absolute;\n\t\t\t\t\t\tinset: 0;\n\t\t\t\t\t\tbackground: #ffffff;\n\t\t\t\t\t\tborder-radius: 16px;\n\t\t\t\t\t\tz-index: 2;\n\t\t\t\t\t}\n\n\t\t\t\t\t.chat-toggle-btn::before {\n\t\t\t\t\t\tcontent: '';\n\t\t\t\t\t\tdisplay: block;\n\t\t\t\t\t\twidth: 24px;\n\t\t\t\t\t\theight: 24px;\n\t\t\t\t\t\tbackground-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M1.25 12C1.25 6.06294 6.06294 1.25 12 1.25C17.937 1.25 22.75 6.06293 22.75 12C22.75 17.937 17.937 22.75 12 22.75C10.1437 22.75 8.39536 22.2788 6.87016 21.4493L2.63727 22.2373C2.39422 22.2826 2.14448 22.2051 1.96967 22.0303C1.79485 21.8555 1.71742 21.6058 1.76267 21.3627L2.55076 17.1298C1.72113 15.6046 1.25 13.8563 1.25 12ZM7.25 10C7.25 9.58579 7.58579 9.25 8 9.25H12H16C16.4142 9.25 16.75 9.58579 16.75 10C16.75 10.4142 16.4142 10.75 16 10.75H12H8C7.58579 10.75 7.25 10.4142 7.25 10ZM8 13.25C7.58579 13.25 7.25 13.5858 7.25 14C7.25 14.4142 7.58579 14.75 8 14.75H10H12C12.4142 14.75 12.75 14.4142 12.75 14C12.75 13.5858 12.4142 13.25 12 13.25H10H8Z' fill='%23111827'/%3E%3C/svg%3E");\n\t\t\t\t\t\tbackground-repeat: no-repeat;\n\t\t\t\t\t\tbackground-position: center;\n\t\t\t\t\t\ttransition: transform 0.3s ease;\n\t\t\t\t\t\tz-index: 3;\n\t\t\t\t\t\tposition: relative;\n\t\t\t\t\t}\n\t\t\t\t\t.chat-toggle-btn.open::before {\n\t\t\t\t\t\tbackground-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z' fill='%23111827'/%3E%3C/svg%3E");\n\t\t\t\t\t}\n\t\t\t\t\t.chat-toggle-btn:hover {\n\t\t\t\t\t\ttransform: translateY(-3px) scale(1.05);\n\t\t\t\t\t}\n\t\t\t\t\t.chat-toggle-btn:hover::after {\n\t\t\t\t\t\tfilter: blur(12px);\n\t\t\t\t\t\topacity: 1;\n\t\t\t\t\t}\n\t\t\t\t\t.chat-toggle-btn:active {\n\t\t\t\t\t\ttransform: translateY(0) scale(0.95);\n\t\t\t\t\t}\n\t\t\t\t\t.chat-unread-badge {\n\t\t\t\t\t\tposition: absolute;\n\t\t\t\t\t\ttop: -6px;\n\t\t\t\t\t\tright: -6px;\n\t\t\t\t\t\tmin-width: 18px;\n\t\t\t\t\t\theight: 18px;\n\t\t\t\t\t\tbackground: linear-gradient(145deg, #ff5146, #e53a30);\n\t\t\t\t\t\tcolor: white;\n\t\t\t\t\t\tborder-radius: 10px;\n\t\t\t\t\t\tfont-size: 10px;\n\t\t\t\t\t\tfont-weight: bold;\n\t\t\t\t\t\tdisplay: flex;\n\t\t\t\t\t\talign-items: center;\n\t\t\t\t\t\tjustify-content: center;\n\t\t\t\t\t\tpadding: 0 4px;\n\t\t\t\t\t\tbox-sizing: border-box;\n\t\t\t\t\t\tborder: 2px solid white;\n\t\t\t\t\t\tz-index: 10;\n\t\t\t\t\t\tbox-shadow: 0 2px 8px rgba(255,65,54,0.3);\n\t\t\t\t\t\tpointer-events: none;\n\t\t\t\t\t\ttransition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);\n\t\t\t\t\t}\n\t\t\t\t\t.chat-unread-badge.hidden {\n\t\t\t\t\t\ttransform: scale(0);\n\t\t\t\t\t\topacity: 0;\n\t\t\t\t\t\tdisplay: flex !important;\n\t\t\t\t\t}\n\t\t\t\t\t@keyframes pulse {\n\t\t\t\t\t\t0% { transform: scale(0.8); opacity: 0.7; }\n\t\t\t\t\t\t50% { transform: scale(1.3); opacity: 1; }\n\t\t\t\t\t\t80% { transform: scale(0.95); opacity: 1; }\n\t\t\t\t\t\t100% { transform: scale(1); opacity: 1; }\n\t\t\t\t\t}\n\t\t\t\t`,t.shadowRoot.appendChild(n)}(0,a.debugLog)("ðŸ’¬ BotÃ³n aÃ±adido al shadow DOM del chat")}else document.body.appendChild(this.button),this.badgeElement=document.createElement("div"),this.badgeElement.className="chat-unread-badge",this.badgeElement.setAttribute("id","chat-unread-badge"),this.button.appendChild(this.badgeElement),this.hideBadge(),(0,a.debugLog)("ðŸ’¬ BotÃ³n aÃ±adido al body (sin shadow DOM)")}onToggle(t){this.toggleCallback.push(t)}applyStyles(){Array.from(this.button.childNodes).forEach((t=>{t.nodeType!==Node.TEXT_NODE&&"SPAN"!==t.tagName||this.button.removeChild(t)})),this.button.style.background="transparent",this.button.style.color="#111827",this.button.style.borderRadius="16px"}addEventListeners(){this.button.addEventListener("click",(()=>{this.isVisible=!this.isVisible,(0,a.debugLog)("Toggle button clicked, new state:",this.isVisible?"visible":"hidden"),this.isVisible?this.button.classList.add("open"):this.button.classList.remove("open"),this.toggleCallback.forEach((t=>{t(this.isVisible)}))}))}hideBadge(){this.badgeElement&&(this.badgeElement.classList.add("hidden"),this.badgeElement.style.opacity="0",this.badgeElement.style.transform="scale(0)",this.badgeElement.style.display="none",this.badgeElement.textContent="",(0,a.debugLog)("ðŸš« Badge oculto - sin mensajes no leÃ­dos"))}updateUnreadBadge(t){if(this.badgeElement){if(this.button&&"none"===this.button.style.display)return(0,a.debugLog)("ðŸš« Badge no se mostrarÃ¡ porque el botÃ³n estÃ¡ oculto"),void this.hideBadge();(0,a.debugLog)(`ðŸ“¬ Actualizando badge: ${t} mensajes no leÃ­dos`),t<=0?this.hideBadge():(this.badgeElement.classList.remove("hidden"),this.badgeElement.style.opacity="1",this.badgeElement.textContent=t>99?"99+":t.toString(),(0,a.debugLog)(`ðŸ”´ Badge visible - ${t} mensajes no leÃ­dos`),this.badgeElement.style.display="flex",this.badgeElement.style.opacity="1",this.badgeElement.style.transform="scale(1)",this.badgeElement&&(this.badgeElement.style.animation="none",setTimeout((()=>{this.badgeElement&&(this.badgeElement.style.animation="pulse 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275)")}),10)))}}initializeStyles(){const t=this.resolvedPosition.button,e={position:"fixed",width:"56px",height:"56px",borderRadius:"16px",background:"transparent",color:"#111827",border:"none",cursor:"pointer",zIndex:"2147483647",display:"flex",alignItems:"center",justifyContent:"center",fontWeight:"bold",boxShadow:"none",transition:"transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)"};if(t.top&&(e.top=t.top),t.bottom&&(e.bottom=t.bottom),t.left&&(e.left=t.left),t.right&&(e.right=t.right),Object.assign(this.button.style,e),this.badgeElement){const t={position:"absolute",top:"-6px",right:"-6px",minWidth:"18px",height:"18px",background:"linear-gradient(145deg, #ff5146, #e53a30)",color:"white",borderRadius:"10px",fontSize:"10px",fontWeight:"bold",display:"flex",alignItems:"center",justifyContent:"center",padding:"0 4px",boxSizing:"border-box",border:"2px solid white",zIndex:"10",boxShadow:"0 2px 8px rgba(255,65,54,0.3)",pointerEvents:"none",transition:"all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)"};Object.assign(this.badgeElement.style,t)}}show(){this.button&&(this.button.style.display="flex");const t=this.unreadService.getUnreadCount();this.badgeElement&&t>0&&(this.badgeElement.style.display="flex")}hide(){this.button&&(this.button.style.display="none"),this.badgeElement&&(this.badgeElement.style.display="none")}isButtonVisible(){const t=this.button&&"none"!==this.button.style.display;return(0,a.debugLog)("ðŸ”˜ isButtonVisible() - Elemento existe:",!!this.button),this.button&&(0,a.debugLog)("ðŸ”˜ isButtonVisible() - Display style:",this.button.style.display),(0,a.debugLog)("ðŸ”˜ isButtonVisible() - Resultado:",t),t}hideUnreadBadge(){this.hideBadge()}updateUnreadCount(t){const e=null!=t?t:0;this.updateUnreadBadge(e)}updateState(t){this.isVisible=t,t?this.button.classList.add("open"):this.button.classList.remove("open"),(0,a.debugLog)("ðŸ”˜ Estado del toggle button actualizado: "+(t?"abierto":"cerrado"))}connectUnreadService(t,e,n){(0,a.debugLog)("ðŸ”Œ Conectando servicio de mensajes no leÃ­dos con visitorId:",t),(0,a.debugLog)("ðŸ“¬ Auto-apertura de chat:",n?"habilitada":"deshabilitada"),this.unreadService.initialize({visitorId:t,onCountChange:t=>{(0,a.debugLog)("ðŸ“¬ Contador de mensajes no leÃ­dos actualizado:",t),this.updateUnreadCount(t)},onMessageReceived:e,autoOpenChatOnMessage:n,debug:!0}),(0,a.debugLog)("âœ… Servicio de mensajes no leÃ­dos conectado")}setActiveChatForUnread(t){(0,a.debugLog)("ðŸ“Œ Estableciendo chat activo para mensajes no leÃ­dos:",t),this.unreadService.setCurrentChat(t)}markAllMessagesAsRead(){return i(this,void 0,void 0,(function*(){(0,a.debugLog)("âœ… Marcando todos los mensajes como leÃ­dos..."),yield this.unreadService.markAllAsRead()}))}notifyChatOpenState(t){(0,a.debugLog)("ðŸ’¬ Notificando estado del chat al UnreadMessagesService: "+(t?"abierto":"cerrado")),this.unreadService.setChatOpenState(t),t&&(this.hideBadge(),(0,a.debugLog)("ðŸš« Badge ocultado porque el chat estÃ¡ abierto"))}getUnreadService(){return this.unreadService}getButtonElement(){return this.button}}},3038:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EventQueueManager=void 0;const i=n(3974);class s{constructor(t={}){var e,n;this.queue=[],this.maxSize=null!==(e=t.maxSize)&&void 0!==e?e:s.DEFAULT_MAX_SIZE,this.persistEnabled=null===(n=t.persistEnabled)||void 0===n||n,this.persistEnabled&&this.loadFromStorage(),(0,i.debugLog)(`[EventQueueManager] âœ… Inicializado (maxSize: ${this.maxSize}, persist: ${this.persistEnabled})`)}enqueue(t){return this.queue.length>=this.maxSize&&((0,i.debugLog)(`[EventQueueManager] âš ï¸ Cola llena (${this.maxSize}), descartando evento mÃ¡s antiguo`),this.queue.shift()),this.queue.push(t),this.persistEnabled&&this.queue.length%10==0&&this.saveToStorage(),(0,i.debugLog)(`[EventQueueManager] âž• Evento encolado (total: ${this.queue.length})`),!0}getBatch(t=500){const e=Math.min(t,this.queue.length);return this.queue.slice(0,e)}dequeue(t){const e=this.queue.splice(0,t);(0,i.debugLog)(`[EventQueueManager] âž– ${e.length} eventos eliminados (quedan: ${this.queue.length})`),this.persistEnabled&&this.saveToStorage()}clear(){this.queue=[],(0,i.debugLog)("[EventQueueManager] ðŸ—‘ï¸ Cola limpiada"),this.persistEnabled&&this.saveToStorage()}size(){return this.queue.length}isEmpty(){return 0===this.queue.length}loadFromStorage(){if("undefined"!=typeof localStorage)try{const t=localStorage.getItem(s.STORAGE_KEY);if(!t)return void(0,i.debugLog)("[EventQueueManager] ðŸ“­ No hay cola persistida");const e=JSON.parse(t);if(!Array.isArray(e))return void(0,i.debugLog)("[EventQueueManager] âš ï¸ Formato de cola invÃ¡lido, ignorando");this.queue=e.filter(this.isValidEvent),(0,i.debugLog)(`[EventQueueManager] ðŸ“‚ ${this.queue.length} eventos cargados desde localStorage`)}catch(t){this.queue=[]}else(0,i.debugLog)("[EventQueueManager] âš ï¸ localStorage no disponible")}saveToStorage(){if("undefined"!=typeof localStorage)try{const t=JSON.stringify(this.queue);localStorage.setItem(s.STORAGE_KEY,t),(0,i.debugLog)(`[EventQueueManager] ðŸ’¾ Cola guardada en localStorage (${this.queue.length} eventos)`)}catch(t){if(t instanceof DOMException&&"QuotaExceededError"===t.name){(0,i.debugLog)("[EventQueueManager] âš ï¸ Quota excedida, limpiando 50% de eventos antiguos");const t=Math.floor(this.queue.length/2);this.queue=this.queue.slice(t);try{localStorage.setItem(s.STORAGE_KEY,JSON.stringify(this.queue))}catch(t){}}}}isValidEvent(t){return t&&"object"==typeof t&&"string"==typeof t.visitorId&&"string"==typeof t.sessionId&&"string"==typeof t.eventType&&"object"==typeof t.metadata}getStats(){return{size:this.queue.length,maxSize:this.maxSize,utilizationPercent:this.queue.length/this.maxSize*100,persistEnabled:this.persistEnabled}}}e.EventQueueManager=s,s.STORAGE_KEY="guiders_tracking_v2_queue",s.DEFAULT_MAX_SIZE=1e4},3104:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.WebSocketService=void 0;const i=n(8007),s=n(6161),a=n(2597),o=n(3974);class r{constructor(){this.socket=null,this.state=s.WebSocketState.DISCONNECTED,this.config=null,this.callbacks={},this.currentRooms=new Set,this.currentVisitorId=null,this.lastActivityEmit=0,this.ACTIVITY_THROTTLE_MS=3e4,this.activityHandler=null,this.visibilityHandler=null,this.manualReconnectAttempt=0,this.manualReconnectTimeout=null,(0,o.debugLog)("ðŸ“¡ [WebSocketService] Instancia creada")}static getInstance(){return r.instance||(r.instance=new r),r.instance}emitUserActivity(t=!1){var e;if(!(null===(e=this.socket)||void 0===e?void 0:e.connected))return;const n=Date.now();!t&&n-this.lastActivityEmit<this.ACTIVITY_THROTTLE_MS||(this.lastActivityEmit=n,this.socket.emit("user:activity"),(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸŽ¯ user:activity emitido"+(t?" (forzado)":"")))}setupActivityListeners(){"undefined"!=typeof document&&(this.activityHandler=()=>this.emitUserActivity(),["mousemove","keydown","click","scroll","touchstart"].forEach((t=>{document.addEventListener(t,this.activityHandler,{passive:!0})})),(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ‘‚ Activity listeners configurados"))}cleanupActivityListeners(){"undefined"!=typeof document&&this.activityHandler&&(["mousemove","keydown","click","scroll","touchstart"].forEach((t=>{document.removeEventListener(t,this.activityHandler)})),this.activityHandler=null,(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ§¹ Activity listeners eliminados"))}setupVisibilityHandler(){"undefined"!=typeof document&&"undefined"!=typeof window&&(this.visibilityHandler=()=>{(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ‘ï¸ Visibilidad/foco detectado"),this.socket&&this.config&&(this.socket.connected?this.emitUserActivity(!0):((0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ”„ Reconectando..."),this.socket.connect()))},document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState&&this.visibilityHandler()})),window.addEventListener("focus",this.visibilityHandler),(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ‘ï¸ Visibility handlers configurados"))}cleanupVisibilityHandler(){this.visibilityHandler&&("undefined"!=typeof window&&window.removeEventListener("focus",this.visibilityHandler),this.visibilityHandler=null,(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ§¹ Visibility + focus handlers eliminados"))}connect(t,e={}){if(this.socket&&this.socket.connected)return void(0,o.debugLog)("ðŸ“¡ [WebSocketService] âš ï¸ Ya hay una conexiÃ³n activa");const n=a.EndpointManager.getInstance().getWebSocketEndpoint();(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ” INICIO DE CONEXIÃ“N WebSocket"),(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ“‹ Endpoint resuelto:",n),(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ“‹ Config recibida:",{url:t.url,path:t.path,hasAuthToken:!!t.authToken,hasSessionId:!!t.sessionId}),this.config={url:t.url||n,path:t.path||"/socket.io/",transports:t.transports||["websocket","polling"],withCredentials:void 0===t.withCredentials||t.withCredentials,reconnection:void 0===t.reconnection||t.reconnection,reconnectionAttempts:t.reconnectionAttempts||1/0,reconnectionDelay:t.reconnectionDelay||1e3,authToken:t.authToken,sessionId:t.sessionId},this.callbacks=e,(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸš€ INTENTANDO CONECTAR a:",{url:this.config.url,fullUrl:this.config.url+this.config.path,path:this.config.path,transports:this.config.transports,withCredentials:this.config.withCredentials,reconnection:this.config.reconnection,reconnectionAttempts:this.config.reconnectionAttempts,hasToken:!!this.config.authToken,hasSessionId:!!this.config.sessionId}),(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸŒ URL COMPLETA WebSocket:",`${this.config.url}${this.config.path}`);const s={path:this.config.path,transports:this.config.transports,withCredentials:this.config.withCredentials,reconnection:this.config.reconnection,reconnectionAttempts:this.config.reconnectionAttempts,reconnectionDelay:this.config.reconnectionDelay},r=localStorage.getItem("visitorId"),c=localStorage.getItem("tenantId")||t.tenantId;s.auth={visitorId:r||"",tenantId:c||""},this.config.authToken&&(s.auth.token=this.config.authToken),(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ” Auth configurado:",{visitorId:r?`${r.substring(0,8)}...`:"null",tenantId:c?`${c.substring(0,8)}...`:"null",hasToken:!!this.config.authToken}),this.socket=(0,i.io)(this.config.url,s),(0,o.debugLog)("ðŸ“¡ [WebSocketService] âœ… Socket.IO cliente creado"),(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ”Œ Esperando conexiÃ³n..."),this.registerEventListeners()}registerEventListeners(){this.socket&&(this.socket.on("connect",(()=>{var t,e,n,i,a,r,c;this.state=s.WebSocketState.CONNECTED,(0,o.debugLog)("ðŸ“¡ [WebSocketService] âœ…âœ…âœ… CONEXIÃ“N EXITOSA! âœ…âœ…âœ…"),(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ†” Socket ID:",null===(t=this.socket)||void 0===t?void 0:t.id),(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸŒ URL conectada:",null===(e=this.config)||void 0===e?void 0:e.url),(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ“ Path:",null===(n=this.config)||void 0===n?void 0:n.path),(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸš€ Transporte usado:",null===(c=null===(r=null===(a=null===(i=this.socket)||void 0===i?void 0:i.io)||void 0===a?void 0:a.engine)||void 0===r?void 0:r.transport)||void 0===c?void 0:c.name),this.cancelManualReconnection(),this.currentVisitorId&&((0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ”„ Re-uniÃ©ndose a sala de visitante:",this.currentVisitorId),this.joinVisitorRoom(this.currentVisitorId)),this.currentRooms.size>0&&((0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ”„ Re-uniÃ©ndose a salas activas:",Array.from(this.currentRooms)),this.currentRooms.forEach((t=>{this.joinChatRoom(t)}))),this.cleanupActivityListeners(),this.cleanupVisibilityHandler(),this.setupActivityListeners(),this.setupVisibilityHandler(),this.emitUserActivity(!0),this.callbacks.onConnect&&this.callbacks.onConnect()})),this.socket.on("disconnect",(t=>{var e;this.state=s.WebSocketState.DISCONNECTED,(0,o.debugLog)("ðŸ“¡ [WebSocketService] âš ï¸âš ï¸ DESCONECTADO âš ï¸âš ï¸"),(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ“‹ RazÃ³n:",t),(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸŒ URL que estaba conectada:",null===(e=this.config)||void 0===e?void 0:e.url),this.callbacks.onDisconnect&&this.callbacks.onDisconnect(t)})),this.socket.on("connect_error",(t=>{var e,n;this.state=s.WebSocketState.ERROR,(0,o.debugError)("ðŸ“¡ [WebSocketService] âŒâŒâŒ ERROR DE CONEXIÃ“N âŒâŒâŒ"),(0,o.debugError)("ðŸ“¡ [WebSocketService] ðŸŒ URL intentada:",null===(e=this.config)||void 0===e?void 0:e.url),(0,o.debugError)("ðŸ“¡ [WebSocketService] ðŸ“ Path:",null===(n=this.config)||void 0===n?void 0:n.path),(0,o.debugError)("ðŸ“¡ [WebSocketService] ðŸš¨ Mensaje de error:",t.message),(0,o.debugError)("ðŸ“¡ [WebSocketService] ðŸ“Š Error completo:",t),(0,o.debugError)("ðŸ“¡ [WebSocketService] ðŸ” Stack trace:",t.stack),this.callbacks.onError&&this.callbacks.onError(t)})),this.socket.on("error",(t=>{(0,o.debugError)("ðŸ“¡ [WebSocketService] âŒ ERROR GENÃ‰RICO del socket:",t)})),this.socket.io.on("reconnect_attempt",(t=>{var e;this.state=s.WebSocketState.RECONNECTING,(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ”„ INTENTO DE RECONEXIÃ“N #"+t),(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸŒ URL:",null===(e=this.config)||void 0===e?void 0:e.url)})),this.socket.io.on("reconnect",(t=>{this.state=s.WebSocketState.CONNECTED,(0,o.debugLog)("ðŸ“¡ [WebSocketService] âœ… Reconectado despuÃ©s de",t,"intentos")})),this.socket.io.on("reconnect_failed",(()=>{this.state=s.WebSocketState.ERROR,(0,o.debugError)("ðŸ“¡ [WebSocketService] âŒâŒâŒ RECONEXIÃ“N FALLIDA - todos los intentos agotados"),(0,o.debugError)("ðŸ“¡ [WebSocketService] ðŸ”„ Iniciando reconexiÃ³n manual con backoff exponencial..."),this.startManualReconnection()})),this.socket.io.on("reconnect_error",(t=>{(0,o.debugError)("ðŸ“¡ [WebSocketService] âš ï¸ Error en intento de reconexiÃ³n:",t.message)})),this.socket.on("message:new",(t=>{(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ“¨ Nuevo mensaje recibido:",{messageId:t.messageId,chatId:t.chatId,senderId:t.senderId,content:t.content.substring(0,50)+"..."}),this.callbacks.onMessage&&this.callbacks.onMessage(t)})),this.socket.on("chat:status",(t=>{(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ“Š Estado del chat actualizado:",t),this.callbacks.onChatStatus&&this.callbacks.onChatStatus(t)})),this.socket.on("user:typing",(t=>{(0,o.debugLog)("ðŸ“¡ [WebSocketService] âœï¸ Typing indicator:",t),this.callbacks.onTyping&&this.callbacks.onTyping(t)})),this.socket.on("chat:created",(t=>{(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸŽ‰ Chat creado proactivamente:",{chatId:t.chatId,visitorId:t.visitorId,status:t.status,message:t.message}),this.callbacks.onChatCreated&&this.callbacks.onChatCreated(t)})),this.socket.on("typing:start",(t=>{(0,o.debugLog)("ðŸ“¡ [WebSocketService] âœï¸ typing:start recibido:",{chatId:t.chatId,userId:t.userId,userType:t.userType}),this.callbacks.onTypingStart&&this.callbacks.onTypingStart(t)})),this.socket.on("typing:stop",(t=>{(0,o.debugLog)("ðŸ“¡ [WebSocketService] âœï¸ typing:stop recibido:",{chatId:t.chatId,userId:t.userId,userType:t.userType}),this.callbacks.onTypingStop&&this.callbacks.onTypingStop(t)})),this.socket.on("presence:changed",(t=>{(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸŸ¢ presence:changed recibido:",{userId:t.userId,userType:t.userType,status:t.status,previousStatus:t.previousStatus}),this.callbacks.onPresenceChanged&&this.callbacks.onPresenceChanged(t)})),this.socket.on("presence:joined",(t=>{(0,o.debugLog)("ðŸ“¡ [WebSocketService] âœ… presence:joined recibido (auto-join):",{userId:t.userId,userType:t.userType,roomName:t.roomName,automatic:t.automatic,timestamp:t.timestamp}),t.automatic&&((0,o.debugLog)("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),(0,o.debugLog)("âœ… AUTO-JOIN AUTOMÃTICO CONFIRMADO"),(0,o.debugLog)(`ðŸ“ Sala personal: ${t.roomName}`),(0,o.debugLog)(`ðŸ‘¤ Usuario: ${t.userId.substring(0,8)}...`),(0,o.debugLog)(`ðŸŽ¯ Tipo: ${t.userType}`),(0,o.debugLog)("ðŸ”” Ahora recibirÃ¡s eventos de presencia filtrados (solo chats activos)"),(0,o.debugLog)("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")),this.callbacks.onPresenceJoined&&this.callbacks.onPresenceJoined(t)})),this.socket.on("visitor:joined",(t=>{(0,o.debugLog)("ðŸ“¡ [WebSocketService] âœ… ConfirmaciÃ³n de uniÃ³n a sala de visitante (legacy):",t)})),this.socket.on("visitor:left",(t=>{(0,o.debugLog)("ðŸ“¡ [WebSocketService] âœ… ConfirmaciÃ³n de salida de sala de visitante:",t)})),this.socket.on("ai:typing:start",(t=>{(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ¤– ai:typing:start recibido - IA generando respuesta:",{chatId:t.chatId}),this.callbacks.onAITypingStart&&this.callbacks.onAITypingStart(t)})),this.socket.on("ai:typing:stop",(t=>{(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ¤– ai:typing:stop recibido - IA terminÃ³ de generar:",{chatId:t.chatId}),this.callbacks.onAITypingStop&&this.callbacks.onAITypingStop(t)})))}joinChatRoom(t){if(!this.socket||!this.socket.connected)return void(0,o.debugWarn)("ðŸ“¡ [WebSocketService] âš ï¸ No conectado, no se puede unir a sala:",t);(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸšª UniÃ©ndose a sala de chat:",t);const e={chatId:t};this.socket.emit("chat:join",e),this.currentRooms.add(t)}leaveChatRoom(t){if(!this.socket||!this.socket.connected)return void(0,o.debugWarn)("ðŸ“¡ [WebSocketService] âš ï¸ No conectado, no se puede salir de sala:",t);(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸšª Saliendo de sala de chat:",t);const e={chatId:t};this.socket.emit("chat:leave",e),this.currentRooms.delete(t)}emitTyping(t,e){if(!this.socket||!this.socket.connected)return void(0,o.debugWarn)("ðŸ“¡ [WebSocketService] âš ï¸ No conectado, no se puede emitir typing");const n={chatId:t,isTyping:e};this.socket.emit("user:typing",n)}emitTypingStart(t,e,n="visitor"){if(!this.socket||!this.socket.connected)return void(0,o.debugWarn)("ðŸ“¡ [WebSocketService] âš ï¸ No conectado, no se puede emitir typing:start");const i={chatId:t,userId:e,userType:n};(0,o.debugLog)("ðŸ“¡ [WebSocketService] âœï¸ Emitiendo typing:start:",i),this.socket.emit("typing:start",i)}emitTypingStop(t,e,n="visitor"){if(!this.socket||!this.socket.connected)return void(0,o.debugWarn)("ðŸ“¡ [WebSocketService] âš ï¸ No conectado, no se puede emitir typing:stop");const i={chatId:t,userId:e,userType:n};(0,o.debugLog)("ðŸ“¡ [WebSocketService] âœï¸ Emitiendo typing:stop:",i),this.socket.emit("typing:stop",i)}joinVisitorRoom(t){if(!this.socket||!this.socket.connected)return void(0,o.debugWarn)("ðŸ“¡ [WebSocketService] âš ï¸ No conectado, no se puede unir a sala de visitante:",t);(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸšª UniÃ©ndose a sala de visitante:",t);const e={visitorId:t};this.socket.emit("visitor:join",e,(e=>{(null==e?void 0:e.success)?((0,o.debugLog)("ðŸ“¡ [WebSocketService] âœ… Unido a sala de visitante:",e.roomName),this.currentVisitorId=t):(0,o.debugError)("ðŸ“¡ [WebSocketService] âŒ Error al unirse a sala de visitante:",null==e?void 0:e.message)}))}leaveVisitorRoom(t){if(!this.socket||!this.socket.connected)return void(0,o.debugWarn)("ðŸ“¡ [WebSocketService] âš ï¸ No conectado, no se puede salir de sala de visitante:",t);(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸšª Saliendo de sala de visitante:",t);const e={visitorId:t};this.socket.emit("visitor:leave",e,(t=>{(null==t?void 0:t.success)&&((0,o.debugLog)("ðŸ“¡ [WebSocketService] âœ… Saliste de sala de visitante"),this.currentVisitorId=null)}))}startManualReconnection(){if(!this.socket||!this.config)return void(0,o.debugError)("ðŸ“¡ [WebSocketService] âš ï¸ No hay socket o config para reconexiÃ³n manual");this.manualReconnectAttempt++;const t=Math.min(1e3*Math.pow(2,this.manualReconnectAttempt-1),3e4),e=.2*t*(2*Math.random()-1),n=Math.round(t+e);(0,o.debugLog)(`ðŸ“¡ [WebSocketService] ðŸ”„ ReconexiÃ³n manual #${this.manualReconnectAttempt} en ${n}ms`),this.manualReconnectTimeout=setTimeout((()=>{this.socket&&!this.socket.connected&&((0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ”„ Intentando reconexiÃ³n manual..."),this.socket.connect(),setTimeout((()=>{this.socket&&!this.socket.connected?this.startManualReconnection():this.manualReconnectAttempt=0}),1e4))}),n)}cancelManualReconnection(){this.manualReconnectTimeout&&(clearTimeout(this.manualReconnectTimeout),this.manualReconnectTimeout=null),this.manualReconnectAttempt=0}disconnect(){this.socket&&((0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ”Œ Desconectando..."),this.cancelManualReconnection(),this.cleanupActivityListeners(),this.currentVisitorId&&this.leaveVisitorRoom(this.currentVisitorId),this.currentRooms.forEach((t=>{this.leaveChatRoom(t)})),this.socket.disconnect(),this.socket=null,this.state=s.WebSocketState.DISCONNECTED,this.currentRooms.clear(),this.currentVisitorId=null)}getState(){return this.state}isConnected(){var t;return(null===(t=this.socket)||void 0===t?void 0:t.connected)||!1}getSocketId(){var t;return null===(t=this.socket)||void 0===t?void 0:t.id}getCurrentRooms(){return Array.from(this.currentRooms)}updateCallbacks(t){const e=this.callbacks.onConnect,n=this.callbacks.onDisconnect,i=this.callbacks.onError,s=this.callbacks.onMessage,a=this.callbacks.onChatStatus,r=this.callbacks.onTyping,c=this.callbacks.onChatCreated,d=this.callbacks.onTypingStart,l=this.callbacks.onTypingStop,h=this.callbacks.onPresenceChanged,u={};(e||t.onConnect)&&(u.onConnect=()=>{e&&e(),t.onConnect&&t.onConnect()}),(n||t.onDisconnect)&&(u.onDisconnect=e=>{n&&n(e),t.onDisconnect&&t.onDisconnect(e)}),(i||t.onError)&&(u.onError=e=>{i&&i(e),t.onError&&t.onError(e)}),(s||t.onMessage)&&(u.onMessage=e=>{s&&s(e),t.onMessage&&t.onMessage(e)}),(a||t.onChatStatus)&&(u.onChatStatus=e=>{a&&a(e),t.onChatStatus&&t.onChatStatus(e)}),(r||t.onTyping)&&(u.onTyping=e=>{r&&r(e),t.onTyping&&t.onTyping(e)}),(c||t.onChatCreated)&&(u.onChatCreated=e=>{c&&c(e),t.onChatCreated&&t.onChatCreated(e)}),(d||t.onTypingStart)&&(u.onTypingStart=e=>{d&&d(e),t.onTypingStart&&t.onTypingStart(e)}),(l||t.onTypingStop)&&(u.onTypingStop=e=>{l&&l(e),t.onTypingStop&&t.onTypingStop(e)}),(h||t.onPresenceChanged)&&(u.onPresenceChanged=e=>{h&&h(e),t.onPresenceChanged&&t.onPresenceChanged(e)});const g=this.callbacks.onAITypingStart;(g||t.onAITypingStart)&&(u.onAITypingStart=e=>{g&&g(e),t.onAITypingStart&&t.onAITypingStart(e)});const p=this.callbacks.onAITypingStop;(p||t.onAITypingStop)&&(u.onAITypingStop=e=>{p&&p(e),t.onAITypingStop&&t.onAITypingStop(e)}),this.callbacks=u,(0,o.debugLog)("ðŸ“¡ [WebSocketService] ðŸ”„ Callbacks actualizados y fusionados")}}e.WebSocketService=r},3129:function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function r(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.ChatUI=void 0;const s=n(3974),a=n(8334),o=n(9167),r=n(4412),c=n(5649),d=n(2782),l=n(5770),h=n(7330);e.ChatUI=class{constructor(t={}){if(this.container=null,this.containerMessages=null,this.currentIndex=null,this.chatId=null,this.visitorId=null,this.chatDetail=null,this.lastKnownChatStatus=null,this.lastNotificationType=null,this.messagesLoaded=!1,this.isLoadingInitialMessages=!1,this.openCallbacks=[],this.closeCallbacks=[],this.initializationCallbacks=[],this.activeIntervals=[],this.titleElement=null,this.subtitleElement=null,this.typingIndicator=null,this.lastMessageDate=null,this.avatarElement=null,this.avatarStatusDot=null,this.avatarContainer=null,this.offlineBanner=null,this.presenceService=null,this.presenceUnsubscribe=null,this.typingUnsubscribe=null,this.showOfflineBannerEnabled=!0,this.chatConsentMessageShown=!1,this.quickActionsUI=null,this.onQuickActionSendMessage=null,this.onQuickActionRequestAgent=null,this.onTrackQuickAction=null,this.isCreatingChatFlag=!1,this.chatCreationPromise=null,this.chatCreationResolve=null,this.options=Object.assign({widget:!1,widgetWidth:"300px",widgetHeight:"400px",userBgColor:"#007bff",otherBgColor:"#6c757d",textColor:"#fff",maxWidthMessage:"80%"},t),this.chatConsentMessageConfig=Object.assign({enabled:!1,message:"Al unirte al chat, confirmas que has leÃ­do y entiendes nuestra",privacyPolicyUrl:"/privacy",privacyPolicyText:"PolÃ­tica de Privacidad",cookiesPolicyUrl:"/cookies",cookiesPolicyText:"PolÃ­tica de Cookies",showOnce:!0},t.chatConsentMessage),this.quickActionsConfig=Object.assign({enabled:!1,welcomeMessage:"Â¡Hola! ðŸ‘‹ Â¿En quÃ© puedo ayudarte?",showOnFirstOpen:!0,showOnChatStart:!0,buttons:[]},t.quickActions),(0,s.debugLog)("ðŸ’¬ [ChatUI] Quick Actions config:",this.quickActionsConfig),t.ai&&(d.MessageRenderer.setAIConfig(t.ai),(0,s.debugLog)("ðŸ’¬ [ChatUI] ðŸ¤– AI config aplicada:",t.ai)),this.resolvedPosition=(0,l.resolvePosition)(t.position,t.mobileDetection),(0,s.debugLog)("ðŸ’¬ [ChatUI] PosiciÃ³n resuelta:",this.resolvedPosition),this.options.containerId){const t=document.getElementById(this.options.containerId);if(!t)throw new Error(`No se encontrÃ³ el contenedor con ID "${this.options.containerId}"`);this.container=t}}init(){if(!this.container||this.options.widget){const t=document.createElement("div");t.classList.add("chat-widget-host"),document.body.appendChild(t);const e=t.attachShadow({mode:"open"});this.container=document.createElement("div"),this.container.classList.add("chat-widget"),this.options.widget&&this.container.classList.add("chat-widget-fixed"),this.container.style.display="none",this.container.style.opacity="0",this.container.style.transform="translateY(20px)",this.container.setAttribute("data-initial-state","hidden"),(0,s.debugLog)("Chat inicializado con estado: oculto"),e.appendChild(this.container),this.createChatHeader(),this.injectStyles(e)}else this.container&&!this.options.widget||(this.container=document.createElement("div"),this.container.classList.add("chat-widget"),document.body.appendChild(this.container),this.options.widget&&this.container.classList.add("chat-widget-fixed"));this.createChatBody(),this.initializeChatContent()}createChatHeader(){if(!this.container)return;const t=document.createElement("div");t.className="chat-header";const e=document.createElement("div");e.className="chat-header-main",e.style.display="flex",e.style.alignItems="center",e.style.gap="12px",e.style.flex="1";const n=document.createElement("div");n.className="chat-header-avatar-container",n.style.position="relative",n.style.display="none";const i=document.createElement("div");i.className="chat-header-avatar",i.innerHTML='\n\t\t\t<svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t<path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="white"/>\n\t\t\t</svg>\n\t\t';const s=document.createElement("span");s.className="avatar-status-dot status-offline",n.appendChild(i),n.appendChild(s),this.avatarElement=i,this.avatarStatusDot=s,this.avatarContainer=n;const a=document.createElement("div");a.className="chat-header-title-container",a.style.display="flex",a.style.flexDirection="column",a.style.flex="1",a.style.minWidth="0";const o=document.createElement("div");o.className="chat-header-title",o.textContent="Chat",this.titleElement=o,a.appendChild(o),e.appendChild(n),e.appendChild(a),t.appendChild(e);const r=document.createElement("div");r.className="chat-header-actions";const c=document.createElement("button");c.className="chat-close-btn",c.setAttribute("aria-label","Cerrar chat"),c.innerHTML='\n\t\t\t<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t<path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n\t\t\t</svg>\n\t\t',c.addEventListener("click",(()=>{this.hide()})),r.appendChild(c),t.appendChild(r),this.container.appendChild(t)}createOfflineBanner(){this.container&&(this.offlineBanner=document.createElement("div"),this.offlineBanner.className="guiders-offline-banner",this.offlineBanner.style.cssText="\n\t\t\tdisplay: none;\n\t\t\tbackground: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);\n\t\t\tcolor: #856404;\n\t\t\tpadding: 12px 16px;\n\t\t\ttext-align: center;\n\t\t\tfont-size: 13px;\n\t\t\tborder-bottom: 1px solid #ffeaa7;\n\t\t\tbox-shadow: 0 2px 4px rgba(0,0,0,0.05);\n\t\t",this.offlineBanner.innerHTML='\n\t\t\t<div style="display: flex; align-items: center; justify-content: center; gap: 8px;">\n\t\t\t\t<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t\t<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" fill="#856404"/>\n\t\t\t\t</svg>\n\t\t\t\t<span>El agente estÃ¡ temporalmente desconectado. Te responderÃ¡ cuando vuelva a estar disponible.</span>\n\t\t\t</div>\n\t\t',this.container.appendChild(this.offlineBanner))}createChatBody(){if(!this.container)return;this.createOfflineBanner();const t=document.createElement("div");t.className="chat-messages",this.container.appendChild(t),this.containerMessages=t,this.createQuickActions();const e=document.createElement("div");e.className="chat-messages-bottom",this.containerMessages.appendChild(e),this.container.style.display="none",this.container.style.flexDirection="column",this.container.style.gap="0",this.container.setAttribute("data-content-ready","true"),this.containerMessages.addEventListener("scroll",(()=>{}))}createQuickActions(){if(!this.containerMessages)return;if(!this.quickActionsConfig.enabled||0===this.quickActionsConfig.buttons.length)return void(0,s.debugLog)("ðŸ’¬ [ChatUI] Quick Actions deshabilitado o sin botones");this.quickActionsUI=new h.QuickActionsUI(this.quickActionsConfig),this.quickActionsUI.onSendMessage=(t,e)=>{this.handleQuickActionSendMessage(t,e)},this.quickActionsUI.onRequestAgent=()=>{this.handleQuickActionRequestAgent()},this.quickActionsUI.onOpenUrl=t=>{this.handleQuickActionOpenUrl(t)},this.quickActionsUI.onActionClicked=(t,e)=>{this.trackQuickActionClick(t,e)};const t=this.quickActionsUI.render();t.style.display="none";const e=this.containerMessages.querySelector(".chat-messages-bottom");e?this.containerMessages.insertBefore(t,e):this.containerMessages.appendChild(t),(0,s.debugLog)("ðŸ’¬ [ChatUI] Quick Actions creado")}handleQuickActionSendMessage(t,e){return i(this,void 0,void 0,(function*(){(0,s.debugLog)("ðŸ’¬ [ChatUI] Quick Action: enviar mensaje",t),this.onQuickActionSendMessage&&(yield this.onQuickActionSendMessage(t,e))}))}handleQuickActionRequestAgent(){return i(this,void 0,void 0,(function*(){(0,s.debugLog)("ðŸ’¬ [ChatUI] Quick Action: solicitar agente humano"),this.onQuickActionRequestAgent&&(yield this.onQuickActionRequestAgent())}))}handleQuickActionOpenUrl(t){(0,s.debugLog)("ðŸ’¬ [ChatUI] Quick Action: abrir URL",t)}trackQuickActionClick(t,e){(0,s.debugLog)("ðŸ’¬ [ChatUI] Quick Action clicked:",t,e.type),this.onTrackQuickAction&&this.onTrackQuickAction({eventType:"quick_action_clicked",buttonId:t,actionType:e.type,timestamp:Date.now()})}injectStyles(t){const e=document.createElement("style");e.textContent=this.getChatStyles(),t.appendChild(e)}getChatStyles(){const t=this.resolvedPosition.widget;return`\n\t\t\t@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap');\n\t\t\t:host { all: initial; font-family: 'Inter', sans-serif; }\n\n\t\t\t.chat-widget {\n\t\t\t\tbox-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08);\n\t\t\t\tborder-radius: 12px;\n\t\t\t\toverflow: hidden;\n\t\t\t\tbackground: #ffffff;\n\t\t\t\tfont-family: 'Inter', sans-serif;\n\t\t\t\tdisplay: flex;\n\t\t\t\tflex-direction: column;\n\t\t\t\ttransition: box-shadow 0.3s cubic-bezier(0.175,0.885,0.32,1.275);\n\t\t\t}\n\n\t\t\t.chat-widget-fixed {\n\t\t\t\twidth: 340px;\n\t\t\t\theight: 520px;\n\t\t\t\tposition: fixed;\n\t\t\t\t${`\n\t\t\t${t.top?`top: ${t.top};`:""}\n\t\t\t${t.bottom?`bottom: ${t.bottom};`:""}\n\t\t\t${t.left?`left: ${t.left};`:""}\n\t\t\t${t.right?`right: ${t.right};`:""}\n\t\t`.trim()}\n\t\t\t\ttransition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);\n\t\t\t\tz-index: 2147483647;\n\t\t\t\tdisplay: flex;\n\t\t\t\tflex-direction: column;\n\t\t\t}\n\t\t\t\n\t\t\t/* ðŸ“± ESTILOS MÃ“VIL - Chat pantalla completa */\n\t\t\t@media (max-width: 768px) {\n\t\t\t\t.chat-widget-fixed {\n\t\t\t\t\twidth: 100% !important;\n\t\t\t\t\theight: 100% !important;\n\t\t\t\t\ttop: 0 !important;\n\t\t\t\t\tleft: 0 !important;\n\t\t\t\t\tright: 0 !important;\n\t\t\t\t\tbottom: 0 !important;\n\t\t\t\t\tborder-radius: 0 !important;\n\t\t\t\t\tmax-width: 100vw;\n\t\t\t\t\tmax-height: 100vh;\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t.chat-header {\n\t\t\t\tbackground: #ffffff;\n\t\t\t\tcolor: #111827;\n\t\t\t\tpadding: 16px 20px;\n\t\t\t\tdisplay: flex;\n\t\t\t\talign-items: center;\n\t\t\t\tjustify-content: space-between;\n\t\t\t\tborder-top-left-radius: 12px;\n\t\t\t\tborder-top-right-radius: 12px;\n\t\t\t\tborder-bottom: 1px solid #e5e7eb;\n\t\t\t}\n\n\t\t\t/* ðŸ“± Header mÃ³vil sin border-radius superior */\n\t\t\t@media (max-width: 768px) {\n\t\t\t\t.chat-header {\n\t\t\t\t\tborder-top-left-radius: 0 !important;\n\t\t\t\t\tborder-top-right-radius: 0 !important;\n\t\t\t\t\tpadding: 18px 20px;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t.chat-header-main {\n\t\t\t\tdisplay: flex;\n\t\t\t\talign-items: center;\n\t\t\t\tgap: 12px;\n\t\t\t\tflex: 1;\n\t\t\t\tmin-width: 0;\n\t\t\t}\n\n\t\t\t.chat-header-avatar-container {\n\t\t\t\tposition: relative;\n\t\t\t\tflex-shrink: 0;\n\t\t\t}\n\n\t\t\t.chat-header-avatar {\n\t\t\t\twidth: 44px;\n\t\t\t\theight: 44px;\n\t\t\t\tborder-radius: 50%;\n\t\t\t\tbackground: rgba(255, 255, 255, 0.2);\n\t\t\t\tbackdrop-filter: blur(10px);\n\t\t\t\tdisplay: flex;\n\t\t\t\talign-items: center;\n\t\t\t\tjustify-content: center;\n\t\t\t\tborder: 2px solid rgba(255, 255, 255, 0.3);\n\t\t\t\tbox-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);\n\t\t\t}\n\n\t\t\t.chat-header-avatar svg {\n\t\t\t\twidth: 24px;\n\t\t\t\theight: 24px;\n\t\t\t}\n\n\t\t\t/* Punto de estado en el avatar (estilo WhatsApp/Messenger) */\n\t\t\t.avatar-status-dot {\n\t\t\t\tposition: absolute;\n\t\t\t\tbottom: 0;\n\t\t\t\tright: 0;\n\t\t\t\twidth: 10px;\n\t\t\t\theight: 10px;\n\t\t\t\tborder-radius: 50%;\n\t\t\t\tborder: 1.5px solid #ffffffff; /* Mismo color del gradiente para consistencia */\n\t\t\t\ttransition: all 0.3s ease;\n\t\t\t}\n\n\t\t\t.avatar-status-dot.status-online {\n\t\t\t\tbackground-color: #10b981;\n\t\t\t\tbox-shadow: 0 0 0 2px rgba(16, 185, 129, 0.2);\n\t\t\t}\n\n\t\t\t.avatar-status-dot.status-offline {\n\t\t\t\tbackground-color: #6b7280;\n\t\t\t}\n\n\t\t\t.avatar-status-dot.status-away {\n\t\t\t\tbackground-color: #f59e0b;\n\t\t\t\tbox-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);\n\t\t\t}\n\n\t\t\t.avatar-status-dot.status-busy {\n\t\t\t\tbackground-color: #ef4444;\n\t\t\t\tbox-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);\n\t\t\t}\n\n\t\t\t.avatar-status-dot.status-chatting {\n\t\t\t\tbackground-color: #60a5fa;\n\t\t\t\tbox-shadow: 0 0 0 2px rgba(96, 165, 250, 0.2);\n\t\t\t}\n\n\t\t\t.chat-header-title-container {\n\t\t\t\tdisplay: flex;\n\t\t\t\tflex-direction: column;\n\t\t\t\tgap: 4px;\n\t\t\t\tflex: 1;\n\t\t\t\tmin-width: 0;\n\t\t\t}\n\n\t\t\t.chat-header-title {\n\t\t\t\tfont-weight: 600;\n\t\t\t\tfont-size: 16px;\n\t\t\t\tletter-spacing: -0.01em;\n\t\t\t\twhite-space: nowrap;\n\t\t\t\toverflow: hidden;\n\t\t\t\ttext-overflow: ellipsis;\n\t\t\t}\n\n\t\t\t.chat-header-actions {\n\t\t\t\tdisplay: flex;\n\t\t\t\talign-items: center;\n\t\t\t\tgap: 8px;\n\t\t\t\tflex-shrink: 0;\n\t\t\t}\n\t\t\t\n\t\t\t.chat-close-btn {\n\t\t\t\tbackground: transparent;\n\t\t\t\tborder: none;\n\t\t\t\tcolor: #6b7280;\n\t\t\t\tcursor: pointer;\n\t\t\t\twidth: 32px;\n\t\t\t\theight: 32px;\n\t\t\t\tdisplay: flex;\n\t\t\t\talign-items: center;\n\t\t\t\tjustify-content: center;\n\t\t\t\tpadding: 0;\n\t\t\t\topacity: 0.9;\n\t\t\t\ttransition: all 0.2s ease;\n\t\t\t\tborder-radius: 50%;\n\t\t\t}\n\n\t\t\t.chat-close-btn:hover {\n\t\t\t\topacity: 1;\n\t\t\t\tbackground: rgba(0, 0, 0, 0.05);\n\t\t\t\tcolor: #111827;\n\t\t\t}\n\n\t\t\t.chat-close-btn:active {\n\t\t\t\ttransform: scale(0.95);\n\t\t\t\tbackground: rgba(0, 0, 0, 0.1);\n\t\t\t}\n\t\t\t\n\t\t\t.chat-close-btn svg {\n\t\t\t\twidth: 20px;\n\t\t\t\theight: 20px;\n\t\t\t}\n\t\t\t\n\t\t\t/* ðŸ“± BotÃ³n de cierre mÃ¡s visible en mÃ³vil */\n\t\t\t@media (max-width: 768px) {\n\t\t\t\t.chat-close-btn {\n\t\t\t\t\twidth: 36px;\n\t\t\t\t\theight: 36px;\n\t\t\t\t\tbackground: rgba(255, 255, 255, 0.15);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.chat-close-btn:hover {\n\t\t\t\t\tbackground: rgba(255, 255, 255, 0.25);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.chat-close-btn svg {\n\t\t\t\t\twidth: 22px;\n\t\t\t\t\theight: 22px;\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t.chat-messages {\n\t\t\t\tdisplay: flex;\n\t\t\t\tflex-direction: column;\n\t\t\t\tflex: 1;\n\t\t\t\toverflow-y: auto;\n\t\t\t\tpadding: 18px 16px 80px 16px;\n\t\t\t\tbackground: #ffffff;\n\t\t\t\tscroll-behavior: smooth;\n\t\t\t}\n\t\t\t\n\t\t\t.chat-message-wrapper {\n\t\t\t\tposition: relative;\n\t\t\t\tmargin-bottom: 16px;\n\t\t\t\tmax-width: 75%;\n\t\t\t\tdisplay: flex;\n\t\t\t\tflex-direction: column;\n\t\t\t}\n\t\t\t\n\t\t\t.chat-message {\n\t\t\t\tpadding: 10px 14px;\n\t\t\t\tborder-radius: 18px;\n\t\t\t\twhite-space: normal;\n\t\t\t\toverflow-wrap: break-word;\n\t\t\t\tword-wrap: break-word;\n\t\t\t\tline-height: 1.4;\n\t\t\t\tfont-size: 14px;\n\t\t\t\tposition: relative;\n\t\t\t}\n\n\t\t\t.chat-message-user-wrapper {\n\t\t\t\tdisplay: flex;\n\t\t\t\talign-self: flex-end;\n\t\t\t}\n\n\t\t\t.chat-message-user {\n\t\t\t\tbackground: #18181b;\n\t\t\t\tcolor: #ffffff;\n\t\t\t\tborder-bottom-right-radius: 4px;\n\t\t\t}\n\n\t\t\t.chat-message-other-wrapper {\n\t\t\t\talign-self: flex-start;\n\t\t\t\tdisplay: flex;\n\t\t\t\tgap: 8px;\n\t\t\t}\n\n\t\t\t.chat-message-other {\n\t\t\t\tbackground: #e4e4e7 !important;\n\t\t\t\tcolor: #18181b;\n\t\t\t\tborder-bottom-left-radius: 4px;\n\t\t\t}\n\t\t\t\n\t\t\t.chat-avatar {\n\t\t\t\twidth: 28px;\n\t\t\t\theight: 28px;\n\t\t\t\tborder-radius: 50%;\n\t\t\t\tbackground-color: #e1e9f1;\n\t\t\t\tdisplay: flex;\n\t\t\t\talign-items: center;\n\t\t\t\tjustify-content: center;\n\t\t\t\tflex-shrink: 0;\n\t\t\t}\n\t\t\t\n\t\t\t.chat-message-time {\n\t\t\t\tfont-size: 11px;\n\t\t\t\tcolor: #6b7280;\n\t\t\t\tmargin-top: 4px;\n\t\t\t\topacity: 0.85;\n\t\t\t}\n\n\t\t\t.chat-input-container {\n\t\t\t\tposition: absolute;\n\t\t\t\tbackground: #ffffff;\n\t\t\t\tbottom: 12px;\n\t\t\t\tleft: 12px;\n\t\t\t\tright: 12px;\n\t\t\t\tdisplay: -webkit-flex;\n\t\t\t\tdisplay: flex;\n\t\t\t\t-webkit-align-items: flex-end;\n\t\t\t\talign-items: flex-end;\n\t\t\t\tgap: 8px;\n\t\t\t\tborder-radius: 28px;\n\t\t\t\tbox-shadow: none;\n\t\t\t\tborder: 1px solid #e5e7eb;\n\t\t\t\tpadding: 6px 6px 6px 16px;\n\t\t\t\t/* Fix Safari: Asegurar que el contenedor mantenga su altura */\n\t\t\t\tbox-sizing: border-box;\n\t\t\t}\n\t\t\t\n\t\t\t/* ðŸ“± Input mÃ³vil */\n\t\t\t@media (max-width: 768px) {\n\t\t\t\t.chat-input-container {\n\t\t\t\t\tbottom: 8px;\n\t\t\t\t\tleft: 8px;\n\t\t\t\t\tright: 8px;\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t.chat-input-field {\n\t\t\t\t-webkit-flex: 1;\n\t\t\t\tflex: 1;\n\t\t\t\tborder: none;\n\t\t\t\tpadding: 8px 0;\n\t\t\t\tfont-size: 14px;\n\t\t\t\tfont-family: 'Inter', sans-serif;\n\t\t\t\toutline: none;\n\t\t\t\tbackground: transparent;\n\t\t\t\tcolor: #111827;\n\t\t\t\t/* Fix Safari: Asegurar que el input no cause overflow */\n\t\t\t\tmin-width: 0;\n\t\t\t\tbox-sizing: border-box;\n\t\t\t\t/* Textarea specific */\n\t\t\t\tresize: none;\n\t\t\t\toverflow: hidden;\n\t\t\t\tline-height: 1.4;\n\t\t\t\tmax-height: 120px;\n\t\t\t\tmin-height: 20px;\n\t\t\t}\n\n\t\t\t.chat-input-field:focus {\n\t\t\t\tbackground: transparent;\n\t\t\t}\n\t\t\t\n\t\t\t.chat-input-field::placeholder {\n\t\t\t\tcolor: #8a9aa9;\n\t\t\t}\n\t\t\t\n\t\t\t.chat-send-btn {\n\t\t\t\tbackground: #18181b;\n\t\t\t\tcolor: #ffffff;\n\t\t\t\tborder: none;\n\t\t\t\tborder-radius: 50%;\n\t\t\t\twidth: 36px;\n\t\t\t\theight: 36px;\n\t\t\t\tcursor: pointer;\n\t\t\t\tdisplay: -webkit-flex;\n\t\t\t\tdisplay: flex;\n\t\t\t\t-webkit-align-items: center;\n\t\t\t\talign-items: center;\n\t\t\t\t-webkit-justify-content: center;\n\t\t\t\tjustify-content: center;\n\t\t\t\ttransition: all 0.15s ease;\n\t\t\t\t-webkit-flex-shrink: 0;\n\t\t\t\tflex-shrink: 0;\n\t\t\t\t/* Fix Safari: Asegurar dimensiones exactas y prevenir compresiÃ³n */\n\t\t\t\tmin-width: 36px;\n\t\t\t\tmin-height: 36px;\n\t\t\t\tmax-width: 36px;\n\t\t\t\tmax-height: 36px;\n\t\t\t\tbox-sizing: border-box;\n\t\t\t}\n\n\t\t\t.chat-send-btn:hover {\n\t\t\t\tbackground: #27272a;\n\t\t\t\ttransform: scale(1.05);\n\t\t\t}\n\n\t\t\t.chat-send-btn:active {\n\t\t\t\t-webkit-transform: scale(0.95);\n\t\t\t\ttransform: scale(0.95);\n\t\t\t}\n\n\t\t\t.chat-send-btn::before {\n\t\t\t\tcontent: '';\n\t\t\t\twidth: 16px;\n\t\t\t\theight: 16px;\n\t\t\t\tbackground-image: url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M3.29106 3.3088C3.00745 3.18938 2.67967 3.25533 2.4643 3.47514C2.24894 3.69495 2.1897 4.02401 2.31488 4.30512L5.40752 11.25H13C13.4142 11.25 13.75 11.5858 13.75 12C13.75 12.4142 13.4142 12.75 13 12.75H5.40754L2.31488 19.6949C2.1897 19.976 2.24894 20.3051 2.4643 20.5249C2.67967 20.7447 3.00745 20.8107 3.29106 20.6912L22.2911 12.6913C22.5692 12.5742 22.75 12.3018 22.75 12C22.75 11.6983 22.5692 11.4259 22.2911 11.3088L3.29106 3.3088Z' fill='%23ffffff'/%3E%3C/svg%3E");\n\t\t\t\tbackground-repeat: no-repeat;\n\t\t\t\tbackground-position: center;\n\t\t\t\ttransition: all 0.2s ease;\n\t\t\t}\n\n\t\t\t.chat-send-btn:hover::before {\n\t\t\t\tbackground-image: url("data:image/svg+xml,%3Csvg width='20' height='20' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M3.29106 3.3088C3.00745 3.18938 2.67967 3.25533 2.4643 3.47514C2.24894 3.69495 2.1897 4.02401 2.31488 4.30512L5.40752 11.25H13C13.4142 11.25 13.75 11.5858 13.75 12C13.75 12.4142 13.4142 12.75 13 12.75H5.40754L2.31488 19.6949C2.1897 19.976 2.24894 20.3051 2.4643 20.5249C2.67967 20.7447 3.00745 20.8107 3.29106 20.6912L22.2911 12.6913C22.5692 12.5742 22.75 12.3018 22.75 12C22.75 11.6983 22.5692 11.4259 22.2911 11.3088L3.29106 3.3088Z' fill='%23111827'/%3E%3C/svg%3E");\n\t\t\t}\n\n\t\t\t/* ðŸŸ¢ Estilos para Presence Indicator */\n\t\t\t.guiders-presence-indicator {\n\t\t\t\tdisplay: inline-flex;\n\t\t\t\talign-items: center;\n\t\t\t\tgap: 6px;\n\t\t\t\tpadding: 4px 10px;\n\t\t\t\tbackground: rgba(255, 255, 255, 0.15);\n\t\t\t\tbackdrop-filter: blur(10px);\n\t\t\t\tborder-radius: 12px;\n\t\t\t\tborder: 1px solid rgba(255, 255, 255, 0.2);\n\t\t\t}\n\n\t\t\t.guiders-status-dot {\n\t\t\t\twidth: 6px;\n\t\t\t\theight: 6px;\n\t\t\t\tborder-radius: 50%;\n\t\t\t\tflex-shrink: 0;\n\t\t\t\ttransition: all 0.3s ease;\n\t\t\t\tborder: 2px solid white;\n\t\t\t}\n\n\t\t\t.guiders-status-online {\n\t\t\t\tbackground-color: #10b981;\n\t\t\t\tbox-shadow: 0 0 8px rgba(16, 185, 129, 0.6);\n\t\t\t}\n\n\t\t\t.guiders-status-offline {\n\t\t\t\tbackground-color: #6b7280;\n\t\t\t\tbox-shadow: none;\n\t\t\t}\n\n\t\t\t.guiders-status-busy {\n\t\t\t\tbackground-color: #ef4444;\n\t\t\t\tbox-shadow: 0 0 8px rgba(239, 68, 68, 0.6);\n\t\t\t}\n\n\t\t\t.guiders-status-away {\n\t\t\t\tbackground-color: #f59e0b;\n\t\t\t\tbox-shadow: 0 0 8px rgba(245, 158, 11, 0.6);\n\t\t\t}\n\n\t\t\t.guiders-status-chatting {\n\t\t\t\tbackground-color: #60a5fa;\n\t\t\t\tbox-shadow: 0 0 8px rgba(96, 165, 250, 0.6);\n\t\t\t}\n\n\t\t\t.guiders-status-text {\n\t\t\t\tfont-size: 11px;\n\t\t\t\tfont-weight: 500;\n\t\t\t\tcolor: rgba(255, 255, 255, 0.95);\n\t\t\t\tletter-spacing: 0.02em;\n\t\t\t\ttext-transform: capitalize;\n\t\t\t}\n\n\t\t\t.guiders-status-changing {\n\t\t\t\tanimation: statusPulse 0.3s ease;\n\t\t\t}\n\n\t\t\t@keyframes statusPulse {\n\t\t\t\t0%, 100% { opacity: 1; }\n\t\t\t\t50% { opacity: 0.7; }\n\t\t\t}\n\n\t\t\t/* ðŸ”´ Estilos para Offline Banner */\n\t\t\t.guiders-offline-banner {\n\t\t\t\tbackground: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);\n\t\t\t\tcolor: #856404;\n\t\t\t\tpadding: 12px 16px;\n\t\t\t\ttext-align: center;\n\t\t\t\tfont-size: 13px;\n\t\t\t\tborder-bottom: 1px solid #ffeaa7;\n\t\t\t\tbox-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);\n\t\t\t\tanimation: bannerSlideIn 0.3s ease-out;\n\t\t\t}\n\n\t\t\t@keyframes bannerSlideIn {\n\t\t\t\tfrom {\n\t\t\t\t\topacity: 0;\n\t\t\t\t\ttransform: translateY(-10px);\n\t\t\t\t}\n\t\t\t\tto {\n\t\t\t\t\topacity: 1;\n\t\t\t\t\ttransform: translateY(0);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t/* âœï¸ Estilos para Typing Indicator */\n\t\t\t.guiders-typing-indicator {\n\t\t\t\tdisplay: flex;\n\t\t\t\talign-items: center;\n\t\t\t\tgap: 8px;\n\t\t\t\tpadding: 12px 16px;\n\t\t\t\tmargin-bottom: 12px;\n\t\t\t\topacity: 0;\n\t\t\t\ttransition: opacity 0.2s ease;\n\t\t\t}\n\n\t\t\t.guiders-typing-bubble {\n\t\t\t\tbackground: #fff;\n\t\t\t\tborder: 1px solid #e1e9f1;\n\t\t\t\tborder-radius: 18px;\n\t\t\t\tpadding: 12px 16px;\n\t\t\t\tdisplay: flex;\n\t\t\t\talign-items: center;\n\t\t\t\tgap: 4px;\n\t\t\t\tbox-shadow: 0 1px 8px rgba(0, 0, 0, 0.08);\n\t\t\t}\n\n\t\t\t.guiders-typing-dot {\n\t\t\t\twidth: 8px;\n\t\t\t\theight: 8px;\n\t\t\t\tbackground-color: #8a9aa9;\n\t\t\t\tborder-radius: 50%;\n\t\t\t\tanimation: typingBounce 1.4s infinite ease-in-out;\n\t\t\t}\n\n\t\t\t.guiders-typing-dot:nth-child(1) {\n\t\t\t\tanimation-delay: 0s;\n\t\t\t}\n\n\t\t\t.guiders-typing-dot:nth-child(2) {\n\t\t\t\tanimation-delay: 0.15s;\n\t\t\t}\n\n\t\t\t.guiders-typing-dot:nth-child(3) {\n\t\t\t\tanimation-delay: 0.3s;\n\t\t\t}\n\n\t\t\t@keyframes typingBounce {\n\t\t\t\t0%, 60%, 100% {\n\t\t\t\t\ttransform: translateY(0);\n\t\t\t\t\topacity: 0.4;\n\t\t\t\t}\n\t\t\t\t30% {\n\t\t\t\t\ttransform: translateY(-8px);\n\t\t\t\t\topacity: 1;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t.guiders-typing-text {\n\t\t\t\tfont-size: 13px;\n\t\t\t\tcolor: #8a9aa9;\n\t\t\t\tfont-style: italic;\n\t\t\t\tmargin-left: 4px;\n\t\t\t}\n\n\t\t\t/* ðŸ“‹ Estilos para Mensaje de Consentimiento del Chat */\n\t\t\t.chat-consent-message-wrapper {\n\t\t\t\talign-self: center;\n\t\t\t\tmax-width: 90%;\n\t\t\t\tmargin: 16px auto 20px auto;\n\t\t\t}\n\n\t\t\t.chat-consent-message {\n\t\t\t\tbackground: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);\n\t\t\t\tborder: 1px solid #dee2e6;\n\t\t\t\tborder-radius: 12px;\n\t\t\t\tpadding: 14px 18px;\n\t\t\t\ttext-align: center;\n\t\t\t\tbox-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);\n\t\t\t}\n\n\t\t\t.chat-consent-message-content {\n\t\t\t\tfont-size: 12px;\n\t\t\t\tline-height: 1.5;\n\t\t\t\tcolor: #495057;\n\t\t\t}\n\n\t\t\t.chat-consent-link {\n\t\t\t\tcolor: #0084ff;\n\t\t\t\ttext-decoration: none;\n\t\t\t\tfont-weight: 500;\n\t\t\t\ttransition: color 0.2s ease, text-decoration 0.2s ease;\n\t\t\t}\n\n\t\t\t.chat-consent-link:hover {\n\t\t\t\tcolor: #0066cc;\n\t\t\t\ttext-decoration: underline;\n\t\t\t}\n\n\t\t\t.chat-consent-link:active {\n\t\t\t\tcolor: #004999;\n\t\t\t}\n\n\t\t\t/* ðŸ“± Estilos mÃ³vil para mensaje de consentimiento */\n\t\t\t@media (max-width: 768px) {\n\t\t\t\t.chat-consent-message-wrapper {\n\t\t\t\t\tmax-width: 95%;\n\t\t\t\t\tmargin: 12px auto 16px auto;\n\t\t\t\t}\n\n\t\t\t\t.chat-consent-message {\n\t\t\t\t\tpadding: 12px 14px;\n\t\t\t\t}\n\n\t\t\t\t.chat-consent-message-content {\n\t\t\t\t\tfont-size: 11px;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t/* ðŸš€ Quick Actions - Botones de acciÃ³n rÃ¡pida */\n\t\t\t.guiders-quick-actions {\n\t\t\t\tdisplay: flex;\n\t\t\t\tflex-direction: column;\n\t\t\t\tpadding: 12px 16px;\n\t\t\t\tmargin: 0;\n\t\t\t\tbackground: transparent;\n\t\t\t\tposition: sticky;\n\t\t\t\tbottom: 0;\n\t\t\t\ttransition: opacity 0.3s ease, transform 0.3s ease;\n\t\t\t}\n\n\t\t\t.guiders-quick-actions-welcome {\n\t\t\t\tpadding: 12px 16px;\n\t\t\t\tbackground: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);\n\t\t\t\tborder-radius: 12px;\n\t\t\t\tmargin-bottom: 12px;\n\t\t\t\tcolor: #1d1d1f;\n\t\t\t\tfont-size: 14px;\n\t\t\t\tline-height: 1.5;\n\t\t\t\ttext-align: center;\n\t\t\t}\n\n\t\t\t.guiders-quick-actions-buttons {\n\t\t\t\tdisplay: flex;\n\t\t\t\tflex-wrap: wrap;\n\t\t\t\tgap: 8px;\n\t\t\t\tjustify-content: center;\n\t\t\t}\n\n\t\t\t.guiders-quick-action-btn {\n\t\t\t\tpadding: 10px 16px;\n\t\t\t\tborder-radius: 20px;\n\t\t\t\tfont-size: 13px;\n\t\t\t\tfont-weight: 500;\n\t\t\t\tcursor: pointer;\n\t\t\t\ttransition: all 0.2s ease;\n\t\t\t\twhite-space: nowrap;\n\t\t\t\tfont-family: inherit;\n\t\t\t\tbackground: white;\n\t\t\t\tcolor: #1d1d1f;\n\t\t\t\tborder: 1.5px solid #e5e7eb;\n\t\t\t}\n\n\t\t\t.guiders-quick-action-btn:hover {\n\t\t\t\tbackground: #f8f9fa;\n\t\t\t\tborder-color: #d1d5db;\n\t\t\t\ttransform: translateY(-1px);\n\t\t\t\tbox-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);\n\t\t\t}\n\n\t\t\t.guiders-quick-action-btn:active {\n\t\t\t\ttransform: translateY(0);\n\t\t\t\tbackground: #f1f3f5;\n\t\t\t}\n\n\t\t\t.guiders-quick-action-btn:focus {\n\t\t\t\toutline: none;\n\t\t\t\tborder-color: #3b82f6;\n\t\t\t\tbox-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);\n\t\t\t}\n\n\t\t\t/* ðŸ“± Responsive: scroll horizontal en mÃ³vil */\n\t\t\t@media (max-width: 768px) {\n\t\t\t\t.guiders-quick-actions {\n\t\t\t\t\tmargin: 0;\n\t\t\t\t\tpadding: 8px 12px;\n\t\t\t\t}\n\n\t\t\t\t.guiders-quick-actions-buttons {\n\t\t\t\t\tflex-wrap: nowrap;\n\t\t\t\t\toverflow-x: auto;\n\t\t\t\t\tjustify-content: flex-start;\n\t\t\t\t\tpadding-bottom: 8px;\n\t\t\t\t\t-webkit-overflow-scrolling: touch;\n\t\t\t\t\tscrollbar-width: none;\n\t\t\t\t\t-ms-overflow-style: none;\n\t\t\t\t}\n\n\t\t\t\t.guiders-quick-actions-buttons::-webkit-scrollbar {\n\t\t\t\t\tdisplay: none;\n\t\t\t\t}\n\n\t\t\t\t.guiders-quick-action-btn {\n\t\t\t\t\tflex-shrink: 0;\n\t\t\t\t}\n\t\t\t}\n\t\t`}setChatId(t){if(!this.container)throw new Error("No se ha inicializado el chat");this.chatId!==t&&(this.messagesLoaded=!1,this.lastKnownChatStatus=null,this.lastNotificationType=null),this.chatId=t,this.container.setAttribute("data-chat-id",t),a.ChatSessionStore.getInstance().setCurrent(t),r.ChatMemoryStore.getInstance().setChatId(t)}getChatId(){if(!this.container)throw new Error("No se ha inicializado el chat");return this.chatId||(this.chatId=r.ChatMemoryStore.getInstance().getChatId()),this.chatId}setVisitorId(t){this.visitorId=t,(0,s.debugLog)("ðŸ‘¤ [ChatUI] Visitor ID establecido:",t)}getVisitorId(){return this.visitorId}getMessagesContainer(){return this.containerMessages}renderChatMessage(t){const{text:e,sender:n,timestamp:i,senderId:s,isAI:a,aiMetadata:o}=t;this.addMessage(e,n,i,s,a,o),this.rebuildDateSeparators()}scrollToBottom(t){this.containerMessages&&(this.containerMessages.scrollTop=t?this.containerMessages.scrollHeight:0)}hide(){if(!this.container)throw new Error("No se ha inicializado el chat");"none"!==this.container.style.display&&(this.deactivatePresence(),this.container.style.transform="translateY(20px)",this.container.style.opacity="0",setTimeout((()=>{this.container&&(this.container.style.display="none"),this.activeIntervals.forEach((t=>{null!==t.id&&(clearInterval(t.id),t.id=null)})),this.closeCallbacks.forEach((t=>t()))}),300))}show(){if(!this.container)throw new Error("No se ha inicializado el chat");this.container.style.display="flex",this.container.offsetHeight,this.container.style.opacity="1",this.container.style.transform="translateY(0)",this.loadChatContent(),this.visitorId?((0,s.debugLog)("ðŸ‘¤ [ChatUI] Usando refreshChatDetailsFromVisitorList con visitorId:",this.visitorId),this.refreshChatDetailsFromVisitorList(this.visitorId).catch((t=>{this.refreshChatDetails()}))):((0,s.debugLog)("âš ï¸ [ChatUI] No hay visitorId, usando refreshChatDetails tradicional"),this.refreshChatDetails()),this.scrollToBottom(!0),this.activatePresence(),this.activeIntervals.forEach((t=>{null===t.id&&(t.id=window.setInterval(t.callback,t.intervalMs))})),this.openCallbacks.forEach((t=>t()))}toggle(){if(!this.container)throw new Error("No se ha inicializado el chat");"none"===this.container.style.display?this.show():this.hide()}isVisible(){return!!this.container&&"none"!==this.container.style.display}getOptions(){return this.options}addMessage(t,e,n,i,s,a){if(!this.container||!this.containerMessages)throw new Error("No se ha inicializado el chat");const o=n?new Date(n):new Date;this.addDateSeparatorIfNeeded(o);const r=this.createMessageDiv(t,e,n,i,s,a);this.containerMessages.appendChild(r),this.scrollToBottom(!0)}createMessageDiv(t,e,n,i,s,a){const o={content:t,sender:s?"ai":this.mapSenderType(e),timestamp:n,senderId:i,isAI:s,aiMetadata:a};return d.MessageRenderer.createMessageElement(o)}mapSenderType(t){return"user"===t?"user":"agent"}getParticipantInitials(t){if(!t)return"BOT";if(!this.chatDetail)return"AH";const e=this.chatDetail.participants.find((e=>e.id===t));return e?(0,c.isBot)(e.name)?"BOT":(0,c.generateInitials)(e.name):"AH"}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}applyModernMessageStyles(t,e){const n=t.querySelector(".message-avatar"),i=t.querySelector(".message-bubble"),s=t.querySelector(".message-content"),a=t.querySelector(".message-text"),o=t.querySelector(".message-metadata"),r=t.querySelector(".message-time"),c=t.querySelector(".message-status");if(t.style.cssText=`\n\t\t\tdisplay: flex;\n\t\t\talign-items: flex-end;\n\t\t\tmargin-bottom: 16px;\n\t\t\t${e?"flex-direction: row-reverse; padding-left: 60px;":"flex-direction: row; padding-right: 60px;"}\n\t\t\tanimation: messageSlideIn 0.3s ease-out;\n\t\t`,n){n.style.cssText="\n\t\t\t\tmargin-right: 12px;\n\t\t\t\tmargin-bottom: 4px;\n\t\t\t";const t=n.querySelector(".avatar-circle");t&&(t.style.cssText="\n\t\t\t\t\twidth: 32px;\n\t\t\t\t\theight: 32px;\n\t\t\t\t\tborder-radius: 50%;\n\t\t\t\t\tbackground: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n\t\t\t\t\tdisplay: flex;\n\t\t\t\t\talign-items: center;\n\t\t\t\t\tjustify-content: center;\n\t\t\t\t\tcolor: white;\n\t\t\t\t\tfont-size: 11px;\n\t\t\t\t\tfont-weight: 600;\n\t\t\t\t\tborder: none;\n\t\t\t\t\tbox-sizing: border-box;\n\t\t\t\t\tmin-width: 32px;\n\t\t\t\t\tmin-height: 32px;\n\t\t\t\t\tmax-width: 32px;\n\t\t\t\t\tmax-height: 32px;\n\t\t\t\t")}i&&(i.style.cssText="\n\t\t\t\tposition: relative;\n\t\t\t\tmax-width: 85%;\n\t\t\t\tmin-width: 120px;\n\t\t\t"),s&&(s.style.cssText=`\n\t\t\t\tpadding: 12px 16px 8px;\n\t\t\t\tborder-radius: 20px;\n\t\t\t\tposition: relative;\n\t\t\t\tword-break: break-word;\n\t\t\t\t${e?"background: linear-gradient(145deg, #0084ff 60%, #00c6fb 100%);\n\t\t\t\t\t color: white;\n\t\t\t\t\t border-bottom-right-radius: 6px;\n\t\t\t\t\t box-shadow: 0 2px 12px rgba(0, 132, 255, 0.3);":"background: white;\n\t\t\t\t\t color: #1d1d1f;\n\t\t\t\t\t border: 1px solid rgba(0, 0, 0, 0.08);\n\t\t\t\t\t border-bottom-left-radius: 6px;\n\t\t\t\t\t box-shadow: 0 1px 8px rgba(0, 0, 0, 0.08);"}\n\t\t\t\tbackdrop-filter: blur(10px);\n\t\t\t\ttransition: all 0.2s ease;\n\t\t\t`),a&&(a.style.cssText="\n\t\t\t\tfont-size: 15px;\n\t\t\t\tline-height: 1.4;\n\t\t\t\tmargin: 0;\n\t\t\t\tfont-weight: 400;\n\t\t\t\tletter-spacing: -0.01em;\n\t\t\t\t-webkit-font-smoothing: antialiased;\n\t\t\t\t-moz-osx-font-smoothing: grayscale;\n\t\t\t"),o&&(o.style.cssText=`\n\t\t\t\tdisplay: flex;\n\t\t\t\talign-items: center;\n\t\t\t\tjustify-content: ${e?"flex-end":"flex-start"};\n\t\t\t\tgap: 6px;\n\t\t\t\tmargin-top: 2px;\n\t\t\t\tpadding: 0 4px;\n\t\t\t`),r&&(r.style.cssText=`\n\t\t\t\tfont-size: 11px;\n\t\t\t\tcolor: ${e?"rgba(0, 0, 0, 0.8)":"rgba(60, 60, 67, 0.6)"};\n\t\t\t\tfont-weight: 500;\n\t\t\t\tletter-spacing: 0.01em;\n\t\t\t`),c&&(c.style.cssText="\n\t\t\t\tfont-size: 12px;\n\t\t\t\tcolor: rgba(255, 255, 255, 0.8);\n\t\t\t\tmargin-left: 2px;\n\t\t\t"),this.addMessageAnimations()}addMessageAnimations(){if(document.getElementById("modern-message-animations"))return;const t=document.createElement("style");t.id="modern-message-animations",t.textContent="\n\t\t\t@keyframes messageSlideIn {\n\t\t\t\tfrom {\n\t\t\t\t\topacity: 0;\n\t\t\t\t\ttransform: translateY(10px);\n\t\t\t\t}\n\t\t\t\tto {\n\t\t\t\t\topacity: 1;\n\t\t\t\t\ttransform: translateY(0);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t/* Efecto hover deshabilitado por solicitud del usuario */\n\n\t\t\t/* Mejorar tipografÃ­a */\n\t\t\t.modern-message .message-text {\n\t\t\t\t-webkit-font-smoothing: antialiased;\n\t\t\t\t-moz-osx-font-smoothing: grayscale;\n\t\t\t}\n\n\t\t\t/* Estilos responsivos */\n\t\t\t@media (max-width: 480px) {\n\t\t\t\t.modern-message {\n\t\t\t\t\tpadding-left: 20px !important;\n\t\t\t\t\tpadding-right: 20px !important;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t.modern-message .message-bubble {\n\t\t\t\t\tmax-width: 95% !important;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t/* Fix especÃ­fico para Safari */\n\t\t\t@media not all and (min-resolution: 0.001dpcm) {\n\t\t\t\t@supports (-webkit-appearance: none) {\n\t\t\t\t\t.chat-input-container {\n\t\t\t\t\t\tdisplay: -webkit-box !important;\n\t\t\t\t\t\tdisplay: -webkit-flex !important;\n\t\t\t\t\t\t-webkit-box-align: center !important;\n\t\t\t\t\t\t-webkit-align-items: center !important;\n\t\t\t\t\t\tposition: relative !important;\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t.chat-send-btn {\n\t\t\t\t\t\tposition: relative !important;\n\t\t\t\t\t\t-webkit-flex-shrink: 0 !important;\n\t\t\t\t\t\tflex-shrink: 0 !important;\n\t\t\t\t\t\twidth: 36px !important;\n\t\t\t\t\t\theight: 36px !important;\n\t\t\t\t\t\tmin-width: 36px !important;\n\t\t\t\t\t\tmin-height: 36px !important;\n\t\t\t\t\t\tdisplay: -webkit-box !important;\n\t\t\t\t\t\tdisplay: -webkit-flex !important;\n\t\t\t\t\t\t-webkit-box-pack: center !important;\n\t\t\t\t\t\t-webkit-justify-content: center !important;\n\t\t\t\t\t\t-webkit-box-align: center !important;\n\t\t\t\t\t\t-webkit-align-items: center !important;\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\t.chat-input-field {\n\t\t\t\t\t\t-webkit-flex: 1 1 auto !important;\n\t\t\t\t\t\tflex: 1 1 auto !important;\n\t\t\t\t\t\tmin-width: 0 !important;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t",document.head.appendChild(t)}getParticipantName(t){if(!t)return"Asistente";if(!this.chatDetail)return"Asesor";const e=this.chatDetail.participants.find((e=>e.id===t));return e?(0,c.isBot)(e.name)?"Asistente":e.name:"Asesor"}addDateSeparatorIfNeeded(t){if(!this.containerMessages)return;const e=(0,c.formatDate)(t);if(!this.lastMessageDate||this.lastMessageDate!==e){const t=(0,c.createDateSeparator)(e);this.containerMessages.appendChild(t),this.lastMessageDate=e}}rebuildDateSeparators(){if(!this.containerMessages)return;this.lastMessageDate=null,this.containerMessages.querySelectorAll(".chat-date-separator").forEach((t=>{var e;return null===(e=t.parentNode)||void 0===e?void 0:e.removeChild(t)}));const t=Array.from(this.containerMessages.querySelectorAll(".chat-message-wrapper"));if(0===t.length)return;let e=null;t.forEach((t=>{const n=t.getAttribute("data-created-at"),i=n?new Date(n):new Date,s=(0,c.formatDate)(i);if(s!==e){e=s;const n=(0,c.createDateSeparator)(s);this.containerMessages&&this.containerMessages.insertBefore(n,t)}})),e&&(this.lastMessageDate=e)}initializeChatContent(){return i(this,void 0,void 0,(function*(){try{(0,s.debugLog)("ðŸ’¬ [ChatUI] Inicializando contenido del chat..."),this.isVisible()&&this.loadChatContent()}catch(t){}}))}loadChatContent(){return i(this,void 0,void 0,(function*(){var t;if(null===(t=this.container)||void 0===t?void 0:t.getAttribute("data-chat-initialized"))if(this.messagesLoaded)(0,s.debugLog)("Los mensajes ya fueron cargados previamente, omitiendo fetch...");else{(0,s.debugLog)("Cargando contenido del chat...");try{this.messagesLoaded=!0,this.chatDetail&&"active"===this.chatDetail.status&&this.checkInitialCommercialStatus()}catch(t){this.chatDetail&&"active"===this.chatDetail.status&&this.checkInitialCommercialStatus()}}else(0,s.debugLog)("Chat no inicializado aÃºn, esperando...")}))}loadChatDetails(){return i(this,arguments,void 0,(function*(t=!1){if(this.chatId)try{(0,s.debugLog)(t?"ðŸ”„ Forzando carga de detalles del chat desde backend...":"Cargando detalles del chat..."),this.chatDetail=yield(0,o.fetchChatDetail)(this.chatId,t),(0,s.debugLog)("Detalles del chat:",this.chatDetail),this.lastKnownChatStatus=this.chatDetail.status,(0,s.debugLog)("Estado actual del chat:",this.lastKnownChatStatus),this.updateChatHeader()}catch(t){}}))}checkInitialCommercialStatus(){this.chatDetail&&this.chatDetail.participants.filter((t=>t.isCommercial)).forEach((t=>{t.isOnline||"offline"===this.lastNotificationType||((0,s.debugLog)("Comercial",t.name,"estÃ¡ offline en la carga inicial"),setTimeout((()=>{this.sendOfflineNotificationMessage(t.name,!0),this.lastNotificationType="offline"}),100))}))}updateChatHeader(){var t;if(!this.chatDetail||!this.titleElement)return;(0,s.debugLog)("ðŸ” [ChatUI] Actualizando header con chatDetail:",{chatId:this.chatDetail.id,status:this.chatDetail.status,assignedCommercial:this.chatDetail.assignedCommercial,participants:this.chatDetail.participants.map((t=>({id:t.id,name:t.name,isCommercial:t.isCommercial,isOnline:t.isOnline})))});const e=this.chatDetail.participants.filter((t=>t.isCommercial));if(e.length>0){const t=e[0];this.titleElement.textContent=t.name||"Asesor",(0,s.debugLog)("âœ… [ChatUI] TÃ­tulo del header actualizado:",t.name),this.avatarContainer&&(this.avatarContainer.style.display="block")}else this.titleElement.textContent="Chat",(0,s.debugLog)("âš ï¸ [ChatUI] No hay comerciales asignados, ocultando avatar y estado"),this.avatarContainer&&(this.avatarContainer.style.display="none");if((null===(t=this.chatDetail.assignedCommercial)||void 0===t?void 0:t.avatarUrl)&&this.avatarElement){(0,s.debugLog)("ðŸ‘¤ [ChatUI] Actualizando avatar del comercial:",{name:this.chatDetail.assignedCommercial.name,avatarUrl:this.chatDetail.assignedCommercial.avatarUrl});const t=this.chatDetail.assignedCommercial.avatarUrl,e=this.chatDetail.assignedCommercial.name,n=document.createElement("img");n.src=t,n.alt=e,n.style.cssText="\n\t\t\t\twidth: 44px;\n\t\t\t\theight: 44px;\n\t\t\t\tobject-fit: cover;\n\t\t\t\tborder-radius: 50%;\n\t\t\t\tdisplay: block;\n\t\t\t",n.onerror=()=>{this.avatarElement.innerHTML='\n\t\t\t\t\t<svg width="24px" height="24px" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n\t\t\t\t\t\t<path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="white"/>\n\t\t\t\t\t</svg>\n\t\t\t\t'},this.avatarElement.innerHTML="",this.avatarElement.style.background="transparent",this.avatarElement.style.padding="0",this.avatarElement.appendChild(n)}}sendOfflineNotificationMessage(t,e=!1){let n;n=e?`${t} no estÃ¡ disponible en este momento. Te responderÃ¡ tan pronto como estÃ© online.`:`${t} se ha desconectado temporalmente. Te responderÃ¡ tan pronto como estÃ© disponible nuevamente.`,(0,s.debugLog)("Enviando mensaje automÃ¡tico de desconexiÃ³n:",n),this.addSystemMessage(n)}checkAndAddInitialMessages(){if(!this.containerMessages)return void(0,s.debugLog)("ðŸ’¬ [ChatUI] Container de mensajes no disponible, omitiendo verificaciÃ³n de mensajes iniciales");if(this.isLoadingInitialMessages)return void(0,s.debugLog)("ðŸ’¬ [ChatUI] ðŸ”’ Carga inicial de mensajes en progreso, omitiendo verificaciÃ³n de mensajes iniciales para evitar race condition");const t=this.containerMessages.querySelector(".loading-messages-indicator");if(t&&"none"!==t.style.display)return void(0,s.debugLog)("ðŸ’¬ [ChatUI] Indicador de carga visible, omitiendo mensajes iniciales automÃ¡ticos");const e=Array.from(this.containerMessages.children).filter((t=>t.classList&&(t.classList.contains("chat-message-user-wrapper")||t.classList.contains("chat-message-other-wrapper"))));(0,s.debugLog)(`ðŸ’¬ [ChatUI] VerificaciÃ³n automÃ¡tica: ${e.length} mensajes encontrados`),0===e.length?((0,s.debugLog)("ðŸ’¬ [ChatUI] âœ… Chat vacÃ­o confirmado, agregando mensajes iniciales"),this.quickActionsUI&&this.quickActionsConfig.enabled&&((0,s.debugLog)("ðŸ’¬ [ChatUI] Mostrando Quick Actions"),this.quickActionsUI.show()),this.addChatConsentMessage()):((0,s.debugLog)("ðŸ’¬ [ChatUI] Chat tiene mensajes, omitiendo mensajes iniciales"),this.quickActionsUI&&this.quickActionsUI.hide())}addSystemMessage(t){if(!this.container||!this.containerMessages)throw new Error("No se ha inicializado el chat");this.addDateSeparatorIfNeeded(new Date);const e=document.createElement("div");e.classList.add("chat-message-wrapper","chat-system-message-wrapper");const n=document.createElement("div");n.classList.add("chat-message","chat-system-message"),n.textContent=t,e.appendChild(n),this.containerMessages.appendChild(e),this.scrollToBottom(!0)}addChatConsentMessage(){if(!this.container||!this.containerMessages)throw new Error("No se ha inicializado el chat");if(!this.chatConsentMessageConfig.enabled)return void(0,s.debugLog)("ðŸ’¬ [ChatUI] Mensaje de consentimiento del chat deshabilitado");if(this.chatConsentMessageConfig.showOnce&&this.chatConsentMessageShown)return void(0,s.debugLog)("ðŸ’¬ [ChatUI] Mensaje de consentimiento del chat ya fue mostrado");const t=document.createElement("div");t.classList.add("chat-message-wrapper","chat-consent-message-wrapper");const e=document.createElement("div");e.classList.add("chat-message","chat-consent-message");const n=document.createElement("div");n.className="chat-consent-message-content";const i=document.createElement("span");i.textContent=this.chatConsentMessageConfig.message+" ",n.appendChild(i);const a=[];if(this.chatConsentMessageConfig.privacyPolicyUrl){const t=document.createElement("a");t.href=this.chatConsentMessageConfig.privacyPolicyUrl,t.textContent=this.chatConsentMessageConfig.privacyPolicyText||"PolÃ­tica de Privacidad",t.className="chat-consent-link",t.target="_blank",t.rel="noopener noreferrer",a.push(t)}if(this.chatConsentMessageConfig.cookiesPolicyUrl){const t=document.createElement("a");t.href=this.chatConsentMessageConfig.cookiesPolicyUrl,t.textContent=this.chatConsentMessageConfig.cookiesPolicyText||"PolÃ­tica de Cookies",t.className="chat-consent-link",t.target="_blank",t.rel="noopener noreferrer",a.push(t)}a.forEach(((t,e)=>{if(e>0){const t=document.createElement("span");t.textContent=" y ",n.appendChild(t)}n.appendChild(t)})),e.appendChild(n),t.appendChild(e);const o=this.containerMessages.querySelector(".chat-message-wrapper");o?this.containerMessages.insertBefore(t,o):this.containerMessages.appendChild(t),this.chatConsentMessageShown=!0,(0,s.debugLog)("ðŸ’¬ [ChatUI] âœ… Mensaje de consentimiento del chat agregado")}refreshChatDetails(){return i(this,arguments,void 0,(function*(t=!1){yield this.loadChatDetails(t)}))}refreshChatDetailsForced(){return i(this,void 0,void 0,(function*(){yield this.loadChatDetails(!0)}))}refreshChatDetailsFromVisitorList(t){return i(this,void 0,void 0,(function*(){if(this.chatId)try{(0,s.debugLog)("ðŸ”„ [ChatUI] Obteniendo chats del visitante para encontrar chat:",this.chatId);const e=(yield Promise.resolve().then((()=>n(7686)))).ChatV2Service.getInstance(),i=yield e.getVisitorChats(t,void 0,50);(0,s.debugLog)("âœ… [ChatUI] Chats del visitante obtenidos:",{total:i.total,count:i.chats.length});const a=i.chats.find((t=>t.id===this.chatId));if(!a)return;(0,s.debugLog)("âœ… [ChatUI] Chat encontrado en lista:",{chatId:a.id,status:a.status,assignedCommercial:a.assignedCommercial});const{convertV2ToLegacy:o}=yield Promise.resolve().then((()=>n(9167))),r={id:a.id,status:a.status,priority:a.priority,visitorInfo:a.visitorInfo,assignedCommercialId:a.assignedCommercialId,assignedCommercial:a.assignedCommercial,availableCommercialIds:a.availableCommercialIds,metadata:a.metadata,createdAt:new Date(a.createdAt),assignedAt:a.assignedAt?new Date(a.assignedAt):void 0,closedAt:a.closedAt?new Date(a.closedAt):void 0,lastMessageDate:a.lastMessageDate?new Date(a.lastMessageDate):void 0,totalMessages:a.totalMessages,unreadMessagesCount:a.unreadMessagesCount,isActive:a.isActive,visitorId:a.visitorId,department:a.department,tags:a.tags,updatedAt:a.updatedAt?new Date(a.updatedAt):void 0};this.chatDetail=o(r),this.lastKnownChatStatus=this.chatDetail.status,(0,s.debugLog)("âœ… [ChatUI] Chat detail actualizado desde lista del visitante"),this.updateChatHeader()}catch(t){}else(0,s.debugLog)("âš ï¸ [ChatUI] No hay chatId, omitiendo refresh desde lista de visitante")}))}onOpen(t){this.openCallbacks.push(t)}onClose(t){this.closeCallbacks.push(t)}onChatInitialized(t){this.initializationCallbacks.push(t)}onActiveInterval(t,e=5e3){this.activeIntervals.push({id:null,callback:t,intervalMs:e})}isCreatingChat(){return this.isCreatingChatFlag}waitForChatCreation(){return i(this,void 0,void 0,(function*(){this.chatCreationPromise&&(yield this.chatCreationPromise)}))}setCreatingChat(t){this.isCreatingChatFlag=t,t?this.chatCreationPromise=new Promise((t=>{this.chatCreationResolve=t})):(this.chatCreationResolve&&(this.chatCreationResolve(),this.chatCreationResolve=null),this.chatCreationPromise=null)}showLoadingMessages(){if(!this.containerMessages)return;let t=this.containerMessages.querySelector(".loading-messages-indicator");t||(t=document.createElement("div"),t.className="loading-messages-indicator",t.style.cssText="\n\t\t\t\ttext-align: center;\n\t\t\t\tpadding: 20px;\n\t\t\t\tcolor: #666;\n\t\t\t\tfont-size: 14px;\n\t\t\t",t.innerHTML='\n\t\t\t\t<div style="display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #0084ff; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;"></div>\n\t\t\t\tCargando mensajes...\n\t\t\t\t<style>\n\t\t\t\t\t@keyframes spin {\n\t\t\t\t\t\t0% { transform: rotate(0deg); }\n\t\t\t\t\t\t100% { transform: rotate(360deg); }\n\t\t\t\t\t}\n\t\t\t\t</style>\n\t\t\t',this.containerMessages.appendChild(t)),t.style.display="block",(0,s.debugLog)("ðŸ’¬ [ChatUI] Indicador de carga de mensajes mostrado")}hideLoadingMessages(){if(!this.containerMessages)return;const t=this.containerMessages.querySelector(".loading-messages-indicator");t&&(t.style.display="none"),(0,s.debugLog)("ðŸ’¬ [ChatUI] Indicador de carga de mensajes ocultado")}clearMessages(){this.containerMessages&&(Array.from(this.containerMessages.children).forEach((t=>{t.classList.contains("loading-messages-indicator")||t.remove()})),this.messagesLoaded=!1,this.lastMessageDate=null,(0,s.debugLog)("ðŸ’¬ [ChatUI] Mensajes limpiados"))}scrollToBottomV2(){this.containerMessages&&requestAnimationFrame((()=>{this.containerMessages&&(this.containerMessages.scrollTop=this.containerMessages.scrollHeight,(0,s.debugLog)("ðŸ’¬ [ChatUI] Scroll al bottom realizado (V2)"))}))}setLoadingInitialMessages(t){this.isLoadingInitialMessages=t,(0,s.debugLog)(`ðŸ’¬ [ChatUI] ðŸ”’ Estado isLoadingInitialMessages cambiado a: ${t}`)}isLoadingMessages(){return this.isLoadingInitialMessages}getResolvedPosition(){return this.resolvedPosition}setPresenceService(t){this.presenceService=t,(0,s.debugLog)("ðŸ’¬ [ChatUI] PresenceService configurado")}setShowOfflineBanner(t){this.showOfflineBannerEnabled=t,(0,s.debugLog)("ðŸ’¬ [ChatUI] Banner offline:",t?"habilitado":"deshabilitado"),t||this.hideOfflineBanner()}updateAvatarStatus(t){this.avatarStatusDot&&(this.avatarStatusDot.className="avatar-status-dot",this.avatarStatusDot.classList.add(`status-${t}`),(0,s.debugLog)("ðŸ’¬ [ChatUI] Avatar status dot actualizado a:",t))}activatePresence(){this.presenceService&&this.chatId?((0,s.debugLog)("ðŸ’¬ [ChatUI] ðŸŸ¢ Activando sistema de presencia para chat:",this.chatId),this.presenceService.joinChatRoom(this.chatId),this.presenceService.getChatPresence(this.chatId).then((t=>{if(!t)return void(0,s.debugLog)("ðŸ’¬ [ChatUI] âš ï¸ No se pudo obtener presencia inicial");(0,s.debugLog)("ðŸ’¬ [ChatUI] âœ… Presencia inicial obtenida:",t);const e=this.presenceService.getCommercialFromParticipants(t.participants);e&&this.avatarStatusDot&&(this.updateAvatarStatus(e.connectionStatus),(0,s.debugLog)("ðŸ’¬ [ChatUI] Avatar status dot actualizado:",e.connectionStatus),"offline"===e.connectionStatus?this.showOfflineBanner():this.hideOfflineBanner())})),this.presenceUnsubscribe=this.presenceService.onPresenceChanged((t=>{(0,s.debugLog)("ðŸ’¬ [ChatUI] ðŸŸ¢ Evento de presencia recibido:",t),this.avatarStatusDot&&"commercial"===t.userType&&(this.updateAvatarStatus(t.status),"offline"===t.status?this.showOfflineBanner():this.hideOfflineBanner())})),this.typingUnsubscribe=this.presenceService.onTypingChanged(((t,e)=>{(0,s.debugLog)("ðŸ’¬ [ChatUI] âœï¸ Evento de typing recibido:",Object.assign(Object.assign({},t),{isTyping:e}))})),(0,s.debugLog)("ðŸ’¬ [ChatUI] âœ… Sistema de presencia activado")):(0,s.debugLog)("ðŸ’¬ [ChatUI] âš ï¸ No se puede activar presencia: servicio o chatId faltante")}deactivatePresence(){this.presenceService&&this.chatId&&((0,s.debugLog)("ðŸ’¬ [ChatUI] ðŸ”´ Desactivando sistema de presencia para chat:",this.chatId),this.presenceUnsubscribe&&(this.presenceUnsubscribe(),this.presenceUnsubscribe=null),this.typingUnsubscribe&&(this.typingUnsubscribe(),this.typingUnsubscribe=null),this.avatarStatusDot&&this.updateAvatarStatus("offline"),this.hideOfflineBanner(),(0,s.debugLog)("ðŸ’¬ [ChatUI] âœ… Sistema de presencia desactivado (permanece en sala WebSocket)"))}showOfflineBanner(){this.offlineBanner&&this.showOfflineBannerEnabled?(this.offlineBanner.style.display="block",(0,s.debugLog)("ðŸ’¬ [ChatUI] ðŸ“¢ Banner offline mostrado")):this.showOfflineBannerEnabled||(0,s.debugLog)("ðŸ’¬ [ChatUI] âš ï¸ Banner offline deshabilitado en configuraciÃ³n")}hideOfflineBanner(){this.offlineBanner&&(this.offlineBanner.style.display="none",(0,s.debugLog)("ðŸ’¬ [ChatUI] ðŸ“¢ Banner offline ocultado"))}}},3235:(t,e)=>{"use strict";function n(){return"undefined"==typeof sessionStorage?null:sessionStorage.getItem("guiders_backend_session_id")}function i(){const t={"Content-Type":"application/json"},e=n();return e&&(t["X-Guiders-Sid"]=e),t}Object.defineProperty(e,"__esModule",{value:!0}),e.getSessionId=n,e.getCommonHeaders=i,e.getCommonFetchOptions=function(t="GET"){return{method:t,headers:i(),credentials:"include"}}},3507:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(t){var e,n=(e="string"==typeof t?(0,s.default)(t):t,Uint8Array.of((15&e[3])<<4|e[4]>>4&15,(15&e[4])<<4|(240&e[5])>>4,(15&e[5])<<4|15&e[6],e[7],(15&e[1])<<4|(240&e[2])>>4,(15&e[2])<<4|(240&e[3])>>4,16|(240&e[0])>>4,(15&e[0])<<4|(240&e[1])>>4,e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]));return"string"==typeof t?(0,a.unsafeStringify)(n):n};var i,s=(i=n(6792))&&i.__esModule?i:{default:i},a=n(9910)},3518:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i,s,a,o=(i=n(2858))&&i.__esModule?i:{default:i},r=n(9910),c=0,d=0;e.default=function(t,e,n){var i=e&&n||0,l=e||new Array(16),h=(t=t||{}).node,u=t.clockseq;if(t._v6||(h||(h=s),null==u&&(u=a)),null==h||null==u){var g=t.random||(t.rng||o.default)();null==h&&(h=[g[0],g[1],g[2],g[3],g[4],g[5]],s||t._v6||(h[0]|=1,s=h)),null==u&&(u=16383&(g[6]<<8|g[7]),void 0!==a||t._v6||(a=u))}var p=void 0!==t.msecs?t.msecs:Date.now(),f=void 0!==t.nsecs?t.nsecs:d+1,m=p-c+(f-d)/1e4;if(m<0&&void 0===t.clockseq&&(u=u+1&16383),(m<0||p>c)&&void 0===t.nsecs&&(f=0),f>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");c=p,d=f,a=u;var b=(1e4*(268435455&(p+=122192928e5))+f)%4294967296;l[i++]=b>>>24&255,l[i++]=b>>>16&255,l[i++]=b>>>8&255,l[i++]=255&b;var v=p/4294967296*1e4&268435455;l[i++]=v>>>8&255,l[i++]=255&v,l[i++]=v>>>24&15|16,l[i++]=v>>>16&255,l[i++]=u>>>8|128,l[i++]=255&u;for(var y=0;y<6;++y)l[i+y]=h[y];return e||(0,r.unsafeStringify)(l)}},3574:function(t,e,n){"use strict";var i=this&&this.__createBinding||(Object.create?function(t,e,n,i){void 0===i&&(i=n);var s=Object.getOwnPropertyDescriptor(e,n);s&&!("get"in s?!e.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return e[n]}}),Object.defineProperty(t,i,s)}:function(t,e,n,i){void 0===i&&(i=n),t[i]=e[n]}),s=this&&this.__exportStar||function(t,e){for(var n in t)"default"===n||Object.prototype.hasOwnProperty.call(e,n)||i(e,t,n)};Object.defineProperty(e,"__esModule",{value:!0}),e.TrackingType=e.COMMON_ACTIVE_HOURS=e.createActiveHoursConfig=e.ActiveHoursValidator=e.useIdentitySignal=e.IdentitySignal=e.AsyncSignal=e.Signal=e.ConfidenceLevel=void 0;var a=n(6932);Object.defineProperty(e,"ConfidenceLevel",{enumerable:!0,get:function(){return a.ConfidenceLevel}});var o=n(1556);Object.defineProperty(e,"Signal",{enumerable:!0,get:function(){return o.Signal}}),Object.defineProperty(e,"AsyncSignal",{enumerable:!0,get:function(){return o.AsyncSignal}});var r=n(5303);Object.defineProperty(e,"IdentitySignal",{enumerable:!0,get:function(){return r.IdentitySignal}}),Object.defineProperty(e,"useIdentitySignal",{enumerable:!0,get:function(){return r.useIdentitySignal}});var c,d=n(6571);Object.defineProperty(e,"ActiveHoursValidator",{enumerable:!0,get:function(){return d.ActiveHoursValidator}}),Object.defineProperty(e,"createActiveHoursConfig",{enumerable:!0,get:function(){return d.createActiveHoursConfig}}),Object.defineProperty(e,"COMMON_ACTIVE_HOURS",{enumerable:!0,get:function(){return d.COMMON_ACTIVE_HOURS}}),s(n(6161),e),function(t){t.PAGE_VIEW="page_view",t.CLICK="click",t.HOVER="hover"}(c||(e.TrackingType=c={}))},3626:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ChatInputUI=void 0,e.ChatInputUI=class{constructor(t){this.inputContainer=null,this.submitCallbacks=[],this.inputElement=null,this.presenceService=null,this.chatId=null,this.typingDebounceTimer=null,this.typingStopTimer=null,this.TYPING_DEBOUNCE_MS=300,this.TYPING_STOP_MS=2e3,this.chatUI=t}setPresenceService(t,e){this.presenceService=t,this.chatId=e}init(){this.inputContainer=document.createElement("div"),this.inputContainer.style.display="flex",this.inputContainer.style.padding="8px 12px",this.inputContainer.style.background="#ffffff";const t=document.createElement("div");t.style.display="flex",t.style.alignItems="flex-end",t.style.flex="1",t.style.background="#ffffff",t.style.borderRadius="24px",t.style.padding="6px 6px 6px 16px",t.style.gap="8px",t.style.minHeight="44px",t.style.boxSizing="border-box",t.style.border="1px solid #e4e4e7",t.style.transition="all 0.2s ease";const e=document.createElement("textarea");e.rows=1,e.style.flex="1",e.style.border="none",e.style.background="transparent",e.style.outline="none",e.style.fontSize="14px",e.style.fontFamily="Inter, -apple-system, BlinkMacSystemFont, sans-serif",e.style.color="#18181b",e.style.padding="4px 0",e.style.resize="none",e.style.overflow="hidden",e.style.lineHeight="1.4",e.style.maxHeight="120px",e.style.minHeight="24px",e.placeholder="Escribe un mensaje...",this.inputElement=e,e.addEventListener("focus",(()=>{t.style.background="#ffffff",t.style.borderColor="#d4d4d8",t.style.boxShadow="0 0 0 3px rgba(0, 0, 0, 0.04)"})),e.addEventListener("blur",(()=>{t.style.background="#ffffff",t.style.borderColor="#e4e4e7",t.style.boxShadow="none",this.stopTyping()}));const n=document.createElement("button");n.innerHTML='<svg width="16" height="16" viewBox="0 0 24 24" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M3.29106 3.3088C3.00745 3.18938 2.67967 3.25533 2.4643 3.47514C2.24894 3.69495 2.1897 4.02401 2.31488 4.30512L5.40752 11.25H13C13.4142 11.25 13.75 11.5858 13.75 12C13.75 12.4142 13.4142 12.75 13 12.75H5.40754L2.31488 19.6949C2.1897 19.976 2.24894 20.3051 2.4643 20.5249C2.67967 20.7447 3.00745 20.8107 3.29106 20.6912L22.2911 12.6913C22.5692 12.5742 22.75 12.3018 22.75 12C22.75 11.6983 22.5692 11.4259 22.2911 11.3088L3.29106 3.3088Z" fill="currentColor"/></svg>',n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.width="32px",n.style.height="32px",n.style.border="none",n.style.borderRadius="50%",n.style.background="#18181b",n.style.color="white",n.style.cursor="pointer",n.style.transition="all 0.15s ease",n.style.flexShrink="0",n.addEventListener("mouseenter",(()=>{n.style.background="#27272a",n.style.transform="scale(1.05)"})),n.addEventListener("mouseleave",(()=>{n.style.background="#18181b",n.style.transform="scale(1)"})),n.addEventListener("click",(()=>{const t=e.value.trim();t&&(this.stopTyping(),this.submitCallbacks.forEach((e=>e(t))),this.chatUI.renderChatMessage({text:t,sender:"user"}),e.value="",e.style.height="auto",e.style.overflow="hidden")})),e.addEventListener("keydown",(t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),n.click())})),e.addEventListener("input",(()=>{this.handleTypingInput(),e.style.height="auto",e.style.height=Math.min(e.scrollHeight,120)+"px",e.scrollHeight>120?e.style.overflow="auto":e.style.overflow="hidden"})),e.addEventListener("blur",(()=>{this.stopTyping()})),t.appendChild(e),t.appendChild(n),this.inputContainer.appendChild(t),document.body.appendChild(this.inputContainer)}onSubmit(t){this.submitCallbacks.push(t)}getContainer(){return this.inputContainer}handleTypingInput(){this.presenceService&&this.chatId&&(this.typingDebounceTimer&&clearTimeout(this.typingDebounceTimer),this.typingDebounceTimer=setTimeout((()=>{this.startTyping()}),this.TYPING_DEBOUNCE_MS))}startTyping(){this.presenceService&&this.chatId&&(this.presenceService.startTyping(this.chatId),this.typingStopTimer&&clearTimeout(this.typingStopTimer),this.typingStopTimer=setTimeout((()=>{this.stopTyping()}),this.TYPING_STOP_MS))}stopTyping(){this.presenceService&&this.chatId&&(this.clearTypingTimers(),this.presenceService.stopTyping(this.chatId))}clearTypingTimers(){this.typingDebounceTimer&&(clearTimeout(this.typingDebounceTimer),this.typingDebounceTimer=null),this.typingStopTimer&&(clearTimeout(this.typingStopTimer),this.typingStopTimer=null)}destroy(){this.stopTyping(),this.clearTypingTimers(),this.inputContainer&&this.inputContainer.parentNode&&this.inputContainer.parentNode.removeChild(this.inputContainer),this.inputContainer=null,this.inputElement=null,this.submitCallbacks=[],this.presenceService=null,this.chatId=null}}},3722:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EventAggregator=void 0;const i=n(3974);class s{constructor(t={}){var e,n,s,a;this.config={enabled:null===(e=t.enabled)||void 0===e||e,windowMs:null!==(n=t.windowMs)&&void 0!==n?n:1e3,maxBufferSize:null!==(s=t.maxBufferSize)&&void 0!==s?s:1e3,debug:null!==(a=t.debug)&&void 0!==a&&a,onFlush:t.onFlush},this.buffer=new Map,this.flushTimer=null,this.stats={totalEventsReceived:0,totalEventsAggregated:0,aggregationRatio:0,aggregatedByType:{}},this.config.enabled&&this.startAutoFlush(),this.config.debug&&(0,i.debugLog)("[EventAggregator] âœ… Initialized:",{windowMs:this.config.windowMs,maxBufferSize:this.config.maxBufferSize})}add(t){if(!this.config.enabled)return;this.stats.totalEventsReceived++;const e=this.getEventFingerprint(t),n=this.buffer.get(e);n?(n.count++,n.lastOccurredAt=t.occurredAt||(new Date).toISOString(),this.mergeMetadata(n.metadata,t.metadata),this.config.debug&&(0,i.debugLog)(`[EventAggregator] ðŸ”— Consolidado ${t.eventType} (count: ${n.count})`)):(this.buffer.set(e,{event:Object.assign({},t),count:1,firstOccurredAt:t.occurredAt||(new Date).toISOString(),lastOccurredAt:t.occurredAt||(new Date).toISOString(),metadata:Object.assign({},t.metadata)}),this.config.debug&&(0,i.debugLog)(`[EventAggregator] âž• Nuevo evento en buffer: ${t.eventType}`)),this.buffer.size>=this.config.maxBufferSize&&((0,i.debugLog)("[EventAggregator] âš ï¸ Buffer lleno, flush forzado"),this.flush())}flush(){if(0===this.buffer.size)return[];const t=[];for(const[e,n]of this.buffer.entries()){const e=Object.assign(Object.assign({},n.event),{occurredAt:n.lastOccurredAt,metadata:Object.assign(Object.assign({},n.metadata),{aggregatedCount:n.count,firstOccurredAt:n.firstOccurredAt,lastOccurredAt:n.lastOccurredAt})});t.push(e),this.stats.aggregatedByType[e.eventType]=(this.stats.aggregatedByType[e.eventType]||0)+1}return this.stats.totalEventsAggregated+=t.length,this.stats.aggregationRatio=this.stats.totalEventsReceived>0?100*(1-this.stats.totalEventsAggregated/this.stats.totalEventsReceived):0,this.config.debug&&(0,i.debugLog)("[EventAggregator] ðŸš€ Flush:",{original:this.stats.totalEventsReceived,aggregated:t.length,reduction:`${this.stats.aggregationRatio.toFixed(1)}%`}),this.buffer.clear(),t}getEventFingerprint(t){const e=t.eventType;if(!s.AGGREGABLE_EVENTS.has(e))return`${e}:${t.occurredAt}:${Math.random()}`;const n=[e,t.visitorId,t.sessionId],i=t.metadata||{};switch(e){case"SCROLL":n.push(i.url||"");break;case"MOUSE_MOVE":case"HOVER":case"MOUSE_ENTER":case"MOUSE_LEAVE":n.push(i.elementId||i.elementClass||"");break;case"RESIZE":break;case"FOCUS":case"BLUR":n.push(i.fieldName||"");break;default:n.push(t.occurredAt||"")}return n.join(":")}mergeMetadata(t,e){for(const n in e){if(!e.hasOwnProperty(n))continue;const i=e[n],s=t[n];if(void 0!==s)if("number"==typeof i&&"number"==typeof s)t[`${n}Min`]=Math.min(s,i),t[`${n}Max`]=Math.max(s,i),t[n]=i;else if(Array.isArray(i)&&Array.isArray(s)){const e=new Set([...s,...i]);t[n]=Array.from(e)}else t[n]=i;else t[n]=i}}startAutoFlush(){this.flushTimer&&clearInterval(this.flushTimer),this.flushTimer=setInterval((()=>{const t=this.flush();t.length>0&&(this.config.debug&&(0,i.debugLog)(`[EventAggregator] â° Auto-flush: ${t.length} eventos consolidados`),this.config.onFlush&&this.config.onFlush(t))}),this.config.windowMs),this.config.debug&&(0,i.debugLog)(`[EventAggregator] â° Auto-flush iniciado cada ${this.config.windowMs}ms`)}stopAutoFlush(){this.flushTimer&&(clearInterval(this.flushTimer),this.flushTimer=null)}getStats(){return Object.assign({},this.stats)}resetStats(){this.stats={totalEventsReceived:0,totalEventsAggregated:0,aggregationRatio:0,aggregatedByType:{}}}updateConfig(t){this.config.enabled,this.config=Object.assign(Object.assign({},this.config),t),void 0===t.windowMs&&void 0===t.enabled||(this.stopAutoFlush(),this.config.enabled&&this.startAutoFlush()),this.config.debug&&(0,i.debugLog)("[EventAggregator] âš™ï¸ ConfiguraciÃ³n actualizada:",this.config)}isEnabled(){return this.config.enabled}setEnabled(t){this.config.enabled=t,t?this.startAutoFlush():this.stopAutoFlush(),(0,i.debugLog)("[EventAggregator] "+(t?"âœ… Habilitado":"âŒ Deshabilitado"))}clear(){this.buffer.clear(),(0,i.debugLog)("[EventAggregator] ðŸ—‘ï¸ Buffer limpiado")}destroy(){this.stopAutoFlush(),this.buffer.clear(),(0,i.debugLog)("[EventAggregator] ðŸ’€ Destruido")}}e.EventAggregator=s,s.AGGREGABLE_EVENTS=new Set(["SCROLL","MOUSE_MOVE","HOVER","MOUSE_ENTER","MOUSE_LEAVE","RESIZE","FOCUS","BLUR"])},3731:function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function r(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.TrackingV2Service=void 0;const s=n(2597),a=n(3974),o=n(3235);class r{constructor(){this.tenantId=null,this.siteId=null,this.apiKey=null,this.initialized=!1,this.loadMetadataFromCache()}isValidTrackingEvent(t){return!(!t||"object"!=typeof t||(t.visitorId&&"string"==typeof t.visitorId?t.sessionId&&"string"==typeof t.sessionId?t.eventType&&"string"==typeof t.eventType?t.metadata&&"object"==typeof t.metadata?t.occurredAt&&"string"==typeof t.occurredAt?r.UUID_REGEX.test(t.visitorId)?r.UUID_REGEX.test(t.sessionId)?("trackingEventId"in t||"pageUrl"in t||"pagePath"in t)&&((0,a.debugLog)("[TrackingV2Service] âŒ Evento invÃ¡lido: contiene campos del formato antiguo",t),1):((0,a.debugLog)("[TrackingV2Service] âŒ Evento invÃ¡lido: sessionId no es UUID",t.sessionId),1):((0,a.debugLog)("[TrackingV2Service] âŒ Evento invÃ¡lido: visitorId no es UUID",t.visitorId),1):((0,a.debugLog)("[TrackingV2Service] âŒ Evento invÃ¡lido: falta occurredAt",t),1):((0,a.debugLog)("[TrackingV2Service] âŒ Evento invÃ¡lido: falta metadata",t),1):((0,a.debugLog)("[TrackingV2Service] âŒ Evento invÃ¡lido: falta eventType",t),1):((0,a.debugLog)("[TrackingV2Service] âŒ Evento invÃ¡lido: falta sessionId",t),1):((0,a.debugLog)("[TrackingV2Service] âŒ Evento invÃ¡lido: falta visitorId",t),1)))}static getInstance(){return r.instance||(r.instance=new r),r.instance}initialize(t){return i(this,void 0,void 0,(function*(){if(this.apiKey=t,this.tenantId&&this.siteId)return(0,a.debugLog)("[TrackingV2Service] âœ… Usando metadata cacheada:",{tenantId:this.tenantId,siteId:this.siteId}),void(this.initialized=!0);try{const e=yield this.fetchMetadata(t);e?(this.tenantId=e.tenantId,this.siteId=e.siteId,this.cacheMetadata(e),this.initialized=!0,(0,a.debugLog)("[TrackingV2Service] âœ… Metadata obtenida del backend:",e)):((0,a.debugLog)("[TrackingV2Service] âš ï¸ No se pudo obtener metadata, usando modo degradado"),this.tenantId=t,this.siteId=t,this.initialized=!0)}catch(e){(0,a.debugLog)("[TrackingV2Service] âŒ Error obteniendo metadata:",e),this.tenantId=t,this.siteId=t,this.initialized=!0}}))}sendBatch(t){return i(this,void 0,void 0,(function*(){if(!this.initialized)return null;if(0===t.length)return(0,a.debugLog)("[TrackingV2Service] ðŸ“­ No hay eventos para enviar"),null;t.length;const e=t.filter((t=>this.isValidTrackingEvent(t)));if(e.length,0===e.length)return null;let n=e;e.length>r.MAX_BATCH_SIZE&&(n=e.slice(0,r.MAX_BATCH_SIZE));const i={tenantId:this.tenantId,siteId:this.siteId,events:n};return(0,a.debugLog)(`[TrackingV2Service] ðŸ“¤ Enviando batch de ${n.length} eventos vÃ¡lidos...`),this.sendBatchWithRetry(i,r.MAX_RETRIES)}))}sendBatchWithBeacon(t){if(!this.initialized||0===t.length)return!1;if("undefined"==typeof navigator||!("sendBeacon"in navigator))return(0,a.debugLog)("[TrackingV2Service] âš ï¸ sendBeacon no disponible"),!1;const e=t.filter((t=>this.isValidTrackingEvent(t)));if(0===e.length)return(0,a.debugLog)("[TrackingV2Service] âŒ No hay eventos vÃ¡lidos para sendBeacon"),!1;const n={tenantId:this.tenantId,siteId:this.siteId,events:e.slice(0,r.MAX_BATCH_SIZE)},i=this.getTrackingEndpoint(),s=new Blob([JSON.stringify(n)],{type:"application/json"});try{const t=navigator.sendBeacon(i,s);return t?(0,a.debugLog)(`[TrackingV2Service] âœ… ${e.length} eventos vÃ¡lidos enviados via sendBeacon`):(0,a.debugLog)("[TrackingV2Service] âš ï¸ sendBeacon fallÃ³"),t}catch(t){return(0,a.debugLog)("[TrackingV2Service] âŒ Error con sendBeacon:",t),!1}}sendBatchWithRetry(t,e){return i(this,void 0,void 0,(function*(){const n=this.getTrackingEndpoint();try{const i=yield fetch(n,Object.assign(Object.assign({},(0,o.getCommonFetchOptions)("POST")),{body:JSON.stringify(t)}));if(!i.ok){if(yield i.text(),i.status>=500&&e>0){const n=1e3*Math.pow(2,r.MAX_RETRIES-e);return yield this.sleep(n),this.sendBatchWithRetry(t,e-1)}return null}const s=yield i.json();return(0,a.debugLog)("[TrackingV2Service] âœ… Batch enviado exitosamente:",s),s}catch(n){if(e>0){const n=1e3*Math.pow(2,r.MAX_RETRIES-e);return yield this.sleep(n),this.sendBatchWithRetry(t,e-1)}return null}}))}fetchMetadata(t){return i(this,void 0,void 0,(function*(){const e=`${s.EndpointManager.getInstance().getEndpoint()}/pixel/metadata?apiKey=${encodeURIComponent(t)}`;try{const t=yield fetch(e,(0,o.getCommonFetchOptions)("GET"));return t.ok?yield t.json():((0,a.debugLog)(`[TrackingV2Service] âš ï¸ Error obteniendo metadata: HTTP ${t.status}`),null)}catch(t){return(0,a.debugLog)("[TrackingV2Service] âŒ Error fetchMetadata:",t),null}}))}cacheMetadata(t){if("undefined"!=typeof localStorage)try{localStorage.setItem(r.METADATA_CACHE_KEY,JSON.stringify(t))}catch(t){(0,a.debugLog)("[TrackingV2Service] âš ï¸ No se pudo cachear metadata:",t)}}loadMetadataFromCache(){if("undefined"!=typeof localStorage)try{const t=localStorage.getItem(r.METADATA_CACHE_KEY);if(t){const e=JSON.parse(t);this.tenantId=e.tenantId,this.siteId=e.siteId,(0,a.debugLog)("[TrackingV2Service] ðŸ“‚ Metadata cargada desde cachÃ©")}}catch(t){(0,a.debugLog)("[TrackingV2Service] âš ï¸ Error cargando metadata desde cachÃ©:",t)}}getTrackingEndpoint(){return`${s.EndpointManager.getInstance().getEndpoint()}/tracking-v2/events`}sleep(t){return new Promise((e=>setTimeout(e,t)))}isInitialized(){return this.initialized}getMetadata(){return{tenantId:this.tenantId,siteId:this.siteId}}}e.TrackingV2Service=r,r.METADATA_CACHE_KEY="guiders_tracking_metadata",r.MAX_BATCH_SIZE=500,r.MAX_RETRIES=3,r.UUID_REGEX=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i},3741:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TrackingV2TransformStage=void 0;const i=n(3974);class s{process(t){try{const e=t.data||{},n=t.metadata||{},s=this.getVisitorId();if(!s)return(0,i.debugLog)("[TrackingV2TransformStage] âš ï¸ No se encontrÃ³ visitorId, evento no serÃ¡ enviado"),t;const a=this.getSessionId(n);if(!a)return(0,i.debugLog)("[TrackingV2TransformStage] âš ï¸ No se encontrÃ³ sessionId, evento no serÃ¡ enviado"),t;const o=e.eventType||t.type,r=this.normalizeEventType(o),c=Object.assign(Object.assign(Object.assign({},e.metadata||{}),n),this.extractAdditionalFields(e));delete c.session,delete c.token,delete c.trackingEventId;const d={visitorId:s,sessionId:a,eventType:r,metadata:c,occurredAt:new Date(t.timestamp).toISOString()};return t.data=d,delete t.metadata,(0,i.debugLog)("[TrackingV2TransformStage] âœ… Evento transformado:",{eventType:r,visitorId:s.substring(0,8)+"...",sessionId:(null==a?void 0:a.substring(0,8))+"..."}),t}catch(e){return t}}getVisitorId(){if("undefined"==typeof localStorage)return null;const t=localStorage.getItem("visitorId");return t&&this.isValidUUID(t)?t:null}isValidUUID(t){return/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t)}getSessionId(t){const e=t.session;if(e&&e.sessionId&&this.isValidUUID(e.sessionId))return e.sessionId;if("undefined"!=typeof sessionStorage){const t=sessionStorage.getItem("guiders_backend_session_id");if(t&&this.isValidUUID(t))return t;const e=sessionStorage.getItem("guiders_session_id");if(e&&this.isValidUUID(e))return e}return null}normalizeEventType(t){if(t===t.toUpperCase())return t;return s.EVENT_TYPE_MAP[t]||t.replace(/([A-Z])/g,"_$1").toUpperCase().replace(/^_/,"")}extractAdditionalFields(t){const e=new Set(["eventType","metadata","trackingEventId"]),n={};for(const i in t)t.hasOwnProperty(i)&&!e.has(i)&&(n[i]=t[i]);return n}}e.TrackingV2TransformStage=s,s.EVENT_TYPE_MAP={page_view:"PAGE_VIEW",click:"CLICK",hover:"HOVER",scroll:"SCROLL",mouse_move:"MOUSE_MOVE",form_submit:"FORM_SUBMIT",form_field_focus:"FORM_FIELD_FOCUS",video_play:"VIDEO_PLAY",video_pause:"VIDEO_PAUSE",video_complete:"VIDEO_COMPLETE",file_download:"FILE_DOWNLOAD",link_click:"LINK_CLICK",button_click:"BUTTON_CLICK",product_view:"PRODUCT_VIEW",add_to_cart:"ADD_TO_CART",search:"SEARCH","visitor:open-chat":"VISITOR_OPEN_CHAT","visitor:close-chat":"VISITOR_CLOSE_CHAT","visitor:chat-active":"VISITOR_CHAT_ACTIVE","visitor:send-message":"VISITOR_SEND_MESSAGE","tracking:tracking-event":"TRACKING_EVENT"}},3776:function(t,e,n){"use strict";var i=this&&this.__createBinding||(Object.create?function(t,e,n,i){void 0===i&&(i=n);var s=Object.getOwnPropertyDescriptor(e,n);s&&!("get"in s?!e.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return e[n]}}),Object.defineProperty(t,i,s)}:function(t,e,n,i){void 0===i&&(i=n),t[i]=e[n]}),s=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),a=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var n in t)"default"!==n&&Object.prototype.hasOwnProperty.call(t,n)&&i(e,t,n);return s(e,t),e},o=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.Manager=void 0;const r=n(4956),c=n(6214),d=a(n(4627)),l=n(5942),h=n(7743),u=n(4454),g=(0,o(n(7833)).default)("socket.io-client:manager");class p extends u.Emitter{constructor(t,e){var n;super(),this.nsps={},this.subs=[],t&&"object"==typeof t&&(e=t,t=void 0),(e=e||{}).path=e.path||"/socket.io",this.opts=e,(0,r.installTimerFunctions)(this,e),this.reconnection(!1!==e.reconnection),this.reconnectionAttempts(e.reconnectionAttempts||1/0),this.reconnectionDelay(e.reconnectionDelay||1e3),this.reconnectionDelayMax(e.reconnectionDelayMax||5e3),this.randomizationFactor(null!==(n=e.randomizationFactor)&&void 0!==n?n:.5),this.backoff=new h.Backoff({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==e.timeout?2e4:e.timeout),this._readyState="closed",this.uri=t;const i=e.parser||d;this.encoder=new i.Encoder,this.decoder=new i.Decoder,this._autoConnect=!1!==e.autoConnect,this._autoConnect&&this.open()}reconnection(t){return arguments.length?(this._reconnection=!!t,t||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(t){return void 0===t?this._reconnectionAttempts:(this._reconnectionAttempts=t,this)}reconnectionDelay(t){var e;return void 0===t?this._reconnectionDelay:(this._reconnectionDelay=t,null===(e=this.backoff)||void 0===e||e.setMin(t),this)}randomizationFactor(t){var e;return void 0===t?this._randomizationFactor:(this._randomizationFactor=t,null===(e=this.backoff)||void 0===e||e.setJitter(t),this)}reconnectionDelayMax(t){var e;return void 0===t?this._reconnectionDelayMax:(this._reconnectionDelayMax=t,null===(e=this.backoff)||void 0===e||e.setMax(t),this)}timeout(t){return arguments.length?(this._timeout=t,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()}open(t){if(g("readyState %s",this._readyState),~this._readyState.indexOf("open"))return this;g("opening %s",this.uri),this.engine=new r.Socket(this.uri,this.opts);const e=this.engine,n=this;this._readyState="opening",this.skipReconnect=!1;const i=(0,l.on)(e,"open",(function(){n.onopen(),t&&t()})),s=e=>{g("error"),this.cleanup(),this._readyState="closed",this.emitReserved("error",e),t?t(e):this.maybeReconnectOnOpen()},a=(0,l.on)(e,"error",s);if(!1!==this._timeout){const t=this._timeout;g("connect attempt will timeout after %d",t);const n=this.setTimeoutFn((()=>{g("connect attempt timed out after %d",t),i(),s(new Error("timeout")),e.close()}),t);this.opts.autoUnref&&n.unref(),this.subs.push((()=>{this.clearTimeoutFn(n)}))}return this.subs.push(i),this.subs.push(a),this}connect(t){return this.open(t)}onopen(){g("open"),this.cleanup(),this._readyState="open",this.emitReserved("open");const t=this.engine;this.subs.push((0,l.on)(t,"ping",this.onping.bind(this)),(0,l.on)(t,"data",this.ondata.bind(this)),(0,l.on)(t,"error",this.onerror.bind(this)),(0,l.on)(t,"close",this.onclose.bind(this)),(0,l.on)(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(t){try{this.decoder.add(t)}catch(t){this.onclose("parse error",t)}}ondecoded(t){(0,r.nextTick)((()=>{this.emitReserved("packet",t)}),this.setTimeoutFn)}onerror(t){g("error",t),this.emitReserved("error",t)}socket(t,e){let n=this.nsps[t];return n?this._autoConnect&&!n.active&&n.connect():(n=new c.Socket(this,t,e),this.nsps[t]=n),n}_destroy(t){const e=Object.keys(this.nsps);for(const t of e)if(this.nsps[t].active)return void g("socket %s is still active, skipping close",t);this._close()}_packet(t){g("writing packet %j",t);const e=this.encoder.encode(t);for(let n=0;n<e.length;n++)this.engine.write(e[n],t.options)}cleanup(){g("cleanup"),this.subs.forEach((t=>t())),this.subs.length=0,this.decoder.destroy()}_close(){g("disconnect"),this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(t,e){var n;g("closed due to %s",t),this.cleanup(),null===(n=this.engine)||void 0===n||n.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",t,e),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const t=this;if(this.backoff.attempts>=this._reconnectionAttempts)g("reconnect failed"),this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const e=this.backoff.duration();g("will wait %dms before reconnect attempt",e),this._reconnecting=!0;const n=this.setTimeoutFn((()=>{t.skipReconnect||(g("attempting reconnect"),this.emitReserved("reconnect_attempt",t.backoff.attempts),t.skipReconnect||t.open((e=>{e?(g("reconnect attempt error"),t._reconnecting=!1,t.reconnect(),this.emitReserved("reconnect_error",e)):(g("reconnect success"),t.onreconnect())})))}),e);this.opts.autoUnref&&n.unref(),this.subs.push((()=>{this.clearTimeoutFn(n)}))}}onreconnect(){const t=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",t)}}e.Manager=p},3974:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.debugLog=function(...t){},e.debugInit=function(...t){},e.debugWarn=function(...t){},e.debugError=function(...t){},e.enableDebug=function(){},e.disableDebug=function(){}},4110:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.hasCORS=void 0;let n=!1;try{n="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(t){}e.hasCORS=n},4213:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0,e.default="ffffffff-ffff-ffff-ffff-ffffffffffff"},4412:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ChatMemoryStore=void 0;const i=n(3974);class s{constructor(){this.currentChatId=null}static getInstance(){return s.instance||(s.instance=new s),s.instance}setChatId(t){this.currentChatId=t,(0,i.debugLog)("[ChatMemoryStore] ðŸ’¾ Chat ID guardado en memoria:",t)}getChatId(){return this.currentChatId}clearChatId(){this.currentChatId=null,(0,i.debugLog)("[ChatMemoryStore] ðŸ—‘ï¸ Chat ID limpiado de memoria")}hasChatId(){return null!==this.currentChatId}}e.ChatMemoryStore=s},4454:(t,e,n)=>{"use strict";function i(t){if(t)return function(t){for(var e in i.prototype)t[e]=i.prototype[e];return t}(t)}n.r(e),n.d(e,{Emitter:()=>i}),i.prototype.on=i.prototype.addEventListener=function(t,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(e),this},i.prototype.once=function(t,e){function n(){this.off(t,n),e.apply(this,arguments)}return n.fn=e,this.on(t,n),this},i.prototype.off=i.prototype.removeListener=i.prototype.removeAllListeners=i.prototype.removeEventListener=function(t,e){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var n,i=this._callbacks["$"+t];if(!i)return this;if(1==arguments.length)return delete this._callbacks["$"+t],this;for(var s=0;s<i.length;s++)if((n=i[s])===e||n.fn===e){i.splice(s,1);break}return 0===i.length&&delete this._callbacks["$"+t],this},i.prototype.emit=function(t){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),n=this._callbacks["$"+t],i=1;i<arguments.length;i++)e[i-1]=arguments[i];if(n){i=0;for(var s=(n=n.slice(0)).length;i<s;++i)n[i].apply(this,e)}return this},i.prototype.emitReserved=i.prototype.emit,i.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]},i.prototype.hasListeners=function(t){return!!this.listeners(t).length}},4476:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SessionInjectionStage=void 0;const i=n(3974);e.SessionInjectionStage=class{constructor(t=null){this.sessionManager=t}setSessionManager(t){this.sessionManager=t}process(t){var e;if((0,i.debugLog)("SessionInjectionStage: Iniciando inyecciÃ³n de sesiÃ³n..."),!this.sessionManager)return t;const n=this.sessionManager.getCurrentSession();return n&&(t.metadata||(t.metadata={}),t.metadata.session={sessionId:n.sessionId,startTime:n.startTime,lastActiveTime:n.lastActiveTime,totalActiveTime:n.totalActiveTime,isActive:n.isActive,isIdle:n.isIdle},t.data||(t.data={}),t.data.sessionId=n.sessionId),(0,i.debugLog)("SessionInjectionStage: SesiÃ³n inyectada en el evento:",null===(e=t.metadata)||void 0===e?void 0:e.session),t}}},4480:function(t,e,n){"use strict";var i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.WT=void 0;const s=n(4689),a=n(4624),o=n(6376),r=(0,i(n(7833)).default)("engine.io-client:webtransport");class c extends s.Transport{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(t){return this.emitReserved("error",t)}this._transport.closed.then((()=>{r("transport closed gracefully"),this.onClose()})).catch((t=>{r("transport closed due to %s",t),this.onError("webtransport error",t)})),this._transport.ready.then((()=>{this._transport.createBidirectionalStream().then((t=>{const e=(0,o.createPacketDecoderStream)(Number.MAX_SAFE_INTEGER,this.socket.binaryType),n=t.readable.pipeThrough(e).getReader(),i=(0,o.createPacketEncoderStream)();i.readable.pipeTo(t.writable),this._writer=i.writable.getWriter();const s=()=>{n.read().then((({done:t,value:e})=>{t?r("session is closed"):(r("received chunk: %o",e),this.onPacket(e),s())})).catch((t=>{r("an error occurred while reading: %s",t)}))};s();const a={type:"open"};this.query.sid&&(a.data=`{"sid":"${this.query.sid}"}`),this._writer.write(a).then((()=>this.onOpen()))}))}))}write(t){this.writable=!1;for(let e=0;e<t.length;e++){const n=t[e],i=e===t.length-1;this._writer.write(n).then((()=>{i&&(0,a.nextTick)((()=>{this.writable=!0,this.emitReserved("drain")}),this.setTimeoutFn)}))}}doClose(){var t;null===(t=this._transport)||void 0===t||t.close()}}e.WT=c},4505:function(t,e,n){"use strict";var i=this&&this.__createBinding||(Object.create?function(t,e,n,i){void 0===i&&(i=n);var s=Object.getOwnPropertyDescriptor(e,n);s&&!("get"in s?!e.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return e[n]}}),Object.defineProperty(t,i,s)}:function(t,e,n,i){void 0===i&&(i=n),t[i]=e[n]}),s=this&&this.__exportStar||function(t,e){for(var n in t)"default"===n||Object.prototype.hasOwnProperty.call(e,n)||i(e,t,n)};Object.defineProperty(e,"__esModule",{value:!0}),s(n(1506),e)},4624:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.defaultBinaryType=e.globalThisShim=e.nextTick=void 0,e.createCookieJar=function(){},e.nextTick="function"==typeof Promise&&"function"==typeof Promise.resolve?t=>Promise.resolve().then(t):(t,e)=>e(t,0),e.globalThisShim="undefined"!=typeof self?self:"undefined"!=typeof window?window:Function("return this")(),e.defaultBinaryType="arraybuffer"},4627:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Decoder=e.Encoder=e.PacketType=e.protocol=void 0;const i=n(4454),s=n(4926),a=n(9133),o=(0,n(7833).default)("socket.io-parser"),r=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"];var c;function d(t){return"[object Object]"===Object.prototype.toString.call(t)}e.protocol=5,function(t){t[t.CONNECT=0]="CONNECT",t[t.DISCONNECT=1]="DISCONNECT",t[t.EVENT=2]="EVENT",t[t.ACK=3]="ACK",t[t.CONNECT_ERROR=4]="CONNECT_ERROR",t[t.BINARY_EVENT=5]="BINARY_EVENT",t[t.BINARY_ACK=6]="BINARY_ACK"}(c=e.PacketType||(e.PacketType={})),e.Encoder=class{constructor(t){this.replacer=t}encode(t){return o("encoding packet %j",t),t.type!==c.EVENT&&t.type!==c.ACK||!(0,a.hasBinary)(t)?[this.encodeAsString(t)]:this.encodeAsBinary({type:t.type===c.EVENT?c.BINARY_EVENT:c.BINARY_ACK,nsp:t.nsp,data:t.data,id:t.id})}encodeAsString(t){let e=""+t.type;return t.type!==c.BINARY_EVENT&&t.type!==c.BINARY_ACK||(e+=t.attachments+"-"),t.nsp&&"/"!==t.nsp&&(e+=t.nsp+","),null!=t.id&&(e+=t.id),null!=t.data&&(e+=JSON.stringify(t.data,this.replacer)),o("encoded %j as %s",t,e),e}encodeAsBinary(t){const e=(0,s.deconstructPacket)(t),n=this.encodeAsString(e.packet),i=e.buffers;return i.unshift(n),i}};class l extends i.Emitter{constructor(t){super(),this.reviver=t}add(t){let e;if("string"==typeof t){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");e=this.decodeString(t);const n=e.type===c.BINARY_EVENT;n||e.type===c.BINARY_ACK?(e.type=n?c.EVENT:c.ACK,this.reconstructor=new h(e),0===e.attachments&&super.emitReserved("decoded",e)):super.emitReserved("decoded",e)}else{if(!(0,a.isBinary)(t)&&!t.base64)throw new Error("Unknown type: "+t);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");e=this.reconstructor.takeBinaryData(t),e&&(this.reconstructor=null,super.emitReserved("decoded",e))}}decodeString(t){let e=0;const n={type:Number(t.charAt(0))};if(void 0===c[n.type])throw new Error("unknown packet type "+n.type);if(n.type===c.BINARY_EVENT||n.type===c.BINARY_ACK){const i=e+1;for(;"-"!==t.charAt(++e)&&e!=t.length;);const s=t.substring(i,e);if(s!=Number(s)||"-"!==t.charAt(e))throw new Error("Illegal attachments");n.attachments=Number(s)}if("/"===t.charAt(e+1)){const i=e+1;for(;++e&&","!==t.charAt(e)&&e!==t.length;);n.nsp=t.substring(i,e)}else n.nsp="/";const i=t.charAt(e+1);if(""!==i&&Number(i)==i){const i=e+1;for(;++e;){const n=t.charAt(e);if(null==n||Number(n)!=n){--e;break}if(e===t.length)break}n.id=Number(t.substring(i,e+1))}if(t.charAt(++e)){const i=this.tryParse(t.substr(e));if(!l.isPayloadValid(n.type,i))throw new Error("invalid payload");n.data=i}return o("decoded %s as %j",t,n),n}tryParse(t){try{return JSON.parse(t,this.reviver)}catch(t){return!1}}static isPayloadValid(t,e){switch(t){case c.CONNECT:return d(e);case c.DISCONNECT:return void 0===e;case c.CONNECT_ERROR:return"string"==typeof e||d(e);case c.EVENT:case c.BINARY_EVENT:return Array.isArray(e)&&("number"==typeof e[0]||"string"==typeof e[0]&&-1===r.indexOf(e[0]));case c.ACK:case c.BINARY_ACK:return Array.isArray(e)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}e.Decoder=l;class h{constructor(t){this.packet=t,this.buffers=[],this.reconPack=t}takeBinaryData(t){if(this.buffers.push(t),this.buffers.length===this.reconPack.attachments){const t=(0,s.reconstructPacket)(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}},4671:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(t={},e,n=0){var o=(0,s.default)(c(c({},t),{},{_v6:!0}),new Uint8Array(16));if(o=(0,a.default)(o),e){for(var r=0;r<16;r++)e[n+r]=o[r];return e}return(0,i.unsafeStringify)(o)};var i=n(9910),s=o(n(3518)),a=o(n(343));function o(t){return t&&t.__esModule?t:{default:t}}function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,i)}return n}function c(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?r(Object(n),!0).forEach((function(e){d(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function d(t,e,n){return(e=function(t){var e=function(t){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}},4689:function(t,e,n){"use strict";var i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.Transport=e.TransportError=void 0;const s=n(6376),a=n(4454),o=n(5374),r=n(8661),c=(0,i(n(7833)).default)("engine.io-client:transport");class d extends Error{constructor(t,e,n){super(t),this.description=e,this.context=n,this.type="TransportError"}}e.TransportError=d;class l extends a.Emitter{constructor(t){super(),this.writable=!1,(0,o.installTimerFunctions)(this,t),this.opts=t,this.query=t.query,this.socket=t.socket,this.supportsBinary=!t.forceBase64}onError(t,e,n){return super.emitReserved("error",new d(t,e,n)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this}send(t){"open"===this.readyState?this.write(t):c("transport is not open, discarding packets")}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(t){const e=(0,s.decodePacket)(t,this.socket.binaryType);this.onPacket(e)}onPacket(t){super.emitReserved("packet",t)}onClose(t){this.readyState="closed",super.emitReserved("close",t)}pause(t){}createUri(t,e={}){return t+"://"+this._hostname()+this._port()+this.opts.path+this._query(e)}_hostname(){const t=this.opts.hostname;return-1===t.indexOf(":")?t:"["+t+"]"}_port(){return this.opts.port&&(this.opts.secure&&Number(443!==this.opts.port)||!this.opts.secure&&80!==Number(this.opts.port))?":"+this.opts.port:""}_query(t){const e=(0,r.encode)(t);return e.length?"?"+e:""}}e.Transport=l},4729:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ConsentBannerUI=void 0;const i=n(3974);e.ConsentBannerUI=class{constructor(t={}){var e,n,s,a,o,r,c,d,l,h,u,g,p,f,m,b,v,y,C,S,w;this.bannerElement=null,this.onAccept=()=>{(0,i.debugLog)("[ConsentBannerUI] ðŸŸ¢ Callback onAccept (no configurado)")},this.onDeny=()=>{(0,i.debugLog)("[ConsentBannerUI] ðŸ”´ Callback onDeny (no configurado)")},this.onPreferences=()=>{(0,i.debugLog)("[ConsentBannerUI] âš™ï¸ Callback onPreferences (no configurado)")};this.config={enabled:null===(e=t.enabled)||void 0===e||e,style:null!==(n=t.style)&&void 0!==n?n:"bottom_bar",text:null!==(s=t.text)&&void 0!==s?s:"ðŸª Usamos cookies para mejorar tu experiencia y proporcionar chat en vivo.",acceptText:null!==(a=t.acceptText)&&void 0!==a?a:"Aceptar Todo",denyText:null!==(o=t.denyText)&&void 0!==o?o:"Rechazar",preferencesText:null!==(r=t.preferencesText)&&void 0!==r?r:"Preferencias",showPreferences:null===(c=t.showPreferences)||void 0===c||c,colors:{background:null!==(l=null===(d=t.colors)||void 0===d?void 0:d.background)&&void 0!==l?l:"#2c3e50",text:null!==(u=null===(h=t.colors)||void 0===h?void 0:h.text)&&void 0!==u?u:"#ffffff",acceptButton:null!==(p=null===(g=t.colors)||void 0===g?void 0:g.acceptButton)&&void 0!==p?p:"#27ae60",denyButton:null!==(m=null===(f=t.colors)||void 0===f?void 0:f.denyButton)&&void 0!==m?m:"#95a5a6",preferencesButton:null!==(v=null===(b=t.colors)||void 0===b?void 0:b.preferencesButton)&&void 0!==v?v:"#3498db"},position:null!==(y=t.position)&&void 0!==y?y:"bottom",showCloseButton:null!==(C=t.showCloseButton)&&void 0!==C&&C,autoShow:null===(S=t.autoShow)||void 0===S||S,className:null!==(w=t.className)&&void 0!==w?w:""},(0,i.debugLog)("[ConsentBannerUI] ðŸŽ¨ Inicializado con config:",this.config)}render(){if(this.config.enabled&&"none"!==this.config.style){switch(this.remove(),this.config.style){case"bottom_bar":this.bannerElement=this.createBottomBar();break;case"modal":this.bannerElement=this.createModal();break;case"corner":this.bannerElement=this.createCorner()}this.bannerElement&&(this.config.className&&this.bannerElement.classList.add(this.config.className),document.body.appendChild(this.bannerElement),(0,i.debugLog)("[ConsentBannerUI] âœ… Banner renderizado (estilo: "+this.config.style+")"))}else(0,i.debugLog)("[ConsentBannerUI] âš ï¸ Banner deshabilitado")}show(){this.bannerElement&&(this.bannerElement.style.display="block",(0,i.debugLog)("[ConsentBannerUI] ðŸ‘ï¸ Banner mostrado"))}hide(){this.bannerElement&&(this.bannerElement.style.display="none",(0,i.debugLog)("[ConsentBannerUI] ðŸ™ˆ Banner oculto"))}remove(){this.bannerElement&&this.bannerElement.parentNode&&(this.bannerElement.parentNode.removeChild(this.bannerElement),this.bannerElement=null,(0,i.debugLog)("[ConsentBannerUI] ðŸ—‘ï¸ Banner removido"))}isVisible(){return null!==this.bannerElement&&"none"!==this.bannerElement.style.display}createBottomBar(){const t=document.createElement("div");t.id="guiders-consent-banner",t.setAttribute("role","dialog"),t.setAttribute("aria-label","Consentimiento de cookies"),t.style.cssText=`\n      position: fixed;\n      ${this.config.position}: 0;\n      left: 0;\n      right: 0;\n      background: ${this.config.colors.background};\n      color: ${this.config.colors.text};\n      padding: 20px;\n      z-index: 999999;\n      box-shadow: 0 -2px 10px rgba(0,0,0,0.2);\n      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;\n      animation: slideUp 0.3s ease-out;\n    `;const e=document.createElement("div");e.style.cssText="\n      max-width: 1200px;\n      margin: 0 auto;\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      flex-wrap: wrap;\n      gap: 15px;\n    ";const n=document.createElement("p");n.textContent=this.config.text,n.style.cssText="\n      margin: 0;\n      flex: 1;\n      min-width: 300px;\n      font-size: 14px;\n      line-height: 1.5;\n    ",e.appendChild(n);const i=document.createElement("div");i.style.cssText="\n      display: flex;\n      gap: 10px;\n      flex-wrap: wrap;\n    ";const s=this.createButton(this.config.acceptText,this.config.colors.acceptButton,(()=>this.onAccept()));if(s.setAttribute("aria-label","Aceptar todas las cookies"),i.appendChild(s),this.config.showPreferences){const t=this.createButton(this.config.preferencesText,this.config.colors.preferencesButton,(()=>this.onPreferences()));t.setAttribute("aria-label","Configurar preferencias de cookies"),i.appendChild(t)}const a=this.createButton(this.config.denyText,this.config.colors.denyButton,(()=>this.onDeny()));return a.setAttribute("aria-label","Rechazar cookies no esenciales"),i.appendChild(a),e.appendChild(i),t.appendChild(e),this.injectStyles(),t}createModal(){const t=document.createElement("div");t.id="guiders-consent-overlay",t.setAttribute("role","dialog"),t.setAttribute("aria-modal","true"),t.setAttribute("aria-label","Consentimiento de cookies"),t.style.cssText="\n      position: fixed;\n      top: 0;\n      left: 0;\n      right: 0;\n      bottom: 0;\n      background: rgba(0,0,0,0.7);\n      z-index: 999998;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      padding: 20px;\n      animation: fadeIn 0.3s ease-out;\n    ";const e=document.createElement("div");e.style.cssText='\n      background: white;\n      padding: 30px;\n      border-radius: 8px;\n      max-width: 500px;\n      width: 100%;\n      box-shadow: 0 4px 20px rgba(0,0,0,0.3);\n      animation: scaleIn 0.3s ease-out;\n      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;\n    ';const n=document.createElement("h2");n.textContent="ðŸª GestiÃ³n de Cookies",n.style.cssText="\n      margin-top: 0;\n      color: #2c3e50;\n      font-size: 20px;\n      font-weight: 600;\n    ",e.appendChild(n);const i=document.createElement("p");i.textContent=this.config.text,i.style.cssText="\n      color: #555;\n      line-height: 1.6;\n      margin-bottom: 20px;\n      font-size: 14px;\n    ",e.appendChild(i);const s=document.createElement("div");s.style.cssText="\n      display: flex;\n      gap: 10px;\n      justify-content: flex-end;\n      flex-wrap: wrap;\n    ";const a=this.createButton(this.config.acceptText,this.config.colors.acceptButton,(()=>this.onAccept()));if(s.appendChild(a),this.config.showPreferences){const t=this.createButton(this.config.preferencesText,this.config.colors.preferencesButton,(()=>this.onPreferences()));s.appendChild(t)}const o=this.createButton(this.config.denyText,this.config.colors.denyButton,(()=>this.onDeny()));return s.appendChild(o),e.appendChild(s),t.appendChild(e),this.injectStyles(),t}createCorner(){const t=document.createElement("div");t.id="guiders-consent-banner",t.setAttribute("role","dialog"),t.setAttribute("aria-label","Consentimiento de cookies"),t.style.cssText=`\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      background: ${this.config.colors.background};\n      color: ${this.config.colors.text};\n      padding: 20px;\n      border-radius: 8px;\n      max-width: 350px;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n      z-index: 999999;\n      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;\n      animation: slideInRight 0.3s ease-out;\n    `;const e=document.createElement("p");e.textContent=this.config.text,e.style.cssText="\n      margin: 0 0 15px 0;\n      font-size: 13px;\n      line-height: 1.5;\n    ",t.appendChild(e);const n=document.createElement("div");n.style.cssText="\n      display: flex;\n      gap: 8px;\n      flex-direction: column;\n    ";const i=this.createButton(this.config.acceptText,this.config.colors.acceptButton,(()=>this.onAccept()));if(i.style.width="100%",n.appendChild(i),this.config.showPreferences){const t=this.createButton(this.config.preferencesText,this.config.colors.preferencesButton,(()=>this.onPreferences()));t.style.width="100%",n.appendChild(t)}const s=this.createButton(this.config.denyText,this.config.colors.denyButton,(()=>this.onDeny()));return s.style.width="100%",n.appendChild(s),t.appendChild(n),this.injectStyles(),t}createButton(t,e,n){const i=document.createElement("button");return i.textContent=t,i.style.cssText=`\n      background: ${e};\n      color: white;\n      border: none;\n      padding: 10px 20px;\n      cursor: pointer;\n      border-radius: 4px;\n      font-weight: 600;\n      font-size: 14px;\n      transition: all 0.2s ease;\n      font-family: inherit;\n    `,i.addEventListener("mouseenter",(()=>{i.style.transform="translateY(-1px)",i.style.boxShadow="0 2px 8px rgba(0,0,0,0.2)"})),i.addEventListener("mouseleave",(()=>{i.style.transform="translateY(0)",i.style.boxShadow="none"})),i.addEventListener("click",n),i}injectStyles(){if(document.getElementById("guiders-consent-banner-styles"))return;const t=document.createElement("style");t.id="guiders-consent-banner-styles",t.textContent="\n      @keyframes slideUp {\n        from {\n          transform: translateY(100%);\n          opacity: 0;\n        }\n        to {\n          transform: translateY(0);\n          opacity: 1;\n        }\n      }\n\n      @keyframes slideInRight {\n        from {\n          transform: translateX(100%);\n          opacity: 0;\n        }\n        to {\n          transform: translateX(0);\n          opacity: 1;\n        }\n      }\n\n      @keyframes fadeIn {\n        from {\n          opacity: 0;\n        }\n        to {\n          opacity: 1;\n        }\n      }\n\n      @keyframes scaleIn {\n        from {\n          transform: scale(0.9);\n          opacity: 0;\n        }\n        to {\n          transform: scale(1);\n          opacity: 1;\n        }\n      }\n\n      /* Responsive para mÃ³viles */\n      @media (max-width: 768px) {\n        #guiders-consent-banner {\n          padding: 15px !important;\n        }\n\n        #guiders-consent-banner > div {\n          flex-direction: column !important;\n          align-items: flex-start !important;\n        }\n\n        #guiders-consent-banner button {\n          width: 100%;\n        }\n      }\n    ",document.head.appendChild(t)}updateConfig(t){t.colors&&(this.config.colors=Object.assign(Object.assign({},this.config.colors),t.colors)),void 0!==t.enabled&&(this.config.enabled=t.enabled),t.style&&(this.config.style=t.style),t.text&&(this.config.text=t.text),t.acceptText&&(this.config.acceptText=t.acceptText),t.denyText&&(this.config.denyText=t.denyText),t.preferencesText&&(this.config.preferencesText=t.preferencesText),void 0!==t.showPreferences&&(this.config.showPreferences=t.showPreferences),t.position&&(this.config.position=t.position),void 0!==t.showCloseButton&&(this.config.showCloseButton=t.showCloseButton),void 0!==t.autoShow&&(this.config.autoShow=t.autoShow),t.className&&(this.config.className=t.className),(0,i.debugLog)("[ConsentBannerUI] ðŸ”„ ConfiguraciÃ³n actualizada"),this.bannerElement&&(this.remove(),this.render())}}},4808:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0,e.default="00000000-0000-0000-0000-000000000000"},4815:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TimeStampStage=void 0,e.TimeStampStage=class{process(t){return t.timestamp=(new Date).getTime(),t}}},4926:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.reconstructPacket=e.deconstructPacket=void 0;const i=n(9133);function s(t,e){if(!t)return t;if((0,i.isBinary)(t)){const n={_placeholder:!0,num:e.length};return e.push(t),n}if(Array.isArray(t)){const n=new Array(t.length);for(let i=0;i<t.length;i++)n[i]=s(t[i],e);return n}if("object"==typeof t&&!(t instanceof Date)){const n={};for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=s(t[i],e));return n}return t}function a(t,e){if(!t)return t;if(t&&!0===t._placeholder){if("number"==typeof t.num&&t.num>=0&&t.num<e.length)return e[t.num];throw new Error("illegal attachments")}if(Array.isArray(t))for(let n=0;n<t.length;n++)t[n]=a(t[n],e);else if("object"==typeof t)for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(t[n]=a(t[n],e));return t}e.deconstructPacket=function(t){const e=[],n=t.data,i=t;return i.data=s(n,e),i.attachments=e.length,{packet:i,buffers:e}},e.reconstructPacket=function(t,e){return t.data=a(t.data,e),delete t.attachments,t}},4948:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i=a(n(9025)),s=a(n(2311));function a(t){return t&&t.__esModule?t:{default:t}}var o=(0,i.default)("v3",48,s.default);e.default=o},4956:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.WebTransport=e.WebSocket=e.NodeWebSocket=e.XHR=e.NodeXHR=e.Fetch=e.nextTick=e.parse=e.installTimerFunctions=e.transports=e.TransportError=e.Transport=e.protocol=e.SocketWithUpgrade=e.SocketWithoutUpgrade=e.Socket=void 0;const i=n(8223);Object.defineProperty(e,"Socket",{enumerable:!0,get:function(){return i.Socket}});var s=n(8223);Object.defineProperty(e,"SocketWithoutUpgrade",{enumerable:!0,get:function(){return s.SocketWithoutUpgrade}}),Object.defineProperty(e,"SocketWithUpgrade",{enumerable:!0,get:function(){return s.SocketWithUpgrade}}),e.protocol=i.Socket.protocol;var a=n(4689);Object.defineProperty(e,"Transport",{enumerable:!0,get:function(){return a.Transport}}),Object.defineProperty(e,"TransportError",{enumerable:!0,get:function(){return a.TransportError}});var o=n(9419);Object.defineProperty(e,"transports",{enumerable:!0,get:function(){return o.transports}});var r=n(5374);Object.defineProperty(e,"installTimerFunctions",{enumerable:!0,get:function(){return r.installTimerFunctions}});var c=n(1015);Object.defineProperty(e,"parse",{enumerable:!0,get:function(){return c.parse}});var d=n(4624);Object.defineProperty(e,"nextTick",{enumerable:!0,get:function(){return d.nextTick}});var l=n(8209);Object.defineProperty(e,"Fetch",{enumerable:!0,get:function(){return l.Fetch}});var h=n(2071);Object.defineProperty(e,"NodeXHR",{enumerable:!0,get:function(){return h.XHR}});var u=n(2071);Object.defineProperty(e,"XHR",{enumerable:!0,get:function(){return u.XHR}});var g=n(8716);Object.defineProperty(e,"NodeWebSocket",{enumerable:!0,get:function(){return g.WS}});var p=n(8716);Object.defineProperty(e,"WebSocket",{enumerable:!0,get:function(){return p.WS}});var f=n(4480);Object.defineProperty(e,"WebTransport",{enumerable:!0,get:function(){return f.WT}})},4968:function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function r(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.ConsentBackendService=void 0;const s=n(2597),a=n(3974),o={analytics:"analytics",functional:"privacy_policy",personalization:"marketing"},r={analytics:"analytics",privacy_policy:"functional",marketing:"personalization"};class c{constructor(){this.sessionId=null}static getInstance(){return c.instance||(c.instance=new c),c.instance}setSessionId(t){this.sessionId=t,(0,a.debugLog)("[ConsentBackendService] ðŸ” Session ID establecido")}getBaseUrl(){return`${s.EndpointManager.getInstance().getEndpoint()}/consents`}makeRequest(t){return i(this,arguments,void 0,(function*(t,e={},n=!1){const i=`${this.getBaseUrl()}${t}`,s=Object.assign({"Content-Type":"application/json"},e.headers||{}),o=this.sessionId||("undefined"!=typeof sessionStorage?sessionStorage.getItem("guiders_backend_session_id"):null);o&&(s["X-Guiders-Sid"]=o,(0,a.debugLog)("[ConsentBackendService] ðŸ” Enviando X-Guiders-Sid:",o));try{const o=yield fetch(i,Object.assign(Object.assign({},e),{headers:s,credentials:"include"}));if(401===o.status&&!n&&((0,a.debugLog)("[ConsentBackendService] âš ï¸ Error 401 - Intentando re-autenticaciÃ³n..."),yield this.reAuthenticate()))return(0,a.debugLog)("[ConsentBackendService] âœ… Re-autenticaciÃ³n exitosa, reintentando..."),this.makeRequest(t,e,!0);if(!o.ok){const t=yield o.json().catch((()=>({})));throw new Error(`Backend consent API error: ${o.status} - ${t.message||o.statusText}`)}return yield o.json()}catch(t){throw t}}))}reAuthenticate(){return i(this,void 0,void 0,(function*(){try{const t=localStorage.getItem("fingerprint"),e=localStorage.getItem("guidersApiKey")||localStorage.getItem("apiKey"),n="undefined"!=typeof window?window.location.hostname:"localhost",i="undefined"!=typeof window?window.location.href:void 0;let o="v1.0";const r=localStorage.getItem("guiders_consent_state");if(r)try{o=JSON.parse(r).version||"v1.0"}catch(t){}if(!t)return(0,a.debugLog)("[ConsentBackendService] âŒ No hay fingerprint para re-autenticar"),!1;const c=`${s.EndpointManager.getInstance().getEndpoint()}/visitors/identify`;(0,a.debugLog)("[ConsentBackendService] ðŸ” Re-autenticando...");const d=yield fetch(c,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({fingerprint:t,domain:n,apiKey:e||"",hasAcceptedPrivacyPolicy:!0,consentVersion:o,currentUrl:i})});if(d.ok){const t=yield d.json();return t.sessionId&&(sessionStorage.setItem("guiders_backend_session_id",t.sessionId),this.sessionId=t.sessionId,(0,a.debugLog)("[ConsentBackendService] âœ… SessionId actualizado:",t.sessionId)),t.visitorId&&localStorage.setItem("visitorId",t.visitorId),(t.tenantId||t.tenant_id)&&localStorage.setItem("tenantId",t.tenantId||t.tenant_id),!0}return(0,a.debugLog)("[ConsentBackendService] âŒ Error en re-autenticaciÃ³n:",d.status),!1}catch(t){return!1}}))}sdkCategoryToBackendType(t){return o[t]||"privacy_policy"}backendTypeToSdkCategory(t){return r[t]||"functional"}grantConsents(t,e){return i(this,void 0,void 0,(function*(){(0,a.debugLog)("[ConsentBackendService] âœ… Otorgando consentimientos:",e);const n=[];for(const[i,s]of Object.entries(e)){if(!s)continue;const e=this.sdkCategoryToBackendType(i);try{const s=yield this.makeRequest("/grant",{method:"POST",body:JSON.stringify({visitorId:t,type:e,metadata:{source:"sdk",category:i}})});n.push(s)}catch(t){}}return n}))}revokeConsent(t,e,n){return i(this,void 0,void 0,(function*(){const i=this.sdkCategoryToBackendType(e);return(0,a.debugLog)("[ConsentBackendService] âŒ Revocando consentimiento:",{visitorId:t,category:e,backendType:i,reason:n}),this.makeRequest("/revoke",{method:"POST",body:JSON.stringify({visitorId:t,type:i,reason:n||"Usuario revocÃ³ consentimiento desde el SDK"})})}))}revokeAllConsents(t,e){return i(this,void 0,void 0,(function*(){(0,a.debugLog)("[ConsentBackendService] âŒ Revocando TODOS los consentimientos");const n=["analytics","functional","personalization"],i=[];for(const s of n)try{const n=yield this.revokeConsent(t,s,e);i.push(n)}catch(t){}return i}))}renewConsent(t,e){return i(this,void 0,void 0,(function*(){const n=this.sdkCategoryToBackendType(e);return(0,a.debugLog)("[ConsentBackendService] ðŸ”„ Renovando consentimiento:",{visitorId:t,category:e,backendType:n}),this.makeRequest("/renew",{method:"POST",body:JSON.stringify({visitorId:t,type:n})})}))}getConsentHistory(t){return i(this,void 0,void 0,(function*(){return(0,a.debugLog)("[ConsentBackendService] ðŸ“‹ Obteniendo historial de consentimientos"),this.makeRequest(`/visitors/${t}`)}))}getAuditLogs(t){return i(this,void 0,void 0,(function*(){return(0,a.debugLog)("[ConsentBackendService] ðŸ“œ Obteniendo audit logs"),this.makeRequest(`/visitors/${t}/audit-logs`)}))}syncWithBackend(t){return i(this,void 0,void 0,(function*(){(0,a.debugLog)("[ConsentBackendService] ðŸ”„ Sincronizando con backend...");try{const e=yield this.getConsentHistory(t),n={analytics:!1,functional:!1,personalization:!1};for(const t of e.consents)if("granted"===t.status){const e=this.backendTypeToSdkCategory(t.type);"analytics"!==e&&"functional"!==e&&"personalization"!==e||(n[e]=!0)}return(0,a.debugLog)("[ConsentBackendService] âœ… Estado sincronizado:",n),n}catch(t){return{analytics:!1,functional:!1,personalization:!1}}}))}isConsentActive(t,e){return i(this,void 0,void 0,(function*(){try{const n=yield this.getConsentHistory(t),i=this.sdkCategoryToBackendType(e),s=n.consents.find((t=>t.type===i));return"granted"===(null==s?void 0:s.status)}catch(t){return!1}}))}exportConsentData(t){return i(this,void 0,void 0,(function*(){(0,a.debugLog)("[ConsentBackendService] ðŸ“¦ Exportando datos de consentimiento");try{const[e,n]=yield Promise.all([this.getConsentHistory(t),this.getAuditLogs(t)]),i={visitorId:t,exportDate:(new Date).toISOString(),consents:e.consents,auditLogs:n.logs,summary:{totalConsents:e.total,activeConsents:e.consents.filter((t=>"granted"===t.status)).length,revokedConsents:e.consents.filter((t=>"revoked"===t.status)).length,expiredConsents:e.consents.filter((t=>"expired"===t.status)).length,totalAuditEntries:n.total}};return JSON.stringify(i,null,2)}catch(t){throw t}}))}deleteConsentData(t){return i(this,void 0,void 0,(function*(){(0,a.debugLog)("[ConsentBackendService] ðŸ—‘ï¸ Eliminando datos de consentimiento del backend");try{yield this.revokeAllConsents(t,"Usuario solicitÃ³ eliminaciÃ³n completa de datos (Right to Erasure)"),(0,a.debugLog)("[ConsentBackendService] âœ… Datos de consentimiento eliminados")}catch(t){throw t}}))}}e.ConsentBackendService=c},5073:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i=o(n(6140)),s=o(n(2858)),a=n(9910);function o(t){return t&&t.__esModule?t:{default:t}}e.default=function(t,e,n){if(i.default.randomUUID&&!e&&!t)return i.default.randomUUID();var o=(t=t||{}).random||(t.rng||s.default)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,e){n=n||0;for(var r=0;r<16;++r)e[n+r]=o[r];return e}return(0,a.unsafeStringify)(o)}},5269:function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function r(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.CommercialAvailabilityService=void 0;const s=n(3974);e.CommercialAvailabilityService=class{constructor(t){this.pollingInterval=null,this.onAvailabilityChangeCallback=null,this.lastAvailability=null,this.lastOnlineCount=0,this.isPolling=!1,this.errorCount=0,this.config=Object.assign({pollingInterval:30,debug:!1},t),this.log("ðŸ“¡ [CommercialAvailability] Servicio inicializado",this.config)}checkAvailability(){return i(this,void 0,void 0,(function*(){var t;const e=`${this.config.apiBaseUrl||""}/v2/commercials/availability`;try{this.log("ðŸ“¡ [CommercialAvailability] Consultando disponibilidad...",e);const n=yield fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({domain:this.config.domain,apiKey:this.config.apiKey})});if(!n.ok){const t=yield n.text();throw new Error(`HTTP ${n.status}: ${t}`)}const i=yield n.json();return this.log("ðŸ“¡ [CommercialAvailability] Respuesta recibida:",i),this.errorCount=0,i.available===this.lastAvailability&&i.onlineCount===this.lastOnlineCount||(this.log(`ðŸ“¡ [CommercialAvailability] ðŸ”„ Estado cambiÃ³: ${i.available} (${i.onlineCount} online)`),this.lastAvailability=i.available,this.lastOnlineCount=i.onlineCount,null===(t=this.onAvailabilityChangeCallback)||void 0===t||t.call(this,i.available,i.onlineCount)),i}catch(t){throw this.errorCount++,this.errorCount,t}}))}onAvailabilityChanged(t){this.onAvailabilityChangeCallback=t,this.log("ðŸ“¡ [CommercialAvailability] Callback registrado para cambios de disponibilidad")}startPolling(){if(this.isPolling)return void this.log("ðŸ“¡ [CommercialAvailability] Polling ya estÃ¡ activo");this.isPolling=!0,this.errorCount=0,this.checkAvailability().catch((t=>{}));const t=1e3*(this.config.pollingInterval||30);this.pollingInterval=setInterval((()=>i(this,void 0,void 0,(function*(){if(this.errorCount>=3){const e=Math.min(6e4,t*Math.pow(2,this.errorCount-3));this.log(`ðŸ“¡ [CommercialAvailability] Usando backoff de ${e}ms debido a errores`)}else try{yield this.checkAvailability()}catch(t){}}))),t),this.log(`â° [CommercialAvailability] Polling iniciado (cada ${this.config.pollingInterval}s)`)}stopPolling(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null,this.isPolling=!1,this.log("â¹ï¸ [CommercialAvailability] Polling detenido"))}isPollingActive(){return this.isPolling}getLastKnownState(){return{available:this.lastAvailability,onlineCount:this.lastOnlineCount}}cleanup(){this.stopPolling(),this.onAvailabilityChangeCallback=null,this.lastAvailability=null,this.lastOnlineCount=0,this.errorCount=0,this.log("ðŸ§¹ [CommercialAvailability] Servicio limpiado")}log(t,...e){this.config.debug&&(0,s.debugLog)(t,...e)}}},5303:function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function r(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.IdentitySignal=void 0,e.useIdentitySignal=function(){const t=d.getInstance();return{signal:t,identify:(e,n,i)=>t.identify(e,n,i),reloadChats:()=>t.reloadChats(),getState:()=>t.getState(),getIdentity:()=>t.getIdentity(),getChats:()=>t.getChats(),getVisitorId:()=>t.getVisitorId(),getSessionId:()=>t.getSessionId(),isIdentified:()=>t.isIdentified(),isLoading:()=>t.isLoading(),hasError:()=>t.hasError(),subscribe:e=>t.subscribe(e),subscribeToChats:e=>t.getChatsSignal().subscribe(e),reset:()=>t.reset()}};const s=n(1556),a=n(7785),o=n(7686),r=n(3974);class c extends s.Signal{setLoading(){super.setLoading()}setSuccess(t){super.setSuccess(t)}setError(t){super.setError(t)}}class d extends s.AsyncSignal{constructor(){super(),this.chatsSignal=new c}static getInstance(){return d.instance||(d.instance=new d),d.instance}getChatsSignal(){return this.chatsSignal}identify(t,e,n){return i(this,void 0,void 0,(function*(){return(0,r.debugLog)("[IdentitySignal] ðŸš€ Iniciando identificaciÃ³n del visitante..."),this.execute((()=>i(this,void 0,void 0,(function*(){let i;if("undefined"!=typeof localStorage){const t=localStorage.getItem("guiders_consent_state");if(t)try{const e=JSON.parse(t);i={hasAcceptedPrivacyPolicy:"granted"===e.status,consentVersion:n||e.version||"v1.0"},(0,r.debugLog)("[IdentitySignal] ðŸ” Estado de consentimiento:",i)}catch(t){}}const s=yield a.VisitorsV2Service.getInstance().identify(t,e,i);if(!s)throw new Error("Failed to identify visitor");(0,r.debugLog)("[IdentitySignal] âœ… Visitante identificado:",s.visitorId);let c=null;if(s.visitorId)try{(0,r.debugLog)("[IdentitySignal] ðŸ’¬ Cargando chats del visitante..."),this.chatsSignal.setLoading(),c=yield o.ChatV2Service.getInstance().getVisitorChats(s.visitorId,void 0,20),this.chatsSignal.setSuccess(c),(0,r.debugLog)("[IdentitySignal] âœ… Chats cargados:",c.chats.length,"chats encontrados")}catch(t){this.chatsSignal.setError(t instanceof Error?t:new Error(String(t)))}return{identity:s,chats:c}}))))}))}reloadChats(){return i(this,void 0,void 0,(function*(){var t,e;const n=this.getState();if(!(null===(e=null===(t=n.data)||void 0===t?void 0:t.identity)||void 0===e?void 0:e.visitorId))return null;try{(0,r.debugLog)("[IdentitySignal] ðŸ”„ Recargando chats..."),this.chatsSignal.setLoading();const t=yield o.ChatV2Service.getInstance().getVisitorChats(n.data.identity.visitorId,void 0,20);return this.chatsSignal.setSuccess(t),this.setSuccess(Object.assign(Object.assign({},n.data),{chats:t})),(0,r.debugLog)("[IdentitySignal] âœ… Chats recargados exitosamente"),t}catch(t){const e=t instanceof Error?t:new Error(String(t));throw this.chatsSignal.setError(e),e}}))}getIdentity(){var t;return(null===(t=this.getState().data)||void 0===t?void 0:t.identity)||null}getChats(){var t;return(null===(t=this.getState().data)||void 0===t?void 0:t.chats)||null}isIdentified(){const t=this.getIdentity();return!!(null==t?void 0:t.visitorId)}getVisitorId(){var t;return(null===(t=this.getIdentity())||void 0===t?void 0:t.visitorId)||null}getSessionId(){var t;return(null===(t=this.getIdentity())||void 0===t?void 0:t.sessionId)||null}reset(){super.reset(),this.chatsSignal.reset()}dispose(){super.dispose(),this.chatsSignal.dispose()}}e.IdentitySignal=d},5374:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.pick=function(t,...e){return e.reduce(((e,n)=>(t.hasOwnProperty(n)&&(e[n]=t[n]),e)),{})},e.installTimerFunctions=function(t,e){e.useNativeTimers?(t.setTimeoutFn=s.bind(i.globalThisShim),t.clearTimeoutFn=a.bind(i.globalThisShim)):(t.setTimeoutFn=i.globalThisShim.setTimeout.bind(i.globalThisShim),t.clearTimeoutFn=i.globalThisShim.clearTimeout.bind(i.globalThisShim))},e.byteLength=function(t){return"string"==typeof t?function(t){let e=0,n=0;for(let i=0,s=t.length;i<s;i++)e=t.charCodeAt(i),e<128?n+=1:e<2048?n+=2:e<55296||e>=57344?n+=3:(i++,n+=4);return n}(t):Math.ceil((t.byteLength||t.size)*o)},e.randomString=function(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)};const i=n(4624),s=i.globalThisShim.setTimeout,a=i.globalThisShim.clearTimeout,o=1.33},5558:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ChatInputUI=void 0;const i=n(3974);e.ChatInputUI=class{constructor(t,e={}){this.listeners={},this.chatUI=t,this.options=Object.assign({placeholder:"Escribe tu mensaje..."},e),this.inputContainer=document.createElement("div"),this.inputContainer.className="chat-input-container",this.inputField=document.createElement("textarea"),this.inputField.placeholder=this.options.placeholder,this.inputField.className="chat-input-field",this.inputField.rows=1,this.inputField.addEventListener("keydown",(t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this.handleSendMessage())}))}init(){const t=this.getChatContainer();this.inputContainer=document.createElement("div"),this.inputContainer.className="chat-input-container",this.inputField=document.createElement("textarea"),this.inputField.className="chat-input-field",this.inputField.placeholder=this.options.placeholder||"Escribe un mensaje...",this.inputField.setAttribute("aria-label","Mensaje"),this.inputField.rows=1;const e=()=>{this.inputField.style.height="auto",this.inputField.style.height=Math.min(this.inputField.scrollHeight,120)+"px"},n=document.createElement("button");n.className="chat-send-btn",n.setAttribute("aria-label","Enviar mensaje"),n.type="button",n.addEventListener("click",(()=>this.handleSendMessage())),this.inputContainer.appendChild(this.inputField),this.inputContainer.appendChild(n),this.inputField.addEventListener("keydown",(t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this.handleSendMessage())})),this.inputField.addEventListener("input",(()=>{e()})),t.appendChild(this.inputContainer)}onSubmit(t){this.listeners.submit=t}handleSendMessage(){const t=this.inputField.value.trim();if(t){if(this.isDevCommand(t))return(0,i.debugLog)(`ðŸŽ² [ChatInput] Comando de desarrollo detectado: ${t}`),this.handleDevCommand(t),void(this.inputField.value="");this.chatUI.renderChatMessage({text:t,sender:"user"}),this.inputField.value="",this.inputField.style.height="auto",this.listeners.submit&&this.listeners.submit(t)}}isDevCommand(t){return null!==t.trim().toLowerCase().match(/^#random(?::\d+)?$/)}handleDevCommand(t){const e=t.trim().toLowerCase().match(/^#random(?::(\d+))?$/);if(e&&"undefined"!=typeof window){const n=new CustomEvent("guidersDevCommand",{detail:{command:"random",text:t,count:e[1]?parseInt(e[1],10):null,chatId:this.getCurrentChatId()}});window.dispatchEvent(n),(0,i.debugLog)(`ðŸŽ² [ChatInput] Evento guidersDevCommand disparado para: ${t}`)}}getCurrentChatId(){try{return this.chatUI.chatId||null}catch(t){return null}}getChatContainer(){const t=this.chatUI.container;if(!t)throw new Error("ChatUI no estÃ¡ inicializado o el contenedor es null");return t}setPresenceService(t,e){(0,i.debugLog)("[ChatInputUI] PresenceService configurado (stub)")}}},5649:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.formatTime=function(t){return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`},e.formatDate=function(t){const e=new Date,n=new Date;n.setDate(n.getDate()-1);const i=t.toDateString()===e.toDateString(),s=t.toDateString()===n.toDateString();if(i)return"Hoy";if(s)return"Ayer";{const e={day:"numeric",month:"long",year:"numeric"};return t.toLocaleDateString("es-ES",e)}},e.isBot=function(t){const e=t.toLowerCase();return["bot","chatbot","assistant","asistente","ia","ai","automÃ¡tico","virtual"].some((t=>e.includes(t)))},e.generateInitials=function(t){const e=t.trim().split(" ");return e.length>=2?(e[0][0]+e[1][0]).toUpperCase():1===e.length?e[0].substring(0,2).toUpperCase():"AH"},e.createDateSeparator=function(t){const e=document.createElement("div");e.className="chat-date-separator",e.setAttribute("data-date",t),e.style.cssText="\n\t\tdisplay: flex;\n\t\talign-items: center;\n\t\tjustify-content: center;\n\t\tmargin: 20px 0;\n\t\tposition: relative;\n\t";const n=document.createElement("div");n.style.cssText="\n\t\tflex: 1;\n\t\theight: 1px;\n\t\tbackground: #e4e4e7;\n\t\tmargin-right: 12px;\n\t";const i=document.createElement("div");i.style.cssText="\n\t\tcolor: #71717a;\n\t\tpadding: 4px 0;\n\t\tfont-size: 11px;\n\t\tfont-weight: 500;\n\t\twhite-space: nowrap;\n\t\tletter-spacing: 0.05em;\n\t\ttext-transform: uppercase;\n\t";const s=document.createElement("span");s.textContent=t,i.appendChild(s);const a=document.createElement("div");return a.style.cssText="\n\t\tflex: 1;\n\t\theight: 1px;\n\t\tbackground: #e4e4e7;\n\t\tmargin-left: 12px;\n\t",e.appendChild(n),e.appendChild(i),e.appendChild(a),e}},5770:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.detectMobileDevice=o,e.isMobileDevice=r,e.resolvePosition=function(t,e){if(!t)return{button:{bottom:"20px",right:"20px"},widget:{bottom:"90px",right:"20px"}};const n=t;let i,o;i=void 0!==n.default?r(e)&&n.mobile?n.mobile:n.default:t,o=function(t){return"string"==typeof t&&["bottom-right","bottom-left","top-right","top-left"].includes(t)}(i)?s[i]:i;const c=function(t){const e=Object.assign({},t);if(t.widgetBottom||t.widgetTop||t.widgetLeft||t.widgetRight)return e;if(t.bottom){const n=parseInt(t.bottom);e.widgetBottom=`${n+a}px`}else if(t.top){const n=parseInt(t.top);e.widgetTop=`${n+a}px`}return t.right&&(e.widgetRight=t.right),t.left&&(e.widgetLeft=t.left),e}(o);return{button:{top:c.top,bottom:c.bottom,left:c.left,right:c.right},widget:{top:c.widgetTop,bottom:c.widgetBottom,left:c.widgetLeft,right:c.widgetRight}}},e.generatePositionCSS=function(t,e=!1){const n=e?t.widget:t.button,i=[];return n.top&&i.push(`top: ${n.top}`),n.bottom&&i.push(`bottom: ${n.bottom}`),n.left&&i.push(`left: ${n.left}`),n.right&&i.push(`right: ${n.right}`),i.join("; ")},e.validateCoordinates=function(t){if(!(t.top||t.bottom||t.widgetTop||t.widgetBottom))return!1;if(!(t.left||t.right||t.widgetLeft||t.widgetRight))return!1;const e=[t.top,t.bottom,t.left,t.right,t.widgetTop,t.widgetBottom,t.widgetLeft,t.widgetRight].filter(Boolean);for(const t of e)if("string"!=typeof t||!/(px|%|em|rem|vh|vw)$/.test(t))return!1;return!0};const i=n(3974),s={"bottom-right":{bottom:"20px",right:"20px",widgetBottom:"90px",widgetRight:"20px"},"bottom-left":{bottom:"20px",left:"20px",widgetBottom:"90px",widgetLeft:"20px"},"top-right":{top:"20px",right:"20px",widgetTop:"90px",widgetRight:"20px"},"top-left":{top:"20px",left:"20px",widgetTop:"90px",widgetLeft:"20px"}},a=70;function o(t){const e=(null==t?void 0:t.mode)||"auto",n=(null==t?void 0:t.breakpoint)||768,s=(null==t?void 0:t.debug)||!1,a=[];let o=!1;const r="undefined"!=typeof window?{width:window.innerWidth||0,height:window.innerHeight||0}:void 0;if("auto"!==e&&"size-only"!==e||"undefined"==typeof window||!window.matchMedia||window.matchMedia(`(max-width: ${n}px)`).matches&&(a.push(`media-query-width-${n}px`),o=!0),"auto"!==e&&"touch-only"!==e||"undefined"==typeof window||!window.matchMedia||window.matchMedia("(pointer: coarse)").matches&&(a.push("touch-capability"),o=!0),"auto"===e&&"undefined"!=typeof window&&window.matchMedia){const t=window.matchMedia("(orientation: portrait)"),e=window.matchMedia("(max-aspect-ratio: 1/1)");t.matches&&e.matches&&r&&r.width<1024&&(a.push("portrait-orientation"),o=!0)}if(("auto"===e||"user-agent-only"===e)&&"undefined"!=typeof navigator){const t=navigator.userAgent.toLowerCase();["android","webos","iphone","ipad","ipod","blackberry","windows phone"].some((e=>t.includes(e)))&&(a.push("user-agent"),o=!0)}const c={isMobile:o,detectedBy:a,breakpoint:n,viewport:r};return s&&"undefined"!=typeof console&&(0,i.debugLog)("[Position Resolver] Mobile detection:",{mode:e,result:o?"MOBILE":"DESKTOP",detectedBy:a.length>0?a.join(", "):"none",viewport:r,breakpoint:`${n}px`}),c}function r(t){return o(t).isMobile}},5829:function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function r(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.MessagePaginationService=void 0;const s=n(2597),a=n(7686),o=n(3235),r=n(3974);class c{constructor(){}static getInstance(){return c.instance||(c.instance=new c),c.instance}getAuthHeaders(){return(0,o.getCommonHeaders)()}getFetchOptions(){return(0,o.getCommonFetchOptions)("GET")}fetchWithReauth(t,e){return i(this,void 0,void 0,(function*(){let n=yield fetch(t,e);if(401===n.status){(0,r.debugLog)("[MessagePaginationService] âš ï¸ Error 401 - Intentando re-autenticaciÃ³n...");const i=a.ChatV2Service.getInstance();(yield i.reAuthenticate())?((0,r.debugLog)("[MessagePaginationService] âœ… Re-autenticaciÃ³n exitosa, reintentando peticiÃ³n..."),n=yield fetch(t,Object.assign(Object.assign({},e),{headers:this.getAuthHeaders()}))):(0,r.debugLog)("[MessagePaginationService] âŒ Re-autenticaciÃ³n fallida")}return n}))}getMessagesEndpoint(){const t=s.EndpointManager.getInstance(),e=localStorage.getItem("pixelEndpoint")||t.getEndpoint();return`${e.endsWith("/api")?e:`${e}/api`}/v2/messages`}loadInitialMessages(t){return i(this,arguments,void 0,(function*(t,e=20){var n;(0,r.debugLog)(`ðŸ“‹ [MessagePagination] Cargando mensajes iniciales del chat: ${t}`);const i=`${this.getMessagesEndpoint()}/chat/${t}?limit=${e}`;try{const t=yield this.fetchWithReauth(i,this.getFetchOptions());if(!t.ok){const e=yield t.text();throw new Error(`Error al cargar mensajes iniciales (${t.status}): ${e}`)}const e=yield t.json();return e.nextCursor&&!e.cursor&&(e.cursor=e.nextCursor),(0,r.debugLog)("âœ… [MessagePagination] Mensajes iniciales cargados:",{count:(null===(n=e.messages)||void 0===n?void 0:n.length)||0,total:e.total,hasMore:e.hasMore,hasCursor:!!e.cursor}),e}catch(t){throw t}}))}loadOlderMessages(t,e){return i(this,arguments,void 0,(function*(t,e,n=20){var i;(0,r.debugLog)(`ðŸ“œ [MessagePagination] Cargando mensajes antiguos del chat: ${t} con cursor: ${e.substring(0,20)}...`);const s=encodeURIComponent(e),a=`${this.getMessagesEndpoint()}/chat/${t}?limit=${n}&cursor=${s}`;try{const t=yield this.fetchWithReauth(a,this.getFetchOptions());if(!t.ok){const e=yield t.text();throw new Error(`Error al cargar mensajes antiguos (${t.status}): ${e}`)}const e=yield t.json();return e.nextCursor&&!e.cursor&&(e.cursor=e.nextCursor),(0,r.debugLog)("âœ… [MessagePagination] Mensajes antiguos cargados:",{count:(null===(i=e.messages)||void 0===i?void 0:i.length)||0,total:e.total,hasMore:e.hasMore,hasCursor:!!e.cursor}),e}catch(t){throw t}}))}isValidCursor(t){if(!t||""===t.trim())return!1;try{return atob(t),!0}catch(t){return!1}}}e.MessagePaginationService=c},5861:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.MetadataInjectionStage=void 0,e.MetadataInjectionStage=class{process(t){return t.metadata=Object.assign(Object.assign({},t.metadata),{device:{userAgent:navigator.userAgent,platform:navigator.platform,language:navigator.language,screen:{width:screen.width,height:screen.height,pixelRatio:window.devicePixelRatio},hardware:{cores:navigator.hardwareConcurrency},touch:{maxTouchPoints:navigator.maxTouchPoints}}}),t}}},5942:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.on=function(t,e,n){return t.on(e,n),function(){t.off(e,n)}}},6140:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var n="undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);e.default={randomUUID:n}},6161:(t,e)=>{"use strict";var n;Object.defineProperty(e,"__esModule",{value:!0}),e.WebSocketState=void 0,function(t){t.DISCONNECTED="disconnected",t.CONNECTING="connecting",t.CONNECTED="connected",t.RECONNECTING="reconnecting",t.ERROR="error"}(n||(e.WebSocketState=n={}))},6214:function(t,e,n){"use strict";var i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.Socket=void 0;const s=n(4627),a=n(5942),o=n(4454),r=(0,i(n(7833)).default)("socket.io-client:socket"),c=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class d extends o.Emitter{constructor(t,e,n){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=t,this.nsp=e,n&&n.auth&&(this.auth=n.auth),this._opts=Object.assign({},n),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const t=this.io;this.subs=[(0,a.on)(t,"open",this.onopen.bind(this)),(0,a.on)(t,"packet",this.onpacket.bind(this)),(0,a.on)(t,"error",this.onerror.bind(this)),(0,a.on)(t,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected||(this.subEvents(),this.io._reconnecting||this.io.open(),"open"===this.io._readyState&&this.onopen()),this}open(){return this.connect()}send(...t){return t.unshift("message"),this.emit.apply(this,t),this}emit(t,...e){var n,i,a;if(c.hasOwnProperty(t))throw new Error('"'+t.toString()+'" is a reserved event name');if(e.unshift(t),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(e),this;const o={type:s.PacketType.EVENT,data:e,options:{}};if(o.options.compress=!1!==this.flags.compress,"function"==typeof e[e.length-1]){const t=this.ids++;r("emitting packet with ack id %d",t);const n=e.pop();this._registerAckCallback(t,n),o.id=t}const d=null===(i=null===(n=this.io.engine)||void 0===n?void 0:n.transport)||void 0===i?void 0:i.writable,l=this.connected&&!(null===(a=this.io.engine)||void 0===a?void 0:a._hasPingExpired());return this.flags.volatile&&!d?r("discard packet as the transport is not currently writable"):l?(this.notifyOutgoingListeners(o),this.packet(o)):this.sendBuffer.push(o),this.flags={},this}_registerAckCallback(t,e){var n;const i=null!==(n=this.flags.timeout)&&void 0!==n?n:this._opts.ackTimeout;if(void 0===i)return void(this.acks[t]=e);const s=this.io.setTimeoutFn((()=>{delete this.acks[t];for(let e=0;e<this.sendBuffer.length;e++)this.sendBuffer[e].id===t&&(r("removing packet with ack id %d from the buffer",t),this.sendBuffer.splice(e,1));r("event with ack id %d has timed out after %d ms",t,i),e.call(this,new Error("operation has timed out"))}),i),a=(...t)=>{this.io.clearTimeoutFn(s),e.apply(this,t)};a.withError=!0,this.acks[t]=a}emitWithAck(t,...e){return new Promise(((n,i)=>{const s=(t,e)=>t?i(t):n(e);s.withError=!0,e.push(s),this.emit(t,...e)}))}_addToQueue(t){let e;"function"==typeof t[t.length-1]&&(e=t.pop());const n={id:this._queueSeq++,tryCount:0,pending:!1,args:t,flags:Object.assign({fromQueue:!0},this.flags)};t.push(((t,...i)=>{if(n===this._queue[0])return null!==t?n.tryCount>this._opts.retries&&(r("packet [%d] is discarded after %d tries",n.id,n.tryCount),this._queue.shift(),e&&e(t)):(r("packet [%d] was successfully sent",n.id),this._queue.shift(),e&&e(null,...i)),n.pending=!1,this._drainQueue()})),this._queue.push(n),this._drainQueue()}_drainQueue(t=!1){if(r("draining queue"),!this.connected||0===this._queue.length)return;const e=this._queue[0];!e.pending||t?(e.pending=!0,e.tryCount++,r("sending packet [%d] (try nÂ°%d)",e.id,e.tryCount),this.flags=e.flags,this.emit.apply(this,e.args)):r("packet [%d] has already been sent and is waiting for an ack",e.id)}packet(t){t.nsp=this.nsp,this.io._packet(t)}onopen(){r("transport is open - connecting"),"function"==typeof this.auth?this.auth((t=>{this._sendConnectPacket(t)})):this._sendConnectPacket(this.auth)}_sendConnectPacket(t){this.packet({type:s.PacketType.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},t):t})}onerror(t){this.connected||this.emitReserved("connect_error",t)}onclose(t,e){r("close (%s)",t),this.connected=!1,delete this.id,this.emitReserved("disconnect",t,e),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach((t=>{if(!this.sendBuffer.some((e=>String(e.id)===t))){const e=this.acks[t];delete this.acks[t],e.withError&&e.call(this,new Error("socket has been disconnected"))}}))}onpacket(t){if(t.nsp===this.nsp)switch(t.type){case s.PacketType.CONNECT:t.data&&t.data.sid?this.onconnect(t.data.sid,t.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case s.PacketType.EVENT:case s.PacketType.BINARY_EVENT:this.onevent(t);break;case s.PacketType.ACK:case s.PacketType.BINARY_ACK:this.onack(t);break;case s.PacketType.DISCONNECT:this.ondisconnect();break;case s.PacketType.CONNECT_ERROR:this.destroy();const e=new Error(t.data.message);e.data=t.data.data,this.emitReserved("connect_error",e)}}onevent(t){const e=t.data||[];r("emitting event %j",e),null!=t.id&&(r("attaching ack callback to event"),e.push(this.ack(t.id))),this.connected?this.emitEvent(e):this.receiveBuffer.push(Object.freeze(e))}emitEvent(t){if(this._anyListeners&&this._anyListeners.length){const e=this._anyListeners.slice();for(const n of e)n.apply(this,t)}super.emit.apply(this,t),this._pid&&t.length&&"string"==typeof t[t.length-1]&&(this._lastOffset=t[t.length-1])}ack(t){const e=this;let n=!1;return function(...i){n||(n=!0,r("sending ack %j",i),e.packet({type:s.PacketType.ACK,id:t,data:i}))}}onack(t){const e=this.acks[t.id];"function"==typeof e?(delete this.acks[t.id],r("calling ack %s with %j",t.id,t.data),e.withError&&t.data.unshift(null),e.apply(this,t.data)):r("bad ack %s",t.id)}onconnect(t,e){r("socket connected with id %s",t),this.id=t,this.recovered=e&&this._pid===e,this._pid=e,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach((t=>this.emitEvent(t))),this.receiveBuffer=[],this.sendBuffer.forEach((t=>{this.notifyOutgoingListeners(t),this.packet(t)})),this.sendBuffer=[]}ondisconnect(){r("server disconnect (%s)",this.nsp),this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach((t=>t())),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&(r("performing disconnect (%s)",this.nsp),this.packet({type:s.PacketType.DISCONNECT})),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(t){return this.flags.compress=t,this}get volatile(){return this.flags.volatile=!0,this}timeout(t){return this.flags.timeout=t,this}onAny(t){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(t),this}prependAny(t){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(t),this}offAny(t){if(!this._anyListeners)return this;if(t){const e=this._anyListeners;for(let n=0;n<e.length;n++)if(t===e[n])return e.splice(n,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(t){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(t),this}prependAnyOutgoing(t){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(t),this}offAnyOutgoing(t){if(!this._anyOutgoingListeners)return this;if(t){const e=this._anyOutgoingListeners;for(let n=0;n<e.length;n++)if(t===e[n])return e.splice(n,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(t){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const e=this._anyOutgoingListeners.slice();for(const n of e)n.apply(this,t.data)}}}e.Socket=d},6376:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.decodePayload=e.decodePacket=e.encodePayload=e.encodePacket=e.protocol=void 0,e.createPacketEncoderStream=function(){return new TransformStream({transform(t,e){(0,i.encodePacketToBinary)(t,(n=>{const i=n.length;let s;if(i<126)s=new Uint8Array(1),new DataView(s.buffer).setUint8(0,i);else if(i<65536){s=new Uint8Array(3);const t=new DataView(s.buffer);t.setUint8(0,126),t.setUint16(1,i)}else{s=new Uint8Array(9);const t=new DataView(s.buffer);t.setUint8(0,127),t.setBigUint64(1,BigInt(i))}t.data&&"string"!=typeof t.data&&(s[0]|=128),e.enqueue(s),e.enqueue(n)}))}})},e.createPacketDecoderStream=function(t,e){r||(r=new TextDecoder);const n=[];let i=0,o=-1,l=!1;return new TransformStream({transform(h,u){for(n.push(h);;){if(0===i){if(c(n)<1)break;const t=d(n,1);l=!(128&~t[0]),o=127&t[0],i=o<126?3:126===o?1:2}else if(1===i){if(c(n)<2)break;const t=d(n,2);o=new DataView(t.buffer,t.byteOffset,t.length).getUint16(0),i=3}else if(2===i){if(c(n)<8)break;const t=d(n,8),e=new DataView(t.buffer,t.byteOffset,t.length),s=e.getUint32(0);if(s>Math.pow(2,21)-1){u.enqueue(a.ERROR_PACKET);break}o=s*Math.pow(2,32)+e.getUint32(4),i=3}else{if(c(n)<o)break;const t=d(n,o);u.enqueue((0,s.decodePacket)(l?t:r.decode(t),e)),i=0}if(0===o||o>t){u.enqueue(a.ERROR_PACKET);break}}}})};const i=n(2686);Object.defineProperty(e,"encodePacket",{enumerable:!0,get:function(){return i.encodePacket}});const s=n(2662);Object.defineProperty(e,"decodePacket",{enumerable:!0,get:function(){return s.decodePacket}});const a=n(2046),o=String.fromCharCode(30);let r;function c(t){return t.reduce(((t,e)=>t+e.length),0)}function d(t,e){if(t[0].length===e)return t.shift();const n=new Uint8Array(e);let i=0;for(let s=0;s<e;s++)n[s]=t[0][i++],i===t[0].length&&(t.shift(),i=0);return t.length&&i<t[0].length&&(t[0]=t[0].slice(i)),n}e.encodePayload=(t,e)=>{const n=t.length,s=new Array(n);let a=0;t.forEach(((t,r)=>{(0,i.encodePacket)(t,!1,(t=>{s[r]=t,++a===n&&e(s.join(o))}))}))},e.decodePayload=(t,e)=>{const n=t.split(o),i=[];for(let t=0;t<n.length;t++){const a=(0,s.decodePacket)(n[t],e);if(i.push(a),"error"===a.type)break}return i},e.protocol=4},6398:function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function r(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.PresenceService=void 0;const s=n(7686),a=n(2597),o=n(3974);e.PresenceService=class{constructor(t,e,n={}){var i,s,r,c,d,l;this.presenceCallbacks=new Set,this.typingCallbacks=new Set,this.presenceJoinedCallbacks=new Set,this.activeChats=new Set,this.typingTimeouts=new Map,this.currentlyTypingIn=new Set,this.webSocketService=t,this.endpointManager=a.EndpointManager.getInstance(),this.visitorId=e,this.config={enabled:null===(i=n.enabled)||void 0===i||i,pollingInterval:null!==(s=n.pollingInterval)&&void 0!==s?s:3e4,showTypingIndicator:null===(r=n.showTypingIndicator)||void 0===r||r,typingTimeout:null!==(c=n.typingTimeout)&&void 0!==c?c:2e3,typingDebounce:null!==(d=n.typingDebounce)&&void 0!==d?d:300,heartbeatInterval:null!==(l=n.heartbeatInterval)&&void 0!==l?l:3e4},(0,o.debugLog)("[PresenceService] ðŸŸ¢ Inicializado",{visitorId:this.visitorId.substring(0,8)+"...",config:this.config}),this.setupWebSocketListeners()}setupWebSocketListeners(){this.webSocketService.updateCallbacks({onTypingStart:t=>{t.userId!==this.visitorId&&((0,o.debugLog)("[PresenceService] âœï¸ Comercial comenzÃ³ a escribir:",t),this.notifyTypingChange(t,!0))},onTypingStop:t=>{t.userId!==this.visitorId&&((0,o.debugLog)("[PresenceService] âœï¸ Comercial dejÃ³ de escribir:",t),this.notifyTypingChange(t,!1))},onPresenceChanged:t=>{(0,o.debugLog)("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),(0,o.debugLog)("ðŸ”” EVENTO DE PRESENCIA FILTRADO RECIBIDO"),(0,o.debugLog)(`ðŸ‘¤ Usuario: ${t.userId.substring(0,8)}... (${t.userType})`),(0,o.debugLog)(`ðŸ“Š Estado: ${t.previousStatus} â†’ ${t.status}`),(0,o.debugLog)("âœ… Este evento fue filtrado por el backend (solo chats activos)"),(0,o.debugLog)("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"),(0,o.debugLog)("[PresenceService] ðŸŸ¢ Presencia cambiÃ³:",{userId:t.userId,userType:t.userType,status:t.status,previousStatus:t.previousStatus,filtered:!0}),this.notifyPresenceChange(t)},onPresenceJoined:t=>{(0,o.debugLog)("[PresenceService] âœ… Auto-join confirmado:",{userId:t.userId,roomName:t.roomName,automatic:t.automatic}),t.automatic&&((0,o.debugLog)("[PresenceService] ðŸŽ¯ Auto-join automÃ¡tico detectado"),(0,o.debugLog)("[PresenceService] ðŸ“ Sala personal:",t.roomName),(0,o.debugLog)("[PresenceService] ðŸ”” Eventos de presencia filtrados activos (solo chats activos)")),this.notifyPresenceJoined(t)}}),(0,o.debugLog)("[PresenceService] ðŸ“¡ Listeners de WebSocket configurados")}getChatPresence(t){return i(this,arguments,void 0,(function*(t,e=!1){try{const n=`${this.endpointManager.getEndpoint()}/presence/chat/${t}`;(0,o.debugLog)("[PresenceService] ðŸ” Obteniendo presencia de chat:",t);const i="undefined"!=typeof sessionStorage?sessionStorage.getItem("guiders_backend_session_id"):null,a={"Content-Type":"application/json"};i&&(a["x-guiders-sid"]=i,(0,o.debugLog)("[PresenceService] ðŸ” Enviando x-guiders-sid:",i.substring(0,8)+"..."));const r=yield fetch(n,{method:"GET",credentials:"include",headers:a});if(401===r.status&&!e){(0,o.debugLog)("[PresenceService] âš ï¸ Error 401 - Intentando re-autenticaciÃ³n...");const e=s.ChatV2Service.getInstance();return(yield e.reAuthenticate())?((0,o.debugLog)("[PresenceService] âœ… Re-autenticaciÃ³n exitosa, reintentando..."),this.getChatPresence(t,!0)):((0,o.debugLog)("[PresenceService] âŒ Re-autenticaciÃ³n fallida"),null)}if(!r.ok)return null;const c=yield r.json();return(0,o.debugLog)("[PresenceService] âœ… Presencia obtenida:",{chatId:c.chatId,participants:c.participants.length}),c}catch(t){return null}}))}joinChatRoom(t){this.config.enabled?this.activeChats.has(t)?(0,o.debugLog)("[PresenceService] âš ï¸ Ya estÃ¡s en la sala del chat:",t):((0,o.debugLog)("[PresenceService] ðŸšª UniÃ©ndose a sala de chat:",t),this.webSocketService.joinChatRoom(t),this.activeChats.add(t),(0,o.debugLog)("[PresenceService] âœ… Unido a sala de chat:",t)):(0,o.debugLog)("[PresenceService] âš ï¸ Presencia deshabilitada, no se une a sala")}leaveChatRoom(t){this.activeChats.has(t)&&((0,o.debugLog)("[PresenceService] ðŸšª Saliendo de sala de chat:",t),this.currentlyTypingIn.has(t)&&this.stopTyping(t),this.webSocketService.leaveChatRoom(t),this.activeChats.delete(t),(0,o.debugLog)("[PresenceService] âœ… Saliste de sala de chat:",t))}startTyping(t){if(!this.config.enabled||!this.config.showTypingIndicator)return;if(!this.activeChats.has(t))return;const e=this.typingTimeouts.get(t);e&&clearTimeout(e),this.currentlyTypingIn.has(t)||((0,o.debugLog)("[PresenceService] âœï¸ Enviando typing:start para chat:",t),this.emitTypingStart(t),this.currentlyTypingIn.add(t));const n=setTimeout((()=>{this.stopTyping(t)}),this.config.typingTimeout);this.typingTimeouts.set(t,n)}stopTyping(t){if(!this.currentlyTypingIn.has(t))return;(0,o.debugLog)("[PresenceService] âœï¸ Enviando typing:stop para chat:",t);const e=this.typingTimeouts.get(t);e&&(clearTimeout(e),this.typingTimeouts.delete(t)),this.emitTypingStop(t),this.currentlyTypingIn.delete(t)}emitTypingStart(t){return i(this,void 0,void 0,(function*(){try{const e=`${this.endpointManager.getEndpoint()}/presence/chat/${t}/typing/start`;(yield fetch(e,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}})).ok}catch(t){}}))}emitTypingStop(t){return i(this,void 0,void 0,(function*(){try{const e=`${this.endpointManager.getEndpoint()}/presence/chat/${t}/typing/stop`;(yield fetch(e,{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"}})).ok}catch(t){}}))}onPresenceChanged(t){return this.presenceCallbacks.add(t),(0,o.debugLog)("[PresenceService] ðŸ“ž Callback de presencia registrado"),()=>{this.presenceCallbacks.delete(t),(0,o.debugLog)("[PresenceService] ðŸ“ž Callback de presencia removido")}}onTypingChanged(t){return this.typingCallbacks.add(t),(0,o.debugLog)("[PresenceService] ðŸ“ž Callback de typing registrado"),()=>{this.typingCallbacks.delete(t),(0,o.debugLog)("[PresenceService] ðŸ“ž Callback de typing removido")}}onPresenceJoined(t){return this.presenceJoinedCallbacks.add(t),(0,o.debugLog)("[PresenceService] ðŸ“ž Callback de presence:joined registrado"),()=>{this.presenceJoinedCallbacks.delete(t),(0,o.debugLog)("[PresenceService] ðŸ“ž Callback de presence:joined removido")}}notifyPresenceChange(t){(0,o.debugLog)("[PresenceService] ðŸ“¢ Notificando cambio de presencia:",t),this.presenceCallbacks.forEach((e=>{try{e(t)}catch(t){}}))}notifyTypingChange(t,e){(0,o.debugLog)("[PresenceService] ðŸ“¢ Notificando cambio de typing:",Object.assign(Object.assign({},t),{isTyping:e})),this.typingCallbacks.forEach((n=>{try{n(t,e)}catch(t){}}))}notifyPresenceJoined(t){(0,o.debugLog)("[PresenceService] ðŸ“¢ Notificando presence:joined:",t),this.presenceJoinedCallbacks.forEach((e=>{try{e(t)}catch(t){}}))}getCommercialFromParticipants(t){return t.find((t=>"commercial"===t.userType))||null}getVisitorFromParticipants(t){return t.find((t=>"visitor"===t.userType))||null}isEnabled(){return this.config.enabled}getConfig(){return Object.assign({},this.config)}getActiveChats(){return Array.from(this.activeChats)}isTypingIn(t){return this.currentlyTypingIn.has(t)}cleanup(){(0,o.debugLog)("[PresenceService] ðŸ§¹ Limpiando recursos..."),this.currentlyTypingIn.forEach((t=>{this.stopTyping(t)})),this.activeChats.forEach((t=>{this.leaveChatRoom(t)})),this.typingTimeouts.forEach((t=>clearTimeout(t))),this.typingTimeouts.clear(),this.presenceCallbacks.clear(),this.typingCallbacks.clear(),this.presenceJoinedCallbacks.clear(),this.activeChats.clear(),this.currentlyTypingIn.clear(),(0,o.debugLog)("[PresenceService] âœ… Cleanup completado")}}},6420:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.SessionTrackingManager=void 0;const i=n(2831);e.SessionTrackingManager=class{constructor(t,e={}){this.sessionData=null,this.heartbeatTimer=null,this._throttleTimeout=null,this.trackCallback=t,this.config=Object.assign({enabled:!0,heartbeatInterval:1e4,maxInactivityTime:6e4},e),this.config.enabled&&(this.startSession(),this.registerActivityListeners())}saveSessionData(){this.sessionData&&sessionStorage.setItem("guiders_session",JSON.stringify(this.sessionData))}startSession(){this.sessionData=sessionStorage.getItem("guiders_session")?JSON.parse(sessionStorage.getItem("guiders_session")):{sessionId:(0,i.v4)(),startTime:Date.now(),lastActiveTime:Date.now(),totalActiveTime:0,isActive:!0,isIdle:!1,isNew:!0},this.sessionData&&this.sessionData.isNew&&(this.trackCallback({event:"session_start",startTime:this.sessionData.startTime,isNew:this.sessionData.isNew}),this.sessionData.isNew=!1),this.saveSessionData(),this.initializeHeartbeat()}endSession(){this.sessionData&&(this.sessionData.isActive&&!this.sessionData.isIdle&&(this.sessionData.totalActiveTime+=Date.now()-this.sessionData.lastActiveTime),this.sessionData.isActive=!1,this.sessionData.isIdle=!1,this.trackCallback({event:"session_end",endTime:Date.now(),startTime:this.sessionData.startTime,totalActiveTime:this.sessionData.totalActiveTime,totalSessionTime:Date.now()-this.sessionData.startTime}),sessionStorage.removeItem("guiders_session"),this.sessionData=null),this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null),this.removeActivityListeners(),this._throttleTimeout&&(clearTimeout(this._throttleTimeout),this._throttleTimeout=null)}updateActivity(t=!1){if(!this.sessionData)return null;const e=Date.now(),n=this.sessionData.isIdle,i=!this.sessionData.isActive,s=this.sessionData.lastActiveTime;if(this.sessionData.isActive&&!this.sessionData.isIdle){const t=e-this.sessionData.lastActiveTime;this.sessionData.totalActiveTime+=t}return this.sessionData.lastActiveTime=e,this.sessionData.isActive=!0,(n||t)&&(this.sessionData.isIdle=!1,this.trackCallback({event:"user_resume",resumeTime:e,previousIdleTime:n?e-s:0,totalActiveTime:this.sessionData.totalActiveTime})),i&&this.trackCallback({event:"session_reactivate",reactivateTime:e,totalActiveTime:this.sessionData.totalActiveTime}),this.saveSessionData(),this.sessionData}getCurrentSession(){return this.sessionData}initializeHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval((()=>{this.checkUserActivity()}),this.config.heartbeatInterval)}checkUserActivity(){if(!this.sessionData||!this.sessionData.isActive)return;const t=Date.now();if(t-this.sessionData.lastActiveTime>this.config.maxInactivityTime&&!this.sessionData.isIdle){this.sessionData.isIdle=!0;const e=this.config.maxInactivityTime;this.sessionData.totalActiveTime+=e,this.trackCallback({event:"user_idle",sessionId:this.sessionData.sessionId,idleStartTime:t,lastActiveTime:this.sessionData.lastActiveTime,totalActiveTime:this.sessionData.totalActiveTime}),this.saveSessionData()}}registerActivityListeners(){if("undefined"==typeof window)return;const t=this.handleUserActivity.bind(this);["mousedown","mousemove","keypress","scroll","touchstart","click"].forEach((e=>{window.addEventListener(e,t,{passive:!0})})),document.addEventListener("visibilitychange",(()=>{"visible"===document.visibilityState?this.updateActivity(!0):this.checkUserActivity()}))}removeActivityListeners(){if("undefined"==typeof window)return;const t=this.handleUserActivity.bind(this);["mousedown","mousemove","keypress","scroll","touchstart","click"].forEach((e=>{window.removeEventListener(e,t)})),document.removeEventListener("visibilitychange",(()=>{}))}handleUserActivity(t){this._throttleTimeout||(this._throttleTimeout=setTimeout((()=>{this._throttleTimeout=null}),1e3),this.updateActivity())}}},6571:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.COMMON_ACTIVE_HOURS=e.ActiveHoursValidator=void 0,e.createActiveHoursConfig=i;class n{constructor(t){this.config=t}getEffectiveTimezone(){if("auto"===this.config.timezone)try{return Intl.DateTimeFormat().resolvedOptions().timeZone}catch(t){return"UTC"}if(!this.config.timezone)try{return Intl.DateTimeFormat().resolvedOptions().timeZone}catch(t){return"UTC"}return this.config.timezone}isChatActive(){if(!this.config.enabled)return!0;if(!this.config.ranges||0===this.config.ranges.length)return!0;const t=this.getCurrentTime();return!!this.isActiveDayOfWeek(t)&&this.config.ranges.some((e=>this.isTimeInRange(t,e)))}isActiveDayOfWeek(t){const e=t.getDay();return this.config.activeDays&&this.config.activeDays.length>0?this.config.activeDays.includes(e):!this.config.excludeWeekends||0!==e&&6!==e}getCurrentTime(){const t=new Date,e=this.getEffectiveTimezone();try{const n=t.toLocaleString("en-US",{timeZone:e,hour12:!1,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"});return new Date(n)}catch(t){}return t}isTimeInRange(t,e){try{const n=this.timeToMinutes(t),i=this.parseTimeString(e.start),s=this.parseTimeString(e.end);return i>s?n>=i||n<=s:n>=i&&n<=s}catch(t){return!0}}parseTimeString(t){const e=t.match(/^(\d{1,2}):(\d{2})$/);if(!e)throw new Error(`Formato de hora invÃ¡lido: ${t}. Use formato HH:MM`);const n=parseInt(e[1],10),i=parseInt(e[2],10);if(n<0||n>23)throw new Error(`Hora invÃ¡lida: ${n}. Debe estar entre 0-23`);if(i<0||i>59)throw new Error(`Minutos invÃ¡lidos: ${i}. Debe estar entre 0-59`);return 60*n+i}timeToMinutes(t){return 60*t.getHours()+t.getMinutes()}getFallbackMessage(){if(this.config.fallbackMessage)return this.config.fallbackMessage;const t=this.getCurrentTime();if(!this.isActiveDayOfWeek(t)){if(this.config.excludeWeekends)return"El chat estÃ¡ disponible solo de lunes a viernes.";if(this.config.activeDays)return`El chat estÃ¡ disponible solo los dÃ­as: ${this.getActiveDayNames()}.`}return"El chat no estÃ¡ disponible en este momento. Por favor, intÃ©ntalo mÃ¡s tarde."}getActiveDayNames(){if(!this.config.activeDays||0===this.config.activeDays.length)return"todos los dÃ­as";const t=["domingo","lunes","martes","miÃ©rcoles","jueves","viernes","sÃ¡bado"];return this.config.activeDays.map((e=>t[e])).join(", ")}getNextAvailableTime(){if(!this.config.enabled||!this.config.ranges.length)return null;const t=this.getCurrentTime(),e=this.timeToMinutes(t);let n=null;for(const t of this.config.ranges)try{const i=this.parseTimeString(t.start);i>e?(null===n||i<n)&&(n=i):null===n&&(n=i)}catch(t){}if(null!==n){const t=n%60;return`${Math.floor(n/60).toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`}return null}getConfig(){return Object.assign({},this.config)}static validateConfig(t){const e=[];if(t.enabled){if(t.ranges&&Array.isArray(t.ranges)?0===t.ranges.length?e.push("Se requiere al menos un rango horario"):t.ranges.forEach(((t,i)=>{if(t.start&&t.end)try{const e=new n({enabled:!0,ranges:[]});e.parseTimeString(t.start),e.parseTimeString(t.end)}catch(t){const n=t instanceof Error?t.message:String(t);e.push(`Rango ${i+1}: ${n}`)}else e.push(`Rango ${i+1}: Se requieren propiedades 'start' y 'end'`)})):e.push("Se requiere un array de rangos horarios cuando activeHours estÃ¡ habilitado"),t.timezone&&"auto"!==t.timezone)try{(new Date).toLocaleString("en-US",{timeZone:t.timezone})}catch(n){const i=n instanceof Error?n.message:String(n);e.push(`Zona horaria invÃ¡lida: ${t.timezone} - ${i}`)}if(t.activeDays)if(Array.isArray(t.activeDays))if(0===t.activeDays.length)e.push("activeDays no puede estar vacÃ­o. Si quieres todos los dÃ­as, omite esta propiedad");else{const n=t.activeDays.filter((t=>t<0||t>6||!Number.isInteger(t)));n.length>0&&e.push(`activeDays contiene valores invÃ¡lidos: ${n.join(", ")}. Use nÃºmeros entre 0 (domingo) y 6 (sÃ¡bado)`)}else e.push("activeDays debe ser un array de nÃºmeros");t.excludeWeekends&&t.activeDays&&t.activeDays.length>0&&e.push("No use excludeWeekends y activeDays al mismo tiempo. activeDays tiene prioridad")}return e}}function i(t,e={}){return{enabled:!0,ranges:t,timezone:e.timezone,fallbackMessage:e.fallbackMessage}}e.ActiveHoursValidator=n,e.COMMON_ACTIVE_HOURS={BUSINESS_HOURS:i([{start:"09:00",end:"18:00"}]),BUSINESS_HOURS_WEEKDAYS:{enabled:!0,ranges:[{start:"09:00",end:"18:00"}],excludeWeekends:!0,fallbackMessage:"El chat estÃ¡ disponible de lunes a viernes de 9:00 a 18:00"},SPLIT_SCHEDULE:i([{start:"08:00",end:"14:00"},{start:"15:00",end:"17:00"}]),SPLIT_SCHEDULE_WEEKDAYS:{enabled:!0,ranges:[{start:"08:00",end:"14:00"},{start:"15:00",end:"17:00"}],excludeWeekends:!0,fallbackMessage:"El chat estÃ¡ disponible de lunes a viernes de 8:00-14:00 y 15:00-17:00"},EXTENDED_HOURS:i([{start:"07:00",end:"22:00"}]),EXTENDED_HOURS_WEEKDAYS:{enabled:!0,ranges:[{start:"07:00",end:"22:00"}],excludeWeekends:!0,fallbackMessage:"El chat estÃ¡ disponible de lunes a viernes de 7:00 a 22:00"},NIGHT_SHIFT:i([{start:"22:00",end:"06:00"}]),WEEKENDS_ONLY:{enabled:!0,ranges:[{start:"10:00",end:"20:00"}],activeDays:[0,6],fallbackMessage:"El chat estÃ¡ disponible solo los fines de semana de 10:00 a 20:00"},MWF_ONLY:{enabled:!0,ranges:[{start:"09:00",end:"17:00"}],activeDays:[1,3,5],fallbackMessage:"El chat estÃ¡ disponible lunes, miÃ©rcoles y viernes de 9:00 a 17:00"}}},6585:t=>{var e=1e3,n=60*e,i=60*n,s=24*i,a=7*s;function o(t,e,n,i){var s=e>=1.5*n;return Math.round(t/n)+" "+i+(s?"s":"")}t.exports=function(t,r){r=r||{};var c,d,l=typeof t;if("string"===l&&t.length>0)return function(t){if(!((t=String(t)).length>100)){var o=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(t);if(o){var r=parseFloat(o[1]);switch((o[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return 315576e5*r;case"weeks":case"week":case"w":return r*a;case"days":case"day":case"d":return r*s;case"hours":case"hour":case"hrs":case"hr":case"h":return r*i;case"minutes":case"minute":case"mins":case"min":case"m":return r*n;case"seconds":case"second":case"secs":case"sec":case"s":return r*e;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return r;default:return}}}}(t);if("number"===l&&isFinite(t))return r.long?(c=t,(d=Math.abs(c))>=s?o(c,d,s,"day"):d>=i?o(c,d,i,"hour"):d>=n?o(c,d,n,"minute"):d>=e?o(c,d,e,"second"):c+" ms"):function(t){var a=Math.abs(t);return a>=s?Math.round(t/s)+"d":a>=i?Math.round(t/i)+"h":a>=n?Math.round(t/n)+"m":a>=e?Math.round(t/e)+"s":t+"ms"}(t);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(t))}},6792:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i,s=(i=n(7037))&&i.__esModule?i:{default:i};e.default=function(t){if(!(0,s.default)(t))throw TypeError("Invalid UUID");var e,n=new Uint8Array(16);return n[0]=(e=parseInt(t.slice(0,8),16))>>>24,n[1]=e>>>16&255,n[2]=e>>>8&255,n[3]=255&e,n[4]=(e=parseInt(t.slice(9,13),16))>>>8,n[5]=255&e,n[6]=(e=parseInt(t.slice(14,18),16))>>>8,n[7]=255&e,n[8]=(e=parseInt(t.slice(19,23),16))>>>8,n[9]=255&e,n[10]=(e=parseInt(t.slice(24,36),16))/1099511627776&255,n[11]=e/4294967296&255,n[12]=e>>>24&255,n[13]=e>>>16&255,n[14]=e>>>8&255,n[15]=255&e,n}},6808:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DomTrackingManager=e.DefaultTrackDataExtractor=void 0;class n{extract(t){const e=t.dataset,n={event:e.trackEvent};return Object.keys(e).forEach((t=>{if("trackEvent"===t)return;const i=t.replace(/[A-Z]/g,(t=>`_${t.toLowerCase()}`));n[i]=e[t]})),n}}e.DefaultTrackDataExtractor=n,e.DomTrackingManager=class{constructor(t,e=new n){this.domEventMap={view_product:"mouseenter",add_to_cart:"click",view_cart:"mouseenter",purchase:"click",page_view:"DOMContentLoaded",search_vehicle_type:"change",search_brand:"change",search_model:"change",search_fuel:"change",search_price_type:"change",sort_vehicles:"change",calculate_financing:"click",add_to_favorites:"click",view_vehicle_location:"mouseenter",filter_by_price:"change",filter_by_payment:"change",search_submit:"click",search_input:"input",add_to_comparison:"click",remove_from_comparison:"click",select_comparison_vehicle:"click",view_vehicle_comparison:"mouseenter",save_comparison:"click",export_comparison:"click",share_comparison:"click",clear_comparison:"click",filter_by_year:"change",filter_by_transmission:"change",filter_by_doors:"change",filter_by_mileage:"change",filter_by_condition:"change",toggle_advanced_filters:"click",contact_dealer:"click",schedule_test_drive:"click",request_quote:"click",view_vehicle_details:"click",view_vehicle_gallery:"click",view_vehicle_specs:"click",view_vehicle_history:"click",download_brochure:"click",analytics_dashboard_view:"mouseenter",export_analytics:"click",share_analytics:"click",chat_ask_about_vehicle:"click",chat_request_financing:"click",chat_schedule_viewing:"click"},this.trackCallback=t,this.extractor=e}enableDOMTracking(){const t=document.querySelector('[data-track-event="page_view"]');t&&"DOMContentLoaded"===this.domEventMap.page_view&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",(()=>{this.trackCallback(this.extractor.extract(t))})):this.trackCallback(this.extractor.extract(t))),Object.entries(this.domEventMap).forEach((([t,e])=>{"page_view"!==t&&document.querySelectorAll(`[data-track-event="${t}"]`).forEach((n=>{const i=`__track_listener_${t}`;n[i]||(n.addEventListener(e,(()=>{this.trackCallback(this.extractor.extract(n))})),n[i]=!0)}))}))}}},6894:function(t,e,n){"use strict";var i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.url=function(t,e="",n){let i=t;n=n||"undefined"!=typeof location&&location,null==t&&(t=n.protocol+"//"+n.host),"string"==typeof t&&("/"===t.charAt(0)&&(t="/"===t.charAt(1)?n.protocol+t:n.host+t),/^(https?|wss?):\/\//.test(t)||(a("protocol-less url %s",t),t=void 0!==n?n.protocol+"//"+t:"https://"+t),a("parse %s",t),i=(0,s.parse)(t)),i.port||(/^(http|ws)$/.test(i.protocol)?i.port="80":/^(http|ws)s$/.test(i.protocol)&&(i.port="443")),i.path=i.path||"/";const o=-1!==i.host.indexOf(":")?"["+i.host+"]":i.host;return i.id=i.protocol+"://"+o+":"+i.port+e,i.href=i.protocol+"://"+o+(n&&n.port===i.port?"":":"+i.port),i};const s=n(4956),a=(0,i(n(7833)).default)("socket.io-client:url")},6932:(t,e)=>{"use strict";var n;Object.defineProperty(e,"__esModule",{value:!0}),e.ConfidenceLevel=void 0,function(t){t[t.EXACT_MATCH=.95]="EXACT_MATCH",t[t.HIGH=.9]="HIGH",t[t.MEDIUM=.7]="MEDIUM",t[t.LOW=.5]="LOW",t[t.FALLBACK=.1]="FALLBACK"}(n||(e.ConfidenceLevel=n={}))},7037:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i,s=(i=n(7656))&&i.__esModule?i:{default:i};e.default=function(t){return"string"==typeof t&&s.default.test(t)}},7183:function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function r(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.ChatMessagesUI=void 0;const s=n(5829),a=n(2782),o=n(3974),r=n(9439),c=n(5649);e.ChatMessagesUI=class{constructor(t){this.chatId=null,this.currentCursor=null,this.hasMoreMessages=!0,this.isLoading=!1,this.isInitialLoad=!0,this.preventAutoScrollLoad=!1,this.topLoadingIndicator=null,this.typingIndicatorContainer=null,this.presenceService=null,this.typingUnsubscribe=null,this.SCROLL_THRESHOLD=100,this.MESSAGE_LIMIT=20,this.container=t,this.messagePaginationService=s.MessagePaginationService.getInstance(),this.typingIndicator=new r.TypingIndicator,this.setupUI(),this.setupScrollListener()}setPresenceService(t){this.presenceService=t,this.typingUnsubscribe=this.presenceService.onTypingChanged(((t,e)=>{"commercial"===t.userType&&(e?((0,o.debugLog)("[ChatMessagesUI] ðŸ“ Comercial estÃ¡ escribiendo:",t),this.showTypingIndicator()):((0,o.debugLog)("[ChatMessagesUI] ðŸ“ Comercial dejÃ³ de escribir:",t),this.hideTypingIndicator()))})),(0,o.debugLog)("[ChatMessagesUI] âœ… PresenceService configurado y suscrito a typing events")}setupUI(){this.messagesContainer=this.container,this.messagesContainer.style.cssText+="\n            overflow-y: auto;\n            scroll-behavior: smooth;\n        ",this.typingIndicatorContainer=this.typingIndicator.render(),this.messagesContainer.appendChild(this.typingIndicatorContainer),(0,o.debugLog)("ðŸ“¦ [ChatMessagesUI] setupUI: Usando contenedor existente como messagesContainer + typing indicator agregado")}setupScrollListener(){this.messagesContainer.addEventListener("scroll",this.handleScroll.bind(this))}handleScroll(){return i(this,void 0,void 0,(function*(){const{scrollTop:t,scrollHeight:e,clientHeight:n}=this.messagesContainer;if((0,o.debugLog)("ðŸ” [ChatMessagesUI] handleScroll ejecutÃ¡ndose:",{scrollTop:t,scrollHeight:e,clientHeight:n,threshold:this.SCROLL_THRESHOLD,chatId:this.chatId,hasMoreMessages:this.hasMoreMessages,isLoading:this.isLoading,currentCursor:this.currentCursor,preventAutoScrollLoad:this.preventAutoScrollLoad}),this.chatId)if(this.hasMoreMessages)if(this.isLoading)(0,o.debugLog)("âŒ [ChatMessagesUI] handleScroll: isLoading = true");else{if(this.preventAutoScrollLoad)return(0,o.debugLog)("ðŸ›¡ï¸ [ChatMessagesUI] handleScroll: preventAutoScrollLoad activo - ignorando threshold"),void(t>2*this.SCROLL_THRESHOLD&&(this.preventAutoScrollLoad=!1,(0,o.debugLog)("âœ… [ChatMessagesUI] handleScroll: Usuario hizo scroll manual - desactivando preventAutoScrollLoad")));(0,o.debugLog)(`ðŸ” [ChatMessagesUI] Verificando threshold: scrollTop=${t} <= ${this.SCROLL_THRESHOLD}?`),t<=this.SCROLL_THRESHOLD?((0,o.debugLog)("ðŸš€ [ChatMessagesUI] THRESHOLD ALCANZADO! Iniciando loadOlderMessages..."),yield this.loadOlderMessages()):(0,o.debugLog)("ðŸ“Š [ChatMessagesUI] Threshold no alcanzado. Necesita scroll mÃ¡s arriba.")}else(0,o.debugLog)("âŒ [ChatMessagesUI] handleScroll: hasMoreMessages = false");else(0,o.debugLog)("âŒ [ChatMessagesUI] handleScroll: Sin chatId")}))}initializeChat(t){return i(this,void 0,void 0,(function*(){(0,o.debugLog)(`ðŸ’¬ [ChatMessagesUI] Inicializando chat: ${t}`),this.chatId!==t||this.isInitialLoad?(this.chatId=t,this.isInitialLoad=!0,this.currentCursor=null,this.hasMoreMessages=!0,this.isLoading=!1,this.preventAutoScrollLoad=!1,this.clearMessages(),yield this.loadInitialMessages(),this.isInitialLoad=!1):(0,o.debugLog)(`ðŸ’¬ [ChatMessagesUI] Chat ${t} ya estÃ¡ inicializado`)}))}loadInitialMessages(){return i(this,void 0,void 0,(function*(){if(this.chatId)try{this.isLoading=!0,(0,o.debugLog)("ðŸ“‹ [ChatMessagesUI] Cargando mensajes iniciales...");const t=yield this.messagePaginationService.loadInitialMessages(this.chatId,this.MESSAGE_LIMIT);this.renderInitialMessages(t),this.updatePaginationState(t),this.scrollToBottom(),(0,o.debugLog)("âœ… [ChatMessagesUI] Mensajes iniciales cargados y scroll al bottom realizado")}catch(t){this.showErrorMessage("Error al cargar mensajes")}finally{this.isLoading=!1}}))}loadOlderMessages(){return i(this,void 0,void 0,(function*(){if((0,o.debugLog)("ðŸš€ [ChatMessagesUI] loadOlderMessages INICIADO"),(0,o.debugLog)("ðŸ” [ChatMessagesUI] Estado antes de validaciones:",{chatId:this.chatId,currentCursor:this.currentCursor,hasMoreMessages:this.hasMoreMessages,isLoading:this.isLoading}),this.chatId)if(this.currentCursor)if(this.hasMoreMessages)try{this.isLoading=!0,this.showTopLoadingIndicator(),(0,o.debugLog)("ðŸ“œ [ChatMessagesUI] âœ… LLAMANDO AL BACKEND - Cargando mensajes antiguos..."),(0,o.debugLog)("ðŸ“‹ [ChatMessagesUI] ParÃ¡metros de peticiÃ³n:",{chatId:this.chatId,cursor:this.currentCursor,limit:this.MESSAGE_LIMIT});const t=this.messagesContainer.scrollHeight,e=this.messagesContainer.scrollTop,n=yield this.messagePaginationService.loadOlderMessages(this.chatId,this.currentCursor,this.MESSAGE_LIMIT);(0,o.debugLog)("ðŸ“¦ [ChatMessagesUI] Respuesta del backend:",n),this.renderOlderMessages(n),this.updatePaginationState(n);const i=this.messagesContainer.scrollHeight-t;this.messagesContainer.scrollTop=e+i,(0,o.debugLog)(`âœ… [ChatMessagesUI] ${n.messages.length} mensajes antiguos cargados`)}catch(t){}finally{this.hideTopLoadingIndicator(),this.isLoading=!1}else(0,o.debugLog)("âŒ [ChatMessagesUI] loadOlderMessages: hasMoreMessages = false");else(0,o.debugLog)("âŒ [ChatMessagesUI] loadOlderMessages: Sin currentCursor");else(0,o.debugLog)("âŒ [ChatMessagesUI] loadOlderMessages: Sin chatId")}))}renderInitialMessages(t){t.messages&&0!==t.messages.length?([...t.messages].reverse().forEach((t=>{const e=this.createMessageElement(t);this.messagesContainer.appendChild(e)})),this.rebuildDateSeparators()):this.showEmptyState()}renderOlderMessages(t){if(!t.messages||0===t.messages.length)return;const e=this.messagesContainer.scrollHeight,n=this.messagesContainer.scrollTop,i=[...t.messages].reverse(),s=document.createDocumentFragment();i.forEach((t=>{const e=this.createMessageElement(t);s.appendChild(e)}));const a=this.messagesContainer.firstChild;a?this.messagesContainer.insertBefore(s,a):this.messagesContainer.appendChild(s),this.rebuildDateSeparators();const o=this.messagesContainer.style.scrollBehavior;this.messagesContainer.style.scrollBehavior="auto";const r=this.messagesContainer.scrollHeight-e;this.messagesContainer.scrollTop=n+r,requestAnimationFrame((()=>{this.messagesContainer.style.scrollBehavior=o||"smooth"}))}createMessageElement(t){const e=a.MessageRenderer.fromMessageV2(t);return a.MessageRenderer.createMessageElement(e)}applyModernMessageStyles(t,e){const n=t.querySelector(".message-avatar"),i=t.querySelector(".message-bubble"),s=t.querySelector(".message-content"),a=t.querySelector(".message-text"),o=t.querySelector(".message-metadata"),r=t.querySelector(".message-time"),c=t.querySelector(".message-status");if(t.style.cssText=`\n            display: flex;\n            align-items: flex-end;\n            margin-bottom: 16px;\n            ${e?"flex-direction: row-reverse; padding-left: 60px;":"flex-direction: row; padding-right: 60px;"}\n            animation: messageSlideIn 0.3s ease-out;\n        `,n){n.style.cssText="\n                margin-right: 12px;\n                margin-bottom: 4px;\n            ";const t=n.querySelector(".avatar-circle");t&&(t.style.cssText="\n                    width: 32px;\n                    height: 32px;\n                    border-radius: 50%;\n                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                    display: flex;\n                    align-items: center;\n                    justify-content: center;\n                    color: white;\n                    font-size: 11px;\n                    font-weight: 600;\n                    border: none;\n                    box-sizing: border-box;\n                    min-width: 32px;\n                    min-height: 32px;\n                    max-width: 32px;\n                    max-height: 32px;\n                ")}i.style.cssText="\n            position: relative;\n            max-width: 85%;\n            min-width: 120px;\n        ",s.style.cssText=`\n            padding: 12px 16px 8px;\n            border-radius: 20px;\n            position: relative;\n            word-break: break-word;\n            ${e?"background: linear-gradient(145deg, #0084ff 60%, #00c6fb 100%);\n                 color: white;\n                 border-bottom-right-radius: 6px;\n                 box-shadow: 0 2px 12px rgba(0, 132, 255, 0.3);":"background: white;\n                 color: #1d1d1f;\n                 border: 1px solid rgba(0, 0, 0, 0.08);\n                 border-bottom-left-radius: 6px;\n                 box-shadow: 0 1px 8px rgba(0, 0, 0, 0.08);"}\n            backdrop-filter: blur(10px);\n            transition: all 0.2s ease;\n        `,a.style.cssText="\n            font-size: 15px;\n            line-height: 1.4;\n            margin: 0;\n            font-weight: 400;\n            letter-spacing: -0.01em;\n        ",o.style.cssText=`\n            display: flex;\n            align-items: center;\n            justify-content: ${e?"flex-end":"flex-start"};\n            gap: 6px;\n            margin-top: 2px;\n            padding: 0 4px;\n        `,r.style.cssText=`\n            font-size: 11px;\n            color: ${e?"rgba(0, 0, 0, 0.8)":"rgba(60, 60, 67, 0.6)"};\n            font-weight: 500;\n            letter-spacing: 0.01em;\n        `,c&&(c.style.cssText="\n                font-size: 12px;\n                color: rgba(255, 255, 255, 0.8);\n                margin-left: 2px;\n            "),this.addMessageAnimations()}addMessageAnimations(){if(document.getElementById("modern-message-animations"))return;const t=document.createElement("style");t.id="modern-message-animations",t.textContent="\n            @keyframes messageSlideIn {\n                from {\n                    opacity: 0;\n                    transform: translateY(10px);\n                }\n                to {\n                    opacity: 1;\n                    transform: translateY(0);\n                }\n            }\n\n            /* Efecto hover deshabilitado por solicitud del usuario */\n\n            /* Mejorar tipografÃ­a */\n            .modern-message .message-text {\n                -webkit-font-smoothing: antialiased;\n                -moz-osx-font-smoothing: grayscale;\n            }\n\n            /* Estilos responsivos */\n            @media (max-width: 480px) {\n                .modern-message {\n                    padding-left: 20px !important;\n                    padding-right: 20px !important;\n                }\n                \n                .modern-message .message-bubble {\n                    max-width: 90% !important;\n                }\n            }\n        ",document.head.appendChild(t)}isUserMessage(t){try{const e=localStorage.getItem("visitorId");if(e)return t.senderId===e}catch(t){}return!1}updatePaginationState(t){var e;(0,o.debugLog)("ðŸ”„ [ChatMessagesUI] updatePaginationState ANTES:",{prevHasMore:this.hasMoreMessages,prevCursor:this.currentCursor}),(0,o.debugLog)("ðŸ“¥ [ChatMessagesUI] Respuesta recibida:",{hasMore:t.hasMore,cursor:t.cursor,nextCursor:t.nextCursor,messagesCount:(null===(e=t.messages)||void 0===e?void 0:e.length)||0}),this.hasMoreMessages=t.hasMore;const n=t.cursor||t.nextCursor;(0,o.debugLog)("ðŸ” [ChatMessagesUI] Cursor extraÃ­do:",{extractedCursor:n,hasMore:t.hasMore}),n&&t.hasMore?this.currentCursor=n:this.currentCursor=null,(0,o.debugLog)("ðŸ“Š [ChatMessagesUI] Estado paginaciÃ³n actualizado DESPUÃ‰S:",{hasMore:this.hasMoreMessages,hasCursor:!!this.currentCursor,cursor:this.currentCursor,totalMessages:this.messagesContainer.children.length})}scrollToBottom(){this.preventAutoScrollLoad=!0,(0,o.debugLog)("ðŸ›¡ï¸ [ChatMessagesUI] scrollToBottom: Activando preventAutoScrollLoad"),requestAnimationFrame((()=>{this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight,setTimeout((()=>{this.preventAutoScrollLoad=!1,(0,o.debugLog)("âœ… [ChatMessagesUI] scrollToBottom: Desactivando preventAutoScrollLoad despuÃ©s de delay")}),500)}))}addNewMessage(t){const e=this.createMessageElement(t);this.messagesContainer.appendChild(e),this.scrollToBottom()}showTopLoadingIndicator(){this.topLoadingIndicator||(this.topLoadingIndicator=document.createElement("div"),this.topLoadingIndicator.className="top-loading-indicator",this.topLoadingIndicator.innerHTML='\n            <div style="text-align: center; padding: 12px; color: #666; font-size: 12px;">\n                <div style="display: inline-block; width: 16px; height: 16px; border: 2px solid #f3f3f3; border-top: 2px solid #0084ff; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;"></div>\n                Cargando mensajes anteriores...\n            </div>\n            <style>\n                @keyframes spin {\n                    0% { transform: rotate(0deg); }\n                    100% { transform: rotate(360deg); }\n                }\n            </style>\n        ',this.messagesContainer.insertBefore(this.topLoadingIndicator,this.messagesContainer.firstChild))}hideTopLoadingIndicator(){this.topLoadingIndicator&&(this.topLoadingIndicator.remove(),this.topLoadingIndicator=null)}showErrorMessage(t){const e=document.createElement("div");e.style.cssText="\n            text-align: center;\n            padding: 20px;\n            color: #dc3545;\n            font-size: 14px;\n        ",e.textContent=t,this.messagesContainer.appendChild(e)}showEmptyState(){const t=document.createElement("div");t.style.cssText="\n            text-align: center;\n            padding: 40px 20px;\n            color: #8a9aa9;\n            font-size: 14px;\n        ",t.innerHTML='\n            <div style="font-size: 48px; margin-bottom: 16px;">ðŸ’¬</div>\n            <div>Â¡Inicia la conversaciÃ³n!</div>\n            <div style="font-size: 12px; margin-top: 8px;">Este es el comienzo de tu chat</div>\n        ',this.messagesContainer.appendChild(t)}clearMessages(){const t=this.typingIndicator.getElement();this.messagesContainer.innerHTML="",t&&this.messagesContainer.appendChild(t),this.typingIndicator.hide(),this.hideTopLoadingIndicator()}formatMessageTime(t){return new Date(t).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",hour12:!1})}escapeHtml(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}showTypingIndicator(){(0,o.debugLog)("[ChatMessagesUI] ðŸ“ Mostrando typing indicator"),this.typingIndicator.show();const{scrollTop:t,scrollHeight:e,clientHeight:n}=this.messagesContainer;e-t-n<100&&this.scrollToBottom()}hideTypingIndicator(){(0,o.debugLog)("[ChatMessagesUI] ðŸ“ Ocultando typing indicator"),this.typingIndicator.hide()}isTypingIndicatorVisible(){return this.typingIndicator.isShown()}rebuildDateSeparators(){this.messagesContainer.querySelectorAll(".chat-date-separator").forEach((t=>{var e;return null===(e=t.parentNode)||void 0===e?void 0:e.removeChild(t)}));const t=Array.from(this.messagesContainer.querySelectorAll(".chat-message-wrapper"));if(0===t.length)return;let e=null;t.forEach((t=>{const n=t.getAttribute("data-created-at"),i=n?new Date(n):new Date,s=(0,c.formatDate)(i);if(s!==e){e=s;const n=(0,c.createDateSeparator)(s);this.messagesContainer.insertBefore(n,t)}})),(0,o.debugLog)("[ChatMessagesUI] âœ… Date separators rebuilt")}destroy(){this.messagesContainer.removeEventListener("scroll",this.handleScroll),this.clearMessages(),this.typingUnsubscribe&&(this.typingUnsubscribe(),this.typingUnsubscribe=null),this.typingIndicator.destroy(),this.typingIndicatorContainer=null,this.presenceService=null,this.chatId=null,this.currentCursor=null,this.hasMoreMessages=!0,this.isLoading=!1,this.preventAutoScrollLoad=!1}getScrollState(){return{hasMore:this.hasMoreMessages,isLoading:this.isLoading,messageCount:this.messagesContainer.children.length}}isChatInitialized(t){return t?this.chatId===t&&!this.isInitialLoad:null!==this.chatId&&!this.isInitialLoad}getCurrentChatId(){return this.chatId}isLoadingMessages(){return this.isLoading}}},7186:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i=a(n(9025)),s=a(n(9042));function a(t){return t&&t.__esModule?t:{default:t}}var o=(0,i.default)("v5",80,s.default);e.default=o},7330:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.QuickActionsUI=void 0;const i=n(3974);e.QuickActionsUI=class{constructor(t={}){var e,n,s,a,o;this.element=null,this.isHidden=!1,this.onSendMessage=null,this.onRequestAgent=null,this.onOpenUrl=null,this.onActionClicked=null,this.config={enabled:null!==(e=t.enabled)&&void 0!==e&&e,welcomeMessage:null!==(n=t.welcomeMessage)&&void 0!==n?n:"Â¡Hola! ðŸ‘‹ Â¿En quÃ© puedo ayudarte?",showOnFirstOpen:null===(s=t.showOnFirstOpen)||void 0===s||s,showOnChatStart:null===(a=t.showOnChatStart)||void 0===a||a,buttons:null!==(o=t.buttons)&&void 0!==o?o:[],onCustomAction:t.onCustomAction},(0,i.debugLog)("[QuickActionsUI] Inicializado con config:",this.config)}render(){if(this.element=document.createElement("div"),this.element.className="guiders-quick-actions",this.element.setAttribute("role","region"),this.element.setAttribute("aria-label","Opciones rÃ¡pidas"),this.config.welcomeMessage){const t=document.createElement("div");t.className="guiders-quick-actions-welcome",t.textContent=this.config.welcomeMessage,this.element.appendChild(t)}if(this.config.buttons.length>0){const t=document.createElement("div");t.className="guiders-quick-actions-buttons";for(const e of this.config.buttons){const n=this.createButton(e);t.appendChild(n)}this.element.appendChild(t)}return(0,i.debugLog)("[QuickActionsUI] Componente renderizado"),this.element}createButton(t){const e=document.createElement("button");e.className="guiders-quick-action-btn",e.setAttribute("data-action-id",t.id),e.setAttribute("aria-label",t.label);const n=t.emoji?`${t.emoji} ${t.label}`:t.label;return e.textContent=n,e.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),this.handleButtonClick(t)})),e}handleButtonClick(t){switch((0,i.debugLog)("[QuickActionsUI] BotÃ³n clickeado:",t.id,t.action.type),this.onActionClicked&&this.onActionClicked(t.id,t.action),t.action.type){case"send_message":this.handleSendMessage(t.action);break;case"open_url":this.handleOpenUrl(t.action);break;case"request_agent":this.handleRequestAgent();break;case"custom":this.handleCustomAction(t.id,t.action);break;default:(0,i.debugLog)("[QuickActionsUI] Tipo de acciÃ³n no soportado:",t.action.type)}this.hide()}handleSendMessage(t){var e;let n,s;if("string"==typeof t.payload)n=t.payload;else{if(!t.payload||"object"!=typeof t.payload)return void(0,i.debugLog)("[QuickActionsUI] send_message sin payload");{const i=t.payload;n=null!==(e=i.message)&&void 0!==e?e:"",s=i.metadata}}this.onSendMessage&&n&&this.onSendMessage(n,s)}handleOpenUrl(t){let e;"string"==typeof t.payload?e=t.payload:t.payload&&"object"==typeof t.payload&&(e=t.payload.message),e?(window.open(e,"_blank","noopener,noreferrer"),this.onOpenUrl&&this.onOpenUrl(e)):(0,i.debugLog)("[QuickActionsUI] open_url sin URL vÃ¡lida")}handleRequestAgent(){(0,i.debugLog)("[QuickActionsUI] Solicitando agente humano"),this.onRequestAgent&&this.onRequestAgent()}handleCustomAction(t,e){this.config.onCustomAction?this.config.onCustomAction(t,e):(0,i.debugLog)("[QuickActionsUI] AcciÃ³n custom sin handler configurado")}show(){this.element&&(this.isHidden=!1,this.element.style.display="flex",this.element.style.opacity="0",this.element.style.transform="translateY(10px)",this.element.offsetHeight,this.element.style.transition="opacity 0.3s ease, transform 0.3s ease",this.element.style.opacity="1",this.element.style.transform="translateY(0)",(0,i.debugLog)("[QuickActionsUI] Componente mostrado"))}hide(){this.element&&!this.isHidden&&(this.isHidden=!0,this.element.style.transition="opacity 0.3s ease, transform 0.3s ease",this.element.style.opacity="0",this.element.style.transform="translateY(-10px)",setTimeout((()=>{this.element&&(this.element.style.display="none")}),300),(0,i.debugLog)("[QuickActionsUI] Componente oculto"))}isVisible(){return null!==this.element&&!this.isHidden&&"none"!==this.element.style.display}isEnabled(){return this.config.enabled&&this.config.buttons.length>0}getElement(){return this.element}destroy(){this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null,this.isHidden=!1,(0,i.debugLog)("[QuickActionsUI] Componente destruido")}updateConfig(t){if(void 0!==t.enabled&&(this.config.enabled=t.enabled),void 0!==t.welcomeMessage&&(this.config.welcomeMessage=t.welcomeMessage),void 0!==t.showOnFirstOpen&&(this.config.showOnFirstOpen=t.showOnFirstOpen),void 0!==t.showOnChatStart&&(this.config.showOnChatStart=t.showOnChatStart),t.buttons&&(this.config.buttons=t.buttons),t.onCustomAction&&(this.config.onCustomAction=t.onCustomAction),(0,i.debugLog)("[QuickActionsUI] ConfiguraciÃ³n actualizada"),this.element&&this.element.parentNode){const t=this.element.parentNode,e=this.isVisible();this.destroy(),t.appendChild(this.render()),e&&this.show()}}}},7656:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0,e.default=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-8][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000|ffffffff-ffff-ffff-ffff-ffffffffffff)$/i},7686:function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function r(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.ChatV2Service=void 0;const s=n(2597),a=n(3974),o=n(3235);class r{constructor(){(0,a.debugLog)("[ChatV2Service] ðŸš€ Constructor llamado")}static getInstance(){return r.instance||(r.instance=new r),r.instance}getAuthHeaders(){return(0,o.getCommonHeaders)()}getFetchOptions(t="GET",e){const n=(0,o.getCommonFetchOptions)(t);return e&&(n.body=e),n}fetchWithReauth(t,e){return i(this,void 0,void 0,(function*(){let n=yield fetch(t,e);return 401===n.status&&((0,a.debugLog)("[ChatV2Service] âš ï¸ Error 401 - Intentando re-autenticaciÃ³n..."),(yield this.reAuthenticate())?((0,a.debugLog)("[ChatV2Service] âœ… Re-autenticaciÃ³n exitosa, reintentando peticiÃ³n..."),n=yield fetch(t,Object.assign(Object.assign({},e),{headers:this.getAuthHeaders()}))):(0,a.debugLog)("[ChatV2Service] âŒ Re-autenticaciÃ³n fallida")),n}))}reAuthenticate(){return i(this,void 0,void 0,(function*(){try{const t=localStorage.getItem("visitorId"),e=localStorage.getItem("fingerprint"),n=localStorage.getItem("guidersApiKey")||localStorage.getItem("apiKey"),i="undefined"!=typeof window?window.location.hostname:"localhost",o="undefined"!=typeof window?window.location.href:void 0;let r="v1.0";const c=localStorage.getItem("guiders_consent_state");if(c)try{r=JSON.parse(c).version||"v1.0"}catch(t){}if((0,a.debugLog)("[ChatV2Service] ðŸ” reAuthenticate() llamado"),(0,a.debugLog)("  - visitorId:",t),(0,a.debugLog)("  - fingerprint:",e?e.substring(0,20)+"...":"null"),(0,a.debugLog)("  - apiKey:",n),(0,a.debugLog)("  - domain:",i),!t||!e)return(0,a.debugLog)("[ChatV2Service] âŒ No hay visitorId o fingerprint para re-autenticar"),!1;const d=s.EndpointManager.getInstance(),l=localStorage.getItem("pixelEndpoint")||d.getEndpoint(),h=`${l.endsWith("/api")?l:`${l}/api`}/visitors/identify`;(0,a.debugLog)("[ChatV2Service] ðŸ“¤ POST",h);const u=yield fetch(h,{method:"POST",headers:Object.assign({"Content-Type":"application/json"},this.getAuthHeaders()),credentials:"include",body:JSON.stringify({fingerprint:e,domain:i,apiKey:n||"",hasAcceptedPrivacyPolicy:!0,consentVersion:r,currentUrl:o})});if((0,a.debugLog)("[ChatV2Service] ðŸ“¥ Response status:",u.status),u.ok){const t=yield u.json();if((0,a.debugLog)("[ChatV2Service] ðŸ“¦ Respuesta identify:",JSON.stringify(t,null,2)),t.sessionId){const e=sessionStorage.getItem("guiders_backend_session_id");sessionStorage.setItem("guiders_backend_session_id",t.sessionId),(0,a.debugLog)("[ChatV2Service] âœ… SessionId actualizado:",e,"â†’",t.sessionId)}else(0,a.debugWarn)("[ChatV2Service] âš ï¸ No hay sessionId en la respuesta");return t.visitorId&&localStorage.setItem("visitorId",t.visitorId),(t.tenantId||t.tenant_id)&&(localStorage.setItem("tenantId",t.tenantId||t.tenant_id),(0,a.debugLog)("[ChatV2Service] âœ… TenantId guardado:",t.tenantId||t.tenant_id)),(0,a.debugLog)("[ChatV2Service] âœ… Re-identificaciÃ³n completada"),!0}const g=yield u.text();return(0,a.debugError)("[ChatV2Service] âŒ Error en re-identificaciÃ³n:",u.status,g),!1}catch(t){return(0,a.debugError)("[ChatV2Service] âŒ Error en re-autenticaciÃ³n:",t),!1}}))}getBaseUrl(){const t=s.EndpointManager.getInstance(),e=localStorage.getItem("pixelEndpoint")||t.getEndpoint();return`${e.endsWith("/api")?e:`${e}/api`}/v2/chats`}getVisitorChats(t,e){return i(this,arguments,void 0,(function*(t,e,n=20){(0,a.debugLog)(`[ChatV2Service] ðŸ‘¤ Obteniendo chats del visitante: ${t}`);const i=new URLSearchParams;e&&i.append("cursor",e),i.append("limit",n.toString());const s=`${this.getBaseUrl()}/visitor/${t}?${i.toString()}`,o=yield this.fetchWithReauth(s,this.getFetchOptions("GET"));if(!o.ok){const e=yield o.text();throw(0,a.debugError)(`[ChatV2Service] âŒ Error al obtener chats del visitante ${t}:`,e),new Error(`Error al obtener chats del visitante (${o.status}): ${e}`)}const r=yield o.json();return(0,a.debugLog)("[ChatV2Service] âœ… Chats del visitante obtenidos:",{count:r.chats.length,total:r.total,hasMore:r.hasMore}),r}))}getLatestVisitorChat(t){return i(this,void 0,void 0,(function*(){try{const e=yield this.getVisitorChats(t,void 0,20);return e.chats&&e.chats.length>0?e.chats[0]:null}catch(t){return(0,a.debugWarn)("[ChatV2Service] âŒ Error obteniendo Ãºltimo chat del visitante:",t),null}}))}getCommercialChats(t,e){return i(this,arguments,void 0,(function*(t,e,n=20,i){(0,a.debugLog)(`[ChatV2Service] ðŸª Obteniendo chats del comercial: ${t}`);const s=new URLSearchParams;e&&s.append("cursor",e),s.append("limit",n.toString()),i&&Object.entries(i).forEach((([t,e])=>{Array.isArray(e)?e.forEach((e=>s.append(`filters[${t}][]`,e))):s.append(`filters[${t}]`,e)}));const o=`${this.getBaseUrl()}/commercial/${t}?${s.toString()}`,r=yield fetch(o,this.getFetchOptions("GET"));if(!r.ok){const e=yield r.text();throw(0,a.debugError)(`[ChatV2Service] âŒ Error al obtener chats del comercial ${t}:`,e),new Error(`Error al obtener chats del comercial (${r.status}): ${e}`)}const c=yield r.json();return(0,a.debugLog)("[ChatV2Service] âœ… Chats del comercial obtenidos:",{count:c.chats.length,total:c.total,hasMore:c.hasMore}),c}))}getPendingQueue(t){return i(this,arguments,void 0,(function*(t,e=50){(0,a.debugLog)("[ChatV2Service] ðŸ“‹ Obteniendo cola de chats pendientes");const n=new URLSearchParams;t&&n.append("department",t),n.append("limit",e.toString());const i=`${this.getBaseUrl()}/queue/pending?${n.toString()}`,s=yield fetch(i,this.getFetchOptions("GET"));if(!s.ok){const t=yield s.text();throw(0,a.debugError)("[ChatV2Service] âŒ Error al obtener cola pendiente:",t),new Error(`Error al obtener cola pendiente (${s.status}): ${t}`)}const o=yield s.json();return(0,a.debugLog)("[ChatV2Service] âœ… Cola de chats pendientes obtenida:",{count:o.length}),o}))}assignChat(t,e){return i(this,void 0,void 0,(function*(){(0,a.debugLog)(`[ChatV2Service] ðŸ“Œ Asignando chat ${t} al comercial ${e}`);const n=yield fetch(`${this.getBaseUrl()}/${t}/assign/${e}`,this.getFetchOptions("PUT"));if(!n.ok){const t=yield n.text();throw(0,a.debugError)("[ChatV2Service] âŒ Error al asignar chat:",t),new Error(`Error al asignar chat (${n.status}): ${t}`)}const i=yield n.json();return(0,a.debugLog)("[ChatV2Service] âœ… Chat asignado exitosamente"),i}))}openChat(t){return i(this,void 0,void 0,(function*(){(0,a.debugLog)(`[ChatV2Service] ðŸ”“ Abriendo chat ${t}`);try{const e=yield fetch(`${this.getBaseUrl()}/${t}/open`,this.getFetchOptions("PUT"));if(404===e.status||501===e.status)return(0,a.debugWarn)(`[ChatV2Service] âš ï¸ Endpoint /open no disponible (${e.status}) - continuando sin sincronizar estado`),null;if(!e.ok){const t=yield e.text();throw(0,a.debugError)("[ChatV2Service] âŒ Error al abrir chat:",t),new Error(`Error al abrir chat (${e.status}): ${t}`)}const n=yield e.json();return(0,a.debugLog)("[ChatV2Service] âœ… Chat abierto exitosamente"),n}catch(t){if(t instanceof TypeError)return(0,a.debugWarn)("[ChatV2Service] âš ï¸ No se pudo conectar al endpoint /open - continuando sin sincronizar estado"),null;throw t}}))}closeChat(t){return i(this,void 0,void 0,(function*(){(0,a.debugLog)(`[ChatV2Service] ðŸ”’ Cerrando chat ${t}`);try{const e=yield fetch(`${this.getBaseUrl()}/${t}/close`,this.getFetchOptions("PUT"));if(404===e.status||501===e.status)return(0,a.debugWarn)(`[ChatV2Service] âš ï¸ Endpoint /close no disponible (${e.status}) - continuando sin sincronizar estado`),null;if(!e.ok){const t=yield e.text();throw(0,a.debugError)("[ChatV2Service] âŒ Error al cerrar chat:",t),new Error(`Error al cerrar chat (${e.status}): ${t}`)}const n=yield e.json();return(0,a.debugLog)("[ChatV2Service] âœ… Chat cerrado exitosamente"),n}catch(t){if(t instanceof TypeError)return(0,a.debugWarn)("[ChatV2Service] âš ï¸ No se pudo conectar al endpoint /close - continuando sin sincronizar estado"),null;throw t}}))}getCommercialMetrics(t,e,n){return i(this,void 0,void 0,(function*(){(0,a.debugLog)(`[ChatV2Service] ðŸ“Š Obteniendo mÃ©tricas del comercial: ${t}`);const i=new URLSearchParams;e&&i.append("dateFrom",e.toISOString()),n&&i.append("dateTo",n.toISOString());const s=`${this.getBaseUrl()}/metrics/commercial/${t}?${i.toString()}`,o=yield fetch(s,this.getFetchOptions("GET"));if(!o.ok){const t=yield o.text();throw(0,a.debugError)("[ChatV2Service] âŒ Error al obtener mÃ©tricas:",t),new Error(`Error al obtener mÃ©tricas (${o.status}): ${t}`)}const r=yield o.json();return(0,a.debugLog)("[ChatV2Service] âœ… MÃ©tricas obtenidas"),r}))}getResponseTimeStats(t,e){return i(this,arguments,void 0,(function*(t,e,n="day"){(0,a.debugLog)("[ChatV2Service] â±ï¸ Obteniendo estadÃ­sticas de tiempo de respuesta");const i=new URLSearchParams;t&&i.append("dateFrom",t.toISOString()),e&&i.append("dateTo",e.toISOString()),i.append("groupBy",n);const s=`${this.getBaseUrl()}/response-time-stats?${i.toString()}`,o=yield fetch(s,this.getFetchOptions("GET"));if(!o.ok){const t=yield o.text();throw(0,a.debugError)("[ChatV2Service] âŒ Error al obtener estadÃ­sticas:",t),new Error(`Error al obtener estadÃ­sticas (${o.status}): ${t}`)}const r=yield o.json();return(0,a.debugLog)("[ChatV2Service] âœ… EstadÃ­sticas obtenidas"),r}))}createChatAuto(t){return i(this,void 0,void 0,(function*(){(0,a.debugLog)("[ChatV2Service] ðŸ†• Creando chat V2 por POST (auto-id)");const e=yield this.fetchWithReauth(`${this.getBaseUrl()}`,this.getFetchOptions("POST",JSON.stringify(t)));if(!e.ok){const t=yield e.text();throw(0,a.debugError)("[ChatV2Service] âŒ Error al crear chat V2 (POST):",t),new Error(`Error al crear chat V2 (POST) (${e.status}): ${t}`)}const n=yield e.json();return(0,a.debugLog)("[ChatV2Service] âœ… Chat V2 creado (POST):",n.id),n}))}createChatWithMessage(t,e){return i(this,void 0,void 0,(function*(){var n,i;(0,a.debugLog)("[ChatV2Service] ðŸ†•ðŸ’¬ Creando chat V2 con mensaje inicial");const s=Object.assign(Object.assign({},t),{firstMessage:e});(0,a.debugLog)("[ChatV2Service] ðŸ“¤ Payload enviado:",JSON.stringify(s,null,2));const o=yield this.fetchWithReauth(`${this.getBaseUrl()}/with-message`,this.getFetchOptions("POST",JSON.stringify(s)));if(!o.ok){const t=yield o.text();throw(0,a.debugError)("[ChatV2Service] âŒ Error al crear chat V2 con mensaje:",t),new Error(`Error al crear chat V2 con mensaje (${o.status}): ${t}`)}const r=yield o.json();return(0,a.debugLog)("[ChatV2Service] âœ… Chat V2 con mensaje creado:",(null===(n=r.chat)||void 0===n?void 0:n.chatId)||(null===(i=r.chat)||void 0===i?void 0:i.id)),r}))}sendMessage(t,e){return i(this,arguments,void 0,(function*(t,e,n="text"){(0,a.debugLog)(`[ChatV2Service] ðŸ’¬ Enviando mensaje al chat ${t}`);const i={chatId:t,content:e,type:n},o=s.EndpointManager.getInstance(),r=localStorage.getItem("pixelEndpoint")||o.getEndpoint(),c=`${r.endsWith("/api")?r:`${r}/api`}/v2/messages`,d=yield this.fetchWithReauth(c,this.getFetchOptions("POST",JSON.stringify(i)));if(!d.ok){const t=yield d.text();throw(0,a.debugError)("[ChatV2Service] âŒ Error al enviar mensaje:",t),new Error(`Error al enviar mensaje (${d.status}): ${t}`)}const l=yield d.json();return(0,a.debugLog)("[ChatV2Service] âœ… Mensaje enviado:",l.messageId||l.id),l}))}sendMessageSmart(t,e){return i(this,arguments,void 0,(function*(t,e,n={},i="text"){(0,a.debugLog)(`[ChatV2Service] ðŸ§  Enviando mensaje inteligente para visitante ${t}`);try{const s=yield this.getVisitorChats(t,void 0,1);if(s.chats&&s.chats.length>0){const t=s.chats[0];(0,a.debugLog)(`[ChatV2Service] ðŸ“‹ Chat existente encontrado: ${t.id}, enviando mensaje`);const n=yield this.sendMessage(t.id,e,i);return{chat:{id:t.id},message:{id:n.messageId||n.id},isNewChat:!1}}{(0,a.debugLog)("[ChatV2Service] ðŸ†• No hay chats existentes, creando chat nuevo con mensaje");const t={content:e,type:i},s=yield this.createChatWithMessage(n,t);return{chat:{id:s.chatId},message:{id:s.messageId},isNewChat:!0}}}catch(t){throw(0,a.debugError)("[ChatV2Service] âŒ Error en sendMessageSmart:",t),t}}))}getChatMessages(t){return i(this,arguments,void 0,(function*(t,e=50,n){var i;(0,a.debugLog)(`[ChatV2Service] ðŸ“‹ Obteniendo mensajes del chat: ${t}`);const o=new URLSearchParams;o.append("limit",e.toString()),n&&o.append("cursor",n);const r=s.EndpointManager.getInstance(),c=localStorage.getItem("pixelEndpoint")||r.getEndpoint(),d=`${c.endsWith("/api")?c:`${c}/api`}/v2/messages/chat/${t}?${o.toString()}`,l=yield this.fetchWithReauth(d,this.getFetchOptions("GET"));if(!l.ok){const t=yield l.text();throw(0,a.debugError)("[ChatV2Service] âŒ Error al obtener mensajes del chat:",t),new Error(`Error al obtener mensajes del chat (${l.status}): ${t}`)}const h=yield l.json();return h.nextCursor&&!h.cursor&&(h.cursor=h.nextCursor),(0,a.debugLog)("[ChatV2Service] âœ… Mensajes del chat obtenidos:",{count:(null===(i=h.messages)||void 0===i?void 0:i.length)||0,total:h.total,hasMore:h.hasMore,cursor:h.cursor}),h}))}}e.ChatV2Service=r},7690:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.URLPageDetector=void 0;const i=n(6932);e.URLPageDetector=class{constructor(){this.urlPatterns=[{pattern:/^\/?(index\.(php|html?)?)?$/i,pageType:"home",confidence:i.ConfidenceLevel.HIGH,metadata:{pageCategory:"main"}},{pattern:/^\/?(home|inicio)$/i,pageType:"home",confidence:i.ConfidenceLevel.HIGH,metadata:{pageCategory:"main"}},{pattern:/\/?(shop|tienda|ecommerce|store)/i,pageType:"ecommerce",confidence:i.ConfidenceLevel.HIGH,metadata:{pageCategory:"ecommerce"}},{pattern:/\/?(product|producto)[\/-]?(\d+|[^\/]+)?/i,pageType:"product_detail",confidence:i.ConfidenceLevel.EXACT_MATCH,metadata:{pageCategory:"ecommerce"}},{pattern:/\/?(cart|carrito|basket)/i,pageType:"cart",confidence:i.ConfidenceLevel.HIGH,metadata:{pageCategory:"ecommerce"}},{pattern:/\/?(checkout|pago|payment)/i,pageType:"checkout",confidence:i.ConfidenceLevel.EXACT_MATCH,metadata:{pageCategory:"ecommerce"}},{pattern:/\/?(vehicle|vehiculo|car|auto)[\/-]?(search|busqueda|buscar)?/i,pageType:"vehicle_search",confidence:i.ConfidenceLevel.HIGH,metadata:{pageCategory:"automotive"}},{pattern:/\/?(vehiculos-ocasion|coches-ocasion|vehiculos-segunda-mano|coches-usados)/i,pageType:"used_vehicles",confidence:i.ConfidenceLevel.EXACT_MATCH,metadata:{pageCategory:"automotive",vehicleType:"used"}},{pattern:/\/?(vehiculos-nuevos|coches-nuevos)/i,pageType:"new_vehicles",confidence:i.ConfidenceLevel.EXACT_MATCH,metadata:{pageCategory:"automotive",vehicleType:"new"}},{pattern:/\/?(coches-km0|vehiculos-km0|km-0)/i,pageType:"km0_vehicles",confidence:i.ConfidenceLevel.EXACT_MATCH,metadata:{pageCategory:"automotive",vehicleType:"km0"}},{pattern:/\/?(ofertas-vehiculos|ofertas-coches|promociones-coches)/i,pageType:"vehicle_offers",confidence:i.ConfidenceLevel.HIGH,metadata:{pageCategory:"automotive",vehicleType:"offers"}},{pattern:/\/?(vehicle|vehiculo|car|auto)[\/-]?(detail|detalle)[\/-]?(\d+|[^\/]+)?/i,pageType:"vehicle_detail",confidence:i.ConfidenceLevel.EXACT_MATCH,metadata:{pageCategory:"automotive"}},{pattern:/\/?(comparison|comparar|compare)/i,pageType:"vehicle_comparison",confidence:i.ConfidenceLevel.HIGH,metadata:{pageCategory:"automotive"}},{pattern:/\/?(financing|financiacion|finance)/i,pageType:"financing",confidence:i.ConfidenceLevel.HIGH,metadata:{pageCategory:"automotive"}},{pattern:/\/?(contact|contacto|contact-us)/i,pageType:"contact",confidence:i.ConfidenceLevel.HIGH,metadata:{pageCategory:"information"}},{pattern:/\/?(about|nosotros|acerca|about-us)/i,pageType:"about",confidence:i.ConfidenceLevel.HIGH,metadata:{pageCategory:"information"}},{pattern:/\/?(analytics|dashboard|admin)/i,pageType:"analytics_dashboard",confidence:i.ConfidenceLevel.HIGH,metadata:{pageCategory:"analytics"}},{pattern:/\/?(search|buscar|busqueda)/i,pageType:"search_results",confidence:i.ConfidenceLevel.MEDIUM,metadata:{pageCategory:"search"}},{pattern:/.*/,pageType:"other",confidence:i.ConfidenceLevel.FALLBACK,metadata:{pageCategory:"unknown"}}]}detectCurrentPage(){const t=window.location.href,e=window.location.pathname;for(const n of this.urlPatterns)if(this.matchesPattern(e,n.pattern))return{pageType:n.pageType,confidence:n.confidence,url:t,path:e,metadata:Object.assign(Object.assign({},n.metadata),{title:document.title,host:window.location.host,search:window.location.search,hash:window.location.hash,referrer:document.referrer||"",timestamp:Date.now()})};return{pageType:"other",confidence:i.ConfidenceLevel.FALLBACK,url:t,path:e,metadata:{pageCategory:"unknown",title:document.title,host:window.location.host,search:window.location.search,hash:window.location.hash,referrer:document.referrer||"",timestamp:Date.now()}}}matchesPattern(t,e){return e instanceof RegExp?e.test(t):t.toLowerCase().includes(e.toLowerCase())}addURLPattern(t){this.urlPatterns.splice(-1,0,t)}getURLPatterns(){return[...this.urlPatterns]}extractPageMetadata(){var t;const e=this.detectCurrentPage();return Object.assign(Object.assign({},e.metadata),{viewport:{width:window.innerWidth,height:window.innerHeight},userAgent:navigator.userAgent,language:navigator.language,page_url:window.location.href,page_path:window.location.pathname,page_search:window.location.search,page_host:window.location.host,page_protocol:window.location.protocol,page_hash:window.location.hash,page_type:e.pageType,page_confidence:e.confidence,page_category:null===(t=e.metadata)||void 0===t?void 0:t.pageCategory})}}},7696:function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function r(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.RealtimeMessageManager=void 0;const s=n(3974),a=n(3104),o=n(7686);class r{constructor(){this.chatUI=null,this.visitorId="",this.currentChatId=null,this.enableTypingIndicators=!0,this.typingIndicatorDelay=3e3,this.typingTimeouts=new Map,this.aiConfig={enabled:!0,showAIIndicator:!0,aiAvatarEmoji:"ðŸ¤–",aiSenderName:"Asistente IA",showTypingIndicator:!0},this.defaultAISenderIds=["ai-assistant","ai-bot","bot","system-ai","assistant"],this.wsService=a.WebSocketService.getInstance(),this.chatService=o.ChatV2Service.getInstance(),(0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] Instancia creada")}static getInstance(){return r.instance||(r.instance=new r),r.instance}initialize(t){var e;(0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] ðŸš€ Inicializando con:",{visitorId:t.visitorId,hasChatUI:!!t.chatUI,enableTyping:t.enableTypingIndicators,aiEnabled:null===(e=t.aiConfig)||void 0===e?void 0:e.enabled}),this.chatUI=t.chatUI,this.visitorId=t.visitorId,this.enableTypingIndicators=!1!==t.enableTypingIndicators,this.typingIndicatorDelay=t.typingIndicatorDelay||3e3,t.aiConfig&&(this.aiConfig=Object.assign(Object.assign({},this.aiConfig),t.aiConfig),(0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] ðŸ¤– ConfiguraciÃ³n de IA aplicada:",this.aiConfig)),this.wsService.updateCallbacks({onConnect:()=>this.handleConnect(),onDisconnect:t=>this.handleDisconnect(t),onError:t=>this.handleError(t),onMessage:t=>this.handleNewMessage(t),onChatStatus:t=>this.handleChatStatus(t),onTyping:t=>this.handleTyping(t)}),(0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] âœ… Inicializado correctamente")}setCurrentChat(t){this.currentChatId!==t?((0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] ðŸ“Œ Cambiando chat activo:",{anterior:this.currentChatId,nuevo:t}),this.currentChatId&&this.wsService.leaveChatRoom(this.currentChatId),this.currentChatId=t,this.wsService.joinChatRoom(t),this.chatUI&&this.chatUI.setChatId(t)):(0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] Chat ya activo:",t)}sendMessage(t){return i(this,arguments,void 0,(function*(t,e="text"){if(!this.currentChatId)throw new Error("No hay chat activo");(0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] ðŸ“¤ Enviando mensaje via HTTP:",{chatId:this.currentChatId,contentLength:t.length,type:e});try{const n=yield this.chatService.sendMessage(this.currentChatId,t,e);(0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] âœ… Mensaje enviado (HTTP):",n.messageId||n.id)}catch(t){throw t}}))}emitTyping(t){if(this.currentChatId&&this.enableTypingIndicators&&(this.wsService.emitTyping(this.currentChatId,t),t)){const t=this.typingTimeouts.get(this.visitorId);t&&clearTimeout(t);const e=setTimeout((()=>{this.wsService.emitTyping(this.currentChatId,!1),this.typingTimeouts.delete(this.visitorId)}),this.typingIndicatorDelay);this.typingTimeouts.set(this.visitorId,e)}}isAIMessage(t){return!1!==this.aiConfig.enabled&&(!0===t.isAI?((0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] ðŸ¤– Mensaje de IA detectado (flag isAI)"),!0):"ai"===t.type?((0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] ðŸ¤– Mensaje de IA detectado (type=ai)"),!0):[...this.defaultAISenderIds,...this.aiConfig.aiSenderIds||[]].includes(t.senderId)?((0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] ðŸ¤– Mensaje de IA detectado (senderId conocido):",t.senderId),!0):!(!t.aiMetadata||!t.aiMetadata.model&&void 0===t.aiMetadata.confidence||((0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] ðŸ¤– Mensaje de IA detectado (aiMetadata presente)"),0)))}setAIConfig(t){this.aiConfig=Object.assign(Object.assign({},this.aiConfig),t),(0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] ðŸ¤– ConfiguraciÃ³n de IA actualizada:",this.aiConfig)}getAIConfig(){return Object.assign({},this.aiConfig)}handleConnect(){(0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] âœ… WebSocket conectado"),this.currentChatId&&this.wsService.joinChatRoom(this.currentChatId)}handleDisconnect(t){(0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] âš ï¸ WebSocket desconectado:",t),this.chatUI}handleError(t){}handleNewMessage(t){var e;if((0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] ðŸ“¨ Procesando mensaje nuevo:",{messageId:t.messageId,chatId:t.chatId,senderId:t.senderId,senderName:t.senderName,isInternal:t.isInternal}),t.chatId===this.currentChatId)if(t.isInternal)(0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] ðŸ”’ Mensaje interno, no visible para visitante");else if(t.senderId!==this.visitorId){if(this.chatUI)try{const n="other",i=this.isAIMessage(t);this.chatUI.renderChatMessage({text:t.content,sender:n,timestamp:new Date(t.sentAt).getTime(),senderId:t.senderId,isAI:i,aiMetadata:t.aiMetadata}),this.chatUI.scrollToBottom(!0),(0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] âœ… Mensaje renderizado en UI",{isAI:i,aiModel:null===(e=t.aiMetadata)||void 0===e?void 0:e.model})}catch(t){}}else(0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] ðŸš« Mensaje propio ignorado (ya renderizado):",{messageId:t.messageId,visitorId:this.visitorId});else(0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] âš ï¸ Mensaje de otro chat, ignorando")}handleChatStatus(t){if((0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] ðŸ“Š Estado del chat actualizado:",t),t.chatId===this.currentChatId&&this.chatUI)switch(t.status){case"IN_PROGRESS":(0,s.debugLog)("ðŸ’¬ Chat en progreso - primera respuesta del comercial");break;case"RESOLVED":(0,s.debugLog)("ðŸ’¬ Chat resuelto");break;case"CLOSED":(0,s.debugLog)("ðŸ’¬ Chat cerrado"),this.chatUI&&this.chatUI.addSystemMessage("El chat ha sido cerrado.")}}handleTyping(t){this.enableTypingIndicators&&t.userId!==this.visitorId&&(0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] âœï¸ Typing indicator:",{user:t.userName,isTyping:t.isTyping})}cleanup(){(0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] ðŸ§¹ Limpiando recursos..."),this.typingTimeouts.forEach((t=>clearTimeout(t))),this.typingTimeouts.clear(),this.currentChatId&&(this.wsService.leaveChatRoom(this.currentChatId),this.currentChatId=null),(0,s.debugLog)("ðŸ’¬ [RealtimeMessageManager] âœ… Recursos limpiados")}getCurrentChatId(){return this.currentChatId}isConnected(){return this.wsService.isConnected()}}e.RealtimeMessageManager=r,r.instance=null},7743:(t,e)=>{"use strict";function n(t){t=t||{},this.ms=t.min||100,this.max=t.max||1e4,this.factor=t.factor||2,this.jitter=t.jitter>0&&t.jitter<=1?t.jitter:0,this.attempts=0}Object.defineProperty(e,"__esModule",{value:!0}),e.Backoff=n,n.prototype.duration=function(){var t=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),n=Math.floor(e*this.jitter*t);t=1&Math.floor(10*e)?t+n:t-n}return 0|Math.min(t,this.max)},n.prototype.reset=function(){this.attempts=0},n.prototype.setMin=function(t){this.ms=t},n.prototype.setMax=function(t){this.max=t},n.prototype.setJitter=function(t){this.jitter=t}},7775:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var i,s=(i=n(7037))&&i.__esModule?i:{default:i};e.default=function(t){if(!(0,s.default)(t))throw TypeError("Invalid UUID");return parseInt(t.slice(14,15),16)}},7785:function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function r(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.VisitorsV2Service=void 0;const s=n(2597),a=n(3974);class o{constructor(){}static getInstance(){return o.instance||(o.instance=new o),o.instance}getBaseUrl(){const t=localStorage.getItem("pixelEndpoint")||s.EndpointManager.getInstance().getEndpoint();return`${t.endsWith("/api")?t:`${t}/api`}/visitors`}identify(t,e,n){return i(this,void 0,void 0,(function*(){var i,s,o;try{const r=`${this.getBaseUrl()}/identify`,c="undefined"!=typeof window?window.location.hostname:"localhost";let d=!1,l="v1.0";if(n)d=n.hasAcceptedPrivacyPolicy,l=n.consentVersion;else if("undefined"!=typeof localStorage){const t=localStorage.getItem("guiders_consent_state");if(t)try{const e=JSON.parse(t);d="granted"===e.status,l=e.version||"v1.0"}catch(t){(0,a.debugWarn)("[VisitorsV2Service] âš ï¸ No se pudo parsear estado de consentimiento")}}const h={fingerprint:t,domain:c,apiKey:e||localStorage.getItem("guidersApiKey")||"",hasAcceptedPrivacyPolicy:d,consentVersion:l,currentUrl:"undefined"!=typeof window?window.location.href:void 0};(0,a.debugLog)("[VisitorsV2Service] ðŸ” Enviando identify con consentimiento:",{hasAcceptedPrivacyPolicy:d,consentVersion:l,currentUrl:h.currentUrl});const u=yield fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(h),credentials:"include"});if(u.ok){const t=yield u.json(),e={visitorId:t.visitorId||t.id,sessionId:t.sessionId||t.session_id,tenantId:t.tenantId||t.tenant_id,name:null!==(i=t.name)&&void 0!==i?i:null,email:null!==(s=t.email)&&void 0!==s?s:null,tel:null!==(o=t.tel)&&void 0!==o?o:null,lifecycle:t.lifecycle,isNewVisitor:t.isNewVisitor,consentStatus:t.consentStatus||"granted",allowedActions:t.allowedActions||["chat","forms","tracking","all"]};return e.visitorId&&localStorage.setItem("visitorId",e.visitorId),e.sessionId&&sessionStorage.setItem("guiders_backend_session_id",e.sessionId),e.tenantId&&localStorage.setItem("tenantId",e.tenantId),(0,a.debugLog)("[VisitorsV2Service] âœ… identify OK (consentimiento aceptado):",e.visitorId,"session:",e.sessionId,"tenant:",e.tenantId),e}if(400===u.status)try{const t=yield u.json();if("denied"===t.consentStatus&&t.visitorId){const e={visitorId:t.visitorId,sessionId:null,lifecycle:t.lifecycle||"anon",isNewVisitor:t.isNewVisitor,consentStatus:"denied",allowedActions:t.allowedActions||["read_only"]};return e.visitorId&&localStorage.setItem("visitorId",e.visitorId),(0,a.debugWarn)("[VisitorsV2Service] âš ï¸ identify: consentimiento rechazado (modo limitado):",e.visitorId),(0,a.debugLog)("[VisitorsV2Service] ðŸ“‹ Acciones permitidas:",e.allowedActions),e}}catch(t){(0,a.debugError)("[VisitorsV2Service] âŒ Error parseando respuesta 400:",t)}const g=yield u.text();return(0,a.debugWarn)("[VisitorsV2Service] âŒ Error al identificar visitante:",u.status,g),null}catch(t){return(0,a.debugWarn)("[VisitorsV2Service] âŒ ExcepciÃ³n en identify:",t),null}}))}heartbeat(t){return i(this,void 0,void 0,(function*(){try{const e=sessionStorage.getItem("guiders_backend_session_id");if(!e)return(0,a.debugWarn)("[VisitorsV2Service] âŒ No sessionId disponible para heartbeat"),!1;const n=`${this.getBaseUrl()}/session/heartbeat`,i={sessionId:e};t&&(i.activityType=t);const s=yield fetch(n,{method:"POST",headers:{"Content-Type":"application/json","x-guiders-sid":e},body:JSON.stringify(i),credentials:"include"});if(!s.ok){const t=yield s.text();return(0,a.debugWarn)("[VisitorsV2Service] âŒ Heartbeat fallido:",s.status,t),!1}return(0,a.debugLog)("[VisitorsV2Service] âœ… Heartbeat exitoso"+(t?` (${t})`:"")),!0}catch(t){return(0,a.debugWarn)("[VisitorsV2Service] âŒ ExcepciÃ³n heartbeat:",t),!1}}))}endSession(){return i(this,arguments,void 0,(function*(t={}){const e=sessionStorage.getItem("guiders_backend_session_id");if(!e)return(0,a.debugWarn)("[VisitorsV2Service] âŒ No sessionId disponible para endSession"),!1;if("true"===sessionStorage.getItem("guiders_is_refresh")&&t.useBeacon)return(0,a.debugLog)("[VisitorsV2Service] ðŸ”„ Refresh detectado - manteniendo sesiÃ³n activa"),sessionStorage.removeItem("guiders_is_refresh"),!0;const n=`${this.getBaseUrl()}/session/end`,i={sessionId:e,reason:t.reason||(t.useBeacon?"page_unload":"manual")};if(t.useBeacon&&"undefined"!=typeof navigator&&"sendBeacon"in navigator)try{const t=new Blob([JSON.stringify(i)],{type:"application/json"});if(navigator.sendBeacon(n,t))return(0,a.debugLog)("[VisitorsV2Service] âœ… endSession enviado via beacon"),sessionStorage.removeItem("guiders_backend_session_id"),!0;(0,a.debugWarn)("[VisitorsV2Service] âš ï¸ sendBeacon fallÃ³, intentando fetch...")}catch(t){(0,a.debugWarn)("[VisitorsV2Service] âŒ Error con sendBeacon, fallback a fetch:",t)}if(!t.useBeacon)try{const t=yield fetch(n,{method:"POST",headers:{"Content-Type":"application/json","x-guiders-sid":e},body:JSON.stringify(i),credentials:"include",keepalive:!0});if(!t.ok){const e=yield t.text();return(0,a.debugWarn)("[VisitorsV2Service] âŒ endSession fallido:",t.status,e),!1}return(0,a.debugLog)("[VisitorsV2Service] âœ… endSession exitoso via fetch"),sessionStorage.removeItem("guiders_backend_session_id"),!0}catch(t){return(0,a.debugWarn)("[VisitorsV2Service] âŒ ExcepciÃ³n endSession:",t),!1}return(0,a.debugWarn)("[VisitorsV2Service] âŒ No se pudo enviar endSession"),!1}))}}e.VisitorsV2Service=o},7833:(t,e,n)=>{e.formatArgs=function(e){if(e[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+e[0]+(this.useColors?"%c ":" ")+"+"+t.exports.humanize(this.diff),!this.useColors)return;const n="color: "+this.color;e.splice(1,0,n,"color: inherit");let i=0,s=0;e[0].replace(/%[a-zA-Z%]/g,(t=>{"%%"!==t&&(i++,"%c"===t&&(s=i))})),e.splice(s,0,n)},e.save=function(t){try{t?e.storage.setItem("debug",t):e.storage.removeItem("debug")}catch(t){}},e.load=function(){let t;try{t=e.storage.getItem("debug")}catch(t){}return!t&&"undefined"!=typeof process&&"env"in process&&(t="MISSING_ENV_VAR".DEBUG),t},e.useColors=function(){if("undefined"!=typeof window&&window.process&&("renderer"===window.process.type||window.process.__nwjs))return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let t;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&(t=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(t[1],10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},e.storage=function(){try{return localStorage}catch(t){}}(),e.destroy=(()=>{let t=!1;return()=>{t||(t=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})(),e.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],e.log=console.debug||console.log||(()=>{}),t.exports=n(736)(e);const{formatters:i}=t.exports;i.j=function(t){try{return JSON.stringify(t)}catch(t){return"[UnexpectedJSONParseError]: "+t.message}}},8007:function(t,e,n){"use strict";var i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.WebTransport=e.WebSocket=e.NodeWebSocket=e.XHR=e.NodeXHR=e.Fetch=e.Socket=e.Manager=e.protocol=void 0,e.io=d,e.connect=d,e.default=d;const s=n(6894),a=n(3776);Object.defineProperty(e,"Manager",{enumerable:!0,get:function(){return a.Manager}});const o=n(6214);Object.defineProperty(e,"Socket",{enumerable:!0,get:function(){return o.Socket}});const r=(0,i(n(7833)).default)("socket.io-client"),c={};function d(t,e){"object"==typeof t&&(e=t,t=void 0),e=e||{};const n=(0,s.url)(t,e.path||"/socket.io"),i=n.source,o=n.id,d=n.path,l=c[o]&&d in c[o].nsps;let h;return e.forceNew||e["force new connection"]||!1===e.multiplex||l?(r("ignoring socket cache for %s",i),h=new a.Manager(i,e)):(c[o]||(r("new io instance for %s",i),c[o]=new a.Manager(i,e)),h=c[o]),n.query&&!e.query&&(e.query=n.queryKey),h.socket(n.path,e)}Object.assign(d,{Manager:a.Manager,Socket:o.Socket,io:d,connect:d});var l=n(4627);Object.defineProperty(e,"protocol",{enumerable:!0,get:function(){return l.protocol}});var h=n(4956);Object.defineProperty(e,"Fetch",{enumerable:!0,get:function(){return h.Fetch}}),Object.defineProperty(e,"NodeXHR",{enumerable:!0,get:function(){return h.NodeXHR}}),Object.defineProperty(e,"XHR",{enumerable:!0,get:function(){return h.XHR}}),Object.defineProperty(e,"NodeWebSocket",{enumerable:!0,get:function(){return h.NodeWebSocket}}),Object.defineProperty(e,"WebSocket",{enumerable:!0,get:function(){return h.WebSocket}}),Object.defineProperty(e,"WebTransport",{enumerable:!0,get:function(){return h.WebTransport}}),t.exports=d},8156:function(t,e,n){"use strict";var i=this&&this.__createBinding||(Object.create?function(t,e,n,i){void 0===i&&(i=n);var s=Object.getOwnPropertyDescriptor(e,n);s&&!("get"in s?!e.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return e[n]}}),Object.defineProperty(t,i,s)}:function(t,e,n,i){void 0===i&&(i=n),t[i]=e[n]}),s=this&&this.__exportStar||function(t,e){for(var n in t)"default"===n||Object.prototype.hasOwnProperty.call(e,n)||i(e,t,n)};Object.defineProperty(e,"__esModule",{value:!0}),e.disableDebug=e.enableDebug=e.debugError=e.debugWarn=e.debugInit=e.debugLog=void 0;const a=n(2597),o=n(401),r=n(1688),c=n(3974);n(2326),s(n(2597),e),s(n(1921),e),s(n(401),e),s(n(6808),e),s(n(2895),e),s(n(1034),e),s(n(7690),e),s(n(6420),e),s(n(1750),e),s(n(421),e),s(n(9167),e),s(n(7686),e),s(n(4968),e),s(n(2090),e),s(n(3574),e);var d=n(3974);Object.defineProperty(e,"debugLog",{enumerable:!0,get:function(){return d.debugLog}}),Object.defineProperty(e,"debugInit",{enumerable:!0,get:function(){return d.debugInit}}),Object.defineProperty(e,"debugWarn",{enumerable:!0,get:function(){return d.debugWarn}}),Object.defineProperty(e,"debugError",{enumerable:!0,get:function(){return d.debugError}}),Object.defineProperty(e,"enableDebug",{enumerable:!0,get:function(){return d.enableDebug}}),Object.defineProperty(e,"disableDebug",{enumerable:!0,get:function(){return d.disableDebug}});const l=r.resolveDefaultEndpoints;function h(){if(window.guiders||window.__GUIDERS_INITIALIZING__)(0,c.debugWarn)("[Guiders SDK] âŒ InicializaciÃ³n ignorada: instancia existente o en progreso");else{window.__GUIDERS_INITIALIZING__=!0;try{const{apiKey:t}=function(){const t=function(){const t=Array.from(document.getElementsByTagName("script"));for(const e of t)if(e.getAttribute("data-guiders-sdk"))return e;if(document.currentScript&&document.currentScript instanceof HTMLScriptElement){const t=document.currentScript;if(t.getAttribute("data-api-key")||t.getAttribute("data-apikey")||t.src&&(t.src.includes("apiKey=")||t.src.includes("apikey=")||t.src.includes("guiders")))return t}for(const e of t)if(e.getAttribute("data-api-key")||e.getAttribute("data-apikey"))return e;for(const e of t)if(e.src&&(e.src.includes("apiKey=")||e.src.includes("apikey=")))return e;for(const e of t)if(e.src&&e.src.includes("guiders"))return e;for(const e of t)if(e.src&&(e.src.includes("tracking")||e.src.includes("index.js"))&&(e.src.includes("apiKey=")||e.src.includes("apikey=")))return e;const e=t.filter((t=>t.src&&(t.src.includes(".js")||t.src.includes("index"))));for(let t=e.length-1;t>=0;t--){const n=e[t];if(n.src.includes("guiders")||n.src.includes("tracking")||n.src.includes("apiKey=")||n.src.includes("apikey="))return n}return null}();if(!t)throw new Error("No se encontrÃ³ el script del SDK Guiders. AsegÃºrate de incluir el atributo data-api-key.");let e=t.getAttribute("data-api-key")||t.getAttribute("data-apikey");if(!e&&t.src){const n=t.src.split("?")[1];if(n){const t=new URLSearchParams(n);e=t.get("apiKey")||t.get("apikey")}}if(!e&&"undefined"!=typeof window&&window.GUIDERS_CONFIG&&(e=window.GUIDERS_CONFIG.apiKey),!e)throw new Error("No se encontrÃ³ la clave API. Usa data-api-key=\"tu-clave\" en el script o configura window.GUIDERS_CONFIG = {apiKey: 'tu-clave'}.");return{apiKey:e}}();window.GUIDERS_API_KEY=t,window.TrackingPixelSDK=a.TrackingPixelSDK;const{endpoint:e,webSocketEndpoint:i,isProd:s}=l();(0,c.debugLog)("[Guiders SDK] ðŸŒ Endpoints resueltos:",{endpoint:e,webSocketEndpoint:i,isProd:s});const r={apiKey:t,autoFlush:!0,flushInterval:1e3,maxRetries:2,heuristicDetection:{enabled:!0,config:{enabled:!0,confidenceThreshold:.7,fallbackToManual:!0}},sessionTracking:{enabled:!0,config:{enabled:!0,heartbeatInterval:3e4,trackBackgroundTime:!1}},endpoint:e,webSocketEndpoint:i};window.GUIDERS_CONFIG&&Object.keys(window.GUIDERS_CONFIG).forEach((t=>{r[t]=window.GUIDERS_CONFIG[t]})),(new o.BotDetector).detect().then((t=>{if(t.isBot)return(0,c.debugLog)("Bot detectado. Probabilidad:",t.probability),(0,c.debugLog)("Detalles:",t.details),void(window.__GUIDERS_INITIALIZING__=!1);window.guiders=new window.TrackingPixelSDK(r),s||"undefined"==typeof window||Promise.resolve().then((()=>n(2326))).then((({DevRandomMessages:t})=>{const e=t.getInstance();window.guidersDevRandomMessages={trigger:(t,n)=>e.triggerRandomMessages(t,n),setConfig:t=>e.setConfig(t),getConfig:()=>e.getConfig(),isEnabled:()=>e.isEnabled(),isGenerating:()=>e.isGenerating()},(0,c.debugLog)("ðŸŽ² [DevRandomMessages] ðŸŒ Interfaz global configurada en window.guidersDevRandomMessages")})),(0,c.debugLog)("[Guiders SDK] âœ… SDK instanciado - esperando consentimiento del usuario"),window.__GUIDERS_INITIALIZING__=!1}))}catch(t){(0,c.debugError)("Error inicializando Guiders SDK:",t),window.__GUIDERS_INITIALIZING__=!1}}}"undefined"!=typeof window&&(window.GUIDERS_CONFIG&&window.GUIDERS_CONFIG.preventAutoInit?(0,c.debugLog)("[Guiders SDK] â¸ï¸ Auto-init desactivado por configuraciÃ³n (preventAutoInit)"):setTimeout((()=>{if(!window.guiders){const t=()=>{document.addEventListener("rocket-script-loaded",(t=>{const e=t.target;!window.guiders&&e&&e.src&&(e.src.includes("guiders")||e.src.includes("apiKey="))&&setTimeout(h,10)})),document.addEventListener("rocket-loaded",(()=>{window.guiders||setTimeout(h,10)}))};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t(),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",h):h(),(void 0!==window.RocketLazyLoadScripts||document.querySelector('script[type="rocketlazyloadscript"]'))&&(setTimeout((()=>{window.guiders||h()}),100),setTimeout((()=>{window.guiders||h()}),500))}}),500))},8209:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.Fetch=void 0;const i=n(528);class s extends i.Polling{doPoll(){this._fetch().then((t=>{if(!t.ok)return this.onError("fetch read error",t.status,t);t.text().then((t=>this.onData(t)))})).catch((t=>{this.onError("fetch read error",t)}))}doWrite(t,e){this._fetch(t).then((t=>{if(!t.ok)return this.onError("fetch write error",t.status,t);e()})).catch((t=>{this.onError("fetch write error",t)}))}_fetch(t){var e;const n=void 0!==t,i=new Headers(this.opts.extraHeaders);return n&&i.set("content-type","text/plain;charset=UTF-8"),null===(e=this.socket._cookieJar)||void 0===e||e.appendCookies(i),fetch(this.uri(),{method:n?"POST":"GET",body:n?t:null,headers:i,credentials:this.opts.withCredentials?"include":"omit"}).then((t=>{var e;return null===(e=this.socket._cookieJar)||void 0===e||e.parseCookies(t.headers.getSetCookie()),t}))}}e.Fetch=s},8223:function(t,e,n){"use strict";var i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.Socket=e.SocketWithUpgrade=e.SocketWithoutUpgrade=void 0;const s=n(9419),a=n(5374),o=n(8661),r=n(1015),c=n(4454),d=n(6376),l=n(4624),h=(0,i(n(7833)).default)("engine.io-client:socket"),u="function"==typeof addEventListener&&"function"==typeof removeEventListener,g=[];u&&addEventListener("offline",(()=>{h("closing %d connection(s) because the network was lost",g.length),g.forEach((t=>t()))}),!1);class p extends c.Emitter{constructor(t,e){if(super(),this.binaryType=l.defaultBinaryType,this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,t&&"object"==typeof t&&(e=t,t=null),t){const n=(0,r.parse)(t);e.hostname=n.host,e.secure="https"===n.protocol||"wss"===n.protocol,e.port=n.port,n.query&&(e.query=n.query)}else e.host&&(e.hostname=(0,r.parse)(e.host).host);(0,a.installTimerFunctions)(this,e),this.secure=null!=e.secure?e.secure:"undefined"!=typeof location&&"https:"===location.protocol,e.hostname&&!e.port&&(e.port=this.secure?"443":"80"),this.hostname=e.hostname||("undefined"!=typeof location?location.hostname:"localhost"),this.port=e.port||("undefined"!=typeof location&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},e.transports.forEach((t=>{const e=t.prototype.name;this.transports.push(e),this._transportsByName[e]=t})),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},e),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),"string"==typeof this.opts.query&&(this.opts.query=(0,o.decode)(this.opts.query)),u&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),"localhost"!==this.hostname&&(h("adding listener for the 'offline' event"),this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},g.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=(0,l.createCookieJar)()),this._open()}createTransport(t){h('creating transport "%s"',t);const e=Object.assign({},this.opts.query);e.EIO=d.protocol,e.transport=t,this.id&&(e.sid=this.id);const n=Object.assign({},this.opts,{query:e,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[t]);return h("options: %j",n),new this._transportsByName[t](n)}_open(){if(0===this.transports.length)return void this.setTimeoutFn((()=>{this.emitReserved("error","No transports available")}),0);const t=this.opts.rememberUpgrade&&p.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket")?"websocket":this.transports[0];this.readyState="opening";const e=this.createTransport(t);e.open(),this.setTransport(e)}setTransport(t){h("setting transport %s",t.name),this.transport&&(h("clearing existing transport %s",this.transport.name),this.transport.removeAllListeners()),this.transport=t,t.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",(t=>this._onClose("transport close",t)))}onOpen(){h("socket open"),this.readyState="open",p.priorWebsocketSuccess="websocket"===this.transport.name,this.emitReserved("open"),this.flush()}_onPacket(t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(h('socket receive: type "%s", data "%s"',t.type,t.data),this.emitReserved("packet",t),this.emitReserved("heartbeat"),t.type){case"open":this.onHandshake(JSON.parse(t.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const e=new Error("server error");e.code=t.data,this._onError(e);break;case"message":this.emitReserved("data",t.data),this.emitReserved("message",t.data)}else h('packet received with socket readyState "%s"',this.readyState)}onHandshake(t){this.emitReserved("handshake",t),this.id=t.sid,this.transport.query.sid=t.sid,this._pingInterval=t.pingInterval,this._pingTimeout=t.pingTimeout,this._maxPayload=t.maxPayload,this.onOpen(),"closed"!==this.readyState&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const t=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+t,this._pingTimeoutTimer=this.setTimeoutFn((()=>{this._onClose("ping timeout")}),t),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,0===this.writeBuffer.length?this.emitReserved("drain"):this.flush()}flush(){if("closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const t=this._getWritablePackets();h("flushing %d packets in socket",t.length),this.transport.send(t),this._prevBufferLen=t.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&"polling"===this.transport.name&&this.writeBuffer.length>1))return this.writeBuffer;let t=1;for(let e=0;e<this.writeBuffer.length;e++){const n=this.writeBuffer[e].data;if(n&&(t+=(0,a.byteLength)(n)),e>0&&t>this._maxPayload)return h("only send %d out of %d packets",e,this.writeBuffer.length),this.writeBuffer.slice(0,e);t+=2}return h("payload size is %d (max: %d)",t,this._maxPayload),this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const t=Date.now()>this._pingTimeoutTime;return t&&(h("throttled timer detected, scheduling connection close"),this._pingTimeoutTime=0,(0,l.nextTick)((()=>{this._onClose("ping timeout")}),this.setTimeoutFn)),t}write(t,e,n){return this._sendPacket("message",t,e,n),this}send(t,e,n){return this._sendPacket("message",t,e,n),this}_sendPacket(t,e,n,i){if("function"==typeof e&&(i=e,e=void 0),"function"==typeof n&&(i=n,n=null),"closing"===this.readyState||"closed"===this.readyState)return;(n=n||{}).compress=!1!==n.compress;const s={type:t,data:e,options:n};this.emitReserved("packetCreate",s),this.writeBuffer.push(s),i&&this.once("flush",i),this.flush()}close(){const t=()=>{this._onClose("forced close"),h("socket closing - telling transport to close"),this.transport.close()},e=()=>{this.off("upgrade",e),this.off("upgradeError",e),t()},n=()=>{this.once("upgrade",e),this.once("upgradeError",e)};return"opening"!==this.readyState&&"open"!==this.readyState||(this.readyState="closing",this.writeBuffer.length?this.once("drain",(()=>{this.upgrading?n():t()})):this.upgrading?n():t()),this}_onError(t){if(h("socket error %j",t),p.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&"opening"===this.readyState)return h("trying next transport"),this.transports.shift(),this._open();this.emitReserved("error",t),this._onClose("transport error",t)}_onClose(t,e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){if(h('socket close with reason: "%s"',t),this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),u&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const t=g.indexOf(this._offlineEventListener);-1!==t&&(h("removing listener for the 'offline' event"),g.splice(t,1))}this.readyState="closed",this.id=null,this.emitReserved("close",t,e),this.writeBuffer=[],this._prevBufferLen=0}}}e.SocketWithoutUpgrade=p,p.protocol=d.protocol;class f extends p{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),"open"===this.readyState&&this.opts.upgrade){h("starting upgrade probes");for(let t=0;t<this._upgrades.length;t++)this._probe(this._upgrades[t])}}_probe(t){h('probing transport "%s"',t);let e=this.createTransport(t),n=!1;p.priorWebsocketSuccess=!1;const i=()=>{n||(h('probe transport "%s" opened',t),e.send([{type:"ping",data:"probe"}]),e.once("packet",(i=>{if(!n)if("pong"===i.type&&"probe"===i.data){if(h('probe transport "%s" pong',t),this.upgrading=!0,this.emitReserved("upgrading",e),!e)return;p.priorWebsocketSuccess="websocket"===e.name,h('pausing current transport "%s"',this.transport.name),this.transport.pause((()=>{n||"closed"!==this.readyState&&(h("changing transport and sending upgrade packet"),d(),this.setTransport(e),e.send([{type:"upgrade"}]),this.emitReserved("upgrade",e),e=null,this.upgrading=!1,this.flush())}))}else{h('probe transport "%s" failed',t);const n=new Error("probe error");n.transport=e.name,this.emitReserved("upgradeError",n)}})))};function s(){n||(n=!0,d(),e.close(),e=null)}const a=n=>{const i=new Error("probe error: "+n);i.transport=e.name,s(),h('probe transport "%s" failed because of error: %s',t,n),this.emitReserved("upgradeError",i)};function o(){a("transport closed")}function r(){a("socket closed")}function c(t){e&&t.name!==e.name&&(h('"%s" works - aborting "%s"',t.name,e.name),s())}const d=()=>{e.removeListener("open",i),e.removeListener("error",a),e.removeListener("close",o),this.off("close",r),this.off("upgrading",c)};e.once("open",i),e.once("error",a),e.once("close",o),this.once("close",r),this.once("upgrading",c),-1!==this._upgrades.indexOf("webtransport")&&"webtransport"!==t?this.setTimeoutFn((()=>{n||e.open()}),200):e.open()}onHandshake(t){this._upgrades=this._filterUpgrades(t.upgrades),super.onHandshake(t)}_filterUpgrades(t){const e=[];for(let n=0;n<t.length;n++)~this.transports.indexOf(t[n])&&e.push(t[n]);return e}}e.SocketWithUpgrade=f,e.Socket=class extends f{constructor(t,e={}){const n="object"==typeof t?t:e;(!n.transports||n.transports&&"string"==typeof n.transports[0])&&(n.transports=(n.transports||["polling","websocket","webtransport"]).map((t=>s.transports[t])).filter((t=>!!t))),super(t,n)}}},8334:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.ChatSessionStore=void 0;class n{constructor(){this.openChats=new Set,this.currentChatId=null,this.LS_KEY="guiders_open_chats",this.hydrate()}static getInstance(){return n.instance||(n.instance=new n),n.instance}hydrate(){try{const t=localStorage.getItem(this.LS_KEY);if(!t)return;const e=JSON.parse(t);Array.isArray(e.open)&&e.open.forEach((t=>t&&this.openChats.add(t))),e.current&&(this.currentChatId=e.current)}catch(t){}}persist(){try{const t={current:this.currentChatId,open:Array.from(this.openChats),lastUpdated:Date.now()};localStorage.setItem(this.LS_KEY,JSON.stringify(t))}catch(t){}}setCurrent(t){t&&(this.currentChatId=t,this.openChats.add(t),this.persist())}add(t){t&&(this.openChats.add(t),this.persist())}remove(t){t&&(this.openChats.delete(t),this.currentChatId===t&&(this.currentChatId=null),this.persist())}getCurrent(){return this.currentChatId}getAll(){return Array.from(this.openChats)}}e.ChatSessionStore=n},8661:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.encode=function(t){let e="";for(let n in t)t.hasOwnProperty(n)&&(e.length&&(e+="&"),e+=encodeURIComponent(n)+"="+encodeURIComponent(t[n]));return e},e.decode=function(t){let e={},n=t.split("&");for(let t=0,i=n.length;t<i;t++){let i=n[t].split("=");e[decodeURIComponent(i[0])]=decodeURIComponent(i[1])}return e}},8716:function(t,e,n){"use strict";var i=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0}),e.WS=e.BaseWS=void 0;const s=n(4689),a=n(5374),o=n(6376),r=n(4624),c=(0,i(n(7833)).default)("engine.io-client:websocket"),d="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase();class l extends s.Transport{get name(){return"websocket"}doOpen(){const t=this.uri(),e=this.opts.protocols,n=d?{}:(0,a.pick)(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(n.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(t,e,n)}catch(t){return this.emitReserved("error",t)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=t=>this.onClose({description:"websocket connection closed",context:t}),this.ws.onmessage=t=>this.onData(t.data),this.ws.onerror=t=>this.onError("websocket error",t)}write(t){this.writable=!1;for(let e=0;e<t.length;e++){const n=t[e],i=e===t.length-1;(0,o.encodePacket)(n,this.supportsBinary,(t=>{try{this.doWrite(n,t)}catch(t){c("websocket closed before onclose event")}i&&(0,r.nextTick)((()=>{this.writable=!0,this.emitReserved("drain")}),this.setTimeoutFn)}))}}doClose(){void 0!==this.ws&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const t=this.opts.secure?"wss":"ws",e=this.query||{};return this.opts.timestampRequests&&(e[this.opts.timestampParam]=(0,a.randomString)()),this.supportsBinary||(e.b64=1),this.createUri(t,e)}}e.BaseWS=l;const h=r.globalThisShim.WebSocket||r.globalThisShim.MozWebSocket;e.WS=class extends l{createSocket(t,e,n){return d?new h(t,e,n):e?new h(t,e):new h(t)}doWrite(t,e){this.ws.send(e)}}},9025:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.URL=e.DNS=void 0,e.default=function(t,e,n){function i(t,i,o,r){var c;if("string"==typeof t&&(t=function(t){t=unescape(encodeURIComponent(t));for(var e=[],n=0;n<t.length;++n)e.push(t.charCodeAt(n));return e}(t)),"string"==typeof i&&(i=(0,a.default)(i)),16!==(null===(c=i)||void 0===c?void 0:c.length))throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var d=new Uint8Array(16+t.length);if(d.set(i),d.set(t,i.length),(d=n(d))[6]=15&d[6]|e,d[8]=63&d[8]|128,o){r=r||0;for(var l=0;l<16;++l)o[r+l]=d[l];return o}return(0,s.unsafeStringify)(d)}try{i.name=t}catch(t){}return i.DNS=o,i.URL=r,i};var i,s=n(9910),a=(i=n(6792))&&i.__esModule?i:{default:i},o=e.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",r=e.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8"},9042:(t,e)=>{"use strict";function n(t,e,n,i){switch(t){case 0:return e&n^~e&i;case 1:case 3:return e^n^i;case 2:return e&n^e&i^n&i}}function i(t,e){return t<<e|t>>>32-e}Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0,e.default=function(t){var e=[1518500249,1859775393,2400959708,3395469782],s=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof t){var a=unescape(encodeURIComponent(t));t=[];for(var o=0;o<a.length;++o)t.push(a.charCodeAt(o))}else Array.isArray(t)||(t=Array.prototype.slice.call(t));t.push(128);for(var r=t.length/4+2,c=Math.ceil(r/16),d=new Array(c),l=0;l<c;++l){for(var h=new Uint32Array(16),u=0;u<16;++u)h[u]=t[64*l+4*u]<<24|t[64*l+4*u+1]<<16|t[64*l+4*u+2]<<8|t[64*l+4*u+3];d[l]=h}d[c-1][14]=8*(t.length-1)/Math.pow(2,32),d[c-1][14]=Math.floor(d[c-1][14]),d[c-1][15]=8*(t.length-1)&4294967295;for(var g=0;g<c;++g){for(var p=new Uint32Array(80),f=0;f<16;++f)p[f]=d[g][f];for(var m=16;m<80;++m)p[m]=i(p[m-3]^p[m-8]^p[m-14]^p[m-16],1);for(var b=s[0],v=s[1],y=s[2],C=s[3],S=s[4],w=0;w<80;++w){var k=Math.floor(w/20),I=i(b,5)+n(k,v,y,C)+S+e[k]+p[w]>>>0;S=C,C=y,y=i(v,30)>>>0,v=b,b=I}s[0]=s[0]+b>>>0,s[1]=s[1]+v>>>0,s[2]=s[2]+y>>>0,s[3]=s[3]+C>>>0,s[4]=s[4]+S>>>0}return[s[0]>>24&255,s[0]>>16&255,s[0]>>8&255,255&s[0],s[1]>>24&255,s[1]>>16&255,s[1]>>8&255,255&s[1],s[2]>>24&255,s[2]>>16&255,s[2]>>8&255,255&s[2],s[3]>>24&255,s[3]>>16&255,s[3]>>8&255,255&s[3],s[4]>>24&255,s[4]>>16&255,s[4]>>8&255,255&s[4]]}},9126:function(t,e,n){t.exports=function(t){var e={};function n(i){if(e[i])return e[i].exports;var s=e[i]={i,l:!1,exports:{}};return t[i].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)n.d(i,s,function(e){return t[e]}.bind(null,s));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){"use strict";var i,s,a=n(1)(),o=n(3),r=n(4),c=n(6),d=function(){var t=new r;return i=t.getResult(),s=new c,this};d.prototype={getSoftwareVersion:function(){return"0.1.11"},getBrowserData:function(){return i},getFingerprint:function(){var t="|",e=i.ua,n=this.getScreenPrint(),s=this.getPlugins(),a=this.getFonts(),r=this.isLocalStorage(),c=this.isSessionStorage(),d=this.getTimeZone(),l=this.getLanguage(),h=this.getSystemLanguage(),u=this.isCookie(),g=this.getCanvasPrint();return o(e+t+n+t+s+t+a+t+r+t+c+t+d+t+l+t+h+t+u+t+g,256)},getCustomFingerprint:function(){for(var t="",e=0;e<arguments.length;e++)t+=arguments[e]+"|";return o(t,256)},getUserAgent:function(){return i.ua},getUserAgentLowerCase:function(){return i.ua.toLowerCase()},getBrowser:function(){return i.browser.name},getBrowserVersion:function(){return i.browser.version},getBrowserMajorVersion:function(){return i.browser.major},isIE:function(){return/IE/i.test(i.browser.name)},isChrome:function(){return/Chrome/i.test(i.browser.name)},isFirefox:function(){return/Firefox/i.test(i.browser.name)},isSafari:function(){return/Safari/i.test(i.browser.name)},isMobileSafari:function(){return/Mobile\sSafari/i.test(i.browser.name)},isOpera:function(){return/Opera/i.test(i.browser.name)},getEngine:function(){return i.engine.name},getEngineVersion:function(){return i.engine.version},getOS:function(){return i.os.name},getOSVersion:function(){return i.os.version},isWindows:function(){return/Windows/i.test(i.os.name)},isMac:function(){return/Mac/i.test(i.os.name)},isLinux:function(){return/Linux/i.test(i.os.name)},isUbuntu:function(){return/Ubuntu/i.test(i.os.name)},isSolaris:function(){return/Solaris/i.test(i.os.name)},getDevice:function(){return i.device.model},getDeviceType:function(){return i.device.type},getDeviceVendor:function(){return i.device.vendor},getCPU:function(){return i.cpu.architecture},isMobile:function(){var t=i.ua||navigator.vendor||window.opera;return/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4))},isMobileMajor:function(){return this.isMobileAndroid()||this.isMobileBlackBerry()||this.isMobileIOS()||this.isMobileOpera()||this.isMobileWindows()},isMobileAndroid:function(){return!!i.ua.match(/Android/i)},isMobileOpera:function(){return!!i.ua.match(/Opera Mini/i)},isMobileWindows:function(){return!!i.ua.match(/IEMobile/i)},isMobileBlackBerry:function(){return!!i.ua.match(/BlackBerry/i)},isMobileIOS:function(){return!!i.ua.match(/iPhone|iPad|iPod/i)},isIphone:function(){return!!i.ua.match(/iPhone/i)},isIpad:function(){return!!i.ua.match(/iPad/i)},isIpod:function(){return!!i.ua.match(/iPod/i)},getScreenPrint:function(){return"Current Resolution: "+this.getCurrentResolution()+", Available Resolution: "+this.getAvailableResolution()+", Color Depth: "+this.getColorDepth()+", Device XDPI: "+this.getDeviceXDPI()+", Device YDPI: "+this.getDeviceYDPI()},getColorDepth:function(){return screen.colorDepth},getCurrentResolution:function(){return screen.width+"x"+screen.height},getAvailableResolution:function(){return screen.availWidth+"x"+screen.availHeight},getDeviceXDPI:function(){return screen.deviceXDPI},getDeviceYDPI:function(){return screen.deviceYDPI},getPlugins:function(){for(var t="",e=0;e<navigator.plugins.length;e++)e==navigator.plugins.length-1?t+=navigator.plugins[e].name:t+=navigator.plugins[e].name+", ";return t},isJava:function(){return navigator.javaEnabled()},getJavaVersion:function(){throw new Error("Please use client.java.js or client.js if you need this functionality!")},isFlash:function(){return!!navigator.plugins["Shockwave Flash"]},getFlashVersion:function(){throw new Error("Please use client.flash.js or client.js if you need this functionality!")},isSilverlight:function(){return!!navigator.plugins["Silverlight Plug-In"]},getSilverlightVersion:function(){return this.isSilverlight()?navigator.plugins["Silverlight Plug-In"].description:""},isMimeTypes:function(){return!(!navigator.mimeTypes||!navigator.mimeTypes.length)},getMimeTypes:function(){var t="";if(navigator.mimeTypes)for(var e=0;e<navigator.mimeTypes.length;e++)e==navigator.mimeTypes.length-1?t+=navigator.mimeTypes[e].description:t+=navigator.mimeTypes[e].description+", ";return t},isFont:function(t){return s.detect(t)},getFonts:function(){for(var t=["Abadi MT Condensed Light","Adobe Fangsong Std","Adobe Hebrew","Adobe Ming Std","Agency FB","Aharoni","Andalus","Angsana New","AngsanaUPC","Aparajita","Arab","Arabic Transparent","Arabic Typesetting","Arial Baltic","Arial Black","Arial CE","Arial CYR","Arial Greek","Arial TUR","Arial","Batang","BatangChe","Bauhaus 93","Bell MT","Bitstream Vera Serif","Bodoni MT","Bookman Old Style","Braggadocio","Broadway","Browallia New","BrowalliaUPC","Calibri Light","Calibri","Californian FB","Cambria Math","Cambria","Candara","Castellar","Casual","Centaur","Century Gothic","Chalkduster","Colonna MT","Comic Sans MS","Consolas","Constantia","Copperplate Gothic Light","Corbel","Cordia New","CordiaUPC","Courier New Baltic","Courier New CE","Courier New CYR","Courier New Greek","Courier New TUR","Courier New","DFKai-SB","DaunPenh","David","DejaVu LGC Sans Mono","Desdemona","DilleniaUPC","DokChampa","Dotum","DotumChe","Ebrima","Engravers MT","Eras Bold ITC","Estrangelo Edessa","EucrosiaUPC","Euphemia","Eurostile","FangSong","Forte","FrankRuehl","Franklin Gothic Heavy","Franklin Gothic Medium","FreesiaUPC","French Script MT","Gabriola","Gautami","Georgia","Gigi","Gisha","Goudy Old Style","Gulim","GulimChe","GungSeo","Gungsuh","GungsuhChe","Haettenschweiler","Harrington","Hei S","HeiT","Heisei Kaku Gothic","Hiragino Sans GB","Impact","Informal Roman","IrisUPC","Iskoola Pota","JasmineUPC","KacstOne","KaiTi","Kalinga","Kartika","Khmer UI","Kino MT","KodchiangUPC","Kokila","Kozuka Gothic Pr6N","Lao UI","Latha","Leelawadee","Levenim MT","LilyUPC","Lohit Gujarati","Loma","Lucida Bright","Lucida Console","Lucida Fax","Lucida Sans Unicode","MS Gothic","MS Mincho","MS PGothic","MS PMincho","MS Reference Sans Serif","MS UI Gothic","MV Boli","Magneto","Malgun Gothic","Mangal","Marlett","Matura MT Script Capitals","Meiryo UI","Meiryo","Menlo","Microsoft Himalaya","Microsoft JhengHei","Microsoft New Tai Lue","Microsoft PhagsPa","Microsoft Sans Serif","Microsoft Tai Le","Microsoft Uighur","Microsoft YaHei","Microsoft Yi Baiti","MingLiU","MingLiU-ExtB","MingLiU_HKSCS","MingLiU_HKSCS-ExtB","Miriam Fixed","Miriam","Mongolian Baiti","MoolBoran","NSimSun","Narkisim","News Gothic MT","Niagara Solid","Nyala","PMingLiU","PMingLiU-ExtB","Palace Script MT","Palatino Linotype","Papyrus","Perpetua","Plantagenet Cherokee","Playbill","Prelude Bold","Prelude Condensed Bold","Prelude Condensed Medium","Prelude Medium","PreludeCompressedWGL Black","PreludeCompressedWGL Bold","PreludeCompressedWGL Light","PreludeCompressedWGL Medium","PreludeCondensedWGL Black","PreludeCondensedWGL Bold","PreludeCondensedWGL Light","PreludeCondensedWGL Medium","PreludeWGL Black","PreludeWGL Bold","PreludeWGL Light","PreludeWGL Medium","Raavi","Rachana","Rockwell","Rod","Sakkal Majalla","Sawasdee","Script MT Bold","Segoe Print","Segoe Script","Segoe UI Light","Segoe UI Semibold","Segoe UI Symbol","Segoe UI","Shonar Bangla","Showcard Gothic","Shruti","SimHei","SimSun","SimSun-ExtB","Simplified Arabic Fixed","Simplified Arabic","Snap ITC","Sylfaen","Symbol","Tahoma","Times New Roman Baltic","Times New Roman CE","Times New Roman CYR","Times New Roman Greek","Times New Roman TUR","Times New Roman","TlwgMono","Traditional Arabic","Trebuchet MS","Tunga","Tw Cen MT Condensed Extra Bold","Ubuntu","Umpush","Univers","Utopia","Utsaah","Vani","Verdana","Vijaya","Vladimir Script","Vrinda","Webdings","Wide Latin","Wingdings"],e="",n=0;n<t.length;n++)s.detect(t[n])&&(e+=n==t.length-1?t[n]:t[n]+", ");return e},isLocalStorage:function(){try{return!!a.localStorage}catch(t){return!0}},isSessionStorage:function(){try{return!!a.sessionStorage}catch(t){return!0}},isCookie:function(){return navigator.cookieEnabled},getTimeZone:function(){var t,e;return t=new Date,(e=String(-t.getTimezoneOffset()/60))<0?"-"+("0"+(e*=-1)).slice(-2):"+"+("0"+e).slice(-2)},getLanguage:function(){return navigator.language},getSystemLanguage:function(){return navigator.systemLanguage||window.navigator.language},isCanvas:function(){var t=document.createElement("canvas");try{return!(!t.getContext||!t.getContext("2d"))}catch(t){return!1}},getCanvasPrint:function(){var t,e=document.createElement("canvas");try{t=e.getContext("2d")}catch(t){return""}var n="ClientJS,org <canvas> 1.0";return t.textBaseline="top",t.font="14px 'Arial'",t.textBaseline="alphabetic",t.fillStyle="#f60",t.fillRect(125,1,62,20),t.fillStyle="#069",t.fillText(n,2,15),t.fillStyle="rgba(102, 204, 0, 0.7)",t.fillText(n,4,17),e.toDataURL()}},e.ClientJS=d},function(t,e,i){"use strict";var s=i(2);t.exports=function(){return"object"==typeof n.g&&n.g&&n.g.Math===Math&&n.g.Array===Array?n.g:s}},function(t,e,n){"use strict";"undefined"!=typeof self?t.exports=self:"undefined"!=typeof window?t.exports=window:t.exports=Function("return this")()},function(t,e,n){t.exports=function(t,e){var n,i,s,a,o,r,c,d;for(n=3&t.length,i=t.length-n,s=e,o=3432918353,r=461845907,d=0;d<i;)c=255&t.charCodeAt(d)|(255&t.charCodeAt(++d))<<8|(255&t.charCodeAt(++d))<<16|(255&t.charCodeAt(++d))<<24,++d,s=27492+(65535&(a=5*(65535&(s=(s^=c=(65535&(c=(c=(65535&c)*o+(((c>>>16)*o&65535)<<16)&4294967295)<<15|c>>>17))*r+(((c>>>16)*r&65535)<<16)&4294967295)<<13|s>>>19))+((5*(s>>>16)&65535)<<16)&4294967295))+((58964+(a>>>16)&65535)<<16);switch(c=0,n){case 3:c^=(255&t.charCodeAt(d+2))<<16;case 2:c^=(255&t.charCodeAt(d+1))<<8;case 1:s^=c=(65535&(c=(c=(65535&(c^=255&t.charCodeAt(d)))*o+(((c>>>16)*o&65535)<<16)&4294967295)<<15|c>>>17))*r+(((c>>>16)*r&65535)<<16)&4294967295}return s^=t.length,s=2246822507*(65535&(s^=s>>>16))+((2246822507*(s>>>16)&65535)<<16)&4294967295,s=3266489909*(65535&(s^=s>>>13))+((3266489909*(s>>>16)&65535)<<16)&4294967295,(s^=s>>>16)>>>0}},function(t,e,n){var i;!function(s,a){"use strict";var o="function",r="undefined",c="object",d="string",l="model",h="name",u="type",g="vendor",p="version",f="architecture",m="console",b="mobile",v="tablet",y="smarttv",C="wearable",S="embedded",w="Amazon",k="Apple",I="ASUS",x="BlackBerry",T="Google",E="Huawei",M="LG",L="Microsoft",_="Motorola",A="Samsung",P="Sony",O="Xiaomi",D="Zebra",j="Facebook",U=function(t){var e={};for(var n in t)e[t[n].toUpperCase()]=t[n];return e},R=function(t,e){return typeof t===d&&-1!==B(e).indexOf(B(t))},B=function(t){return t.toLowerCase()},N=function(t,e){if(typeof t===d)return t=t.replace(/^\s\s*/,"").replace(/\s\s*$/,""),typeof e===r?t:t.substring(0,255)},V=function(t,e){for(var n,i,s,r,d,l,h=0;h<e.length&&!d;){var u=e[h],g=e[h+1];for(n=i=0;n<u.length&&!d;)if(d=u[n++].exec(t))for(s=0;s<g.length;s++)l=d[++i],typeof(r=g[s])===c&&r.length>0?2==r.length?typeof r[1]==o?this[r[0]]=r[1].call(this,l):this[r[0]]=r[1]:3==r.length?typeof r[1]!==o||r[1].exec&&r[1].test?this[r[0]]=l?l.replace(r[1],r[2]):a:this[r[0]]=l?r[1].call(this,l,r[2]):a:4==r.length&&(this[r[0]]=l?r[3].call(this,l.replace(r[1],r[2])):a):this[r]=l||a;h+=2}},F=function(t,e){for(var n in e)if(typeof e[n]===c&&e[n].length>0){for(var i=0;i<e[n].length;i++)if(R(e[n][i],t))return"?"===n?a:n}else if(R(e[n],t))return"?"===n?a:n;return t},z={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},H={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[p,[h,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[p,[h,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[h,p],[/opios[\/ ]+([\w\.]+)/i],[p,[h,"Opera Mini"]],[/\bopr\/([\w\.]+)/i],[p,[h,"Opera"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer)[\/ ]?([\w\.]*)/i,/(avant |iemobile|slim)(?:browser)?[\/ ]?([\w\.]*)/i,/(ba?idubrowser)[\/ ]?([\w\.]+)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|quark|qupzilla|falkon|rekonq|puffin|brave|whale|qqbrowserlite|qq)\/([-\w\.]+)/i,/(weibo)__([\d\.]+)/i],[h,p],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[p,[h,"UCBrowser"]],[/\bqbcore\/([\w\.]+)/i],[p,[h,"WeChat(Win) Desktop"]],[/micromessenger\/([\w\.]+)/i],[p,[h,"WeChat"]],[/konqueror\/([\w\.]+)/i],[p,[h,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[p,[h,"IE"]],[/yabrowser\/([\w\.]+)/i],[p,[h,"Yandex"]],[/(avast|avg)\/([\w\.]+)/i],[[h,/(.+)/,"$1 Secure Browser"],p],[/\bfocus\/([\w\.]+)/i],[p,[h,"Firefox Focus"]],[/\bopt\/([\w\.]+)/i],[p,[h,"Opera Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[p,[h,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[p,[h,"Dolphin"]],[/coast\/([\w\.]+)/i],[p,[h,"Opera Coast"]],[/miuibrowser\/([\w\.]+)/i],[p,[h,"MIUI Browser"]],[/fxios\/([-\w\.]+)/i],[p,[h,"Firefox"]],[/\bqihu|(qi?ho?o?|360)browser/i],[[h,"360 Browser"]],[/(oculus|samsung|sailfish)browser\/([\w\.]+)/i],[[h,/(.+)/,"$1 Browser"],p],[/(comodo_dragon)\/([\w\.]+)/i],[[h,/_/g," "],p],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|baiduboxapp|2345Explorer)[\/ ]?([\w\.]+)/i],[h,p],[/(metasr)[\/ ]?([\w\.]+)/i,/(lbbrowser)/i],[h],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[h,j],p],[/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(chromium|instagram)[\/ ]([-\w\.]+)/i],[h,p],[/\bgsa\/([\w\.]+) .*safari\//i],[p,[h,"GSA"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[p,[h,"Chrome Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[h,"Chrome WebView"],p],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[p,[h,"Android Browser"]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[h,p],[/version\/([\w\.]+) .*mobile\/\w+ (safari)/i],[p,[h,"Mobile Safari"]],[/version\/([\w\.]+) .*(mobile ?safari|safari)/i],[p,h],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[h,[p,F,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[h,p],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[h,"Netscape"],p],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[p,[h,"Firefox Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror|klar)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|sleipnir|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i],[h,p]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[f,"amd64"]],[/(ia32(?=;))/i],[[f,B]],[/((?:i[346]|x)86)[;\)]/i],[[f,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[f,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[f,"armhf"]],[/windows (ce|mobile); ppc;/i],[[f,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[f,/ower/,"",B]],[/(sun4\w)[;\)]/i],[[f,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[f,B]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[pt]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[l,[g,A],[u,v]],[/\b((?:s[cgp]h|gt|sm)-\w+|galaxy nexus)/i,/samsung[- ]([-\w]+)/i,/sec-(sgh\w+)/i],[l,[g,A],[u,b]],[/\((ip(?:hone|od)[\w ]*);/i],[l,[g,k],[u,b]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[l,[g,k],[u,v]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[l,[g,E],[u,v]],[/(?:huawei|honor)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}-[atu]?[ln][01259x][012359][an]?)\b(?!.+d\/s)/i],[l,[g,E],[u,b]],[/\b(poco[\w ]+)(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite)?)(?: bui|\))/i],[[l,/_/g," "],[g,O],[u,b]],[/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[l,/_/g," "],[g,O],[u,v]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007)\b/i],[l,[g,"OPPO"],[u,b]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[l,[g,"Vivo"],[u,b]],[/\b(rmx[12]\d{3})(?: bui|;|\))/i],[l,[g,"Realme"],[u,b]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[l,[g,_],[u,b]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[l,[g,_],[u,v]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[l,[g,M],[u,v]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[l,[g,M],[u,b]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[l,[g,"Lenovo"],[u,v]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[l,/_/g," "],[g,"Nokia"],[u,b]],[/(pixel c)\b/i],[l,[g,T],[u,v]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[l,[g,T],[u,b]],[/droid.+ ([c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[l,[g,P],[u,b]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[l,"Xperia Tablet"],[g,P],[u,v]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[l,[g,"OnePlus"],[u,b]],[/(alexa)webm/i,/(kf[a-z]{2}wi)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[l,[g,w],[u,v]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[l,/(.+)/g,"Fire Phone $1"],[g,w],[u,b]],[/(playbook);[-\w\),; ]+(rim)/i],[l,g,[u,v]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[l,[g,x],[u,b]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[l,[g,I],[u,v]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[l,[g,I],[u,b]],[/(nexus 9)/i],[l,[g,"HTC"],[u,v]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic|sony)[-_ ]?([-\w]*)/i],[g,[l,/_/g," "],[u,b]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[l,[g,"Acer"],[u,v]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[l,[g,"Meizu"],[u,b]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[l,[g,"Sharp"],[u,b]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron)[-_ ]?([-\w]*)/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[g,l,[u,b]],[/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[g,l,[u,v]],[/(surface duo)/i],[l,[g,L],[u,v]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[l,[g,"Fairphone"],[u,b]],[/(u304aa)/i],[l,[g,"AT&T"],[u,b]],[/\bsie-(\w*)/i],[l,[g,"Siemens"],[u,b]],[/\b(rct\w+) b/i],[l,[g,"RCA"],[u,v]],[/\b(venue[\d ]{2,7}) b/i],[l,[g,"Dell"],[u,v]],[/\b(q(?:mv|ta)\w+) b/i],[l,[g,"Verizon"],[u,v]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[l,[g,"Barnes & Noble"],[u,v]],[/\b(tm\d{3}\w+) b/i],[l,[g,"NuVision"],[u,v]],[/\b(k88) b/i],[l,[g,"ZTE"],[u,v]],[/\b(nx\d{3}j) b/i],[l,[g,"ZTE"],[u,b]],[/\b(gen\d{3}) b.+49h/i],[l,[g,"Swiss"],[u,b]],[/\b(zur\d{3}) b/i],[l,[g,"Swiss"],[u,v]],[/\b((zeki)?tb.*\b) b/i],[l,[g,"Zeki"],[u,v]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[g,"Dragon Touch"],l,[u,v]],[/\b(ns-?\w{0,9}) b/i],[l,[g,"Insignia"],[u,v]],[/\b((nxa|next)-?\w{0,9}) b/i],[l,[g,"NextBook"],[u,v]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[g,"Voice"],l,[u,b]],[/\b(lvtel\-)?(v1[12]) b/i],[[g,"LvTel"],l,[u,b]],[/\b(ph-1) /i],[l,[g,"Essential"],[u,b]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[l,[g,"Envizen"],[u,v]],[/\b(trio[-\w\. ]+) b/i],[l,[g,"MachSpeed"],[u,v]],[/\btu_(1491) b/i],[l,[g,"Rotor"],[u,v]],[/(shield[\w ]+) b/i],[l,[g,"Nvidia"],[u,v]],[/(sprint) (\w+)/i],[g,l,[u,b]],[/(kin\.[onetw]{3})/i],[[l,/\./g," "],[g,L],[u,b]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[l,[g,D],[u,v]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[l,[g,D],[u,b]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[g,l,[u,m]],[/droid.+; (shield) bui/i],[l,[g,"Nvidia"],[u,m]],[/(playstation [345portablevi]+)/i],[l,[g,P],[u,m]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[l,[g,L],[u,m]],[/smart-tv.+(samsung)/i],[g,[u,y]],[/hbbtv.+maple;(\d+)/i],[[l,/^/,"SmartTV"],[g,A],[u,y]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[g,M],[u,y]],[/(apple) ?tv/i],[g,[l,"Apple TV"],[u,y]],[/crkey/i],[[l,"Chromecast"],[g,T],[u,y]],[/droid.+aft(\w)( bui|\))/i],[l,[g,w],[u,y]],[/\(dtv[\);].+(aquos)/i],[l,[g,"Sharp"],[u,y]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w ]*; *(\w[^;]*);([^;]*)/i],[[g,N],[l,N],[u,y]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[u,y]],[/((pebble))app/i],[g,l,[u,C]],[/droid.+; (glass) \d/i],[l,[g,T],[u,C]],[/droid.+; (wt63?0{2,3})\)/i],[l,[g,D],[u,C]],[/(quest( 2)?)/i],[l,[g,j],[u,C]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[g,[u,S]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+? mobile safari/i],[l,[u,b]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[l,[u,v]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[u,v]],[/(phone|mobile(?:[;\/]| safari)|pda(?=.+windows ce))/i],[[u,b]],[/(android[-\w\. ]{0,9});.+buil/i],[l,[g,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[p,[h,"EdgeHTML"]],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[p,[h,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i],[h,p],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[p,h]],os:[[/microsoft (windows) (vista|xp)/i],[h,p],[/(windows) nt 6\.2; (arm)/i,/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i,/(windows)[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i],[h,[p,F,z]],[/(win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[h,"Windows"],[p,F,z]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/cfnetwork\/.+darwin/i],[[p,/_/g,"."],[h,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[h,"Mac OS"],[p,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86)/i],[p,h],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[h,p],[/\(bb(10);/i],[p,[h,x]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[p,[h,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[p,[h,"Firefox OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[p,[h,"webOS"]],[/crkey\/([\d\.]+)/i],[p,[h,"Chromecast"]],[/(cros) [\w]+ ([\w\.]+\w)/i],[[h,"Chromium OS"],p],[/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[h,p],[/(sunos) ?([\w\.\d]*)/i],[[h,"Solaris"],p],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux)/i,/(unix) ?([\w\.]*)/i],[h,p]]},K=function(t,e){if(typeof t===c&&(e=t,t=a),!(this instanceof K))return new K(t,e).getResult();var n=t||(typeof s!==r&&s.navigator&&s.navigator.userAgent?s.navigator.userAgent:""),i=e?function(t,e){var n={};for(var i in t)e[i]&&e[i].length%2==0?n[i]=e[i].concat(t[i]):n[i]=t[i];return n}(H,e):H;return this.getBrowser=function(){var t,e={};return e.name=a,e.version=a,V.call(e,n,i.browser),e.major=typeof(t=e.version)===d?t.replace(/[^\d\.]/g,"").split(".")[0]:a,e},this.getCPU=function(){var t={};return t.architecture=a,V.call(t,n,i.cpu),t},this.getDevice=function(){var t={};return t.vendor=a,t.model=a,t.type=a,V.call(t,n,i.device),t},this.getEngine=function(){var t={};return t.name=a,t.version=a,V.call(t,n,i.engine),t},this.getOS=function(){var t={};return t.name=a,t.version=a,V.call(t,n,i.os),t},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return n},this.setUA=function(t){return n=typeof t===d&&t.length>255?N(t,255):t,this},this.setUA(n),this};K.VERSION="0.7.30",K.BROWSER=U([h,p,"major"]),K.CPU=U([f]),K.DEVICE=U([l,g,u,m,b,y,v,C,S]),K.ENGINE=K.OS=U([h,p]),typeof e!==r?(typeof t!==r&&t.exports&&(e=t.exports=K),e.UAParser=K):n(5)?(i=function(){return K}.call(e,n,e,t))===a||(t.exports=i):typeof s!==r&&(s.UAParser=K);var $=typeof s!==r&&(s.jQuery||s.Zepto);if($&&!$.ua){var W=new K;$.ua=W.getResult(),$.ua.get=function(){return W.getUA()},$.ua.set=function(t){W.setUA(t);var e=W.getResult();for(var n in e)$.ua[n]=e[n]}}}("object"==typeof window?window:this)},function(t,e){(function(e){t.exports=e}).call(this,{})},function(t,e){t.exports=function(){var t=["monospace","sans-serif","serif"],e=document.getElementsByTagName("body")[0],n=document.createElement("span");n.style.fontSize="72px",n.innerHTML="mmmmmmmmmmlli";var i={},s={};for(var a in t)n.style.fontFamily=t[a],e.appendChild(n),i[t[a]]=n.offsetWidth,s[t[a]]=n.offsetHeight,e.removeChild(n);this.detect=function(a){var o=!1;for(var r in t){n.style.fontFamily=a+","+t[r],e.appendChild(n);var c=n.offsetWidth!=i[t[r]]||n.offsetHeight!=s[t[r]];e.removeChild(n),o=o||c}return o}}}])},9133:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.hasBinary=e.isBinary=void 0;const n="function"==typeof ArrayBuffer,i=Object.prototype.toString,s="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===i.call(Blob),a="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===i.call(File);function o(t){return n&&(t instanceof ArrayBuffer||(t=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(t):t.buffer instanceof ArrayBuffer)(t))||s&&t instanceof Blob||a&&t instanceof File}e.isBinary=o,e.hasBinary=function t(e,n){if(!e||"object"!=typeof e)return!1;if(Array.isArray(e)){for(let n=0,i=e.length;n<i;n++)if(t(e[n]))return!0;return!1}if(o(e))return!0;if(e.toJSON&&"function"==typeof e.toJSON&&1===arguments.length)return t(e.toJSON(),!0);for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)&&t(e[n]))return!0;return!1}},9167:function(t,e,n){"use strict";var i=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,a){function o(t){try{c(i.next(t))}catch(t){a(t)}}function r(t){try{c(i.throw(t))}catch(t){a(t)}}function c(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(o,r)}c((i=i.apply(t,e||[])).next())}))};Object.defineProperty(e,"__esModule",{value:!0}),e.fetchChatDetailV2=o,e.convertV2ToLegacy=r,e.fetchChatDetail=function(t){return i(this,arguments,void 0,(function*(t,e=!1){return r(yield o(t,e))}))};const s=n(2597),a=n(3974);function o(t){return i(this,arguments,void 0,(function*(t,e=!1){var n,i,o;if(!t)throw new Error("chatId requerido");if(e)(0,a.debugLog)("[chat-detail-service] ðŸ”„ Force refresh habilitado - ignorando cachÃ© y consultando backend directamente");else try{const e=localStorage.getItem("guiders_recent_chats");if(e){const s=JSON.parse(e).find((e=>e&&e.id===t));if(s){const e={id:s.id,status:s.status,priority:s.priority,visitorInfo:s.visitorInfo,assignedCommercialId:s.assignedCommercialId,assignedCommercial:s.assignedCommercial,availableCommercialIds:s.availableCommercialIds,metadata:s.metadata,createdAt:new Date(s.createdAt),assignedAt:s.assignedAt?new Date(s.assignedAt):void 0,closedAt:s.closedAt?new Date(s.closedAt):void 0,lastMessageDate:s.lastMessageDate?new Date(s.lastMessageDate):void 0,totalMessages:null!==(n=s.totalMessages)&&void 0!==n?n:0,unreadMessagesCount:null!==(i=s.unreadMessagesCount)&&void 0!==i?i:0,isActive:null===(o=s.isActive)||void 0===o||o,visitorId:s.visitorId,department:s.department,tags:s.tags,updatedAt:s.updatedAt?new Date(s.updatedAt):void 0,averageResponseTimeMinutes:s.averageResponseTimeMinutes,chatDurationMinutes:s.chatDurationMinutes,resolutionStatus:s.resolutionStatus,satisfactionRating:s.satisfactionRating};return(0,a.debugLog)("[chat-detail-service] ðŸ“¦ Usando detalle de chat desde cache local (sin GET):",t),e}}}catch(t){}const r=localStorage.getItem("accessToken"),c=s.EndpointManager.getInstance(),d=localStorage.getItem("pixelEndpoint")||c.getEndpoint(),l=`${d.endsWith("/api")?d:`${d}/api`}/v2/chats/${t}`,h={"Content-Type":"application/json"},u=sessionStorage.getItem("guiders_backend_session_id");u&&(h["X-Guiders-Sid"]=u),r&&(h.Authorization=`Bearer ${r}`);const g=yield fetch(l,{method:"GET",headers:h});if(!g.ok)throw new Error(`Error al obtener detalles del chat V2 (${g.status})`);return g.json()}))}function r(t){var e,n,i,s,a;const o=[];if(o.push({id:t.visitorInfo.id,name:t.visitorInfo.name,isCommercial:!1,isVisitor:!0,isOnline:!0,assignedAt:t.createdAt.toISOString(),lastSeenAt:(null===(e=t.lastMessageDate)||void 0===e?void 0:e.toISOString())||null,isViewing:t.isActive,isTyping:!1,isAnonymous:!1}),t.assignedCommercialId){const e=(null===(n=t.assignedCommercial)||void 0===n?void 0:n.name)||`Comercial ${t.assignedCommercialId}`;o.push({id:t.assignedCommercialId,name:e,isCommercial:!0,isVisitor:!1,isOnline:t.isActive,assignedAt:(null===(i=t.assignedAt)||void 0===i?void 0:i.toISOString())||t.createdAt.toISOString(),lastSeenAt:(null===(s=t.lastMessageDate)||void 0===s?void 0:s.toISOString())||null,isViewing:t.isActive,isTyping:!1,isAnonymous:!1})}else t.availableCommercialIds&&t.availableCommercialIds.forEach((e=>{o.push({id:e,name:`Comercial ${e}`,isCommercial:!0,isVisitor:!1,isOnline:!1,assignedAt:t.createdAt.toISOString(),lastSeenAt:null,isViewing:!1,isTyping:!1,isAnonymous:!1})}));return{id:t.id,participants:o,status:t.status,lastMessage:null,lastMessageAt:(null===(a=t.lastMessageDate)||void 0===a?void 0:a.toISOString())||null,createdAt:t.createdAt.toISOString(),assignedCommercial:t.assignedCommercial}}},9329:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.URLInjectionStage=void 0;const i=n(3974);e.URLInjectionStage=class{process(t){if(t.metadata&&"object"==typeof t.metadata&&"page"in t.metadata&&"object"==typeof t.metadata.page&&t.metadata.page&&"url"in t.metadata.page)(0,i.debugLog)("[URLInjectionStage] âœ… URL ya presente en metadata, omitiendo inyecciÃ³n automÃ¡tica");else if("undefined"!=typeof window&&window.location){t.metadata||(t.metadata={});const e={url:window.location.href,path:window.location.pathname,search:window.location.search,host:window.location.host,protocol:window.location.protocol,hash:window.location.hash,referrer:document.referrer||"",timestamp:Date.now()};t.metadata.page=e,t.data&&(t.data.pageUrl=window.location.href,t.data.pagePath=window.location.pathname),(0,i.debugLog)("[URLInjectionStage] ðŸŒ URL generada automÃ¡ticamente para page_view:",{url:e.url,path:e.path,search:e.search})}return t}}},9419:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.transports=void 0;const i=n(2071),s=n(8716),a=n(4480);e.transports={websocket:s.WS,webtransport:a.WT,polling:i.XHR}},9439:(t,e)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.TypingIndicator=void 0,e.TypingIndicator=class{constructor(){this.container=null,this.isVisible=!1}render(){this.container=document.createElement("div"),this.container.className="guiders-typing-indicator",this.container.style.display="none",this.container.style.opacity="0";const t=document.createElement("div");t.className="guiders-typing-bubble";for(let e=0;e<3;e++){const n=document.createElement("span");n.className="guiders-typing-dot",n.style.animationDelay=.15*e+"s",t.appendChild(n)}const e=document.createElement("span");return e.className="guiders-typing-text",e.textContent="El agente estÃ¡ escribiendo...",this.container.appendChild(t),this.container.appendChild(e),this.container}show(){this.container&&!this.isVisible&&(this.isVisible=!0,this.container.style.display="flex",this.container.offsetHeight,requestAnimationFrame((()=>{this.container&&(this.container.style.opacity="1")})))}hide(){this.container&&this.isVisible&&(this.isVisible=!1,this.container.style.opacity="0",setTimeout((()=>{this.container&&(this.container.style.display="none")}),200))}isShown(){return this.isVisible}updateText(t){if(!this.container)return;const e=this.container.querySelector(".guiders-typing-text");e&&(e.textContent=t)}destroy(){this.container&&(this.hide(),setTimeout((()=>{this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container),this.container=null}),200))}getElement(){return this.container}}},9453:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.EventThrottler=void 0;const i=n(3974);class s{constructor(t={}){var e,n;this.config={enabled:null===(e=t.enabled)||void 0===e||e,rules:Object.assign(Object.assign({},s.DEFAULT_RULES),t.rules||{}),debug:null!==(n=t.debug)&&void 0!==n&&n},this.lastEventTimestamps=new Map,this.stats={allowed:0,throttled:0,throttledByType:{}},this.config.debug&&(0,i.debugLog)("[EventThrottler] âœ… Initialized with rules:",this.config.rules)}shouldAllow(t){if(!this.config.enabled)return this.stats.allowed++,!0;const e=this.config.rules[t];if(void 0===e)return this.stats.allowed++,!0;const n=Date.now(),s=this.lastEventTimestamps.get(t);if(void 0===s)return this.lastEventTimestamps.set(t,n),this.stats.allowed++,!0;const a=n-s;return a>=e?(this.lastEventTimestamps.set(t,n),this.stats.allowed++,this.config.debug&&(0,i.debugLog)(`[EventThrottler] âœ… ${t} allowed (elapsed: ${a}ms >= ${e}ms)`),!0):(this.stats.throttled++,this.stats.throttledByType[t]=(this.stats.throttledByType[t]||0)+1,this.config.debug&&(0,i.debugLog)(`[EventThrottler] â±ï¸ ${t} throttled (elapsed: ${a}ms < ${e}ms)`),!1)}reset(t){this.lastEventTimestamps.delete(t)}resetAll(){this.lastEventTimestamps.clear(),this.stats={allowed:0,throttled:0,throttledByType:{}},(0,i.debugLog)("[EventThrottler] ðŸ”„ Reset completo")}getStats(){return Object.assign({},this.stats)}updateConfig(t){this.config=Object.assign(Object.assign(Object.assign({},this.config),t),{rules:Object.assign(Object.assign({},this.config.rules),t.rules||{})}),this.config.debug&&(0,i.debugLog)("[EventThrottler] âš™ï¸ ConfiguraciÃ³n actualizada:",this.config)}setRule(t,e){this.config.rules[t]=e,this.config.debug&&(0,i.debugLog)(`[EventThrottler] ðŸ“ Regla actualizada: ${t} â†’ ${e}ms`)}removeRule(t){delete this.config.rules[t],this.config.debug&&(0,i.debugLog)(`[EventThrottler] ðŸ—‘ï¸ Regla eliminada: ${t}`)}getTimeUntilNext(t){const e=this.config.rules[t];if(void 0===e)return 0;const n=this.lastEventTimestamps.get(t);if(void 0===n)return 0;const i=e-(Date.now()-n);return Math.max(0,i)}isEnabled(){return this.config.enabled}setEnabled(t){this.config.enabled=t,(0,i.debugLog)("[EventThrottler] "+(t?"âœ… Habilitado":"âŒ Deshabilitado"))}}e.EventThrottler=s,s.DEFAULT_RULES={SCROLL:100,MOUSE_MOVE:50,HOVER:200,MOUSE_ENTER:200,MOUSE_LEAVE:200,RESIZE:300}},9910:(t,e,n)=>{"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0,e.unsafeStringify=r;for(var i,s=(i=n(7037))&&i.__esModule?i:{default:i},a=[],o=0;o<256;++o)a.push((o+256).toString(16).slice(1));function r(t,e=0){return(a[t[e+0]]+a[t[e+1]]+a[t[e+2]]+a[t[e+3]]+"-"+a[t[e+4]]+a[t[e+5]]+"-"+a[t[e+6]]+a[t[e+7]]+"-"+a[t[e+8]]+a[t[e+9]]+"-"+a[t[e+10]]+a[t[e+11]]+a[t[e+12]]+a[t[e+13]]+a[t[e+14]]+a[t[e+15]]).toLowerCase()}e.default=function(t,e=0){var n=r(t,e);if(!(0,s.default)(n))throw TypeError("Stringified UUID is invalid");return n}}},e={};function n(i){var s=e[i];if(void 0!==s)return s.exports;var a=e[i]={exports:{}};return t[i].call(a.exports,a,a.exports,n),a.exports}n.d=(t,e)=>{for(var i in e)n.o(e,i)&&!n.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(t){if("object"==typeof window)return window}}(),n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})};var i=n(8156);return i.default})()));