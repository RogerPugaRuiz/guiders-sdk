<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test EndSession - Page Unload</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; cursor: pointer; }
        .btn-danger { background: #dc3545; color: white; border: none; border-radius: 4px; }
        .btn-primary { background: #007bff; color: white; border: none; border-radius: 4px; }
        .btn-secondary { background: #6c757d; color: white; border: none; border-radius: 4px; }
        #logs { background: #f8f9fa; border: 1px solid #dee2e6; padding: 15px; margin: 20px 0; max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>üß™ Test EndSession y Page Unload</h1>
    
    <div class="status success">
        <strong>‚úÖ SDK cargado:</strong> Configurado para enviar endSession autom√°ticamente en page unload
    </div>
    
    <div class="status warning">
        <strong>‚ö†Ô∏è Instrucciones:</strong> 
        <ol>
            <li>Abrir DevTools ‚Üí Network para monitorear peticiones</li>
            <li>Probar los diferentes m√©todos de cierre de p√°gina</li>
            <li>Verificar que se env√≠a POST a /session/end con sendBeacon</li>
        </ol>
    </div>

    <h2>Acciones de Prueba</h2>
    
    <button class="btn-primary" onclick="manualEndSession()">
        üì§ EndSession Manual (fetch)
    </button>
    
    <button class="btn-primary" onclick="manualEndSessionBeacon()">
        üì° EndSession Manual (beacon)
    </button>
    
    <button class="btn-secondary" onclick="simulatePageHide()">
        üëÅÔ∏è Simular Page Hide
    </button>
    
    <button class="btn-secondary" onclick="simulateVisibilityHidden()">
        üï∂Ô∏è Simular Visibility Hidden
    </button>
    
    <button class="btn-danger" onclick="reloadPage()">
        üîÑ Recargar P√°gina (test beforeunload)
    </button>
    
    <button class="btn-danger" onclick="closePage()">
        ‚ùå Cerrar P√°gina (test unload)
    </button>

    <h2>Logs de Red</h2>
    <div id="logs">Los logs aparecer√°n aqu√≠...</div>

    <h2>Estado Actual</h2>
    <div id="status">
        <p><strong>Session ID:</strong> <span id="sessionId">Cargando...</span></p>
        <p><strong>Visitor ID:</strong> <span id="visitorId">Cargando...</span></p>
        <p><strong>Beacon Support:</strong> <span id="beaconSupport">Verificando...</span></p>
    </div>

    <!-- SDK -->
    <script src="http://localhost:8082/index.js" data-api-key="test-api-key"></script>
    
    <script>
        // Interceptar console.log para mostrar en la p√°gina
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        const logsDiv = document.getElementById('logs');
        
        function addLog(level, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => typeof arg === 'object' ? JSON.stringify(arg, null, 2) : arg).join(' ');
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}] ${level}:</strong> ${message}`;
            logEntry.style.marginBottom = '5px';
            if (level === 'ERROR') logEntry.style.color = '#dc3545';
            if (level === 'WARN') logEntry.style.color = '#856404';
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog('LOG', ...args);
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addLog('WARN', ...args);
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('ERROR', ...args);
        };

        // Funciones de prueba
        async function manualEndSession() {
            console.log('üß™ Iniciando endSession manual...');
            const result = await window.guiders?.visitorsService?.endSession({ useBeacon: false, reason: 'manual_test' });
            console.log('üìã Resultado endSession manual:', result);
        }
        
        async function manualEndSessionBeacon() {
            console.log('üß™ Iniciando endSession con beacon...');
            const result = await window.guiders?.visitorsService?.endSession({ useBeacon: true, reason: 'beacon_test' });
            console.log('üìã Resultado endSession beacon:', result);
        }
        
        function simulatePageHide() {
            console.log('üß™ Simulando evento pagehide...');
            window.dispatchEvent(new Event('pagehide'));
        }
        
        function simulateVisibilityHidden() {
            console.log('üß™ Simulando visibilitychange to hidden...');
            Object.defineProperty(document, 'visibilityState', { value: 'hidden', writable: true });
            document.dispatchEvent(new Event('visibilitychange'));
        }
        
        function reloadPage() {
            console.log('üß™ Recargando p√°gina en 2 segundos...');
            setTimeout(() => location.reload(), 2000);
        }
        
        function closePage() {
            console.log('üß™ Intentando cerrar p√°gina...');
            window.close();
        }
        
        // Actualizar estado en la p√°gina
        function updateStatus() {
            const sessionId = sessionStorage.getItem('guiders_backend_session_id');
            const visitorId = localStorage.getItem('visitorId');
            const beaconSupport = 'sendBeacon' in navigator;
            
            document.getElementById('sessionId').textContent = sessionId || 'No disponible';
            document.getElementById('visitorId').textContent = visitorId || 'No disponible';
            document.getElementById('beaconSupport').textContent = beaconSupport ? '‚úÖ Soportado' : '‚ùå No soportado';
        }
        
        // Actualizar estado cada segundo
        setInterval(updateStatus, 1000);
        updateStatus();
        
        // Log inicial
        console.log('üöÄ P√°gina de prueba cargada. SDK configurado para endSession autom√°tico.');
    </script>
</body>
</html>